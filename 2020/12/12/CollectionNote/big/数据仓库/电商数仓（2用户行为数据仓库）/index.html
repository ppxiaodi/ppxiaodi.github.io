<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="momo"><meta name="copyright" content="momo"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>2用户行为数据仓库 | 我的笔记</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"ppxiaodi.gitee.io","root":"/","title":"momo的小站","version":"1.7.0","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><meta name="description" content="第1章 数仓分层概念 ¶1.1 为什么要分层  ODS(Operation Data Store) 原始数据层   ：原始数据层，存放原始数据，直接加载原始日志、数据，数据保持原貌不做处理。 DWD(data warehouse detail)明细数据层：结构和粒度与原始表保持一致，对ODS层数据进行清晰（去除空值，脏数据，超过极限范围的数据） DWS(data warehouse service">
<meta property="og:type" content="article">
<meta property="og:title" content="2用户行为数据仓库">
<meta property="og:url" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/index.html">
<meta property="og:site_name" content="我的笔记">
<meta property="og:description" content="第1章 数仓分层概念 ¶1.1 为什么要分层  ODS(Operation Data Store) 原始数据层   ：原始数据层，存放原始数据，直接加载原始日志、数据，数据保持原貌不做处理。 DWD(data warehouse detail)明细数据层：结构和粒度与原始表保持一致，对ODS层数据进行清晰（去除空值，脏数据，超过极限范围的数据） DWS(data warehouse service">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85GHOS.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85dwn0.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85sQns.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85rHX9.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/856Pot.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85o5QI.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/856Pot-1607767778299.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85ba0x.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85qcPU.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8I96mD.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8IioX6.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8Ik8Z8.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/03/22/8IF4Ug.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8IrPN6.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8TgknS.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8T2kgx.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8TRofs.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8T41nx.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/87rLtI.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/87ss8P.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/87ytGq.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/876EOU.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/876Mf1.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/876xc6.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8HJ6sI.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8Ht5Ks.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8HfdG4.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8Hh1YD.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8Hh4tU.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8H4m9g.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8H4vbq.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8H5ErR.png">
<meta property="article:published_time" content="2020-12-11T16:00:00.000Z">
<meta property="article:modified_time" content="2021-07-11T08:54:53.458Z">
<meta property="article:author" content="momo">
<meta property="article:tag" content="大数据">
<meta property="article:tag" content="电商数仓">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85GHOS.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="momo"><img width="96" loading="lazy" src="/yun.png" alt="momo"></a><div class="site-author-name"><a href="/about/">momo</a></div><a class="site-name" href="/about/site.html">我的笔记</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">198</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">58</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">47</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=kZJzggTTCf4SpvEQ8lXWoi5ZjhAx0ILZ&amp;jump_from=webapi" title="QQ 群 1050458482" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YunYouJun" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/jizhideyunyoujun" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/yunyoujun/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/yunyoujun/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/about/white-qrcode-and-search.jpg" title="微信公众号" target="_blank" style="color:#1AAD19"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-2-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/YunYouJun" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@yunyoujun.cn" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.link" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-train-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">第1章 数仓分层概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%88%86%E5%B1%82"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 为什么要分层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%95%B0%E4%BB%93%E5%88%86%E5%B1%82"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 数仓分层</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#font-color-blue-%E4%B8%8B%E9%9D%A2%E6%98%AF%E6%96%87%E5%AD%97%E7%89%88-font"><span class="toc-number">1.2.0.0.0.1.</span> <span class="toc-text">下面是文字版</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E6%95%B0%E6%8D%AE%E9%9B%86%E5%B8%82%E4%B8%8E%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 数据集市与数据仓库概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E6%95%B0%E4%BB%93%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 数仓命名规范</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">第2章 数仓搭建环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-Hive-MySQL%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 Hive&amp;MySQL安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-Hive-MySQL%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 Hive&amp;MySQL安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-%E4%BF%AE%E6%94%B9hive-site-xml"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2 修改hive-site.xml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Hive%E8%BF%90%E8%A1%8C%E5%BC%95%E6%93%8ETez"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 Hive运行引擎Tez</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E5%AE%89%E8%A3%85%E5%8C%85%E5%87%86%E5%A4%87"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 安装包准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E5%9C%A8Hive%E4%B8%AD%E9%85%8D%E7%BD%AETez"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 在Hive中配置Tez</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-%E9%85%8D%E7%BD%AETez"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3 配置Tez</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-%E4%B8%8A%E4%BC%A0Tez%E5%88%B0%E9%9B%86%E7%BE%A4"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4 上传Tez到集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-5-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.2.5.</span> <span class="toc-text">2.2.5 测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-6-%E5%B0%8F%E7%BB%93"><span class="toc-number">2.2.6.</span> <span class="toc-text">2.2.6 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C%E4%B9%8B%E5%85%83%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 项目经验之元数据备份</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">第3章 数仓搭建之ODS层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 创建数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ODS%E5%B1%82"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ODS层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E6%97%A5%E5%BF%97%E8%A1%A8ods-start-log"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1 创建启动日志表ods_start_log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-%E5%88%9B%E5%BB%BA%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97%E8%A1%A8ods-event-log"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2 创建事件日志表ods_event_log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-Shell%E4%B8%AD%E5%8D%95%E5%BC%95%E5%8F%B7%E5%92%8C%E5%8F%8C%E5%BC%95%E5%8F%B7%E5%8C%BA%E5%88%AB"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3 Shell中单引号和双引号区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-4-ODS%E5%B1%82%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E8%84%9A%E6%9C%AC"><span class="toc-number">3.2.4.</span> <span class="toc-text">3.2.4 ODS层加载数据脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">第4章 数仓搭建之DWD层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-DWD%E5%B1%82%E5%90%AF%E5%8A%A8%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 DWD层启动表数据解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E8%A1%A8"><span class="toc-number">4.1.1.</span> <span class="toc-text">4.1.1 创建启动表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E5%90%91%E5%90%AF%E5%8A%A8%E8%A1%A8%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">4.1.2.</span> <span class="toc-text">4.1.2 向启动表导入数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-DWD%E5%B1%82%E5%90%AF%E5%8A%A8%E8%A1%A8%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E8%84%9A%E6%9C%AC"><span class="toc-number">4.1.3.</span> <span class="toc-text">4.1.3 DWD层启动表加载数据脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-DWD%E5%B1%82%E4%BA%8B%E4%BB%B6%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 DWD层事件表数据解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E5%88%9B%E5%BB%BA%E5%9F%BA%E7%A1%80%E6%98%8E%E7%BB%86%E8%A1%A8"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1 创建基础明细表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E8%87%AA%E5%AE%9A%E4%B9%89UDF%E5%87%BD%E6%95%B0%EF%BC%88%E8%A7%A3%E6%9E%90%E5%85%AC%E5%85%B1%E5%AD%97%E6%AE%B5%EF%BC%89"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2 自定义UDF函数（解析公共字段）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-%E8%87%AA%E5%AE%9A%E4%B9%89UDTF%E5%87%BD%E6%95%B0%EF%BC%88%E8%A7%A3%E6%9E%90%E5%85%B7%E4%BD%93%E4%BA%8B%E4%BB%B6%E5%AD%97%E6%AE%B5%EF%BC%89"><span class="toc-number">4.2.3.</span> <span class="toc-text">4.2.3 自定义UDTF函数（解析具体事件字段）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-4-%E8%A7%A3%E6%9E%90%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97%E5%9F%BA%E7%A1%80%E6%98%8E%E7%BB%86%E8%A1%A8"><span class="toc-number">4.2.4.</span> <span class="toc-text">4.2.4 解析事件日志基础明细表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-5-DWD%E5%B1%82%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90%E8%84%9A%E6%9C%AC"><span class="toc-number">4.2.5.</span> <span class="toc-text">4.2.5 DWD层数据解析脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-DWD%E5%B1%82%E4%BA%8B%E4%BB%B6%E8%A1%A8%E8%8E%B7%E5%8F%96"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 DWD层事件表获取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-%E5%95%86%E5%93%81%E7%82%B9%E5%87%BB%E8%A1%A8"><span class="toc-number">4.3.1.</span> <span class="toc-text">4.3.1 商品点击表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5%E8%A1%A8"><span class="toc-number">4.3.2.</span> <span class="toc-text">4.3.2 商品详情页表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-3-%E5%95%86%E5%93%81%E5%88%97%E8%A1%A8%E9%A1%B5%E8%A1%A8"><span class="toc-number">4.3.3.</span> <span class="toc-text">4.3.3 商品列表页表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-4-%E5%B9%BF%E5%91%8A%E8%A1%A8"><span class="toc-number">4.3.4.</span> <span class="toc-text">4.3.4 广告表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-5-%E6%B6%88%E6%81%AF%E9%80%9A%E7%9F%A5%E8%A1%A8"><span class="toc-number">4.3.5.</span> <span class="toc-text">4.3.5 消息通知表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-6-%E7%94%A8%E6%88%B7%E5%89%8D%E5%8F%B0%E6%B4%BB%E8%B7%83%E8%A1%A8"><span class="toc-number">4.3.6.</span> <span class="toc-text">4.3.6 用户前台活跃表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-7-%E7%94%A8%E6%88%B7%E5%90%8E%E5%8F%B0%E6%B4%BB%E8%B7%83%E8%A1%A8"><span class="toc-number">4.3.7.</span> <span class="toc-text">4.3.7 用户后台活跃表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-8-%E8%AF%84%E8%AE%BA%E8%A1%A8"><span class="toc-number">4.3.8.</span> <span class="toc-text">4.3.8 评论表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-9-%E6%94%B6%E8%97%8F%E8%A1%A8"><span class="toc-number">4.3.9.</span> <span class="toc-text">4.3.9 收藏表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-10-%E7%82%B9%E8%B5%9E%E8%A1%A8"><span class="toc-number">4.3.10.</span> <span class="toc-text">4.3.10 点赞表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-11-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E8%A1%A8"><span class="toc-number">4.3.11.</span> <span class="toc-text">4.3.11 错误日志表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-12-DWD%E5%B1%82%E4%BA%8B%E4%BB%B6%E8%A1%A8%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E8%84%9A%E6%9C%AC"><span class="toc-number">4.3.12.</span> <span class="toc-text">4.3.12 DWD层事件表加载数据脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">第5章 业务知识准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E4%B8%9A%E5%8A%A1%E6%9C%AF%E8%AF%AD"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 业务术语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E7%B3%BB%E7%BB%9F%E5%87%BD%E6%95%B0"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 系统函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-collect-set%E5%87%BD%E6%95%B0"><span class="toc-number">5.2.1.</span> <span class="toc-text">5.2.1 collect_set函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-%E6%97%A5%E6%9C%9F%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><span class="toc-number">5.2.2.</span> <span class="toc-text">5.2.2 日期处理函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">第6章 需求一：用户活跃主题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-DWS%E5%B1%82"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 DWS层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-%E6%AF%8F%E6%97%A5%E6%B4%BB%E8%B7%83%E8%AE%BE%E5%A4%87%E6%98%8E%E7%BB%86"><span class="toc-number">6.1.1.</span> <span class="toc-text">6.1.1 每日活跃设备明细</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-%E6%AF%8F%E5%91%A8%E6%B4%BB%E8%B7%83%E8%AE%BE%E5%A4%87%E6%98%8E%E7%BB%86"><span class="toc-number">6.1.2.</span> <span class="toc-text">6.1.2 每周活跃设备明细</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3-%E6%AF%8F%E6%9C%88%E6%B4%BB%E8%B7%83%E8%AE%BE%E5%A4%87%E6%98%8E%E7%BB%86"><span class="toc-number">6.1.3.</span> <span class="toc-text">6.1.3 每月活跃设备明细</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-4-DWS%E5%B1%82%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E8%84%9A%E6%9C%AC"><span class="toc-number">6.1.4.</span> <span class="toc-text">6.1.4 DWS层加载数据脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-ADS%E5%B1%82"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 ADS层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-%E6%B4%BB%E8%B7%83%E8%AE%BE%E5%A4%87%E6%95%B0"><span class="toc-number">6.2.1.</span> <span class="toc-text">6.2.1 活跃设备数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-ADS%E5%B1%82%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E8%84%9A%E6%9C%AC"><span class="toc-number">6.2.2.</span> <span class="toc-text">6.2.2 ADS层加载数据脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">第7章 需求二：用户新增主题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-DWS%E5%B1%82%EF%BC%88%E6%AF%8F%E6%97%A5%E6%96%B0%E5%A2%9E%E8%AE%BE%E5%A4%87%E6%98%8E%E7%BB%86%E8%A1%A8%EF%BC%89"><span class="toc-number">7.1.</span> <span class="toc-text">7.1 DWS层（每日新增设备明细表）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-ADS%E5%B1%82%EF%BC%88%E6%AF%8F%E6%97%A5%E6%96%B0%E5%A2%9E%E8%AE%BE%E5%A4%87%E8%A1%A8%EF%BC%89"><span class="toc-number">7.2.</span> <span class="toc-text">7.2 ADS层（每日新增设备表）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">8.</span> <span class="toc-text">第8章 需求三：用户留存主题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E9%9C%80%E6%B1%82%E7%9B%AE%E6%A0%87"><span class="toc-number">8.1.</span> <span class="toc-text">8.1 需求目标</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-1-%E7%94%A8%E6%88%B7%E7%95%99%E5%AD%98%E6%A6%82%E5%BF%B5"><span class="toc-number">8.1.1.</span> <span class="toc-text">8.1.1 用户留存概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-2-%E9%9C%80%E6%B1%82%E6%8F%8F%E8%BF%B0"><span class="toc-number">8.1.2.</span> <span class="toc-text">8.1.2 需求描述</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-DWS%E5%B1%82"><span class="toc-number">8.2.</span> <span class="toc-text">8.2 DWS层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-1-DWS%E5%B1%82%EF%BC%88%E6%AF%8F%E6%97%A5%E7%95%99%E5%AD%98%E7%94%A8%E6%88%B7%E6%98%8E%E7%BB%86%E8%A1%A8%EF%BC%89"><span class="toc-number">8.2.1.</span> <span class="toc-text">8.2.1 DWS层（每日留存用户明细表）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-2-DWS%E5%B1%82%EF%BC%881-2-3-n%E5%A4%A9%E7%95%99%E5%AD%98%E7%94%A8%E6%88%B7%E6%98%8E%E7%BB%86%E8%A1%A8%EF%BC%89"><span class="toc-number">8.2.2.</span> <span class="toc-text">8.2.2 DWS层（1,2,3,n天留存用户明细表）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-3-Union%E4%B8%8EUnion-all%E5%8C%BA%E5%88%AB"><span class="toc-number">8.2.3.</span> <span class="toc-text">8.2.3 Union与Union all区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-ADS%E5%B1%82"><span class="toc-number">8.3.</span> <span class="toc-text">8.3 ADS层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-1-%E7%95%99%E5%AD%98%E7%94%A8%E6%88%B7%E6%95%B0"><span class="toc-number">8.3.1.</span> <span class="toc-text">8.3.1 留存用户数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-2-%E7%95%99%E5%AD%98%E7%94%A8%E6%88%B7%E6%AF%94%E7%8E%87"><span class="toc-number">8.3.2.</span> <span class="toc-text">8.3.2 留存用户比率</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">9.</span> <span class="toc-text">第9章 新数据准备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">10.</span> <span class="toc-text">第10章 需求四：沉默用户数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-DWS%E5%B1%82"><span class="toc-number">10.1.</span> <span class="toc-text">10.1 DWS层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-ADS%E5%B1%82"><span class="toc-number">10.2.</span> <span class="toc-text">10.2 ADS层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC"><span class="toc-number">10.3.</span> <span class="toc-text">10.3 编写脚本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">11.</span> <span class="toc-text">第11章 需求五：本周回流用户数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-DWS%E5%B1%82"><span class="toc-number">11.1.</span> <span class="toc-text">11.1 DWS层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-2-ADS%E5%B1%82"><span class="toc-number">11.2.</span> <span class="toc-text">11.2 ADS层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-3-%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC"><span class="toc-number">11.3.</span> <span class="toc-text">11.3 编写脚本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">12.</span> <span class="toc-text">第12章 需求六：流失用户数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#12-1-DWS%E5%B1%82"><span class="toc-number">12.1.</span> <span class="toc-text">12.1 DWS层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-2-ADS%E5%B1%82"><span class="toc-number">12.2.</span> <span class="toc-text">12.2 ADS层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-3-%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC"><span class="toc-number">12.3.</span> <span class="toc-text">12.3 编写脚本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">13.</span> <span class="toc-text">第13章 需求七：最近连续三周活跃用户数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#13-1-DWS%E5%B1%82"><span class="toc-number">13.1.</span> <span class="toc-text">13.1 DWS层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-2-ADS%E5%B1%82"><span class="toc-number">13.2.</span> <span class="toc-text">13.2 ADS层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-3-%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC"><span class="toc-number">13.3.</span> <span class="toc-text">13.3 编写脚本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">14.</span> <span class="toc-text">第14章 需求八：最近七天内连续三天活跃用户数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#14-1-DWS%E5%B1%82"><span class="toc-number">14.1.</span> <span class="toc-text">14.1 DWS层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-2-ADS%E5%B1%82"><span class="toc-number">14.2.</span> <span class="toc-text">14.2 ADS层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-3-%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC"><span class="toc-number">14.3.</span> <span class="toc-text">14.3 编写脚本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">15.</span> <span class="toc-text">第15章 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#15-1-%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E4%BB%93%E4%B8%9A%E5%8A%A1%E6%80%BB%E7%BB%93"><span class="toc-number">15.1.</span> <span class="toc-text">15.1 用户行为数仓业务总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-1-%E6%95%B0%E4%BB%93%E5%88%86%E5%87%A0%E5%B1%82%EF%BC%9F%E6%AF%8F%E5%B1%82%E5%81%9A%E4%BB%80%E4%B9%88%E7%9A%84%EF%BC%9F"><span class="toc-number">15.1.1.</span> <span class="toc-text">15.1.1 数仓分几层？每层做什么的？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-2-Tez%E5%BC%95%E6%93%8E%E4%BC%98%E7%82%B9%EF%BC%9F"><span class="toc-number">15.1.2.</span> <span class="toc-text">15.1.2 Tez引擎优点？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-3-%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E6%98%AF%E5%90%A6%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87UDF%E3%80%81UDTF%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BB%A5%E5%8F%8A%E7%94%A8%E4%BB%96%E4%BB%AC%E5%A4%84%E7%90%86%E4%BA%86%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">15.1.3.</span> <span class="toc-text">15.1.3 在项目中是否自定义过UDF、UDTF函数，以及用他们处理了什么问题？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-4-%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90%E7%94%A8%E6%88%B7%E6%B4%BB%E8%B7%83%EF%BC%9F"><span class="toc-number">15.1.4.</span> <span class="toc-text">15.1.4 如何分析用户活跃？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-5-%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90%E7%94%A8%E6%88%B7%E6%96%B0%E5%A2%9E%EF%BC%9F"><span class="toc-number">15.1.5.</span> <span class="toc-text">15.1.5 如何分析用户新增？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-6-%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90%E7%94%A8%E6%88%B71%E5%A4%A9%E7%95%99%E5%AD%98%EF%BC%9F"><span class="toc-number">15.1.6.</span> <span class="toc-text">15.1.6 如何分析用户1天留存？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-7-%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90%E6%B2%89%E9%BB%98%E7%94%A8%E6%88%B7%EF%BC%9F"><span class="toc-number">15.1.7.</span> <span class="toc-text">15.1.7 如何分析沉默用户？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-8-%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90%E6%9C%AC%E5%91%A8%E5%9B%9E%E6%B5%81%E7%94%A8%E6%88%B7%EF%BC%9F"><span class="toc-number">15.1.8.</span> <span class="toc-text">15.1.8 如何分析本周回流用户？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-9-%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90%E6%B5%81%E5%A4%B1%E7%94%A8%E6%88%B7%EF%BC%9F"><span class="toc-number">15.1.9.</span> <span class="toc-text">15.1.9 如何分析流失用户？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-10-%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90%E6%9C%80%E8%BF%91%E8%BF%9E%E7%BB%AD3%E5%91%A8%E6%B4%BB%E8%B7%83%E7%94%A8%E6%88%B7%E6%95%B0%EF%BC%9F"><span class="toc-number">15.1.10.</span> <span class="toc-text">15.1.10 如何分析最近连续3周活跃用户数？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-11-%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90%E6%9C%80%E8%BF%91%E4%B8%83%E5%A4%A9%E5%86%85%E8%BF%9E%E7%BB%AD%E4%B8%89%E5%A4%A9%E6%B4%BB%E8%B7%83%E7%94%A8%E6%88%B7%E6%95%B0%EF%BC%9F"><span class="toc-number">15.1.11.</span> <span class="toc-text">15.1.11 如何分析最近七天内连续三天活跃用户数？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-12-%E6%95%B4%E4%B8%AA%E6%96%87%E6%A1%A3%E4%B8%AD%E6%B6%89%E5%8F%8A%E7%9A%84%E6%89%80%E6%9C%89%E5%B1%82%E7%BA%A7%E5%8F%8A%E8%A1%A8"><span class="toc-number">15.1.12.</span> <span class="toc-text">15.1.12 整个文档中涉及的所有层级及表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-2-Hive%E6%80%BB%E7%BB%93"><span class="toc-number">15.2.</span> <span class="toc-text">15.2 Hive总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-1-Hive%E7%9A%84%E6%9E%B6%E6%9E%84"><span class="toc-number">15.2.1.</span> <span class="toc-text">15.2.1 Hive的架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-2-Hive%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E6%AF%94%E8%BE%83"><span class="toc-number">15.2.2.</span> <span class="toc-text">15.2.2 Hive和数据库比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-3-%E5%86%85%E9%83%A8%E8%A1%A8%E5%92%8C%E5%A4%96%E9%83%A8%E8%A1%A8"><span class="toc-number">15.2.3.</span> <span class="toc-text">15.2.3 内部表和外部表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-4-4%E4%B8%AABy%E5%8C%BA%E5%88%AB"><span class="toc-number">15.2.4.</span> <span class="toc-text">15.2.4 4个By区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2%E2%80%A65-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="toc-number">15.2.5.</span> <span class="toc-text">15.2…5 窗口函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-6-%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E6%98%AF%E5%90%A6%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87UDF%E3%80%81UDTF%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BB%A5%E5%8F%8A%E7%94%A8%E4%BB%96%E4%BB%AC%E5%A4%84%E7%90%86%E4%BA%86%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">15.2.6.</span> <span class="toc-text">15.2.6 在项目中是否自定义过UDF、UDTF函数，以及用他们处理了什么问题？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-7-Hive%E4%BC%98%E5%8C%96"><span class="toc-number">15.2.7.</span> <span class="toc-text">,15.2.7 Hive优化</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="momo"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="我的笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">2用户行为数据仓库</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2020-12-12 00:00:00" itemprop="dateCreated datePublished" datetime="2020-12-12T00:00:00+08:00">2020-12-12</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-07-11 16:54:53" itemprop="dateModified" datetime="2021-07-11T16:54:53+08:00">2021-07-11</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">大数据</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">电商数仓</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">大数据</span></a><a class="tag-item" href="/tags/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">电商数仓</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h1>第1章 数仓分层概念</h1>
<h2 id="1-1-为什么要分层"><a class="header-anchor" href="#1-1-为什么要分层">¶</a>1.1 为什么要分层</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85GHOS.png" class="" title="85GHOS.png" loading="lazy">
<p>ODS(Operation Data Store) 原始数据层   ：原始数据层，存放原始数据，直接加载原始日志、数据，数据保持原貌不做处理。</p>
<p>DWD(data warehouse detail)明细数据层：结构和粒度与原始表保持一致，对ODS层数据进行清晰（去除空值，脏数据，超过极限范围的数据）</p>
<p>DWS(data warehouse service)服务数据层：进行轻度汇总。</p>
<p>ADS(Application Data Store) 数据应用层：为各种统计报表提供数据</p>
<h2 id="1-2-数仓分层"><a class="header-anchor" href="#1-2-数仓分层">¶</a>1.2 数仓分层</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85dwn0.png" class="" title="85dwn0.png" loading="lazy">
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85sQns.png" class="" title="85sQns.png" loading="lazy">
<h6 id="font-color-blue-下面是文字版-font"><a class="header-anchor" href="#font-color-blue-下面是文字版-font">¶</a><font color='blue'>下面是文字版</font></h6>
<p>1）ODS层（原始数据层）</p>
<p>原始数据层，<font color=red>存放原始数据</font>，直接加载原始日志、数据，数据保持原貌不做处理。</p>
<p><code>/origin_data/gmall/log/topic_start/    </code></p>
<p>表： <code>ods_start_log</code></p>
<p><code>/origin_data/gmall/log/topic_event/</code></p>
<p>表：<code>ods_event_log</code></p>
<p>2)DWD层（明细数据层）</p>
<p>结构和粒度与原始表保持一致，对ODS层数据进行清洗(去除空值，脏数据，超过极限范围的数据)，也有公司叫DWI。</p>
<p>基本明细解析:  <code>ods_start_log</code>                      <code>ods_event_log</code></p>
<p>具体表:  <code>dwd_start_log</code></p>
<p><code>dwd_base_event_log     dwd_display_log        	   dwd_active_forgground_log     dwd_newsdetail_log     	dwd_active_background_log     dwd_loading_log    	       dwd_comment_log     dwd_error_log     dwd_ad_log        		dwd_praise_log     dwd_notification_log      dwd_favorites_log </code></p>
<p>3）DWS层（服务数据层）</p>
<p>以DWD为基础，进行轻度汇总。一般聚集到以用户当日，设备当日，商家当日，商品当日等等的粒度。</p>
<p>在这层通常会有以某个一个维度为线索，组成跨主题的宽度，比如，一个用户的当日的签到数、收藏数、评论数、抽奖数、订阅数、点赞数、浏览商品数、添加购物车数、下单数、支付数、退款数、点击广告数组成的多个列表。</p>
<p>dwd_start_log   启动日志表</p>
<p>dwd_display_log  商品点击表</p>
<p>dwd_active_foreground_log 用户前台活跃表</p>
<p>dwd_error_log  错误日志表</p>
<p>dwd_praise_log  点赞表</p>
<p>dwd_comment_log 评论表</p>
<p>dwd_ad_log 广告表</p>
<p>dwd_newsdetail_log  商品详情页表</p>
<p>dwd_active_background_log    用户后台活跃表</p>
<p>dwd_favorites_log   收藏表</p>
<p>dwd_notification_log   消息通知表</p>
<p>dwd_loading_log   商品列表页表</p>
<p><font color='red'> dws_uv_detail_day 每日活跃设备明细</font></p>
<p><font color='red'> dws_uv_detail_wk  每周活跃设备明细</font></p>
<p><font color='red'> dws_uv_detail_mn  每月活跃设备明细</font></p>
<p><font color='red'> dws_new_mid_day  每日新增设备明细表</font></p>
<p><font color='red'> dws_user_retention_day  每日留存用户明细表  </font></p>
<p>4)ADS层（数据应用层）</p>
<p>ADS层，为各种统计报表提供数据，也有公司或书把这层命名为APP层、DM层等。</p>
<p><font color='red'> dws_uv_detail_day 每日活跃设备明细</font></p>
<p><font color='red'> dws_uv_detail_wk  每周活跃设备明细</font></p>
<p><font color='red'> dws_uv_detail_mn  每月活跃设备明细</font></p>
<p><font color='red'> dws_new_mid_day  每日新增设备明细表</font></p>
<p><font color='red'> dws_user_retention_day  每日留存用户明细表 </font></p>
<p><font color='blue'>ads_uv_count 日、周、月设备活跃</font></p>
<p><font color='blue'>ads_new_mid_count  日新增设备</font></p>
<p><font color='blue'>ads_user_retention_day_count  日留存用户数</font></p>
<p><font color='blue'>ads_user_retention_day_rate  用户留存率</font></p>
<h2 id="1-3-数据集市与数据仓库概念"><a class="header-anchor" href="#1-3-数据集市与数据仓库概念">¶</a>1.3 数据集市与数据仓库概念</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85rHX9.png" class="" title="85rHX9.png" loading="lazy">
<h2 id="1-4-数仓命名规范"><a class="header-anchor" href="#1-4-数仓命名规范">¶</a>1.4 数仓命名规范</h2>
<ul>
<li>
<p>ODS层命名为ods</p>
</li>
<li>
<p>DWD层命名为dwd</p>
</li>
<li>
<p>DWS层命名为dws</p>
</li>
<li>
<p>ADS层命名为ads</p>
</li>
<li>
<p>临时表数据库命名为xxx_tmp</p>
</li>
<li>
<p>备份数据数据库命名为xxx_bak</p>
</li>
</ul>
<h1>第2章 数仓搭建环境准备</h1>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/856Pot.png" class="" title="856Pot.png" loading="lazy">
<p>集群规划</p>
<hr>
<p>​</p>
<p>​</p>
<table>
<thead>
<tr>
<th>服务器hadoop102</th>
<th>服务器hadoop103</th>
<th>服务器hadoop104</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hive</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MySQL</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>​</p>
<h2 id="2-1-Hive-MySQL安装"><a class="header-anchor" href="#2-1-Hive-MySQL安装">¶</a>2.1 Hive&amp;MySQL安装</h2>
<h3 id="2-1-1-Hive-MySQL安装"><a class="header-anchor" href="#2-1-1-Hive-MySQL安装">¶</a>2.1.1 Hive&amp;MySQL安装</h3>
<p>详见：尚硅谷大数据技术之Hive</p>
<p><a href="./%E5%B0%9A%E7%A1%85%E8%B0%B7%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E4%B9%8BHive.md">尚硅谷大数据技术之Hive.md</a></p>
<h3 id="2-1-2-修改hive-site-xml"><a class="header-anchor" href="#2-1-2-修改hive-site-xml">¶</a>2.1.2 修改hive-site.xml</h3>
<p>1）关闭元数据检查</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 conf]$ pwd

&#x2F;opt&#x2F;module&#x2F;hive&#x2F;conf

[atguigu@hadoop102 conf]$ vim hive-site.xml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>增加如下配置：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>hive.metastore.schema.verification<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-2-Hive运行引擎Tez"><a class="header-anchor" href="#2-2-Hive运行引擎Tez">¶</a>2.2 Hive运行引擎Tez</h2>
<p>Tez是一个Hive的运行引擎，性能优于MR。为什么优于MR呢？看下图。</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85o5QI.png" class="" title="85o5QI.png" loading="lazy">
<p>用Hive直接编写MR程序，假设有四个有依赖关系的MR作业，上图中，绿色是Reduce<br>
Task，云状表示写屏蔽，需要将中间结果持久化写到HDFS。</p>
<p>Tez可以将多个有依赖的作业转换为一个作业，这样只需写一次HDFS，且中间节点较少，从而大大提升作业的计算性能。</p>
<h3 id="2-2-1-安装包准备"><a class="header-anchor" href="#2-2-1-安装包准备">¶</a>2.2.1 安装包准备</h3>
<p>1）下载tez的依赖包：<a target="_blank" rel="noopener" href="http://tez.apache.org">http://tez.apache.org</a></p>
<p>2）拷贝apache-tez-0.9.1-bin.tar.gz到hadoop102的/opt/module目录</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ ls
apache-tez-0.9.1-bin.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>3）解压缩apache-tez-0.9.1-bin.tar.gz</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ tar -zxvf apache-tez-0.9.1-bin.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）修改名称</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ mv apache-tez-0.9.1-bin&#x2F; tez-0.9.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="2-2-2-在Hive中配置Tez"><a class="header-anchor" href="#2-2-2-在Hive中配置Tez">¶</a>2.2.2 在Hive中配置Tez</h3>
<p>1）进入到Hive的配置目录：/opt/module/hive/conf</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 conf]$ pwd
&#x2F;opt&#x2F;module&#x2F;hive&#x2F;conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>2）在hive-env.sh文件中添加tez环境变量配置和依赖包环境变量配置</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 conf]$ vim hive-env.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>添加如下配置</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># Set HADOOP_HOME to point to a specific hadoop install directory
export HADOOP_HOME&#x3D;&#x2F;opt&#x2F;module&#x2F;hadoop-2.7.2

# Hive Configuration Directory can be controlled by:
export HIVE_CONF_DIR&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;conf

# Folder containing extra libraries required for hive compilation&#x2F;execution can be controlled by:
export TEZ_HOME&#x3D;&#x2F;opt&#x2F;module&#x2F;tez-0.9.1    #是你的tez的解压目录
export TEZ_JARS&#x3D;&quot;&quot;
for jar in &#96;ls $TEZ_HOME |grep jar&#96;; do
    export TEZ_JARS&#x3D;$TEZ_JARS:$TEZ_HOME&#x2F;$jar
done
for jar in &#96;ls $TEZ_HOME&#x2F;lib&#96;; do
    export TEZ_JARS&#x3D;$TEZ_JARS:$TEZ_HOME&#x2F;lib&#x2F;$jar
done

export HIVE_AUX_JARS_PATH&#x3D;&#x2F;opt&#x2F;module&#x2F;hadoop-2.7.2&#x2F;share&#x2F;hadoop&#x2F;common&#x2F;hadoop-lzo-0.4.20.jar$TEZ_JARS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）在hive-site.xml文件中添加如下配置，更改hive计算引擎</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>hive.execution.engine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>tez<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-2-3-配置Tez"><a class="header-anchor" href="#2-2-3-配置Tez">¶</a>2.2.3 配置Tez</h3>
<p>1）在Hive的/opt/module/hive/conf下面创建一个tez-site.xml文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 conf]$ pwd
&#x2F;opt&#x2F;module&#x2F;hive&#x2F;conf
[atguigu@hadoop102 conf]$ vim tez-site.xml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>添加如下内容</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token prolog">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>tez.lib.uris<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>   
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>$&#123;fs.defaultFS&#125;/tez/tez-0.9.1,$&#123;fs.defaultFS&#125;/tez/tez-0.9.1/lib<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>tez.lib.uris.classpath<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>    	
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>$&#123;fs.defaultFS&#125;/tez/tez-0.9.1,$&#123;fs.defaultFS&#125;/tez/tez-0.9.1/lib<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>tez.use.cluster.hadoop-libs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>tez.history.logging.service.class<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>org.apache.tez.dag.history.logging.ats.ATSHistoryLoggingService<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-2-4-上传Tez到集群"><a class="header-anchor" href="#2-2-4-上传Tez到集群">¶</a>2.2.4 上传Tez到集群</h3>
<p>1）将/opt/module/tez-0.9.1上传到HDFS的/tez路径</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 conf]$ hadoop fs -mkdir &#x2F;tez
[atguigu@hadoop102 conf]$ hadoop fs -put &#x2F;opt&#x2F;module&#x2F;tez-0.9.1&#x2F; &#x2F;tez
[atguigu@hadoop102 conf]$ hadoop fs -ls &#x2F;tez
&#x2F;tez&#x2F;tez-0.9.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-2-5-测试"><a class="header-anchor" href="#2-2-5-测试">¶</a>2.2.5 测试</h3>
<p>1）启动Hive</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 hive]$ bin&#x2F;hive<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>2）创建LZO表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> student<span class="token punctuation">(</span>
id <span class="token keyword">int</span><span class="token punctuation">,</span>
name string<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>3）向表中插入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）如果没有报错就表示成功了</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span>
<span class="token number">1</span>       zhangsan<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="2-2-6-小结"><a class="header-anchor" href="#2-2-6-小结">¶</a>2.2.6 小结</h3>
<p>1）运行Tez时检查到用过多内存而被NodeManager杀死进程问题：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Caused by: org.apache.tez.dag.api.SessionNotRunning: TezSession has already shutdown. Application application_1546781144082_0005 failed 2 times due to AM Container for appattempt_1546781144082_0005_000002 exited with  exitCode: -103
For more detailed output, check application tracking page:http:&#x2F;&#x2F;hadoop103:8088&#x2F;cluster&#x2F;app&#x2F;application_1546781144082_0005Then, click on links to logs of each attempt.
Diagnostics: Container [pid&#x3D;11116,containerID&#x3D;container_1546781144082_0005_02_000001] is running beyond virtual memory limits. Current usage: 216.3 MB of 1 GB physical memory used; 2.6 GB of 2.1 GB virtual memory used. Killing container.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这种问题是从机上运行的Container试图使用过多的内存，而被NodeManager<br>
kill掉了。</p>
<pre class="line-numbers language-none"><code class="language-none">[摘录] The NodeManager is killing your container. It sounds like you are trying to use hadoop streaming which is running as a child process of the map-reduce task. The NodeManager monitors the entire process tree of the task and if it eats up more memory than the maximum set in mapreduce.map.memory.mb or mapreduce.reduce.memory.mb respectively, we would expect the Nodemanager to kill the task, otherwise your task is stealing memory belonging to other containers, which you don&#39;t want.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>解决方法：</strong></p>
<p>方案一：或者是关掉虚拟内存检查。我们选这个，修改yarn-site.xml，修改后一定要分发，并重新启动hadoop集群。</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.nodemanager.vmem-check-enabled<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>方案二：mapred-site.xml中设置Map和Reduce任务的内存配置如下：(value中实际配置的内存需要根据自己机器内存大小及应用情况进行修改)</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>mapreduce.map.memory.mb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>1536<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>mapreduce.map.java.opts<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>-Xmx1024M<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>mapreduce.reduce.memory.mb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>3072<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>mapreduce.reduce.java.opts<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>-Xmx2560M<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-3-项目经验之元数据备份"><a class="header-anchor" href="#2-3-项目经验之元数据备份">¶</a>2.3 项目经验之元数据备份</h2>
<p>元数据备份（重点，如数据损坏，可能整个集群无法运行，至少要保证每日零点之后备份到其它服务器两个复本）</p>
<h1>第3章 数仓搭建之ODS层</h1>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/856Pot-1607767778299.png" class="" title="856Pot.png" loading="lazy">
<h2 id="3-1-创建数据库"><a class="header-anchor" href="#3-1-创建数据库">¶</a>3.1 创建数据库</h2>
<p>1）创建gmall数据库</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> gmall<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>说明：如果数据库存在且有数据，需要强制删除时执行：drop database gmall<br>
cascade;</p>
<p>2）使用gmall数据库</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">use</span> gmall<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="3-2-ODS层"><a class="header-anchor" href="#3-2-ODS层">¶</a>3.2 ODS层</h2>
<p>原始数据层，存放原始数据，直接加载原始日志、数据，数据保持原貌不做处理。</p>
<h3 id="3-2-1-创建启动日志表ods-start-log"><a class="header-anchor" href="#3-2-1-创建启动日志表ods-start-log">¶</a>3.2.1 创建启动日志表ods_start_log</h3>
<p><font color='red'>ODS层创建启动日志表分析</font></p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85ba0x.png" class="" title="85ba0x.png" loading="lazy">
<p>1）创建输入数据是lzo输出是text，支持json解析的分区表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ods_start_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_start_log <span class="token punctuation">(</span><span class="token punctuation">`</span>line<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_start_log'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明Hive的LZO压缩：<a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+LZO">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+LZO</a></p>
<p>2）加载数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">load</span> <span class="token keyword">data</span> inpath <span class="token string">'/origin_data/gmall/log/topic_start/2020-03-23'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> gmall<span class="token punctuation">.</span>ods_start_log <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>注意：时间格式都配置成YYYY-MM-DD格式，这是Hive默认支持的时间格式</p>
<p>3）查看是否加载成功</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ods_start_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="3-2-2-创建事件日志表ods-event-log"><a class="header-anchor" href="#3-2-2-创建事件日志表ods-event-log">¶</a>3.2.2 创建事件日志表ods_event_log</h3>
<p>ODS层创建事件日志表分析</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/85qcPU.png" class="" title="85qcPU.png" loading="lazy">
<p>1）创建输入数据是lzo输出是text，支持json解析的分区表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ods_event_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_event_log<span class="token punctuation">(</span><span class="token punctuation">`</span>line<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_event_log'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）加载数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">load</span> <span class="token keyword">data</span> inpath <span class="token string">'/origin_data/gmall/log/topic_event/2020-03-23'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> gmall<span class="token punctuation">.</span>ods_event_log <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>注意：时间格式都配置成YYYY-MM-DD格式，这是Hive默认支持的时间格式</p>
<p>3）查看是否加载成功</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ods_event_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="3-2-3-Shell中单引号和双引号区别"><a class="header-anchor" href="#3-2-3-Shell中单引号和双引号区别">¶</a>3.2.3 Shell中单引号和双引号区别</h3>
<p>1）在/home/atguigu/bin创建一个test.sh文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim test.sh <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在文件中添加如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash
do_date&#x3D;$1

echo &#39;$do_date&#39;
echo &quot;$do_date&quot;
echo &quot;&#39;$do_date&#39;&quot;
echo &#39;&quot;$do_date&quot;&#39;
echo &#96;date&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）查看执行结果</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ test.sh 2019-02-10
$do_date
2019-02-10
&#39;2019-02-10&#39;
&quot;$do_date&quot;
2019年 05月 02日 星期四 21:02:08 CST<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）总结：</p>
<p>（1）单引号不取变量值</p>
<p>（2）双引号取变量值</p>
<p>（3）反引号`，执行引号中命令</p>
<p>（4）双引号内部嵌套单引号，取出变量值</p>
<p>（5）单引号内部嵌套双引号，不取出变量值</p>
<h3 id="3-2-4-ODS层加载数据脚本"><a class="header-anchor" href="#3-2-4-ODS层加载数据脚本">¶</a>3.2.4 ODS层加载数据脚本</h3>
<p>1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ods_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中编写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

# 定义变量方便修改
APP&#x3D;gmall
hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天
if [ -n &quot;$1&quot; ] ;then
   do_date&#x3D;$1
else 
   do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;
fi 

echo &quot;&#x3D;&#x3D;&#x3D;日志日期为 $do_date&#x3D;&#x3D;&#x3D;&quot;
sql&#x3D;&quot;
load data inpath &#39;&#x2F;origin_data&#x2F;gmall&#x2F;log&#x2F;topic_start&#x2F;$do_date&#39; into table &quot;$APP&quot;.ods_start_log partition(dt&#x3D;&#39;$do_date&#39;);

load data inpath &#39;&#x2F;origin_data&#x2F;gmall&#x2F;log&#x2F;topic_event&#x2F;$do_date&#39; into table &quot;$APP&quot;.ods_event_log partition(dt&#x3D;&#39;$do_date&#39;);
&quot;

$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明1：</p>
<p>[ -n 变量值 ] 判断变量的值，是否为空</p>
<p>– 变量的值，非空，返回true</p>
<p>– 变量的值，为空，返回false</p>
<p>说明2：</p>
<p>查看date命令的使用，</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 ~]$ date --help<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 ods_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）脚本使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ ods_log.sh 2019-02-11<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查看导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ods_start_log <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-11'</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ods_event_log <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-11'</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>5）脚本执行时间</p>
<p>企业开发中一般在每日凌晨30分~1点</p>
<h1>第4章 数仓搭建之DWD层</h1>
<p>对ODS层数据进行清洗（去除空值，脏数据，超过极限范围的数据，行式存储改为列存储，改压缩格式）。</p>
<h2 id="4-1-DWD层启动表数据解析"><a class="header-anchor" href="#4-1-DWD层启动表数据解析">¶</a>4.1 DWD层启动表数据解析</h2>
<h3 id="4-1-1-创建启动表"><a class="header-anchor" href="#4-1-1-创建启动表">¶</a>4.1.1 创建启动表</h3>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_start_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_start_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span>  
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>entry<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>open_ad_type<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>loading_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>detail<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>extend1<span class="token punctuation">`</span> string
<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
location <span class="token string">'/warehouse/gmall/dwd/dwd_start_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-1-2-向启动表导入数据"><a class="header-anchor" href="#4-1-2-向启动表导入数据">¶</a>4.1.2 向启动表导入数据</h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_start_log
<span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> 
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.mid'</span><span class="token punctuation">)</span> mid_id<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.uid'</span><span class="token punctuation">)</span> user_id<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.vc'</span><span class="token punctuation">)</span> version_code<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.vn'</span><span class="token punctuation">)</span> version_name<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.l'</span><span class="token punctuation">)</span> lang<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.sr'</span><span class="token punctuation">)</span> source<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.os'</span><span class="token punctuation">)</span> os<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.ar'</span><span class="token punctuation">)</span> area<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.md'</span><span class="token punctuation">)</span> model<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.ba'</span><span class="token punctuation">)</span> brand<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.sv'</span><span class="token punctuation">)</span> sdk_version<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.g'</span><span class="token punctuation">)</span> gmail<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.hw'</span><span class="token punctuation">)</span> height_width<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.t'</span><span class="token punctuation">)</span> app_time<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.nw'</span><span class="token punctuation">)</span> network<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.ln'</span><span class="token punctuation">)</span> lng<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.la'</span><span class="token punctuation">)</span> lat<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.entry'</span><span class="token punctuation">)</span> entry<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.open_ad_type'</span><span class="token punctuation">)</span> open_ad_type<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.action'</span><span class="token punctuation">)</span> <span class="token keyword">action</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.loading_time'</span><span class="token punctuation">)</span> loading_time<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.detail'</span><span class="token punctuation">)</span> detail<span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.extend1'</span><span class="token punctuation">)</span> extend1
<span class="token keyword">from</span> ods_start_log 
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_start_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-1-3-DWD层启动表加载数据脚本"><a class="header-anchor" href="#4-1-3-DWD层启动表加载数据脚本">¶</a>4.1.3 DWD层启动表加载数据脚本</h3>
<p>1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim dwd_start_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中编写如下内容</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#!/bin/bash</span>

<span class="token comment"># 定义变量方便修改</span>
APP<span class="token operator">=</span>gmall
hive<span class="token operator">=</span><span class="token operator">/</span>opt<span class="token operator">/</span>module<span class="token operator">/</span>hive<span class="token operator">/</span>bin<span class="token operator">/</span>hive

<span class="token comment"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$1"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>
	do_date<span class="token operator">=</span>$<span class="token number">1</span>
<span class="token keyword">else</span> 
	do_date<span class="token operator">=</span><span class="token punctuation">`</span><span class="token keyword">date</span> <span class="token operator">-</span>d <span class="token string">"-1 day"</span> <span class="token operator">+</span><span class="token operator">%</span>F<span class="token punctuation">`</span>  
fi 

<span class="token keyword">sql</span><span class="token operator">=</span><span class="token string">"
set hive.exec.dynamic.partition.mode=nonstrict;

insert overwrite table "</span>$APP<span class="token string">".dwd_start_log
PARTITION (dt='$do_date')
select 
    get_json_object(line,'$.mid') mid_id,
    get_json_object(line,'$.uid') user_id,
    get_json_object(line,'$.vc') version_code,
    get_json_object(line,'$.vn') version_name,
    get_json_object(line,'$.l') lang,
    get_json_object(line,'$.sr') source,
    get_json_object(line,'$.os') os,
    get_json_object(line,'$.ar') area,
    get_json_object(line,'$.md') model,
    get_json_object(line,'$.ba') brand,
    get_json_object(line,'$.sv') sdk_version,
    get_json_object(line,'$.g') gmail,
    get_json_object(line,'$.hw') height_width,
    get_json_object(line,'$.t') app_time,
    get_json_object(line,'$.nw') network,
    get_json_object(line,'$.ln') lng,
    get_json_object(line,'$.la') lat,
    get_json_object(line,'$.entry') entry,
    get_json_object(line,'$.open_ad_type') open_ad_type,
    get_json_object(line,'$.action') action,
    get_json_object(line,'$.loading_time') loading_time,
    get_json_object(line,'$.detail') detail,
    get_json_object(line,'$.extend1') extend1
from "</span>$APP<span class="token string">".ods_start_log 
where dt='$do_date';
"</span>

$hive <span class="token operator">-</span>e <span class="token string">"$sql"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 dwd_start_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）脚本使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ dwd_start_log.sh 2019-02-11<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查询导入结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_start_log <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-11'</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>5）脚本执行时间</p>
<p>企业开发中一般在每日凌晨30分~1点</p>
<h2 id="4-2-DWD层事件表数据解析"><a class="header-anchor" href="#4-2-DWD层事件表数据解析">¶</a>4.2 DWD层事件表数据解析</h2>
<h3 id="4-2-1-创建基础明细表"><a class="header-anchor" href="#4-2-1-创建基础明细表">¶</a>4.2.1 创建基础明细表</h3>
<p>明细表用于存储ODS层原始表转换过来的明细数据。</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/8I96mD"><img src="%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8I96mD.png" alt="8I96mD.png" loading="lazy"></a></p>
<p>1）创建事件日志基础明细表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_base_event_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_base_event_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>event_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>event_json<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>server_time<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
stored <span class="token keyword">as</span> parquet
location <span class="token string">'/warehouse/gmall/dwd/dwd_base_event_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）说明：其中event_name和event_json用来对应事件名和整个事件。这个地方将原始日志1对多的形式拆分出来了。操作的时候我们需要将原始日志展平，需要用到UDF和UDTF。</p>
<h3 id="4-2-2-自定义UDF函数（解析公共字段）"><a class="header-anchor" href="#4-2-2-自定义UDF函数（解析公共字段）">¶</a>4.2.2 自定义UDF函数（解析公共字段）</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8IioX6.png" class="" title="8IioX6.png" loading="lazy">
<p>1）创建一个maven工程：hivefunction</p>
<p>2）创建包名：com.atguigu.udf</p>
<p>3）在pom.xml文件中添加如下内容</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">></span></span>UTF8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hive.version</span><span class="token punctuation">></span></span>1.2.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hive.version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--添加hive依赖--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.hive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>hive-exec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;hive.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-assembly-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRefs</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRef</span><span class="token punctuation">></span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRef</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRefs</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>make-assembly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>single<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>4）UDF用于解析公共字段</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>udf</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>ql<span class="token punctuation">.</span>exec<span class="token punctuation">.</span></span>UDF<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaseFieldUDF</span> <span class="token keyword">extends</span> UDF <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token class-name">String</span> line<span class="token punctuation">,</span> <span class="token class-name">String</span> jsonkeysString<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        
        <span class="token comment">// 0 准备一个sb</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1 切割jsonkeys  mid uid vc vn l sr os ar md</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> jsonkeys <span class="token operator">=</span> jsonkeysString<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2 处理line   服务器时间 | json</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> logContents <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3 合法性校验</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logContents<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">2</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>logContents<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 4 开始处理json</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>logContents<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 获取cm里面的对象</span>
            <span class="token class-name">JSONObject</span> base <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"cm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 循环遍历取值</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> jsonkeys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">String</span> filedName <span class="token operator">=</span> jsonkeys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>filedName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>filedName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"et"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>logContents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSONException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">String</span> line <span class="token operator">=</span> <span class="token string">"1541217850324|&#123;\"cm\":&#123;\"mid\":\"m7856\",\"uid\":\"u8739\",\"ln\":\"-74.8\",\"sv\":\"V2.2.2\",\"os\":\"8.1.3\",\"g\":\"P7XC9126@gmail.com\",\"nw\":\"3G\",\"l\":\"es\",\"vc\":\"6\",\"hw\":\"640*960\",\"ar\":\"MX\",\"t\":\"1541204134250\",\"la\":\"-31.7\",\"md\":\"huawei-17\",\"vn\":\"1.1.2\",\"sr\":\"O\",\"ba\":\"Huawei\"&#125;,\"ap\":\"weather\",\"et\":[&#123;\"ett\":\"1541146624055\",\"en\":\"display\",\"kv\":&#123;\"goodsid\":\"n4195\",\"copyright\":\"ESPN\",\"content_provider\":\"CNN\",\"extend2\":\"5\",\"action\":\"2\",\"extend1\":\"2\",\"place\":\"3\",\"showtype\":\"2\",\"category\":\"72\",\"newstype\":\"5\"&#125;&#125;,&#123;\"ett\":\"1541213331817\",\"en\":\"loading\",\"kv\":&#123;\"extend2\":\"\",\"loading_time\":\"15\",\"action\":\"3\",\"extend1\":\"\",\"type1\":\"\",\"type\":\"3\",\"loading_way\":\"1\"&#125;&#125;,&#123;\"ett\":\"1541126195645\",\"en\":\"ad\",\"kv\":&#123;\"entry\":\"3\",\"show_style\":\"0\",\"action\":\"2\",\"detail\":\"325\",\"source\":\"4\",\"behavior\":\"2\",\"content\":\"1\",\"newstype\":\"5\"&#125;&#125;,&#123;\"ett\":\"1541202678812\",\"en\":\"notification\",\"kv\":&#123;\"ap_time\":\"1541184614380\",\"action\":\"3\",\"type\":\"4\",\"content\":\"\"&#125;&#125;,&#123;\"ett\":\"1541194686688\",\"en\":\"active_background\",\"kv\":&#123;\"active_source\":\"3\"&#125;&#125;]&#125;"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BaseFieldUDF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,nw,ln,la,t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：使用main函数主要用于模拟数据测试。</p>
<h3 id="4-2-3-自定义UDTF函数（解析具体事件字段）"><a class="header-anchor" href="#4-2-3-自定义UDTF函数（解析具体事件字段）">¶</a>4.2.3 自定义UDTF函数（解析具体事件字段）</h3>
<p>UDTF函数解析具体事件</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8Ik8Z8.png" class="" title="8Ik8Z8.png" loading="lazy">
<p>1）创建包名：com.atguigu.udtf</p>
<p>2）在com.atguigu.udtf包下创建类名：EventJsonUDTF</p>
<p>3）用于展开业务字段</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>udtf</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>ql<span class="token punctuation">.</span>exec<span class="token punctuation">.</span></span><span class="token class-name">UDFArgumentException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>ql<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span></span><span class="token class-name">HiveException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>ql<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>generic<span class="token punctuation">.</span></span><span class="token class-name">GenericUDTF</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>serde2<span class="token punctuation">.</span>objectinspector<span class="token punctuation">.</span></span><span class="token class-name">ObjectInspector</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>serde2<span class="token punctuation">.</span>objectinspector<span class="token punctuation">.</span></span><span class="token class-name">ObjectInspectorFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>serde2<span class="token punctuation">.</span>objectinspector<span class="token punctuation">.</span></span><span class="token class-name">StructObjectInspector</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>serde2<span class="token punctuation">.</span>objectinspector<span class="token punctuation">.</span>primitive<span class="token punctuation">.</span></span><span class="token class-name">PrimitiveObjectInspectorFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONArray</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONException</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventJsonUDTF</span> <span class="token keyword">extends</span> <span class="token class-name">GenericUDTF</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">//该方法中，我们将指定输出参数的名称和参数类型：</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">StructObjectInspector</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">ObjectInspector</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argOIs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UDFArgumentException</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> fieldNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ObjectInspector</span><span class="token punctuation">></span></span> fieldOIs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ObjectInspector</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        fieldNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"event_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fieldOIs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">PrimitiveObjectInspectorFactory</span><span class="token punctuation">.</span>javaStringObjectInspector<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fieldNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"event_json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fieldOIs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">PrimitiveObjectInspectorFactory</span><span class="token punctuation">.</span>javaStringObjectInspector<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">ObjectInspectorFactory</span><span class="token punctuation">.</span><span class="token function">getStandardStructObjectInspector</span><span class="token punctuation">(</span>fieldNames<span class="token punctuation">,</span> fieldOIs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//输入1条记录，输出若干条结果</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">HiveException</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 获取传入的et</span>
        <span class="token class-name">String</span> input <span class="token operator">=</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果传进来的数据为空，直接返回过滤掉该数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 获取一共有几个事件（ad/facoriters）</span>
                <span class="token class-name">JSONArray</span> ja <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONArray</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>ja <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>

                <span class="token comment">// 循环遍历每一个事件</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ja<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">// 取出每个的事件名称（ad/facoriters）</span>
                        result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ja<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"en"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// 取出每一个事件整体</span>
                        result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ja<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSONException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token comment">// 将结果返回</span>
                    <span class="token function">forward</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSONException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//当没有记录处理的时候该方法会被调用，用来清理代码或者产生额外的输出</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">HiveException</span> <span class="token punctuation">&#123;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）打包</p>
<p><img src="https://s1.ax1x.com/2020/03/22/8IF4Ug.png" alt="8IF4Ug.png" loading="lazy"></p>
<p>3）将hivefunction-1.0-SNAPSHOT上传到hadoop102的/opt/module/hive/</p>
<p>4）将jar包添加到Hive的classpath</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">add</span> jar <span class="token operator">/</span>opt<span class="token operator">/</span>module<span class="token operator">/</span>hive<span class="token operator">/</span>hivefunction<span class="token operator">-</span><span class="token number">1.0</span><span class="token operator">-</span><span class="token keyword">SNAPSHOT</span><span class="token punctuation">.</span>jar<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>5）创建临时函数与开发好的java class关联</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">create</span> <span class="token keyword">temporary</span> <span class="token keyword">function</span> base_analizer <span class="token keyword">as</span> <span class="token string">'com.atguigu.udf.BaseFieldUDF'</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">temporary</span> <span class="token keyword">function</span> flat_analizer <span class="token keyword">as</span> <span class="token string">'com.atguigu.udtf.EventJsonUDTF'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-2-4-解析事件日志基础明细表"><a class="header-anchor" href="#4-2-4-解析事件日志基础明细表">¶</a>4.2.4 解析事件日志基础明细表</h3>
<p>1）解析事件日志基础明细表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_base_event_log 
<span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
mid_id<span class="token punctuation">,</span>
user_id<span class="token punctuation">,</span>
version_code<span class="token punctuation">,</span>
version_name<span class="token punctuation">,</span>
lang<span class="token punctuation">,</span>
source<span class="token punctuation">,</span>
os<span class="token punctuation">,</span>
area<span class="token punctuation">,</span>
model<span class="token punctuation">,</span>
brand<span class="token punctuation">,</span>
sdk_version<span class="token punctuation">,</span>
gmail<span class="token punctuation">,</span>
height_width<span class="token punctuation">,</span>
app_time<span class="token punctuation">,</span>
network<span class="token punctuation">,</span>
lng<span class="token punctuation">,</span>
lat<span class="token punctuation">,</span>
event_name<span class="token punctuation">,</span>
event_json<span class="token punctuation">,</span>
server_time
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
<span class="token keyword">select</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>   <span class="token keyword">as</span> mid_id<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>   <span class="token keyword">as</span> user_id<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>   <span class="token keyword">as</span> version_code<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>   <span class="token keyword">as</span> version_name<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>   <span class="token keyword">as</span> lang<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>   <span class="token keyword">as</span> source<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>   <span class="token keyword">as</span> os<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>   <span class="token keyword">as</span> area<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>   <span class="token keyword">as</span> model<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>   <span class="token keyword">as</span> brand<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>   <span class="token keyword">as</span> sdk_version<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span>  <span class="token keyword">as</span> gmail<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span>  <span class="token keyword">as</span> height_width<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span>  <span class="token keyword">as</span> app_time<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span>  <span class="token keyword">as</span> network<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span>  <span class="token keyword">as</span> lng<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span>  <span class="token keyword">as</span> lat<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span>  <span class="token keyword">as</span> ops<span class="token punctuation">,</span>
split<span class="token punctuation">(</span>base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span>  <span class="token keyword">as</span> server_time
<span class="token keyword">from</span> ods_event_log <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span>  <span class="token operator">and</span> base_analizer<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'</span><span class="token punctuation">)</span><span class="token operator">&lt;></span><span class="token string">''</span> 
<span class="token punctuation">)</span> sdk_log lateral <span class="token keyword">view</span> flat_analizer<span class="token punctuation">(</span>ops<span class="token punctuation">)</span> tmp_k <span class="token keyword">as</span> event_name<span class="token punctuation">,</span> event_json<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_base_event_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-2-5-DWD层数据解析脚本"><a class="header-anchor" href="#4-2-5-DWD层数据解析脚本">¶</a>4.2.5 DWD层数据解析脚本</h3>
<p>1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim dwd_base_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中编写如下内容</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#!/bin/bash</span>

<span class="token comment"># 定义变量方便修改</span>
APP<span class="token operator">=</span>gmall
hive<span class="token operator">=</span><span class="token operator">/</span>opt<span class="token operator">/</span>module<span class="token operator">/</span>hive<span class="token operator">/</span>bin<span class="token operator">/</span>hive

<span class="token comment"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$1"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>
	do_date<span class="token operator">=</span>$<span class="token number">1</span>
<span class="token keyword">else</span> 
	do_date<span class="token operator">=</span><span class="token punctuation">`</span><span class="token keyword">date</span> <span class="token operator">-</span>d <span class="token string">"-1 day"</span> <span class="token operator">+</span><span class="token operator">%</span>F<span class="token punctuation">`</span>  
fi 

<span class="token keyword">sql</span><span class="token operator">=</span><span class="token string">"
	add jar /opt/module/hive/hivefunction-1.0-SNAPSHOT.jar;

	create temporary function base_analizer as 'com.atguigu.udf.BaseFieldUDF';
	create temporary function flat_analizer as 'com.atguigu.udtf.EventJsonUDTF';

 	set hive.exec.dynamic.partition.mode=nonstrict;

	insert overwrite table "</span>$APP<span class="token string">".dwd_base_event_log 
	PARTITION (dt='$do_date')
	select
	mid_id,
	user_id,
	version_code,
	version_name,
	lang,
	source ,
	os ,
	area ,
	model ,
	brand ,
	sdk_version ,
	gmail ,
	height_width ,
	network ,
	lng ,
	lat ,
	app_time ,
	event_name , 
	event_json , 
	server_time  
	from
	(
	select
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[0]   as mid_id,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[1]   as user_id,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[2]   as version_code,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[3]   as version_name,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[4]   as lang,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[5]   as source,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[6]   as os,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[7]   as area,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[8]   as model,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[9]   as brand,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[10]   as sdk_version,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[11]  as gmail,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[12]  as height_width,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[13]  as app_time,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[14]  as network,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[15]  as lng,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[16]  as lat,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[17]  as ops,
	split(base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la'),'\t')[18]  as server_time
	from "</span>$APP<span class="token string">".ods_event_log where dt='$do_date'  and base_analizer(line,'mid,uid,vc,vn,l,sr,os,ar,md,ba,sv,g,hw,t,nw,ln,la')&lt;>'' 
	) sdk_log lateral view flat_analizer(ops) tmp_k as event_name, event_json;
"</span>

$hive <span class="token operator">-</span>e <span class="token string">"$sql"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 dwd_base_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）脚本使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ dwd_base_log.sh 2019-02-11<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查询导入结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_base_event_log <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-11'</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>5）脚本执行时间</p>
<p>企业开发中一般在每日凌晨30分~1点</p>
<h2 id="4-3-DWD层事件表获取"><a class="header-anchor" href="#4-3-DWD层事件表获取">¶</a>4.3 DWD层事件表获取</h2>
<h3 id="4-3-1-商品点击表"><a class="header-anchor" href="#4-3-1-商品点击表">¶</a>4.3.1 商品点击表</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8IrPN6.png" class="" title="8IrPN6.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_display_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_display_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>goodsid<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>place<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>extend1<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>category<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>server_time<span class="token punctuation">`</span> string
<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
location <span class="token string">'/warehouse/gmall/dwd/dwd_display_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_display_log
<span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> 
mid_id<span class="token punctuation">,</span>
user_id<span class="token punctuation">,</span>
version_code<span class="token punctuation">,</span>
version_name<span class="token punctuation">,</span>
lang<span class="token punctuation">,</span>
source<span class="token punctuation">,</span>
os<span class="token punctuation">,</span>
area<span class="token punctuation">,</span>
model<span class="token punctuation">,</span>
brand<span class="token punctuation">,</span>
sdk_version<span class="token punctuation">,</span>
gmail<span class="token punctuation">,</span>
height_width<span class="token punctuation">,</span>
app_time<span class="token punctuation">,</span>
network<span class="token punctuation">,</span>
lng<span class="token punctuation">,</span>
lat<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.action'</span><span class="token punctuation">)</span> <span class="token keyword">action</span><span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.goodsid'</span><span class="token punctuation">)</span> goodsid<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.place'</span><span class="token punctuation">)</span> place<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.extend1'</span><span class="token punctuation">)</span> extend1<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.category'</span><span class="token punctuation">)</span> category<span class="token punctuation">,</span>
server_time
<span class="token keyword">from</span> dwd_base_event_log 
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span> <span class="token operator">and</span> event_name<span class="token operator">=</span><span class="token string">'display'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_display_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-3-2-商品详情页表"><a class="header-anchor" href="#4-3-2-商品详情页表">¶</a>4.3.2 商品详情页表</h3>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_newsdetail_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_newsdetail_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>  
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>entry<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>goodsid<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>showtype<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>news_staytime<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>loading_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>type1<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>category<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>server_time<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
location <span class="token string">'/warehouse/gmall/dwd/dwd_newsdetail_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_newsdetail_log
<span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> 
mid_id<span class="token punctuation">,</span>
user_id<span class="token punctuation">,</span>
version_code<span class="token punctuation">,</span>
version_name<span class="token punctuation">,</span>
lang<span class="token punctuation">,</span>
source<span class="token punctuation">,</span>
os<span class="token punctuation">,</span>
area<span class="token punctuation">,</span>
model<span class="token punctuation">,</span>
brand<span class="token punctuation">,</span>
sdk_version<span class="token punctuation">,</span>
gmail<span class="token punctuation">,</span>
height_width<span class="token punctuation">,</span>
app_time<span class="token punctuation">,</span>
network<span class="token punctuation">,</span>
lng<span class="token punctuation">,</span>
lat<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.entry'</span><span class="token punctuation">)</span> entry<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.action'</span><span class="token punctuation">)</span> <span class="token keyword">action</span><span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.goodsid'</span><span class="token punctuation">)</span> goodsid<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.showtype'</span><span class="token punctuation">)</span> showtype<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.news_staytime'</span><span class="token punctuation">)</span> news_staytime<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.loading_time'</span><span class="token punctuation">)</span> loading_time<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.type1'</span><span class="token punctuation">)</span> type1<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.category'</span><span class="token punctuation">)</span> category<span class="token punctuation">,</span>
server_time
<span class="token keyword">from</span> dwd_base_event_log
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span> <span class="token operator">and</span> event_name<span class="token operator">=</span><span class="token string">'newsdetail'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_newsdetail_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-3-3-商品列表页表"><a class="header-anchor" href="#4-3-3-商品列表页表">¶</a>4.3.3 商品列表页表</h3>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_loading_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_loading_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span>  
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>loading_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>loading_way<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>extend1<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>extend2<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span><span class="token keyword">type</span><span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>type1<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>server_time<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
location <span class="token string">'/warehouse/gmall/dwd/dwd_loading_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_loading_log
<span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> 
mid_id<span class="token punctuation">,</span>
user_id<span class="token punctuation">,</span>
version_code<span class="token punctuation">,</span>
version_name<span class="token punctuation">,</span>
lang<span class="token punctuation">,</span>
source<span class="token punctuation">,</span>
os<span class="token punctuation">,</span>
area<span class="token punctuation">,</span>
model<span class="token punctuation">,</span>
brand<span class="token punctuation">,</span>
sdk_version<span class="token punctuation">,</span>
gmail<span class="token punctuation">,</span>
height_width<span class="token punctuation">,</span>
app_time<span class="token punctuation">,</span>
network<span class="token punctuation">,</span>
lng<span class="token punctuation">,</span>
lat<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.action'</span><span class="token punctuation">)</span> <span class="token keyword">action</span><span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.loading_time'</span><span class="token punctuation">)</span> loading_time<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.loading_way'</span><span class="token punctuation">)</span> loading_way<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.extend1'</span><span class="token punctuation">)</span> extend1<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.extend2'</span><span class="token punctuation">)</span> extend2<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.type'</span><span class="token punctuation">)</span> <span class="token keyword">type</span><span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.type1'</span><span class="token punctuation">)</span> type1<span class="token punctuation">,</span>
server_time
<span class="token keyword">from</span> dwd_base_event_log
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span> <span class="token operator">and</span> event_name<span class="token operator">=</span><span class="token string">'loading'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_loading_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-3-4-广告表"><a class="header-anchor" href="#4-3-4-广告表">¶</a>4.3.4 广告表</h3>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_ad_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_ad_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span>  
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>entry<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>content<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>detail<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>ad_source<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>behavior<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>newstype<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>show_style<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>server_time<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
location <span class="token string">'/warehouse/gmall/dwd/dwd_ad_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_ad_log
<span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> 
mid_id<span class="token punctuation">,</span>
user_id<span class="token punctuation">,</span>
version_code<span class="token punctuation">,</span>
version_name<span class="token punctuation">,</span>
lang<span class="token punctuation">,</span>
source<span class="token punctuation">,</span>
os<span class="token punctuation">,</span>
area<span class="token punctuation">,</span>
model<span class="token punctuation">,</span>
brand<span class="token punctuation">,</span>
sdk_version<span class="token punctuation">,</span>
gmail<span class="token punctuation">,</span>
height_width<span class="token punctuation">,</span>
app_time<span class="token punctuation">,</span>
network<span class="token punctuation">,</span>
lng<span class="token punctuation">,</span>
lat<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.entry'</span><span class="token punctuation">)</span> entry<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.action'</span><span class="token punctuation">)</span> <span class="token keyword">action</span><span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.content'</span><span class="token punctuation">)</span> content<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.detail'</span><span class="token punctuation">)</span> detail<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.source'</span><span class="token punctuation">)</span> ad_source<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.behavior'</span><span class="token punctuation">)</span> behavior<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.newstype'</span><span class="token punctuation">)</span> newstype<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.show_style'</span><span class="token punctuation">)</span> show_style<span class="token punctuation">,</span>
server_time
<span class="token keyword">from</span> dwd_base_event_log 
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span> <span class="token operator">and</span> event_name<span class="token operator">=</span><span class="token string">'ad'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_ad_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-3-5-消息通知表"><a class="header-anchor" href="#4-3-5-消息通知表">¶</a>4.3.5 消息通知表</h3>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_notification_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_notification_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span>  
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>noti_type<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>ap_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>content<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>server_time<span class="token punctuation">`</span> string
<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
location <span class="token string">'/warehouse/gmall/dwd/dwd_notification_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt; 
set hive.exec.dynamic.partition.mode&#x3D;nonstrict;

insert overwrite table dwd_notification_log
PARTITION (dt&#x3D;&#39;2019-02-10&#39;)
select 
mid_id,
user_id,
version_code,
version_name,
lang,
source,
os,
area,
model,
brand,
sdk_version,
gmail,
height_width,
app_time,
network,
lng,
lat,
get_json_object(event_json,&#39;$.kv.action&#39;) action,
get_json_object(event_json,&#39;$.kv.noti_type&#39;) noti_type,
get_json_object(event_json,&#39;$.kv.ap_time&#39;) ap_time,
get_json_object(event_json,&#39;$.kv.content&#39;) content,
server_time
from dwd_base_event_log
where dt&#x3D;&#39;2019-02-10&#39; and event_name&#x3D;&#39;notification&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_notification_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-3-6-用户前台活跃表"><a class="header-anchor" href="#4-3-6-用户前台活跃表">¶</a>4.3.6 用户前台活跃表</h3>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_active_foreground_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_active_foreground_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>push_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>access<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>server_time<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
location <span class="token string">'/warehouse/gmall/dwd/dwd_foreground_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_active_foreground_log
<span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> 
mid_id<span class="token punctuation">,</span>
user_id<span class="token punctuation">,</span>
version_code<span class="token punctuation">,</span>
version_name<span class="token punctuation">,</span>
lang<span class="token punctuation">,</span>
source<span class="token punctuation">,</span>
os<span class="token punctuation">,</span>
area<span class="token punctuation">,</span>
model<span class="token punctuation">,</span>
brand<span class="token punctuation">,</span>
sdk_version<span class="token punctuation">,</span>
gmail<span class="token punctuation">,</span>
height_width<span class="token punctuation">,</span>
app_time<span class="token punctuation">,</span>
network<span class="token punctuation">,</span>
lng<span class="token punctuation">,</span>
lat<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.push_id'</span><span class="token punctuation">)</span> push_id<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.access'</span><span class="token punctuation">)</span> access<span class="token punctuation">,</span>
server_time
<span class="token keyword">from</span> dwd_base_event_log
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span> <span class="token operator">and</span> event_name<span class="token operator">=</span><span class="token string">'active_foreground'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_active_foreground_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-3-7-用户后台活跃表"><a class="header-anchor" href="#4-3-7-用户后台活跃表">¶</a>4.3.7 用户后台活跃表</h3>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_active_background_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_active_background_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
 <span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>active_source<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>server_time<span class="token punctuation">`</span> string
<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
location <span class="token string">'/warehouse/gmall/dwd/dwd_background_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_active_background_log
<span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> 
mid_id<span class="token punctuation">,</span>
user_id<span class="token punctuation">,</span>
version_code<span class="token punctuation">,</span>
version_name<span class="token punctuation">,</span>
lang<span class="token punctuation">,</span>
source<span class="token punctuation">,</span>
os<span class="token punctuation">,</span>
area<span class="token punctuation">,</span>
model<span class="token punctuation">,</span>
brand<span class="token punctuation">,</span>
sdk_version<span class="token punctuation">,</span>
gmail<span class="token punctuation">,</span>
height_width<span class="token punctuation">,</span>
app_time<span class="token punctuation">,</span>
network<span class="token punctuation">,</span>
lng<span class="token punctuation">,</span>
lat<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.active_source'</span><span class="token punctuation">)</span> active_source<span class="token punctuation">,</span>
server_time
<span class="token keyword">from</span> dwd_base_event_log
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span> <span class="token operator">and</span> event_name<span class="token operator">=</span><span class="token string">'active_background'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_active_background_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-3-8-评论表"><a class="header-anchor" href="#4-3-8-评论表">¶</a>4.3.8 评论表</h3>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_comment_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_comment_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>comment_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>userid<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>p_comment_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>content<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>addtime<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>other_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>praise_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>reply_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>server_time<span class="token punctuation">`</span> string
<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
location <span class="token string">'/warehouse/gmall/dwd/dwd_comment_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_comment_log
<span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> 
mid_id<span class="token punctuation">,</span>
user_id<span class="token punctuation">,</span>
version_code<span class="token punctuation">,</span>
version_name<span class="token punctuation">,</span>
lang<span class="token punctuation">,</span>
source<span class="token punctuation">,</span>
os<span class="token punctuation">,</span>
area<span class="token punctuation">,</span>
model<span class="token punctuation">,</span>
brand<span class="token punctuation">,</span>
sdk_version<span class="token punctuation">,</span>
gmail<span class="token punctuation">,</span>
height_width<span class="token punctuation">,</span>
app_time<span class="token punctuation">,</span>
network<span class="token punctuation">,</span>
lng<span class="token punctuation">,</span>
lat<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.comment_id'</span><span class="token punctuation">)</span> comment_id<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.userid'</span><span class="token punctuation">)</span> userid<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.p_comment_id'</span><span class="token punctuation">)</span> p_comment_id<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.content'</span><span class="token punctuation">)</span> content<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.addtime'</span><span class="token punctuation">)</span> addtime<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.other_id'</span><span class="token punctuation">)</span> other_id<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.praise_count'</span><span class="token punctuation">)</span> praise_count<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.reply_count'</span><span class="token punctuation">)</span> reply_count<span class="token punctuation">,</span>
server_time
<span class="token keyword">from</span> dwd_base_event_log
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span> <span class="token operator">and</span> event_name<span class="token operator">=</span><span class="token string">'comment'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_comment_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-3-9-收藏表"><a class="header-anchor" href="#4-3-9-收藏表">¶</a>4.3.9 收藏表</h3>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_favorites_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_favorites_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span>  
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>course_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>userid<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>add_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>server_time<span class="token punctuation">`</span> string
<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
location <span class="token string">'/warehouse/gmall/dwd/dwd_favorites_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_favorites_log
<span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> 
mid_id<span class="token punctuation">,</span>
user_id<span class="token punctuation">,</span>
version_code<span class="token punctuation">,</span>
version_name<span class="token punctuation">,</span>
lang<span class="token punctuation">,</span>
source<span class="token punctuation">,</span>
os<span class="token punctuation">,</span>
area<span class="token punctuation">,</span>
model<span class="token punctuation">,</span>
brand<span class="token punctuation">,</span>
sdk_version<span class="token punctuation">,</span>
gmail<span class="token punctuation">,</span>
height_width<span class="token punctuation">,</span>
app_time<span class="token punctuation">,</span>
network<span class="token punctuation">,</span>
lng<span class="token punctuation">,</span>
lat<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.id'</span><span class="token punctuation">)</span> id<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.course_id'</span><span class="token punctuation">)</span> course_id<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.userid'</span><span class="token punctuation">)</span> userid<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.add_time'</span><span class="token punctuation">)</span> add_time<span class="token punctuation">,</span>
server_time
<span class="token keyword">from</span> dwd_base_event_log 
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span> <span class="token operator">and</span> event_name<span class="token operator">=</span><span class="token string">'favorites'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_favorites_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-3-10-点赞表"><a class="header-anchor" href="#4-3-10-点赞表">¶</a>4.3.10 点赞表</h3>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_praise_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_praise_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span>  
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>id<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>userid<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>target_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span><span class="token keyword">type</span><span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>add_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>server_time<span class="token punctuation">`</span> string
<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
location <span class="token string">'/warehouse/gmall/dwd/dwd_praise_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_praise_log
<span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> 
mid_id<span class="token punctuation">,</span>
user_id<span class="token punctuation">,</span>
version_code<span class="token punctuation">,</span>
version_name<span class="token punctuation">,</span>
lang<span class="token punctuation">,</span>
source<span class="token punctuation">,</span>
os<span class="token punctuation">,</span>
area<span class="token punctuation">,</span>
model<span class="token punctuation">,</span>
brand<span class="token punctuation">,</span>
sdk_version<span class="token punctuation">,</span>
gmail<span class="token punctuation">,</span>
height_width<span class="token punctuation">,</span>
app_time<span class="token punctuation">,</span>
network<span class="token punctuation">,</span>
lng<span class="token punctuation">,</span>
lat<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.id'</span><span class="token punctuation">)</span> id<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.userid'</span><span class="token punctuation">)</span> userid<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.target_id'</span><span class="token punctuation">)</span> target_id<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.type'</span><span class="token punctuation">)</span> <span class="token keyword">type</span><span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.add_time'</span><span class="token punctuation">)</span> add_time<span class="token punctuation">,</span>
server_time
<span class="token keyword">from</span> dwd_base_event_log
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span> <span class="token operator">and</span> event_name<span class="token operator">=</span><span class="token string">'praise'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_praise_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-3-11-错误日志表"><a class="header-anchor" href="#4-3-11-错误日志表">¶</a>4.3.11 错误日志表</h3>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_error_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_error_log<span class="token punctuation">(</span>
<span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>source<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>os<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>area<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>model<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string<span class="token punctuation">,</span>  
<span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string<span class="token punctuation">,</span>
<span class="token punctuation">`</span>network<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>errorBrief<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>errorDetail<span class="token punctuation">`</span> string<span class="token punctuation">,</span> 
<span class="token punctuation">`</span>server_time<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
location <span class="token string">'/warehouse/gmall/dwd/dwd_error_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_error_log
<span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> 
mid_id<span class="token punctuation">,</span>
user_id<span class="token punctuation">,</span>
version_code<span class="token punctuation">,</span>
version_name<span class="token punctuation">,</span>
lang<span class="token punctuation">,</span>
source<span class="token punctuation">,</span>
os<span class="token punctuation">,</span>
area<span class="token punctuation">,</span>
model<span class="token punctuation">,</span>
brand<span class="token punctuation">,</span>
sdk_version<span class="token punctuation">,</span>
gmail<span class="token punctuation">,</span>
height_width<span class="token punctuation">,</span>
app_time<span class="token punctuation">,</span>
network<span class="token punctuation">,</span>
lng<span class="token punctuation">,</span>
lat<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.errorBrief'</span><span class="token punctuation">)</span> errorBrief<span class="token punctuation">,</span>
get_json_object<span class="token punctuation">(</span>event_json<span class="token punctuation">,</span><span class="token string">'$.kv.errorDetail'</span><span class="token punctuation">)</span> errorDetail<span class="token punctuation">,</span>
server_time
<span class="token keyword">from</span> dwd_base_event_log 
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span> <span class="token operator">and</span> event_name<span class="token operator">=</span><span class="token string">'error'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_error_log <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-3-12-DWD层事件表加载数据脚本"><a class="header-anchor" href="#4-3-12-DWD层事件表加载数据脚本">¶</a>4.3.12 DWD层事件表加载数据脚本</h3>
<p>1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span>atguigu<span class="token variable">@hadoop102</span> bin<span class="token punctuation">]</span>$ vim dwd_event_log<span class="token punctuation">.</span>sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中编写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

# 定义变量方便修改
APP&#x3D;gmall
hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天
if [ -n &quot;$1&quot; ] ;then
	do_date&#x3D;$1
else 
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;  
fi 

sql&#x3D;&quot;
set hive.exec.dynamic.partition.mode&#x3D;nonstrict;

insert overwrite table &quot;$APP&quot;.dwd_display_log
PARTITION (dt&#x3D;&#39;$do_date&#39;)
select 
	mid_id,
	user_id,
	version_code,
	version_name,
	lang,
	source,
	os,
	area,
	model,
	brand,
	sdk_version,
	gmail,
	height_width,
	app_time,
	network,
	lng,
	lat,
	get_json_object(event_json,&#39;$.kv.action&#39;) action,
	get_json_object(event_json,&#39;$.kv.goodsid&#39;) goodsid,
	get_json_object(event_json,&#39;$.kv.place&#39;) place,
	get_json_object(event_json,&#39;$.kv.extend1&#39;) extend1,
	get_json_object(event_json,&#39;$.kv.category&#39;) category,
	server_time
from &quot;$APP&quot;.dwd_base_event_log 
where dt&#x3D;&#39;$do_date&#39; and event_name&#x3D;&#39;display&#39;;


insert overwrite table &quot;$APP&quot;.dwd_newsdetail_log
PARTITION (dt&#x3D;&#39;$do_date&#39;)
select 
	mid_id,
	user_id,
	version_code,
	version_name,
	lang,
	source,
	os,
	area,
	model,
	brand,
	sdk_version,
	gmail,
	height_width,
	app_time,
	network,
	lng,
	lat,
	get_json_object(event_json,&#39;$.kv.entry&#39;) entry,
	get_json_object(event_json,&#39;$.kv.action&#39;) action,
	get_json_object(event_json,&#39;$.kv.goodsid&#39;) goodsid,
	get_json_object(event_json,&#39;$.kv.showtype&#39;) showtype,
	get_json_object(event_json,&#39;$.kv.news_staytime&#39;) news_staytime,
	get_json_object(event_json,&#39;$.kv.loading_time&#39;) loading_time,
	get_json_object(event_json,&#39;$.kv.type1&#39;) type1,
	get_json_object(event_json,&#39;$.kv.category&#39;) category,
	server_time
from &quot;$APP&quot;.dwd_base_event_log 
where dt&#x3D;&#39;$do_date&#39; and event_name&#x3D;&#39;newsdetail&#39;;


insert overwrite table &quot;$APP&quot;.dwd_loading_log
PARTITION (dt&#x3D;&#39;$do_date&#39;)
select 
	mid_id,
	user_id,
	version_code,
	version_name,
	lang,
	source,
	os,
	area,
	model,
	brand,
	sdk_version,
	gmail,
	height_width,
	app_time,
	network,
	lng,
	lat,
	get_json_object(event_json,&#39;$.kv.action&#39;) action,
	get_json_object(event_json,&#39;$.kv.loading_time&#39;) loading_time,
	get_json_object(event_json,&#39;$.kv.loading_way&#39;) loading_way,
	get_json_object(event_json,&#39;$.kv.extend1&#39;) extend1,
	get_json_object(event_json,&#39;$.kv.extend2&#39;) extend2,
	get_json_object(event_json,&#39;$.kv.type&#39;) type,
	get_json_object(event_json,&#39;$.kv.type1&#39;) type1,
	server_time
from &quot;$APP&quot;.dwd_base_event_log 
where dt&#x3D;&#39;$do_date&#39; and event_name&#x3D;&#39;loading&#39;;


insert overwrite table &quot;$APP&quot;.dwd_ad_log
PARTITION (dt&#x3D;&#39;$do_date&#39;)
select 
	mid_id,
	user_id,
	version_code,
	version_name,
	lang,
	source,
	os,
	area,
	model,
	brand,
	sdk_version,
	gmail,
	height_width,
	app_time,
	network,
	lng,
	lat,
	get_json_object(event_json,&#39;$.kv.entry&#39;) entry,
	get_json_object(event_json,&#39;$.kv.action&#39;) action,
	get_json_object(event_json,&#39;$.kv.content&#39;) content,
	get_json_object(event_json,&#39;$.kv.detail&#39;) detail,
	get_json_object(event_json,&#39;$.kv.source&#39;) ad_source,
	get_json_object(event_json,&#39;$.kv.behavior&#39;) behavior,
	get_json_object(event_json,&#39;$.kv.newstype&#39;) newstype,
	get_json_object(event_json,&#39;$.kv.show_style&#39;) show_style,
	server_time
from &quot;$APP&quot;.dwd_base_event_log 
where dt&#x3D;&#39;$do_date&#39; and event_name&#x3D;&#39;ad&#39;;


insert overwrite table &quot;$APP&quot;.dwd_notification_log
PARTITION (dt&#x3D;&#39;$do_date&#39;)
select 
	mid_id,
	user_id,
	version_code,
	version_name,
	lang,
	source,
	os,
	area,
	model,
	brand,
	sdk_version,
	gmail,
	height_width,
	app_time,
	network,
	lng,
	lat,
	get_json_object(event_json,&#39;$.kv.action&#39;) action,
	get_json_object(event_json,&#39;$.kv.noti_type&#39;) noti_type,
	get_json_object(event_json,&#39;$.kv.ap_time&#39;) ap_time,
	get_json_object(event_json,&#39;$.kv.content&#39;) content,
	server_time
from &quot;$APP&quot;.dwd_base_event_log 
where dt&#x3D;&#39;$do_date&#39; and event_name&#x3D;&#39;notification&#39;;


insert overwrite table &quot;$APP&quot;.dwd_active_foreground_log
PARTITION (dt&#x3D;&#39;$do_date&#39;)
select 
	mid_id,
	user_id,
	version_code,
	version_name,
	lang,
	source,
	os,
	area,
	model,
	brand,
	sdk_version,
	gmail,
	height_width,
	app_time,
	network,
	lng,
	lat,
get_json_object(event_json,&#39;$.kv.push_id&#39;) push_id,
get_json_object(event_json,&#39;$.kv.access&#39;) access,
	server_time
from &quot;$APP&quot;.dwd_base_event_log 
where dt&#x3D;&#39;$do_date&#39; and event_name&#x3D;&#39;active_foreground&#39;;


insert overwrite table &quot;$APP&quot;.dwd_active_background_log
PARTITION (dt&#x3D;&#39;$do_date&#39;)
select 
	mid_id,
	user_id,
	version_code,
	version_name,
	lang,
	source,
	os,
	area,
	model,
	brand,
	sdk_version,
	gmail,
	height_width,
	app_time,
	network,
	lng,
	lat,
	get_json_object(event_json,&#39;$.kv.active_source&#39;) active_source,
	server_time
from &quot;$APP&quot;.dwd_base_event_log 
where dt&#x3D;&#39;$do_date&#39; and event_name&#x3D;&#39;active_background&#39;;


insert overwrite table &quot;$APP&quot;.dwd_comment_log
PARTITION (dt&#x3D;&#39;$do_date&#39;)
select 
	mid_id,
	user_id,
	version_code,
	version_name,
	lang,
	source,
	os,
	area,
	model,
	brand,
	sdk_version,
	gmail,
	height_width,
	app_time,
	network,
	lng,
	lat,
	get_json_object(event_json,&#39;$.kv.comment_id&#39;) comment_id,
	get_json_object(event_json,&#39;$.kv.userid&#39;) userid,
	get_json_object(event_json,&#39;$.kv.p_comment_id&#39;) p_comment_id,
	get_json_object(event_json,&#39;$.kv.content&#39;) content,
	get_json_object(event_json,&#39;$.kv.addtime&#39;) addtime,
	get_json_object(event_json,&#39;$.kv.other_id&#39;) other_id,
	get_json_object(event_json,&#39;$.kv.praise_count&#39;) praise_count,
	get_json_object(event_json,&#39;$.kv.reply_count&#39;) reply_count,
	server_time
from &quot;$APP&quot;.dwd_base_event_log 
where dt&#x3D;&#39;$do_date&#39; and event_name&#x3D;&#39;comment&#39;;


insert overwrite table &quot;$APP&quot;.dwd_favorites_log
PARTITION (dt&#x3D;&#39;$do_date&#39;)
select 
	mid_id,
	user_id,
	version_code,
	version_name,
	lang,
	source,
	os,
	area,
	model,
	brand,
	sdk_version,
	gmail,
	height_width,
	app_time,
	network,
	lng,
	lat,
	get_json_object(event_json,&#39;$.kv.id&#39;) id,
	get_json_object(event_json,&#39;$.kv.course_id&#39;) course_id,
	get_json_object(event_json,&#39;$.kv.userid&#39;) userid,
	get_json_object(event_json,&#39;$.kv.add_time&#39;) add_time,
	server_time
from &quot;$APP&quot;.dwd_base_event_log 
where dt&#x3D;&#39;$do_date&#39; and event_name&#x3D;&#39;favorites&#39;;


insert overwrite table &quot;$APP&quot;.dwd_praise_log
PARTITION (dt&#x3D;&#39;$do_date&#39;)
select 
	mid_id,
	user_id,
	version_code,
	version_name,
	lang,
	source,
	os,
	area,
	model,
	brand,
	sdk_version,
	gmail,
	height_width,
	app_time,
	network,
	lng,
	lat,
	get_json_object(event_json,&#39;$.kv.id&#39;) id,
	get_json_object(event_json,&#39;$.kv.userid&#39;) userid,
	get_json_object(event_json,&#39;$.kv.target_id&#39;) target_id,
	get_json_object(event_json,&#39;$.kv.type&#39;) type,
	get_json_object(event_json,&#39;$.kv.add_time&#39;) add_time,
	server_time
from &quot;$APP&quot;.dwd_base_event_log 
where dt&#x3D;&#39;$do_date&#39; and event_name&#x3D;&#39;praise&#39;;


insert overwrite table &quot;$APP&quot;.dwd_error_log
PARTITION (dt&#x3D;&#39;$do_date&#39;)
select 
	mid_id,
	user_id,
	version_code,
	version_name,
	lang,
	source,
	os,
	area,
	model,
	brand,
	sdk_version,
	gmail,
	height_width,
	app_time,
	network,
	lng,
	lat,
	get_json_object(event_json,&#39;$.kv.errorBrief&#39;) errorBrief,
	get_json_object(event_json,&#39;$.kv.errorDetail&#39;) errorDetail,
	server_time
from &quot;$APP&quot;.dwd_base_event_log 
where dt&#x3D;&#39;$do_date&#39; and event_name&#x3D;&#39;error&#39;;
&quot;

$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span>atguigu<span class="token variable">@hadoop102</span> bin<span class="token punctuation">]</span>$ chmod <span class="token number">777</span> dwd_event_log<span class="token punctuation">.</span>sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）脚本使用</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span>atguigu<span class="token variable">@hadoop102</span> module<span class="token punctuation">]</span>$ dwd_event_log<span class="token punctuation">.</span>sh <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">11</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查询导入结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_comment_log <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-11'</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>5）脚本执行时间</p>
<p>企业开发中一般在每日凌晨30分~1点</p>
<h1>第5章 业务知识准备</h1>
<h2 id="5-1-业务术语"><a class="header-anchor" href="#5-1-业务术语">¶</a>5.1 业务术语</h2>
<ol>
<li>用户</li>
</ol>
<p>用户以设备为判断标准，在移动统计中，每个独立设备认为是一个独立用户。Android系统根据IMEI号，IOS系统根据OpenUDID来标识一个独立用户，每部手机一个用户。</p>
<ol start="2">
<li>新增用户</li>
</ol>
<p>首次联网使用应用的用户。如果一个用户首次打开某APP，那这个用户定义为新增用户；卸载再安装的设备，不会被算作一次新增。新增用户包括日新增用户、周新增用户、月新增用户。</p>
<ol start="3">
<li>活跃用户</li>
</ol>
<p>打开应用的用户即为活跃用户，不考虑用户的使用情况。每天一台设备打开多次会被计为一个活跃用户。</p>
<ol start="4">
<li>周（月）活跃用户</li>
</ol>
<p>某个自然周（月）内启动过应用的用户，该周（月）内的多次启动只记一个活跃用户。</p>
<ol start="5">
<li>月活跃率</li>
</ol>
<p>月活跃用户与截止到该月累计的用户总和之间的比例。</p>
<ol start="6">
<li>沉默用户</li>
</ol>
<p>用户仅在安装当天（次日）启动一次，后续时间无再启动行为。该指标可以反映新增用户质量和用户与APP的匹配程度。</p>
<ol start="7">
<li>版本分布</li>
</ol>
<p>不同版本的周内各天新增用户数，活跃用户数和启动次数。利于判断APP各个版本之间的优劣和用户行为习惯。</p>
<ol start="8">
<li>本周回流用户</li>
</ol>
<p>上周未启动过应用，本周启动了应用的用户。</p>
<ol start="9">
<li>连续n周活跃用户</li>
</ol>
<p>连续n周，每周至少启动一次。</p>
<ol start="10">
<li>忠诚用户</li>
</ol>
<p>连续活跃5周以上的用户</p>
<ol start="11">
<li>连续活跃用户</li>
</ol>
<p>连续2周及以上活跃的用户</p>
<ol start="12">
<li>近期流失用户</li>
</ol>
<p>连续n(2&lt;= n &lt;= 4)周没有启动应用的用户。（第n+1周没有启动过）</p>
<ol start="13">
<li>留存用户</li>
</ol>
<p>某段时间内的新增用户，经过一段时间后，仍然使用应用的被认作是留存用户；这部分用户占当时新增用户的比例即是留存率。</p>
<p>例如，5月份新增用户200，这200人在6月份启动过应用的有100人，7月份启动过应用的有80人，8月份启动过应用的有50人；则5月份新增用户一个月后的留存率是50%，二个月后的留存率是40%，三个月后的留存率是25%。</p>
<ol start="14">
<li>用户新鲜度</li>
</ol>
<p>每天启动应用的新老用户比例，即新增用户数占活跃用户数的比例。</p>
<ol start="15">
<li>单次使用时长</li>
</ol>
<p>每次启动使用的时间长度。</p>
<ol start="16">
<li>日使用时长</li>
</ol>
<p>累计一天内的使用时间长度。</p>
<ol start="17">
<li>启动次数计算标准</li>
</ol>
<p>IOS平台应用退到后台就算一次独立的启动；Android平台我们规定，两次启动之间的间隔小于30秒，被计算一次启动。用户在使用过程中，若因收发短信或接电话等退出应用30秒又再次返回应用中，那这两次行为应该是延续而非独立的，所以可以被算作一次使用行为，即一次启动。业内大多使用30秒这个标准，但用户还是可以自定义此时间间隔。</p>
<h2 id="5-2-系统函数"><a class="header-anchor" href="#5-2-系统函数">¶</a>5.2 系统函数</h2>
<h3 id="5-2-1-collect-set函数"><a class="header-anchor" href="#5-2-1-collect-set函数">¶</a>5.2.1 collect_set函数</h3>
<p>1）创建原数据表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> stud<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> stud <span class="token punctuation">(</span>name string<span class="token punctuation">,</span> area string<span class="token punctuation">,</span> course string<span class="token punctuation">,</span> score <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>2）向原数据表中插入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> stud <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'zhang3'</span><span class="token punctuation">,</span><span class="token string">'bj'</span><span class="token punctuation">,</span><span class="token string">'math'</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> stud <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'li4'</span><span class="token punctuation">,</span><span class="token string">'bj'</span><span class="token punctuation">,</span><span class="token string">'math'</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> stud <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'wang5'</span><span class="token punctuation">,</span><span class="token string">'sh'</span><span class="token punctuation">,</span><span class="token string">'chinese'</span><span class="token punctuation">,</span><span class="token number">92</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> stud <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'zhao6'</span><span class="token punctuation">,</span><span class="token string">'sh'</span><span class="token punctuation">,</span><span class="token string">'chinese'</span><span class="token punctuation">,</span><span class="token number">54</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> stud <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'tian7'</span><span class="token punctuation">,</span><span class="token string">'bj'</span><span class="token punctuation">,</span><span class="token string">'chinese'</span><span class="token punctuation">,</span><span class="token number">91</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询表中数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stud<span class="token punctuation">;</span>
stud<span class="token punctuation">.</span>name       stud<span class="token punctuation">.</span>area       stud<span class="token punctuation">.</span>course     stud<span class="token punctuation">.</span>score
zhang3 bj      math    <span class="token number">88</span>
li4     bj      math    <span class="token number">99</span>
wang5   sh      chinese <span class="token number">92</span>
zhao6   sh      chinese <span class="token number">54</span>
tian7   bj      chinese <span class="token number">91</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>4）把同一分组的不同行的数据聚合成一个集合</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> course<span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>area<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">from</span> stud <span class="token keyword">group</span> <span class="token keyword">by</span> course<span class="token punctuation">;</span>
chinese <span class="token punctuation">[</span><span class="token string">"sh"</span><span class="token punctuation">,</span><span class="token string">"bj"</span><span class="token punctuation">]</span>     <span class="token number">79.0</span>
math    <span class="token punctuation">[</span><span class="token string">"bj"</span><span class="token punctuation">]</span>  <span class="token number">93.5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>5） 用下标可以取某一个</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> course<span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>area<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">from</span> stud <span class="token keyword">group</span> <span class="token keyword">by</span> course<span class="token punctuation">;</span>
chinese sh      <span class="token number">79.0</span>
math    bj      <span class="token number">93.5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="5-2-2-日期处理函数"><a class="header-anchor" href="#5-2-2-日期处理函数">¶</a>5.2.2 日期处理函数</h3>
<p>1）date_format函数（根据格式整理日期）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> date_format<span class="token punctuation">(</span><span class="token string">'2019-02-10'</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>2）date_add函数（加减日期）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> date_add<span class="token punctuation">(</span><span class="token string">'2019-02-10'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">09</span>
hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> date_add<span class="token punctuation">(</span><span class="token string">'2019-02-10'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">11</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）next_day函数</p>
<p>（1）取当前天的下一个周一</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> next_day<span class="token punctuation">(</span><span class="token string">'2019-02-12'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">18</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>说明：星期一到星期日的英文（Monday，Tuesday、Wednesday、Thursday、Friday、Saturday、Sunday）</p>
<p>（2）取当前周的周一</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-12'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">11</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>4）last_day函数（求当月最后一天日期）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> last_day<span class="token punctuation">(</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">28</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1>第6章 需求一：用户活跃主题</h1>
<h2 id="6-1-DWS层"><a class="header-anchor" href="#6-1-DWS层">¶</a>6.1 DWS层</h2>
<p>目标：统计当日、当周、当月活动的每个设备明细</p>
<h3 id="6-1-1-每日活跃设备明细"><a class="header-anchor" href="#6-1-1-每日活跃设备明细">¶</a>6.1.1 每日活跃设备明细</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8TgknS.png" class="" title="8TgknS.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dws_uv_detail_day<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> dws_uv_detail_day
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'设备唯一标识'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'用户标识'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'程序版本号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'程序版本名'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'系统语言'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>source<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'渠道号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'安卓系统版本'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>area<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'区域'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'sdkVersion'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'gmail'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'屏幕宽高'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'客户端日志产生时的时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>network<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'网络模式'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'经度'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'纬度'</span>
<span class="token punctuation">)</span>
partitioned <span class="token keyword">by</span><span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>
stored <span class="token keyword">as</span> parquet
location <span class="token string">'/warehouse/gmall/dws/dws_uv_detail_day'</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）数据导入</p>
<p>以用户单日访问为key进行聚合，如果某个用户在一天中使用了两种操作系统、两个系统版本、多个地区，登录不同账号，只取其中之一</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_uv_detail_day 
<span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>  
    mid_id<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> user_id<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>version_code<span class="token punctuation">)</span><span class="token punctuation">)</span> version_code<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>version_name<span class="token punctuation">)</span><span class="token punctuation">)</span> version_name<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>lang<span class="token punctuation">)</span><span class="token punctuation">)</span>lang<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> source<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>os<span class="token punctuation">)</span><span class="token punctuation">)</span> os<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>area<span class="token punctuation">)</span><span class="token punctuation">)</span> area<span class="token punctuation">,</span> 
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">)</span> model<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>brand<span class="token punctuation">)</span><span class="token punctuation">)</span> brand<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>sdk_version<span class="token punctuation">)</span><span class="token punctuation">)</span> sdk_version<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>gmail<span class="token punctuation">)</span><span class="token punctuation">)</span> gmail<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>height_width<span class="token punctuation">)</span><span class="token punctuation">)</span> height_width<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>app_time<span class="token punctuation">)</span><span class="token punctuation">)</span> app_time<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>network<span class="token punctuation">)</span><span class="token punctuation">)</span> network<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>lng<span class="token punctuation">)</span><span class="token punctuation">)</span> lng<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>lat<span class="token punctuation">)</span><span class="token punctuation">)</span> lat
<span class="token keyword">from</span> dwd_start_log
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询导入结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dws_uv_detail_day <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span>
hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dws_uv_detail_day<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>4）思考：不同渠道来源的每日活跃数统计怎么计算？</p>
<h3 id="6-1-2-每周活跃设备明细"><a class="header-anchor" href="#6-1-2-每周活跃设备明细">¶</a>6.1.2 每周活跃设备明细</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8T2kgx.png" class="" title="8T2kgx.png" loading="lazy">
<p>根据日用户访问明细，获得周用户访问明细。</p>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dws_uv_detail_wk<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> dws_uv_detail_wk<span class="token punctuation">(</span> 
    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'设备唯一标识'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'用户标识'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'程序版本号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'程序版本名'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'系统语言'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>source<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'渠道号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'安卓系统版本'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>area<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'区域'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'sdkVersion'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'gmail'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'屏幕宽高'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'客户端日志产生时的时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>network<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'网络模式'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'经度'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'纬度'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>monday_date<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'周一日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sunday_date<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span>  <span class="token string">'周日日期'</span> 
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活跃用户按周明细'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>wk_dt<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
stored <span class="token keyword">as</span> parquet
location <span class="token string">'/warehouse/gmall/dws/dws_uv_detail_wk/'</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）数据导入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_uv_detail_wk <span class="token keyword">partition</span><span class="token punctuation">(</span>wk_dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>  
    mid_id<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> user_id<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>version_code<span class="token punctuation">)</span><span class="token punctuation">)</span> version_code<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>version_name<span class="token punctuation">)</span><span class="token punctuation">)</span> version_name<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>lang<span class="token punctuation">)</span><span class="token punctuation">)</span> lang<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> source<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>os<span class="token punctuation">)</span><span class="token punctuation">)</span> os<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>area<span class="token punctuation">)</span><span class="token punctuation">)</span> area<span class="token punctuation">,</span> 
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">)</span> model<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>brand<span class="token punctuation">)</span><span class="token punctuation">)</span> brand<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>sdk_version<span class="token punctuation">)</span><span class="token punctuation">)</span> sdk_version<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>gmail<span class="token punctuation">)</span><span class="token punctuation">)</span> gmail<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>height_width<span class="token punctuation">)</span><span class="token punctuation">)</span> height_width<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>app_time<span class="token punctuation">)</span><span class="token punctuation">)</span> app_time<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>network<span class="token punctuation">)</span><span class="token punctuation">)</span> network<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>lng<span class="token punctuation">)</span><span class="token punctuation">)</span> lng<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>lat<span class="token punctuation">)</span><span class="token punctuation">)</span> lat<span class="token punctuation">,</span>
    date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    concat<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span> next_day<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'_'</span> <span class="token punctuation">,</span> date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token punctuation">)</span>
<span class="token keyword">from</span> dws_uv_detail_day 
<span class="token keyword">where</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">and</span> dt<span class="token operator">&lt;=</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询导入结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dws_uv_detail_wk <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span>
hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dws_uv_detail_wk<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="6-1-3-每月活跃设备明细"><a class="header-anchor" href="#6-1-3-每月活跃设备明细">¶</a>6.1.3 每月活跃设备明细</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8TRofs.png" class="" title="8TRofs.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dws_uv_detail_mn<span class="token punctuation">;</span>

<span class="token keyword">create</span> external <span class="token keyword">table</span> dws_uv_detail_mn<span class="token punctuation">(</span> 
    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'设备唯一标识'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'用户标识'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'程序版本号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'程序版本名'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'系统语言'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>source<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'渠道号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'安卓系统版本'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>area<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'区域'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'sdkVersion'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'gmail'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'屏幕宽高'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'客户端日志产生时的时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>network<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'网络模式'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'经度'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'纬度'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活跃用户按月明细'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>mn<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
stored <span class="token keyword">as</span> parquet
location <span class="token string">'/warehouse/gmall/dws/dws_uv_detail_mn/'</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）数据导入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_uv_detail_mn <span class="token keyword">partition</span><span class="token punctuation">(</span>mn<span class="token punctuation">)</span>
<span class="token keyword">select</span>  
    mid_id<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> user_id<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>version_code<span class="token punctuation">)</span><span class="token punctuation">)</span> version_code<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>version_name<span class="token punctuation">)</span><span class="token punctuation">)</span> version_name<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>lang<span class="token punctuation">)</span><span class="token punctuation">)</span> lang<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> source<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>os<span class="token punctuation">)</span><span class="token punctuation">)</span> os<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>area<span class="token punctuation">)</span><span class="token punctuation">)</span> area<span class="token punctuation">,</span> 
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">)</span> model<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>brand<span class="token punctuation">)</span><span class="token punctuation">)</span> brand<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>sdk_version<span class="token punctuation">)</span><span class="token punctuation">)</span> sdk_version<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>gmail<span class="token punctuation">)</span><span class="token punctuation">)</span> gmail<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>height_width<span class="token punctuation">)</span><span class="token punctuation">)</span> height_width<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>app_time<span class="token punctuation">)</span><span class="token punctuation">)</span> app_time<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>network<span class="token punctuation">)</span><span class="token punctuation">)</span> network<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>lng<span class="token punctuation">)</span><span class="token punctuation">)</span> lng<span class="token punctuation">,</span>
    concat_ws<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>lat<span class="token punctuation">)</span><span class="token punctuation">)</span> lat<span class="token punctuation">,</span>
    date_format<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> dws_uv_detail_day
<span class="token keyword">where</span> date_format<span class="token punctuation">(</span>dt<span class="token punctuation">,</span><span class="token string">'yyyy-MM'</span><span class="token punctuation">)</span> <span class="token operator">=</span> date_format<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM'</span><span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询导入结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dws_uv_detail_mn <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span>
hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dws_uv_detail_mn <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="6-1-4-DWS层加载数据脚本"><a class="header-anchor" href="#6-1-4-DWS层加载数据脚本">¶</a>6.1.4 DWS层加载数据脚本</h3>
<p>1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim dws_uv_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中编写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

# 定义变量方便修改
APP&#x3D;gmall
hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天
if [ -n &quot;$1&quot; ] ;then
	do_date&#x3D;$1
else 
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;  
fi 


sql&#x3D;&quot;
  set hive.exec.dynamic.partition.mode&#x3D;nonstrict;

  insert overwrite table &quot;$APP&quot;.dws_uv_detail_day partition(dt&#x3D;&#39;$do_date&#39;)
  select  
    mid_id,
    concat_ws(&#39;|&#39;, collect_set(user_id)) user_id,
    concat_ws(&#39;|&#39;, collect_set(version_code)) version_code,
    concat_ws(&#39;|&#39;, collect_set(version_name)) version_name,
    concat_ws(&#39;|&#39;, collect_set(lang)) lang,
    concat_ws(&#39;|&#39;, collect_set(source)) source,
    concat_ws(&#39;|&#39;, collect_set(os)) os,
    concat_ws(&#39;|&#39;, collect_set(area)) area, 
    concat_ws(&#39;|&#39;, collect_set(model)) model,
    concat_ws(&#39;|&#39;, collect_set(brand)) brand,
    concat_ws(&#39;|&#39;, collect_set(sdk_version)) sdk_version,
    concat_ws(&#39;|&#39;, collect_set(gmail)) gmail,
    concat_ws(&#39;|&#39;, collect_set(height_width)) height_width,
    concat_ws(&#39;|&#39;, collect_set(app_time)) app_time,
    concat_ws(&#39;|&#39;, collect_set(network)) network,
    concat_ws(&#39;|&#39;, collect_set(lng)) lng,
    concat_ws(&#39;|&#39;, collect_set(lat)) lat
  from &quot;$APP&quot;.dwd_start_log
  where dt&#x3D;&#39;$do_date&#39;  
  group by mid_id;


  insert overwrite table &quot;$APP&quot;.dws_uv_detail_wk partition(wk_dt)
  select  
    mid_id,
    concat_ws(&#39;|&#39;, collect_set(user_id)) user_id,
    concat_ws(&#39;|&#39;, collect_set(version_code)) version_code,
    concat_ws(&#39;|&#39;, collect_set(version_name)) version_name,
    concat_ws(&#39;|&#39;, collect_set(lang)) lang,
    concat_ws(&#39;|&#39;, collect_set(source)) source,
    concat_ws(&#39;|&#39;, collect_set(os)) os,
    concat_ws(&#39;|&#39;, collect_set(area)) area, 
    concat_ws(&#39;|&#39;, collect_set(model)) model,
    concat_ws(&#39;|&#39;, collect_set(brand)) brand,
    concat_ws(&#39;|&#39;, collect_set(sdk_version)) sdk_version,
    concat_ws(&#39;|&#39;, collect_set(gmail)) gmail,
    concat_ws(&#39;|&#39;, collect_set(height_width)) height_width,
    concat_ws(&#39;|&#39;, collect_set(app_time)) app_time,
    concat_ws(&#39;|&#39;, collect_set(network)) network,
    concat_ws(&#39;|&#39;, collect_set(lng)) lng,
    concat_ws(&#39;|&#39;, collect_set(lat)) lat,
    date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7),
    date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-1),
    concat(date_add( next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7), &#39;_&#39; , date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-1) 
  )
  from &quot;$APP&quot;.dws_uv_detail_day
  where dt&gt;&#x3D;date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7) and dt&lt;&#x3D;date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-1) 
  group by mid_id; 


  insert overwrite table &quot;$APP&quot;.dws_uv_detail_mn partition(mn)
  select
    mid_id,
    concat_ws(&#39;|&#39;, collect_set(user_id)) user_id,
    concat_ws(&#39;|&#39;, collect_set(version_code)) version_code,
    concat_ws(&#39;|&#39;, collect_set(version_name)) version_name,
    concat_ws(&#39;|&#39;, collect_set(lang))lang,
    concat_ws(&#39;|&#39;, collect_set(source)) source,
    concat_ws(&#39;|&#39;, collect_set(os)) os,
    concat_ws(&#39;|&#39;, collect_set(area)) area, 
    concat_ws(&#39;|&#39;, collect_set(model)) model,
    concat_ws(&#39;|&#39;, collect_set(brand)) brand,
    concat_ws(&#39;|&#39;, collect_set(sdk_version)) sdk_version,
    concat_ws(&#39;|&#39;, collect_set(gmail)) gmail,
    concat_ws(&#39;|&#39;, collect_set(height_width)) height_width,
    concat_ws(&#39;|&#39;, collect_set(app_time)) app_time,
    concat_ws(&#39;|&#39;, collect_set(network)) network,
    concat_ws(&#39;|&#39;, collect_set(lng)) lng,
    concat_ws(&#39;|&#39;, collect_set(lat)) lat,
    date_format(&#39;$do_date&#39;,&#39;yyyy-MM&#39;)
  from &quot;$APP&quot;.dws_uv_detail_day
  where date_format(dt,&#39;yyyy-MM&#39;) &#x3D; date_format(&#39;$do_date&#39;,&#39;yyyy-MM&#39;)   
  group by mid_id;
&quot;

$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 dws_uv_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）脚本使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ dws_uv_log.sh 2020-03-23<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查询结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dws_uv_detail_day <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span><span class="token punctuation">;</span>
hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dws_uv_detail_wk<span class="token punctuation">;</span>
hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dws_uv_detail_mn <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>5）脚本执行时间</p>
<p>企业开发中一般在每日凌晨30分~1点</p>
<h2 id="6-2-ADS层"><a class="header-anchor" href="#6-2-ADS层">¶</a>6.2 ADS层</h2>
<p>目标：当日、当周、当月活跃设备数</p>
<h3 id="6-2-1-活跃设备数"><a class="header-anchor" href="#6-2-1-活跃设备数">¶</a>6.2.1 活跃设备数</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8T41nx.png" class="" title="8T41nx.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ads_uv_count<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> ads_uv_count<span class="token punctuation">(</span> 
<span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>day_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'当日用户数量'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>wk_count<span class="token punctuation">`</span>  <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'当周用户数量'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>mn_count<span class="token punctuation">`</span>  <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'当月用户数量'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>is_weekend<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'Y,N是否是周末,用于得到本周最终结果'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>is_monthend<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'Y,N是否是月末,用于得到本月最终结果'</span> 
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活跃设备数'</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_uv_count/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_uv_count 
<span class="token keyword">select</span>  
  <span class="token string">'2020-03-23'</span> dt<span class="token punctuation">,</span>
   daycount<span class="token punctuation">.</span>ct<span class="token punctuation">,</span>
   wkcount<span class="token punctuation">.</span>ct<span class="token punctuation">,</span>
   mncount<span class="token punctuation">.</span>ct<span class="token punctuation">,</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'Y'</span><span class="token punctuation">,</span><span class="token string">'N'</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>last_day<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'Y'</span><span class="token punctuation">,</span><span class="token string">'N'</span><span class="token punctuation">)</span> 
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
   <span class="token keyword">select</span>  
      <span class="token string">'2020-03-23'</span> dt<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> ct
   <span class="token keyword">from</span> dws_uv_detail_day
   <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span>  
<span class="token punctuation">)</span>daycount <span class="token keyword">join</span> 
<span class="token punctuation">(</span> 
   <span class="token keyword">select</span>  
     <span class="token string">'2020-03-23'</span> dt<span class="token punctuation">,</span>
     <span class="token function">count</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> ct
   <span class="token keyword">from</span> dws_uv_detail_wk
   <span class="token keyword">where</span> wk_dt<span class="token operator">=</span>concat<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'_'</span> <span class="token punctuation">,</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token punctuation">)</span> wkcount <span class="token keyword">on</span> daycount<span class="token punctuation">.</span>dt<span class="token operator">=</span>wkcount<span class="token punctuation">.</span>dt
<span class="token keyword">join</span> 
<span class="token punctuation">(</span> 
   <span class="token keyword">select</span>  
     <span class="token string">'2020-03-23'</span> dt<span class="token punctuation">,</span>
     <span class="token function">count</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> ct
   <span class="token keyword">from</span> dws_uv_detail_mn
   <span class="token keyword">where</span> mn<span class="token operator">=</span>date_format<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM'</span><span class="token punctuation">)</span>  
<span class="token punctuation">)</span>mncount <span class="token keyword">on</span> daycount<span class="token punctuation">.</span>dt<span class="token operator">=</span>mncount<span class="token punctuation">.</span>dt
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询导入结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_uv_count <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="6-2-2-ADS层加载数据脚本"><a class="header-anchor" href="#6-2-2-ADS层加载数据脚本">¶</a>6.2.2 ADS层加载数据脚本</h3>
<p>1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ads_uv_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中编写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

# 定义变量方便修改
APP&#x3D;gmall
hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天
if [ -n &quot;$1&quot; ] ;then
	do_date&#x3D;$1
else 
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;  
fi 

sql&#x3D;&quot;
  set hive.exec.dynamic.partition.mode&#x3D;nonstrict;

insert into table &quot;$APP&quot;.ads_uv_count 
select  
  &#39;$do_date&#39; dt,
   daycount.ct,
   wkcount.ct,
   mncount.ct,
   if(date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-1)&#x3D;&#39;$do_date&#39;,&#39;Y&#39;,&#39;N&#39;) ,
   if(last_day(&#39;$do_date&#39;)&#x3D;&#39;$do_date&#39;,&#39;Y&#39;,&#39;N&#39;) 
from 
(
   select  
      &#39;$do_date&#39; dt,
       count(*) ct
   from &quot;$APP&quot;.dws_uv_detail_day
   where dt&#x3D;&#39;$do_date&#39;  
)daycount   join 
( 
   select  
     &#39;$do_date&#39; dt,
     count (*) ct
   from &quot;$APP&quot;.dws_uv_detail_wk
   where wk_dt&#x3D;concat(date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7),&#39;_&#39; ,date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-1) )
)  wkcount  on daycount.dt&#x3D;wkcount.dt
join 
( 
   select  
     &#39;$do_date&#39; dt,
     count (*) ct
   from &quot;$APP&quot;.dws_uv_detail_mn
   where mn&#x3D;date_format(&#39;$do_date&#39;,&#39;yyyy-MM&#39;)  
)mncount on daycount.dt&#x3D;mncount.dt;
&quot;

$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 ads_uv_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）脚本使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ ads_uv_log.sh 2019-02-11<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）脚本执行时间</p>
<p>企业开发中一般在每日凌晨30分~1点</p>
<p>5）查询导入结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_uv_count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1>第7章 需求二：用户新增主题</h1>
<p>首次联网使用应用的用户。如果一个用户首次打开某APP，那这个用户定义为新增用户；卸载再安装的设备，不会被算作一次新增。新增用户包括日新增用户、周新增用户、月新增用户。</p>
<h2 id="7-1-DWS层（每日新增设备明细表）"><a class="header-anchor" href="#7-1-DWS层（每日新增设备明细表）">¶</a>7.1 DWS层（每日新增设备明细表）</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/87rLtI.png" class="" title="87rLtI.png" loading="lazy">
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/87ss8P.png" class="" title="87ss8P.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dws_new_mid_day<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> dws_new_mid_day
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'设备唯一标识'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'用户标识'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'程序版本号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'程序版本名'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'系统语言'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>source<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'渠道号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'安卓系统版本'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>area<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'区域'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'sdkVersion'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'gmail'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'屏幕宽高'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'客户端日志产生时的时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>network<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'网络模式'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'经度'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'纬度'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_date<span class="token punctuation">`</span>  string  <span class="token keyword">comment</span> <span class="token string">'创建时间'</span> 
<span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'每日新增设备信息'</span>
stored <span class="token keyword">as</span> parquet
location <span class="token string">'/warehouse/gmall/dws/dws_new_mid_day/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<p>用每日活跃用户表Left<br>
Join每日新增设备表，关联的条件是mid_id相等。如果是每日新增的设备，则在每日新增设备表中为null。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> dws_new_mid_day
<span class="token keyword">select</span>  
    ud<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>
    ud<span class="token punctuation">.</span>user_id <span class="token punctuation">,</span> 
    ud<span class="token punctuation">.</span>version_code <span class="token punctuation">,</span> 
    ud<span class="token punctuation">.</span>version_name <span class="token punctuation">,</span> 
    ud<span class="token punctuation">.</span>lang <span class="token punctuation">,</span> 
    ud<span class="token punctuation">.</span>source<span class="token punctuation">,</span> 
    ud<span class="token punctuation">.</span>os<span class="token punctuation">,</span> 
    ud<span class="token punctuation">.</span>area<span class="token punctuation">,</span> 
    ud<span class="token punctuation">.</span>model<span class="token punctuation">,</span> 
    ud<span class="token punctuation">.</span>brand<span class="token punctuation">,</span> 
    ud<span class="token punctuation">.</span>sdk_version<span class="token punctuation">,</span> 
    ud<span class="token punctuation">.</span>gmail<span class="token punctuation">,</span> 
    ud<span class="token punctuation">.</span>height_width<span class="token punctuation">,</span>
    ud<span class="token punctuation">.</span>app_time<span class="token punctuation">,</span>
    ud<span class="token punctuation">.</span>network<span class="token punctuation">,</span>
    ud<span class="token punctuation">.</span>lng<span class="token punctuation">,</span>
    ud<span class="token punctuation">.</span>lat<span class="token punctuation">,</span>
    <span class="token string">'2020-03-23'</span>
<span class="token keyword">from</span> dws_uv_detail_day ud <span class="token keyword">left</span> <span class="token keyword">join</span> dws_new_mid_day nm <span class="token keyword">on</span> ud<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>nm<span class="token punctuation">.</span>mid_id
<span class="token keyword">where</span> ud<span class="token punctuation">.</span>dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span> <span class="token operator">and</span> nm<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dws_new_mid_day <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="7-2-ADS层（每日新增设备表）"><a class="header-anchor" href="#7-2-ADS层（每日新增设备表）">¶</a>7.2 ADS层（每日新增设备表）</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/87ytGq.png" class="" title="87ytGq.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ads_new_mid_count<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> ads_new_mid_count
<span class="token punctuation">(</span>
<span class="token punctuation">`</span>create_date<span class="token punctuation">`</span> string <span class="token keyword">comment</span> <span class="token string">'创建时间'</span> <span class="token punctuation">,</span>
<span class="token punctuation">`</span>new_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">comment</span> <span class="token string">'新增设备数量'</span> 
<span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'每日新增设备信息数量'</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_new_mid_count/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_new_mid_count 
<span class="token keyword">select</span>
create_date<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> dws_new_mid_day
<span class="token keyword">where</span> create_date<span class="token operator">=</span><span class="token string">'2020-03-23'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> create_date<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_new_mid_count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1>第8章 需求三：用户留存主题</h1>
<h2 id="8-1-需求目标"><a class="header-anchor" href="#8-1-需求目标">¶</a>8.1 需求目标</h2>
<h3 id="8-1-1-用户留存概念"><a class="header-anchor" href="#8-1-1-用户留存概念">¶</a>8.1.1 用户留存概念</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/876EOU.png" class="" title="876EOU.png" loading="lazy">
<h3 id="8-1-2-需求描述"><a class="header-anchor" href="#8-1-2-需求描述">¶</a>8.1.2 需求描述</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/876Mf1.png" class="" title="876Mf1.png" loading="lazy">
<h2 id="8-2-DWS层"><a class="header-anchor" href="#8-2-DWS层">¶</a>8.2 DWS层</h2>
<h3 id="8-2-1-DWS层（每日留存用户明细表）"><a class="header-anchor" href="#8-2-1-DWS层（每日留存用户明细表）">¶</a>8.2.1 DWS层（每日留存用户明细表）</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/876xc6.png" class="" title="876xc6.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dws_user_retention_day<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> dws_user_retention_day 
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'设备唯一标识'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'用户标识'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'程序版本号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>version_name<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'程序版本名'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>lang<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'系统语言'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>source<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'渠道号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'安卓系统版本'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>area<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'区域'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>sdk_version<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'sdkVersion'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>gmail<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'gmail'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>height_width<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'屏幕宽高'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>app_time<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'客户端日志产生时的时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>network<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'网络模式'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>lng<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'经度'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>lat<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'纬度'</span><span class="token punctuation">,</span>
   <span class="token punctuation">`</span>create_date<span class="token punctuation">`</span>    string  <span class="token keyword">comment</span> <span class="token string">'设备新增时间'</span><span class="token punctuation">,</span>
   <span class="token punctuation">`</span>retention_day<span class="token punctuation">`</span>  <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'截止当前日期留存天数'</span>
<span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'每日用户留存情况'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
stored <span class="token keyword">as</span> parquet
location <span class="token string">'/warehouse/gmall/dws/dws_user_retention_day/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据（每天计算前1天的新用户访问留存明细）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_user_retention_day
<span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">"2020-03-23"</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>  
    nm<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>user_id <span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>version_code <span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>version_name <span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>lang <span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>source<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>os<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>area<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>model<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>brand<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>sdk_version<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>gmail<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>height_width<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>app_time<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>network<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>lng<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>lat<span class="token punctuation">,</span>
nm<span class="token punctuation">.</span>create_date<span class="token punctuation">,</span>
<span class="token number">1</span> retention_day 
<span class="token keyword">from</span> dws_uv_detail_day ud <span class="token keyword">join</span> dws_new_mid_day nm <span class="token keyword">on</span> ud<span class="token punctuation">.</span>mid_id <span class="token operator">=</span>nm<span class="token punctuation">.</span>mid_id 
<span class="token keyword">where</span> ud<span class="token punctuation">.</span>dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span> <span class="token operator">and</span> nm<span class="token punctuation">.</span>create_date<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询导入数据（每天计算前1天的新用户访问留存明细）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dws_user_retention_day<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="8-2-2-DWS层（1-2-3-n天留存用户明细表）"><a class="header-anchor" href="#8-2-2-DWS层（1-2-3-n天留存用户明细表）">¶</a>8.2.2 DWS层（1,2,3,n天留存用户明细表）</h3>
<p>1）导入数据（每天计算前1,2,3，n天的新用户访问留存明细）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_user_retention_day
<span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">"2020-03-23"</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    nm<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>version_code<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>version_name<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>lang<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>source<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>os<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>area<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>brand<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>sdk_version<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>gmail<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>height_width<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>app_time<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>network<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>lng<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>lat<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>create_date<span class="token punctuation">,</span>
    <span class="token number">1</span> retention_day 
<span class="token keyword">from</span> dws_uv_detail_day ud <span class="token keyword">join</span> dws_new_mid_day nm  <span class="token keyword">on</span> ud<span class="token punctuation">.</span>mid_id <span class="token operator">=</span>nm<span class="token punctuation">.</span>mid_id 
<span class="token keyword">where</span> ud<span class="token punctuation">.</span>dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span> <span class="token operator">and</span> nm<span class="token punctuation">.</span>create_date<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span>  
    nm<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>user_id <span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>version_code <span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>version_name <span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>lang <span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>source<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>os<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>area<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>model<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>brand<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>sdk_version<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>gmail<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>height_width<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>app_time<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>network<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>lng<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>lat<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>create_date<span class="token punctuation">,</span>
    <span class="token number">2</span> retention_day 
<span class="token keyword">from</span>  dws_uv_detail_day ud <span class="token keyword">join</span> dws_new_mid_day nm   <span class="token keyword">on</span> ud<span class="token punctuation">.</span>mid_id <span class="token operator">=</span>nm<span class="token punctuation">.</span>mid_id 
<span class="token keyword">where</span> ud<span class="token punctuation">.</span>dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span> <span class="token operator">and</span> nm<span class="token punctuation">.</span>create_date<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span>  
    nm<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>user_id <span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>version_code <span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>version_name <span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>lang <span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>source<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>os<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>area<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>model<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>brand<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>sdk_version<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>gmail<span class="token punctuation">,</span> 
    nm<span class="token punctuation">.</span>height_width<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>app_time<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>network<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>lng<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>lat<span class="token punctuation">,</span>
    nm<span class="token punctuation">.</span>create_date<span class="token punctuation">,</span>
    <span class="token number">3</span> retention_day 
<span class="token keyword">from</span>  dws_uv_detail_day ud <span class="token keyword">join</span> dws_new_mid_day nm   <span class="token keyword">on</span> ud<span class="token punctuation">.</span>mid_id <span class="token operator">=</span>nm<span class="token punctuation">.</span>mid_id 
<span class="token keyword">where</span> ud<span class="token punctuation">.</span>dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span> <span class="token operator">and</span> nm<span class="token punctuation">.</span>create_date<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-03-23'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）查询导入数据（每天计算前1,2,3天的新用户访问留存明细）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> retention_day <span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dws_user_retention_day <span class="token keyword">group</span> <span class="token keyword">by</span> retention_day<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="8-2-3-Union与Union-all区别"><a class="header-anchor" href="#8-2-3-Union与Union-all区别">¶</a>8.2.3 Union与Union all区别</h3>
<p>1）准备两张表</p>
<table>
<thead>
<tr>
<th>tableA</th>
<th></th>
<th></th>
<th>tableB</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>name</td>
<td>score</td>
<td>id</td>
<td>name</td>
<td>score</td>
</tr>
<tr>
<td>1</td>
<td>a</td>
<td>80</td>
<td>1</td>
<td>d</td>
<td>48</td>
</tr>
<tr>
<td>2</td>
<td>b</td>
<td>79</td>
<td>2</td>
<td>e</td>
<td>23</td>
</tr>
<tr>
<td>3</td>
<td>c</td>
<td>68</td>
<td>3</td>
<td>c</td>
<td>86</td>
</tr>
</tbody>
</table>
<p>2）采用union查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> name <span class="token keyword">from</span> tableA　　　　　　　　　　　　　
<span class="token keyword">union</span>　　　　　　　　　　　　　　　　　　　　　　　　
<span class="token keyword">select</span> name <span class="token keyword">from</span> tableB　　　　　　　　　　　　　
查询结果
name
a
d
b
e
c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）采用union all查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> name <span class="token keyword">from</span> tableA
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> tableB
查询结果
name
a
b
c
d
e
c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>4）总结</p>
<p>（1）union会将联合的结果集去重，效率较union all差</p>
<p>（2）union all不会对结果集去重，所以效率高</p>
<h2 id="8-3-ADS层"><a class="header-anchor" href="#8-3-ADS层">¶</a>8.3 ADS层</h2>
<h3 id="8-3-1-留存用户数"><a class="header-anchor" href="#8-3-1-留存用户数">¶</a>8.3.1 留存用户数</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8HJ6sI.png" class="" title="8HJ6sI.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ads_user_retention_day_count<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> ads_user_retention_day_count 
<span class="token punctuation">(</span>
<span class="token punctuation">`</span>create_date<span class="token punctuation">`</span> string  <span class="token keyword">comment</span> <span class="token string">'设备新增日期'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>retention_day<span class="token punctuation">`</span> <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'截止当前日期留存天数'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>retention_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span> <span class="token keyword">comment</span>  <span class="token string">'留存数量'</span>
<span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'每日用户留存情况'</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_user_retention_day_count/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_user_retention_day_count 
<span class="token keyword">select</span>
    create_date<span class="token punctuation">,</span>
    retention_day<span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> retention_count
<span class="token keyword">from</span> dws_user_retention_day
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-03-23'</span> 
<span class="token keyword">group</span> <span class="token keyword">by</span> create_date<span class="token punctuation">,</span>retention_day<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_user_retention_day_count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="8-3-2-留存用户比率"><a class="header-anchor" href="#8-3-2-留存用户比率">¶</a>8.3.2 留存用户比率</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8Ht5Ks.png" class="" title="8Ht5Ks.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ads_user_retention_day_rate<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> ads_user_retention_day_rate 
<span class="token punctuation">(</span>
<span class="token punctuation">`</span>stat_date<span class="token punctuation">`</span> string <span class="token keyword">comment</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>create_date<span class="token punctuation">`</span> string  <span class="token keyword">comment</span> <span class="token string">'设备新增日期'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>retention_day<span class="token punctuation">`</span> <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'截止当前日期留存天数'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>retention_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span> <span class="token keyword">comment</span>  <span class="token string">'留存数量'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>new_mid_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">'当日设备新增数量'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>retention_ratio<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'留存率'</span>
<span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'每日用户留存情况'</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_user_retention_day_rate/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_user_retention_day_rate
<span class="token keyword">select</span> 
    <span class="token string">'2020-03-23'</span><span class="token punctuation">,</span> 
    ur<span class="token punctuation">.</span>create_date<span class="token punctuation">,</span>
    ur<span class="token punctuation">.</span>retention_day<span class="token punctuation">,</span> 
    ur<span class="token punctuation">.</span>retention_count<span class="token punctuation">,</span> 
    nc<span class="token punctuation">.</span>new_mid_count<span class="token punctuation">,</span>
    ur<span class="token punctuation">.</span>retention_count<span class="token operator">/</span>nc<span class="token punctuation">.</span>new_mid_count<span class="token operator">*</span><span class="token number">100</span>
<span class="token keyword">from</span> ads_user_retention_day_count ur <span class="token keyword">join</span> ads_new_mid_count nc
<span class="token keyword">on</span> nc<span class="token punctuation">.</span>create_date<span class="token operator">=</span>ur<span class="token punctuation">.</span>create_date<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_user_retention_day_rate<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1>第9章 新数据准备</h1>
<p>为了分析沉默用户、本周回流用户数、流失用户、最近连续3周活跃用户、最近七天内连续三天活跃用户数，需要准备2019-02-12、2019-02-20日的数据。</p>
<p>1）2019-02-12数据准备</p>
<p>（1）修改日志时间</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 ~]$ dt.sh 2019-02-12<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（2）启动集群</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 ~]$ cluster.sh start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（3）生成日志数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 ~]$ lg.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（4）将HDFS数据导入到ODS层</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span>atguigu<span class="token variable">@hadoop102</span> <span class="token operator">~</span><span class="token punctuation">]</span>$ ods_log<span class="token punctuation">.</span>sh <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（5）将ODS数据导入到DWD层</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span>atguigu<span class="token variable">@hadoop102</span> <span class="token operator">~</span><span class="token punctuation">]</span>$ dwd_start_log<span class="token punctuation">.</span>sh <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span>
<span class="token punctuation">[</span>atguigu<span class="token variable">@hadoop102</span> <span class="token operator">~</span><span class="token punctuation">]</span>$ dwd_base_log<span class="token punctuation">.</span>sh <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span>
<span class="token punctuation">[</span>atguigu<span class="token variable">@hadoop102</span> <span class="token operator">~</span><span class="token punctuation">]</span>$ dwd_event_log<span class="token punctuation">.</span>sh <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>（6）将DWD数据导入到DWS层</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 ~]$ dws_uv_log.sh 2019-02-12<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（7）验证</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dws_uv_detail_day <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-12'</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>2）2019-02-20数据准备</p>
<p>（1）修改日志时间</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 ~]$ dt.sh 2019-02-20<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（2）启动集群</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 ~]$ cluster.sh start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（3）生成日志数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 ~]$ lg.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（4）将HDFS数据导入到ODS层</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 ~]$ ods_log.sh 2019-02-20<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（5）将ODS数据导入到DWD层</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 ~]$ dwd_start_log.sh 2019-02-20
[atguigu@hadoop102 ~]$ dwd_base_log.sh 2019-02-20
[atguigu@hadoop102 ~]$ dwd_event_log.sh 2019-02-20<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>（6）将DWD数据导入到DWS层</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 ~]$ dws_uv_log.sh 2019-02-20<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（7）验证</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dws_uv_detail_day <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-20'</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1>第10章 需求四：沉默用户数</h1>
<p>沉默用户：指的是只在安装当天启动过，且启动时间是在一周前</p>
<h2 id="10-1-DWS层"><a class="header-anchor" href="#10-1-DWS层">¶</a>10.1 DWS层</h2>
<p>使用日活明细表dws_uv_detail_day作为DWS层数据</p>
<h2 id="10-2-ADS层"><a class="header-anchor" href="#10-2-ADS层">¶</a>10.2 ADS层</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8HfdG4.png" class="" title="8HfdG4.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ads_silent_count<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> ads_silent_count<span class="token punctuation">(</span> 
    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>silent_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'沉默设备数'</span>
<span class="token punctuation">)</span> 
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_silent_count'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入2019-02-20数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_silent_count
<span class="token keyword">select</span> 
    <span class="token string">'2019-02-20'</span> dt<span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> silent_count
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> mid_id
    <span class="token keyword">from</span> dws_uv_detail_day
    <span class="token keyword">where</span> dt<span class="token operator">&lt;=</span><span class="token string">'2019-02-20'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id
    <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token function">min</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token operator">&lt;</span>date_add<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> t1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_silent_count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="10-3-编写脚本"><a class="header-anchor" href="#10-3-编写脚本">¶</a>10.3 编写脚本</h2>
<p>1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ads_silent_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中编写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive
APP&#x3D;gmall

if [ -n &quot;$1&quot; ];then
	do_date&#x3D;$1
else
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;
fi

echo &quot;-----------导入日期$do_date-----------&quot;

sql&#x3D;&quot;
insert into table &quot;$APP&quot;.ads_silent_count
select 
    &#39;$do_date&#39; dt,
    count(*) silent_count
from 
(
    select 
        mid_id
    from &quot;$APP&quot;.dws_uv_detail_day
    where dt&lt;&#x3D;&#39;$do_date&#39;
    group by mid_id
    having count(*)&#x3D;1 and min(dt)&lt;&#x3D;date_add(&#39;$do_date&#39;,-7)
)t1;&quot;

$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 ads_silent_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）脚本使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ ads_silent_log.sh 2019-02-20<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查询结果</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">hive (gmall)&gt; select * from ads_silent_count;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>5）脚本执行时间</p>
<p>企业开发中一般在每日凌晨30分~1点</p>
<h1>第11章 需求五：本周回流用户数</h1>
<p>本周回流=本周活跃-本周新增-上周活跃</p>
<h2 id="11-1-DWS层"><a class="header-anchor" href="#11-1-DWS层">¶</a>11.1 DWS层</h2>
<p>使用日活明细表dws_uv_detail_day作为DWS层数据</p>
<h2 id="11-2-ADS层"><a class="header-anchor" href="#11-2-ADS层">¶</a>11.2 ADS层</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8Hh1YD.png" class="" title="8Hh1YD.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ads_back_count<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> ads_back_count<span class="token punctuation">(</span> 
    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>wk_dt<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'统计日期所在周'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>wastage_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'回流设备数'</span>
<span class="token punctuation">)</span> 
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_back_count'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入数据：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_back_count
<span class="token keyword">select</span> 
   <span class="token string">'2019-02-20'</span> dt<span class="token punctuation">,</span>
   concat<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'_'</span><span class="token punctuation">,</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> wk_dt<span class="token punctuation">,</span>
   <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> t1<span class="token punctuation">.</span>mid_id
    <span class="token keyword">from</span> 
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>	mid_id
        <span class="token keyword">from</span> dws_uv_detail_wk
        <span class="token keyword">where</span> wk_dt<span class="token operator">=</span>concat<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'_'</span><span class="token punctuation">,</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>t1
    <span class="token keyword">left</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span> mid_id
        <span class="token keyword">from</span> dws_new_mid_day
        <span class="token keyword">where</span> create_date<span class="token operator">&lt;=</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">and</span> create_date<span class="token operator">>=</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>t2
    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>mid_id
    <span class="token keyword">left</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span> mid_id
        <span class="token keyword">from</span> dws_uv_detail_wk
        <span class="token keyword">where</span> wk_dt<span class="token operator">=</span>concat<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'_'</span><span class="token punctuation">,</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>t3
    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>t3<span class="token punctuation">.</span>mid_id
    <span class="token keyword">where</span> t2<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> t3<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span>t4<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_back_count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="11-3-编写脚本"><a class="header-anchor" href="#11-3-编写脚本">¶</a>11.3 编写脚本</h2>
<p>1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ads_back_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中编写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

if [ -n &quot;$1&quot; ];then
	do_date&#x3D;$1
else
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;
fi

hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive
APP&#x3D;gmall

echo &quot;-----------导入日期$do_date-----------&quot;

sql&#x3D;&quot;
insert into table &quot;$APP&quot;.ads_back_count
select 
       &#39;$do_date&#39; dt,
       concat(date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7),&#39;_&#39;,date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-1)) wk_dt,
       count(*)
from 
(
    select t1.mid_id
    from 
    (
        select mid_id
        from &quot;$APP&quot;.dws_uv_detail_wk
        where wk_dt&#x3D;concat(date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7),&#39;_&#39;,date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-1))
    )t1
    left join
    (
        select mid_id
        from &quot;$APP&quot;.dws_new_mid_day
        where create_date&lt;&#x3D;date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-1) and create_date&gt;&#x3D;date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7)
    )t2
    on t1.mid_id&#x3D;t2.mid_id
    left join
    (
        select mid_id
        from &quot;$APP&quot;.dws_uv_detail_wk
        where wk_dt&#x3D;concat(date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7*2),&#39;_&#39;,date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7-1))
    )t3
    on t1.mid_id&#x3D;t3.mid_id
    where t2.mid_id is null and t3.mid_id is null
)t4;
&quot;

$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 ads_back_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）脚本使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ ads_back_log.sh 2019-02-20<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查询结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_back_count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>5）脚本执行时间</p>
<p>企业开发中一般在每周一凌晨30分~1点</p>
<h1>第12章 需求六：流失用户数</h1>
<p>流失用户：最近7天未登录我们称之为流失用户</p>
<h2 id="12-1-DWS层"><a class="header-anchor" href="#12-1-DWS层">¶</a>12.1 DWS层</h2>
<p>使用日活明细表dws_uv_detail_day作为DWS层数据</p>
<h2 id="12-2-ADS层"><a class="header-anchor" href="#12-2-ADS层">¶</a>12.2 ADS层</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8Hh4tU.png" class="" title="8Hh4tU.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ads_wastage_count<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> ads_wastage_count<span class="token punctuation">(</span> 
    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>wastage_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'流失设备数'</span>
<span class="token punctuation">)</span> 
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_wastage_count'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入2019-02-20数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_wastage_count
<span class="token keyword">select</span>
     <span class="token string">'2019-02-20'</span><span class="token punctuation">,</span>
     <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> mid_id
<span class="token keyword">from</span> dws_uv_detail_day
    <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id
    <span class="token keyword">having</span> <span class="token function">max</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token operator">&lt;=</span>date_add<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>t1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="12-3-编写脚本"><a class="header-anchor" href="#12-3-编写脚本">¶</a>12.3 编写脚本</h2>
<p>1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ads_wastage_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中编写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

if [ -n &quot;$1&quot; ];then
	do_date&#x3D;$1
else
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;
fi

hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive
APP&#x3D;gmall

echo &quot;-----------导入日期$do_date-----------&quot;

sql&#x3D;&quot;
insert into table &quot;$APP&quot;.ads_wastage_count
select
     &#39;$do_date&#39;,
     count(*)
from 
(
    select mid_id
    from &quot;$APP&quot;.dws_uv_detail_day
    group by mid_id
    having max(dt)&lt;&#x3D;date_add(&#39;$do_date&#39;,-7)
)t1;
&quot;

$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 ads_wastage_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）脚本使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ ads_wastage_log.sh 2019-02-20<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查询结果</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">hive (gmall)&gt; select * from ads_wastage_count;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>5）脚本执行时间</p>
<p>企业开发中一般在每日凌晨30分~1点</p>
<h1>第13章 需求七：最近连续三周活跃用户数</h1>
<p>最近3周连续活跃的用户：通常是周一对前3周的数据做统计，该数据一周计算一次。</p>
<h2 id="13-1-DWS层"><a class="header-anchor" href="#13-1-DWS层">¶</a>13.1 DWS层</h2>
<p>使用周活明细表dws_uv_detail_wk作为DWS层数据</p>
<h2 id="13-2-ADS层"><a class="header-anchor" href="#13-2-ADS层">¶</a>13.2 ADS层</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8H4m9g.png" class="" title="8H4m9g.png" loading="lazy">
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ads_continuity_wk_count<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> ads_continuity_wk_count<span class="token punctuation">(</span> 
    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'统计日期,一般用结束周周日日期,如果每天计算一次,可用当天日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>wk_dt<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'持续时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>continuity_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span>
<span class="token punctuation">)</span> 
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_continuity_wk_count'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入2019-02-20所在周的数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_continuity_wk_count
<span class="token keyword">select</span> 
     <span class="token string">'2019-02-20'</span><span class="token punctuation">,</span>
     concat<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'_'</span><span class="token punctuation">,</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> mid_id
    <span class="token keyword">from</span> dws_uv_detail_wk
    <span class="token keyword">where</span> wk_dt<span class="token operator">>=</span>concat<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'_'</span><span class="token punctuation">,</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token operator">and</span> wk_dt<span class="token operator">&lt;=</span>concat<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'_'</span><span class="token punctuation">,</span>date_add<span class="token punctuation">(</span>next_day<span class="token punctuation">(</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span><span class="token string">'MO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id
    <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token punctuation">)</span>t1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_continuity_wk_count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="13-3-编写脚本"><a class="header-anchor" href="#13-3-编写脚本">¶</a>13.3 编写脚本</h2>
<p>1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ads_continuity_wk_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中编写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

if [ -n &quot;$1&quot; ];then
	do_date&#x3D;$1
else
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;
fi

hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive
APP&#x3D;gmall

echo &quot;-----------导入日期$do_date-----------&quot;

sql&#x3D;&quot;
insert into table &quot;$APP&quot;.ads_continuity_wk_count
select 
     &#39;$do_date&#39;,
     concat(date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7*3),&#39;_&#39;,date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-1)),
     count(*)
from 
(
    select mid_id
    from &quot;$APP&quot;.dws_uv_detail_wk
    where wk_dt&gt;&#x3D;concat(date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7*3),&#39;_&#39;,date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7*2-1)) 
    and wk_dt&lt;&#x3D;concat(date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-7),&#39;_&#39;,date_add(next_day(&#39;$do_date&#39;,&#39;MO&#39;),-1))
    group by mid_id
    having count(*)&#x3D;3
)t1;&quot;

$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 ads_continuity_wk_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）脚本使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ ads_continuity_wk_log.sh 2019-02-20<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查询结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_continuity_wk_count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>5）脚本执行时间</p>
<p>企业开发中一般在每周一凌晨30分~1点</p>
<h1>第14章 需求八：最近七天内连续三天活跃用户数</h1>
<p>说明：最近7天内连续3天活跃用户数</p>
<h2 id="14-1-DWS层"><a class="header-anchor" href="#14-1-DWS层">¶</a>14.1 DWS层</h2>
<p>使用日活明细表dws_uv_detail_day作为DWS层数据</p>
<h2 id="14-2-ADS层"><a class="header-anchor" href="#14-2-ADS层">¶</a>14.2 ADS层</h2>
<p>1）建表语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ads_continuity_uv_count<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> ads_continuity_uv_count<span class="token punctuation">(</span> 
    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>wk_dt<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'最近7天日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>continuity_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'连续活跃设备数'</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_continuity_uv_count'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）写出导入数据的SQL语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_continuity_uv_count
<span class="token keyword">select</span>
    <span class="token string">'2019-02-12'</span><span class="token punctuation">,</span>
    concat<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span><span class="token string">'2019-02-12'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'_'</span><span class="token punctuation">,</span><span class="token string">'2019-02-12'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> mid_id
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span> mid_id      
        <span class="token keyword">from</span>
        <span class="token punctuation">(</span>
            <span class="token keyword">select</span> 
                mid_id<span class="token punctuation">,</span>
                date_sub<span class="token punctuation">(</span>dt<span class="token punctuation">,</span>rank<span class="token punctuation">)</span> date_dif
            <span class="token keyword">from</span>
            <span class="token punctuation">(</span>
                <span class="token keyword">select</span> 
                    mid_id<span class="token punctuation">,</span>
                    dt<span class="token punctuation">,</span>
                    rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> mid_id <span class="token keyword">order</span> <span class="token keyword">by</span> dt<span class="token punctuation">)</span> rank
                <span class="token keyword">from</span> dws_uv_detail_day
                <span class="token keyword">where</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2019-02-12'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">and</span> dt<span class="token operator">&lt;=</span><span class="token string">'2019-02-12'</span>
            <span class="token punctuation">)</span>t1
        <span class="token punctuation">)</span>t2 
        <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">,</span>date_dif
        <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">3</span>
    <span class="token punctuation">)</span>t3 
    <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id
<span class="token punctuation">)</span>t4<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_continuity_uv_count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="14-3-编写脚本"><a class="header-anchor" href="#14-3-编写脚本">¶</a>14.3 编写脚本</h2>
<p>1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ads_continuity_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中编写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

if [ -n &quot;$1&quot; ];then
	do_date&#x3D;$1
else
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;
fi

hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive
APP&#x3D;gmall

echo &quot;-----------导入日期$do_date-----------&quot;

sql&#x3D;&quot;
insert into table &quot;$APP&quot;.ads_continuity_uv_count
select 
     &#39;$do_date&#39;,
     concat(date_add(&#39;$do_date&#39;,-6),&#39;_&#39;,&#39;$do_date&#39;) dt,
     count(*) 
from 
(
    select mid_id
    from
    (
        select mid_id
        from 
        (
            select
                mid_id,
                date_sub(dt,rank) date_diff
            from 
            (
                select 
                    mid_id,
                    dt,
                    rank() over(partition by mid_id order by dt) rank
                from &quot;$APP&quot;.dws_uv_detail_day
                where dt&gt;&#x3D;date_add(&#39;$do_date&#39;,-6) and dt&lt;&#x3D;&#39;$do_date&#39;
            )t1
        )t2
        group by mid_id,date_diff
        having count(*)&gt;&#x3D;3
    )t3 
    group by mid_id
)t4;
&quot;

$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 ads_continuity_log.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）脚本使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 module]$ ads_continuity_log.sh 2019-02-12<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查询结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_continuity_uv_count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>5）脚本执行时间</p>
<p>企业开发中一般在每日凌晨30分~1点</p>
<h1>第15章 总结</h1>
<h2 id="15-1-用户行为数仓业务总结"><a class="header-anchor" href="#15-1-用户行为数仓业务总结">¶</a>15.1 用户行为数仓业务总结</h2>
<h3 id="15-1-1-数仓分几层？每层做什么的？"><a class="header-anchor" href="#15-1-1-数仓分几层？每层做什么的？">¶</a>15.1.1 数仓分几层？每层做什么的？</h3>
<p>1）ODS层（原始数据层）</p>
<p>存储原始数据，直接加载原始日志、数据，数据保持原貌不做处理。</p>
<p>2）DWD层（明细层）</p>
<p>对ODS层数据进行清洗（去除空值、脏数据，超过极限范围的数据）</p>
<p>3）DWS层（服务数据层）</p>
<p>以DWD层为基础，进行轻度汇总。比如：用户当日、设备当日、商品当日。</p>
<p>4）ADS层（数据应用层）</p>
<h3 id="15-1-2-Tez引擎优点？"><a class="header-anchor" href="#15-1-2-Tez引擎优点？">¶</a>15.1.2 Tez引擎优点？</h3>
<p>Tez可以将多个有依赖的作业转换为一个作业，这样只需写一次HDFS，且中间节点较少，从而大大提升作业的计算性能。</p>
<h3 id="15-1-3-在项目中是否自定义过UDF、UDTF函数，以及用他们处理了什么问题？"><a class="header-anchor" href="#15-1-3-在项目中是否自定义过UDF、UDTF函数，以及用他们处理了什么问题？">¶</a>15.1.3 在项目中是否自定义过UDF、UDTF函数，以及用他们处理了什么问题？</h3>
<p>自定义过。</p>
<p>用UDF函数解析公共字段；用UDTF函数解析事件字段。</p>
<h3 id="15-1-4-如何分析用户活跃？"><a class="header-anchor" href="#15-1-4-如何分析用户活跃？">¶</a>15.1.4 如何分析用户活跃？</h3>
<p>在启动日志中统计不同设备id 出现次数。</p>
<h3 id="15-1-5-如何分析用户新增？"><a class="header-anchor" href="#15-1-5-如何分析用户新增？">¶</a>15.1.5 如何分析用户新增？</h3>
<p>用活跃用户表 left join 用户新增表，用户新增表中mid为空的即为用户新增。</p>
<h3 id="15-1-6-如何分析用户1天留存？"><a class="header-anchor" href="#15-1-6-如何分析用户1天留存？">¶</a>15.1.6 如何分析用户1天留存？</h3>
<p>留存用户=前一天新增 join 今天活跃</p>
<p>用户留存率=留存用户/前一天新增</p>
<h3 id="15-1-7-如何分析沉默用户？"><a class="header-anchor" href="#15-1-7-如何分析沉默用户？">¶</a>15.1.7 如何分析沉默用户？</h3>
<p>按照设备id对日活表分组，登录次数为1，且是在一周前登录。</p>
<h3 id="15-1-8-如何分析本周回流用户？"><a class="header-anchor" href="#15-1-8-如何分析本周回流用户？">¶</a>15.1.8 如何分析本周回流用户？</h3>
<p>本周活跃left join本周新增 left<br>
join上周活跃，且本周新增id和上周活跃id都为null</p>
<h3 id="15-1-9-如何分析流失用户？"><a class="header-anchor" href="#15-1-9-如何分析流失用户？">¶</a>15.1.9 如何分析流失用户？</h3>
<p>按照设备id对日活表分组，且七天内没有登录过。</p>
<h3 id="15-1-10-如何分析最近连续3周活跃用户数？"><a class="header-anchor" href="#15-1-10-如何分析最近连续3周活跃用户数？">¶</a>15.1.10 如何分析最近连续3周活跃用户数？</h3>
<p>按照设备id对周活进行分组，统计次数等于3次。</p>
<h3 id="15-1-11-如何分析最近七天内连续三天活跃用户数？"><a class="header-anchor" href="#15-1-11-如何分析最近七天内连续三天活跃用户数？">¶</a>15.1.11 如何分析最近七天内连续三天活跃用户数？</h3>
<p>1）查询出最近7天的活跃用户，并对用户活跃日期进行排名</p>
<p>2）计算用户活跃日期及排名之间的差值</p>
<p>3）对同用户及差值分组，统计差值个数</p>
<p>4）将差值相同个数大于等于3的数据取出，然后去重，即为连续3天及以上活跃的用户</p>
<h3 id="15-1-12-整个文档中涉及的所有层级及表"><a class="header-anchor" href="#15-1-12-整个文档中涉及的所有层级及表">¶</a>15.1.12 整个文档中涉及的所有层级及表</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8H4vbq.png" class="" title="8H4vbq.png" loading="lazy">
<h2 id="15-2-Hive总结"><a class="header-anchor" href="#15-2-Hive总结">¶</a>15.2 Hive总结</h2>
<h3 id="15-2-1-Hive的架构"><a class="header-anchor" href="#15-2-1-Hive的架构">¶</a>15.2.1 Hive的架构</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8H5ErR.png" class="" title="8H5ErR.png" loading="lazy">
<h3 id="15-2-2-Hive和数据库比较"><a class="header-anchor" href="#15-2-2-Hive和数据库比较">¶</a>15.2.2 Hive和数据库比较</h3>
<p>Hive 和数据库除了拥有类似的查询语言，再无类似之处。</p>
<p>1）数据存储位置</p>
<p>Hive 存储在 HDFS 。数据库将数据保存在块设备或者本地文件系统中。</p>
<p>2）数据更新</p>
<p>Hive中不建议对数据的改写。而数据库中的数据通常是需要经常进行修改的，</p>
<p>3）执行延迟</p>
<p>Hive 执行延迟较高。数据库的执行延迟较低。当然，这个是有条件的，即数据规模较小，当数据规模大到超过数据库的处理能力的时候，Hive的并行计算显然能体现出优势。</p>
<p>4）数据规模</p>
<p>Hive支持很大规模的数据计算；数据库可以支持的数据规模较小。</p>
<h3 id="15-2-3-内部表和外部表"><a class="header-anchor" href="#15-2-3-内部表和外部表">¶</a>15.2.3 内部表和外部表</h3>
<p>1）管理表：当我们删除一个管理表时，Hive也会删除这个表中数据。管理表不适合和其他工具共享数据。</p>
<p>2）外部表：删除该表并不会删除掉原始数据，删除的是表的元数据</p>
<h3 id="15-2-4-4个By区别"><a class="header-anchor" href="#15-2-4-4个By区别">¶</a>15.2.4 4个By区别</h3>
<p>1）Sort By：分区内有序；</p>
<p>2）Order By：全局排序，只有一个Reducer；</p>
<p>3）Distrbute By：类似MR中Partition，进行分区，结合sort by使用。</p>
<p>4） Cluster By：当Distribute by和Sorts by字段相同时，可以使用Cluster<br>
by方式。Cluster by除了具有Distribute by的功能外还兼具Sort<br>
by的功能。但是排序只能是升序排序，不能指定排序规则为ASC或者DESC。</p>
<h3 id="15-2…5-窗口函数"><a class="header-anchor" href="#15-2…5-窗口函数">¶</a>15.2…5 窗口函数</h3>
<p><strong>1）窗口函数：</strong></p>
<p>（1） OVER()：指定分析函数工作的数据窗口大小，这个数据窗口大小可能会随着行的变而变化。常用partition<br>
by 分区order by排序。</p>
<p>（2）CURRENT ROW：当前行</p>
<p>（3）n PRECEDING：往前n行数据</p>
<p>（4） n FOLLOWING：往后n行数据</p>
<p>（5）UNBOUNDED：起点，UNBOUNDED PRECEDING 表示从前面的起点，<br>
UNBOUNDED FOLLOWING表示到后面的终点</p>
<p>（6） LAG(col,n)：往前第n行数据</p>
<p>（7）LEAD(col,n)：往后第n行数据</p>
<p>（8） NTILE(n)：把有序分区中的行分发到指定数据的组中，各个组有编号，编号从1开始，对于每一行，NTILE返回此行所属的组的编号。注意：n必须为int类型。</p>
<p><strong>2）排序函数：</strong></p>
<blockquote>
<p>（1）RANK() 排序相同时会重复，总数不会变</p>
<p>（2）DENSE_RANK() 排序相同时会重复，总数会减少</p>
<p>（3）ROW_NUMBER() 会根据顺序计算</p>
</blockquote>
<h3 id="15-2-6-在项目中是否自定义过UDF、UDTF函数，以及用他们处理了什么问题？"><a class="header-anchor" href="#15-2-6-在项目中是否自定义过UDF、UDTF函数，以及用他们处理了什么问题？">¶</a>15.2.6 在项目中是否自定义过UDF、UDTF函数，以及用他们处理了什么问题？</h3>
<p>1）自定义过。</p>
<p>2）用UDF函数解析公共字段；用UDTF函数解析事件字段。</p>
<p>3）自定义UDF步骤：定义一个类继承UDF，重写evaluate方法</p>
<p>4）自定义UDTF步骤：定义一个类继承GenericUDTF，重写初始化方法、关闭方法和process方法。</p>
<h3 id="15-2-7-Hive优化"><a class="header-anchor" href="#15-2-7-Hive优化">¶</a>,15.2.7 Hive优化</h3>
<ul>
<li><strong>1）MapJoin</strong></li>
</ul>
<p>如果不指定MapJoin或者不符合MapJoin的条件，那么Hive解析器会将Join操作转换成Common<br>
Join，即：在Reduce阶段完成join。容易发生数据倾斜。可以用MapJoin把小表全部加载到内存在map端进行join，避免reducer处理。</p>
<ul>
<li><strong>2）行列过滤</strong></li>
</ul>
<p>列处理：在SELECT中，只拿需要的列，如果有，尽量使用分区过滤，少用SELECT<br>
*。</p>
<p>行处理：在分区剪裁中，当使用外关联时，如果将副表的过滤条件写在Where后面，那么就会先全表关联，之后再过滤。</p>
<ul>
<li>
<p><strong>3）采用分桶技术</strong></p>
</li>
<li>
<p><strong>4）采用分区技术</strong></p>
</li>
<li>
<p><strong>5）合理设置Map数</strong></p>
</li>
</ul>
<p><strong>（1）通常情况下，作业会通过input的目录产生一个或者多个map任务。</strong></p>
<p>主要的决定因素有：input的文件总个数，input的文件大小，集群设置的文件块大小。</p>
<p><strong>（2）是不是map数越多越好？</strong></p>
<p>答案是否定的。如果一个任务有很多小文件（远远小于块大小128m），则每个小文件也会被当做一个块，用一个map任务来完成，而一个map任务启动和初始化的时间远远大于逻辑处理的时间，就会造成很大的资源浪费。而且，同时可执行的map数是受限的。</p>
<p><strong>（3）是不是保证每个map处理接近128m的文件块，就高枕无忧了？</strong></p>
<p>答案也是不一定。比如有一个127m的文件，正常会用一个map去完成，但这个文件只有一个或者两个小字段，却有几千万的记录，如果map处理的逻辑比较复杂，用一个map任务去做，肯定也比较耗时。</p>
<p>针对上面的问题2和3，我们需要采取两种方式来解决：即减少map数和增加map数；</p>
<ul>
<li><strong>6）小文件进行合并</strong></li>
</ul>
<p>在Map执行前合并小文件，减少Map数：CombineHiveInputFormat具有对小文件进行合并的功能（系统默认的格式）。HiveInputFormat没有对小文件合并功能。</p>
<ul>
<li><strong>7）合理设置Reduce数</strong></li>
</ul>
<p>Reduce个数并不是越多越好</p>
<p>（1）过多的启动和初始化Reduce也会消耗时间和资源；</p>
<p>（2）另外，有多少个Reduce，就会有多少个输出文件，如果生成了很多个小文件，那么如果这些小文件作为下一个任务的输入，则也会出现小文件过多的问题；</p>
<p>在设置Reduce个数的时候也需要考虑这两个原则：处理大数据量利用合适的Reduce数；使单个Reduce任务处理数据量大小要合适；</p>
<ul>
<li><strong>8）常用参数</strong></li>
</ul>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml">SET hive.merge.mapfiles = true; -- 默认true，在map-only任务结束时合并小文件
SET hive.merge.mapredfiles = true; -- 默认false，在map-reduce任务结束时合并小文件
SET hive.merge.size.per.task = 268435456; -- 默认256M
SET hive.merge.smallfiles.avgsize = 16777216; -- 当输出文件的平均大小小于该值时，启动一个独立的map-reduce任务进行文件merge<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>momo</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/" title="2用户行为数据仓库">https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2020/12/12/CollectionNote/big/spark/03_SparkSql/" rel="prev" title="SparkSQL"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">SparkSQL</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/" rel="next" title="3系统业务数据仓库"><span class="post-nav-text">3系统业务数据仓库</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> momo</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.7.0</span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div id="local-search-result"></div></div></div></body></html>