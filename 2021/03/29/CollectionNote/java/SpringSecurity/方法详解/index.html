<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="momo"><meta name="copyright" content="momo"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>security方法详解 | 我的笔记</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"ppxiaodi.gitee.io","root":"/","title":"momo的小站","version":"1.7.0","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><meta name="description" content="方法详解 ¶一、springboot security 自定义 AuthenticationEntryPoint 和 AccessDeineHandler 找了大半天的资料终于在国外的网站上找到了，相关问题，不过还好把security的认证流程和授权流程又重新看了遍： AuthenticationEntryPoint 用来解决匿名用户访问无权限资源时的异常 AccessDeineHandler 用">
<meta property="og:type" content="article">
<meta property="og:title" content="security方法详解">
<meta property="og:url" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="我的笔记">
<meta property="og:description" content="方法详解 ¶一、springboot security 自定义 AuthenticationEntryPoint 和 AccessDeineHandler 找了大半天的资料终于在国外的网站上找到了，相关问题，不过还好把security的认证流程和授权流程又重新看了遍： AuthenticationEntryPoint 用来解决匿名用户访问无权限资源时的异常 AccessDeineHandler 用">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-b16fef3e257325d4.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-f924a2057f2343ea.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-a962a6466fb011b7.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-3b639421d038e793.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-f19e3fa3e64eeb13.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-8c5d2b16d087db96.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-03f587cd988ee805.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-efa60ac5b3a14a86.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-4099df07d820862a.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-a3fe8277c35aa841.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-b91ad56aae06b4ec.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-30fbb2fa74e082d0.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-9183ec9e6ca3a652.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-19cadc7af6ac9a13.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-8ee459e52dfbc1ef.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-ef0a75ff270a3d0c.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-e3736042702b1194.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-a1bcd695b220088b.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/1313132-20190120155653707-1681055739.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/2018101317375330">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/image-20200907110057084.png">
<meta property="article:published_time" content="2021-03-28T16:00:00.000Z">
<meta property="article:modified_time" content="2021-07-11T08:54:53.884Z">
<meta property="article:author" content="momo">
<meta property="article:tag" content="SpringSecurity">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-b16fef3e257325d4.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="momo"><img width="96" loading="lazy" src="/yun.png" alt="momo"></a><div class="site-author-name"><a href="/about/">momo</a></div><a class="site-name" href="/about/site.html">我的笔记</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">198</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">58</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">47</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=kZJzggTTCf4SpvEQ8lXWoi5ZjhAx0ILZ&amp;jump_from=webapi" title="QQ 群 1050458482" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YunYouJun" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/jizhideyunyoujun" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/yunyoujun/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/yunyoujun/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/about/white-qrcode-and-search.jpg" title="微信公众号" target="_blank" style="color:#1AAD19"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-2-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/YunYouJun" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@yunyoujun.cn" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.link" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-train-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">方法详解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81springboot-security-%E8%87%AA%E5%AE%9A%E4%B9%89-AuthenticationEntryPoint-%E5%92%8C-AccessDeineHandler"><span class="toc-number">1.1.</span> <span class="toc-text">一、springboot security 自定义 AuthenticationEntryPoint 和 AccessDeineHandler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81WebSecurityConfigurerAdapter%E4%B8%8EResourceServerConfigurerAdapter"><span class="toc-number">1.2.</span> <span class="toc-text">二、WebSecurityConfigurerAdapter与ResourceServerConfigurerAdapter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#spring-security%E7%9A%84%E5%86%85%E9%83%A8filter%E6%98%AF%E4%B8%AA%E4%BB%80%E4%B9%88%E6%A0%B7%E5%AD%90%EF%BC%9F"><span class="toc-number">1.2.1.</span> <span class="toc-text">spring security的内部filter是个什么样子？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E5%90%8C%E6%97%B6%E5%9C%A8%E5%A4%84%E7%90%86%E5%90%8C%E4%B8%80%E4%B8%AAUrl%EF%BC%88%E5%A6%82%EF%BC%9A-api-%EF%BC%89%E5%BA%94%E8%AF%A5%E6%98%AF%E5%93%AA%E4%B8%AA%E7%94%9F%E6%95%88%EF%BC%9F"><span class="toc-number">1.2.2.</span> <span class="toc-text">如果同时在处理同一个Url（如：&#x2F;api&#x2F;**）应该是哪个生效？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%96%E4%BB%AC%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.2.3.</span> <span class="toc-text">他们之间的关系是什么？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Spring-Security-%E4%B9%8B-SecurityContext"><span class="toc-number">1.3.</span> <span class="toc-text">三、Spring Security 之 SecurityContext</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.3.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SecurityContext%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.3.2.</span> <span class="toc-text">SecurityContext接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Authentication%E6%8E%A5%E5%8F%A3%E5%8F%88%E6%98%AF%E5%B9%B2%E5%98%9B%E7%9A%84%EF%BC%9F"><span class="toc-number">1.3.3.</span> <span class="toc-text">Authentication接口又是干嘛的？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SecurityContextHolder%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">1.3.4.</span> <span class="toc-text">SecurityContextHolder工具类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E7%BB%93%E6%9D%9F%EF%BC%8CSecurityContext%E5%AD%98%E5%82%A8%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="toc-number">1.3.5.</span> <span class="toc-text">请求结束，SecurityContext存储在哪里？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E8%A7%86%E5%9B%BE"><span class="toc-number">1.3.6.</span> <span class="toc-text">流程视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SecurityContextPersistenceFilter%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">1.3.7.</span> <span class="toc-text">SecurityContextPersistenceFilter拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat%E5%BB%BA%E7%AB%8B%E4%BC%9A%E8%AF%9D%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.8.</span> <span class="toc-text">Tomcat建立会话的流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%A0%B8%E5%BF%83%E8%BF%87%E6%BB%A4%E5%99%A8Filter"><span class="toc-number">1.4.</span> <span class="toc-text">四、核心过滤器Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81WebAsyncManagerIntegrationFilter"><span class="toc-number">1.4.1.</span> <span class="toc-text">1、WebAsyncManagerIntegrationFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81SecurityContextPersistenceFilter"><span class="toc-number">1.4.2.</span> <span class="toc-text">2、SecurityContextPersistenceFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81HeaderWriterFilter"><span class="toc-number">1.4.3.</span> <span class="toc-text">3、HeaderWriterFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81LogoutFilter"><span class="toc-number">1.4.4.</span> <span class="toc-text">4、LogoutFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81UsernamePasswordAuthenticationFilter"><span class="toc-number">1.4.5.</span> <span class="toc-text">5、UsernamePasswordAuthenticationFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81DefaultLoginPageGeneratingFilter"><span class="toc-number">1.4.6.</span> <span class="toc-text">6、DefaultLoginPageGeneratingFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81BasicAuthenticationFilter"><span class="toc-number">1.4.7.</span> <span class="toc-text">7、BasicAuthenticationFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81RequestCacheAwareFilter"><span class="toc-number">1.4.8.</span> <span class="toc-text">8、RequestCacheAwareFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81SecurityContextHolderAwareRequestFilter"><span class="toc-number">1.4.9.</span> <span class="toc-text">9、SecurityContextHolderAwareRequestFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81AnonymousAuthenticationFilter"><span class="toc-number">1.4.10.</span> <span class="toc-text">10、AnonymousAuthenticationFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%E3%80%81SessionManagementFilter"><span class="toc-number">1.4.11.</span> <span class="toc-text">11、SessionManagementFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12%E3%80%81ExceptionTranslationFilter"><span class="toc-number">1.4.12.</span> <span class="toc-text">12、ExceptionTranslationFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13%E3%80%81FilterSecurityInterceptor"><span class="toc-number">1.4.13.</span> <span class="toc-text">13、FilterSecurityInterceptor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flux-security%E8%BF%87%E6%BB%A4%E9%93%BE"><span class="toc-number">1.5.</span> <span class="toc-text">Flux security过滤链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ServerWebExchangeReactorContextWebFilter"><span class="toc-number">1.5.1.</span> <span class="toc-text">ServerWebExchangeReactorContextWebFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpHeaderWriterWebFilter"><span class="toc-number">1.5.2.</span> <span class="toc-text">HttpHeaderWriterWebFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReactorContextWebFilter"><span class="toc-number">1.5.3.</span> <span class="toc-text">ReactorContextWebFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AuthenticationWebFilter"><span class="toc-number">1.5.4.</span> <span class="toc-text">AuthenticationWebFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SecurityContextServerWebExchangeWebFilter"><span class="toc-number">1.5.5.</span> <span class="toc-text">SecurityContextServerWebExchangeWebFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ServerRequestCacheWebFilter"><span class="toc-number">1.5.6.</span> <span class="toc-text">ServerRequestCacheWebFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LogoutWebFilter"><span class="toc-number">1.5.7.</span> <span class="toc-text">LogoutWebFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ExceptionTranslationWebFilter"><span class="toc-number">1.5.8.</span> <span class="toc-text">ExceptionTranslationWebFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AuthorizationWebFilter"><span class="toc-number">1.5.9.</span> <span class="toc-text">AuthorizationWebFilter</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="momo"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="我的笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">security方法详解</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2021-03-29 00:00:00" itemprop="dateCreated datePublished" datetime="2021-03-29T00:00:00+08:00">2021-03-29</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-07-11 16:54:53" itemprop="dateModified" datetime="2021-07-11T16:54:53+08:00">2021-07-11</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/java/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">java</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/java/SpringSecurity/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">SpringSecurity</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/SpringSecurity/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">SpringSecurity</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h1>方法详解</h1>
<h2 id="一、springboot-security-自定义-AuthenticationEntryPoint-和-AccessDeineHandler"><a class="header-anchor" href="#一、springboot-security-自定义-AuthenticationEntryPoint-和-AccessDeineHandler">¶</a>一、springboot security 自定义 AuthenticationEntryPoint 和 AccessDeineHandler</h2>
<p>找了大半天的资料终于在国外的网站上找到了，相关问题，不过还好把security的认证流程和授权流程又重新看了遍：<br>
AuthenticationEntryPoint 用来解决匿名用户访问无权限资源时的异常</p>
<p>AccessDeineHandler 用来解决认证过的用户访问无权限资源时的异常</p>
<p>配置类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyWebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">BCryptPasswordEncoder</span> bCryptPasswordEncoder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        http<span class="token punctuation">.</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/user/sign"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JWTLoginFilter</span><span class="token punctuation">(</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JwtAuthenticationFilter</span><span class="token punctuation">(</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//添加自定义异常入口，处理accessdeine异常</span>
        http<span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomAuthenticationEntryPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">accessDeniedHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomAccessDeineHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span>bCryptPasswordEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之后，自定义AuthenticationEntryPoint的实现类:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationEntryPoint</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>panku<span class="token punctuation">.</span>common<span class="token punctuation">.</span>domain<span class="token punctuation">.</span></span><span class="token class-name">RestMsg</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomAuthenticationEntryPoint</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationEntryPoint</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commence</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
            <span class="token class-name">AuthenticationException</span> authException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
        response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/javascript;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token class-name">RestMsg</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"没有访问权限!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>自定义，AccessDeineHandler：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span></span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>access<span class="token punctuation">.</span></span><span class="token class-name">AccessDeniedHandler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>panku<span class="token punctuation">.</span>common<span class="token punctuation">.</span>domain<span class="token punctuation">.</span></span><span class="token class-name">RestMsg</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomAccessDeineHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AccessDeniedHandler</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
            <span class="token class-name">AccessDeniedException</span> accessDeniedException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
        response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/javascript;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token class-name">RestMsg</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"没有访问权限!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="二、WebSecurityConfigurerAdapter与ResourceServerConfigurerAdapter"><a class="header-anchor" href="#二、WebSecurityConfigurerAdapter与ResourceServerConfigurerAdapter">¶</a>二、WebSecurityConfigurerAdapter与ResourceServerConfigurerAdapter</h2>
<p>我们在用spring boot 配合spring security和oauth2的时候经常会把这两个类都用上，网上很多教程都没有告诉我们他们之间的关系是什么？如果同时在处理同一个Url（如：/api/**）应该是哪个生效？spring security的内部filter是个什么样子？带着这些疑问我们一层层的来扒开。</p>
<h3 id="spring-security的内部filter是个什么样子？"><a class="header-anchor" href="#spring-security的内部filter是个什么样子？">¶</a>spring security的内部filter是个什么样子？</h3>
<p>Java在正常servelet处理http的请求可能会经过很多的filter，大体例子像下面这个：</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-b16fef3e257325d4.png" class="" title="img" loading="lazy">
<p>而spring security又是怎么处理的呢，详见下图：</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-f924a2057f2343ea.png" class="" title="img" loading="lazy">
<p>从图中可以看出spring security自己有一个叫<code>FilterChainProxy</code>代理<code>类，该类也实现了servlet接口。</code>FilterChainProxy``内部有一个List<SecurityFilterChain> filterChains,而SecurityFilterChain是一个接口也是一个chain，每个chain里有若干个filter.既然有多个filter chain，那么来了一个http请求，这个请求（通过该请求的url来判断）应该由哪个或者哪些filter chain来进行处理呢？在spring security里一个请只会被一个filter chain进行处理，也就是spring security通过遍历filterChains这个集合时，只要找到能处理该请求的filter chain就不再进行其他的filter chain匹配。如下图：`</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-a962a6466fb011b7.png" class="" title="img" loading="lazy">
<p>比如来了一个请求，url是：<code>/foo/**</code>，那么他会被会第一个filter chain处理，后面的两个filter chain会被忽略掉。`</p>
<p>当我们在spring boot引入了spring-security的相关包时，security默认会为我们创建一个默认WebSecurityConfigurerAdapter，他拦截所有的http请求(/**),且这个Order的值是：SecurityProperties.BASIC_AUTH_ORDER。Security默认还会为我们创建一些filter：</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-3b639421d038e793.png" class="" title="img" loading="lazy">
<p>每个filter的作用可以在spring security中文档中找到。</p>
<p>当然你可以通过配置文件设置<code>security.basic.enabled=false</code> <code>来让默认的失效，或者你可以自定义一个并添加@Order值更低的WebSecurityConfigurerAdapter</code> (or <code>WebSecurityConfigurer</code>) 的`@Bean``，比如像下面的代码：</p>
<pre class="line-numbers language-none"><code class="language-none">@Order(SecurityProperties.BASIC_AUTH_ORDER - 10)

public class ApplicationConfigurerAdapter extends WebSecurityConfigurerAdapter &#123;

 @Override

 protected void configure(HttpSecurity http) throws Exception &#123;

 http.antMatcher(&quot;&#x2F;foo&#x2F;**&quot;)

 ...;

 &#125;

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="如果同时在处理同一个Url（如：-api-）应该是哪个生效？"><a class="header-anchor" href="#如果同时在处理同一个Url（如：-api-）应该是哪个生效？">¶</a>如果同时在处理同一个Url（如：/api/**）应该是哪个生效？</h3>
<p>WebSecurityConfigurerAdapter与ResourceServerConfigurerAdapter同时在的话且都配置了处理url为：/api/**，默认是后者会生效。我们在写ResourceServerConfigurerAdapter时，基本上会这么写：</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-f19e3fa3e64eeb13.png" class="" title="img" loading="lazy">
<p>为什么是后者生效呢，因为默认的WebSecurityConfigurerAdapter里的@Order值是100（我们可以在该类上可以明确看到@Order(100)），而我们在ResourceServerConfigurerAdapter上添加了@EnableResourceServer注解，这个玩意儿是干什么用的呢？他其中之一就是定义了@Order值为3（该注解里引用了ResourceServerConfiguration，这个类里面定义了Order值）.在spring 的体系里Order值越小优先级越高，所以ResourceServerConfigurerAdapter优先级比另外一个更高，他会优先处理，而WebSecurityConfigurerAdapter会失效。</p>
<p>如果我们想让WebSecurityConfigurerAdapter比ResourceServerConfigurerAdapter优先级高的话，只须要让前者的@Order值比后者的@Order值更低就行了。</p>
<p>**注意：**我们每声明一个*Adapter类，都会产生一个filterChain。前面我们讲到一个request（匹配url）只能被一个filterChain处理，这就解释了为什么二者Adapter同时在的时候，前者默认为什么会失效的原因。我们可以在FilterChainProxy中的getFilters(HttpServletRequest request)方法中可以看到有哪些filter chain，并处理哪些url，例如：</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-8c5d2b16d087db96.png" class="" title="img" loading="lazy">
<p>a.如果我们通过这种方式配置的话，requestMatcher值为显示No fields to display:</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-03f587cd988ee805.png" class="" title="img" loading="lazy">
<p>b.如果通过这种方式配置的话，requestMatcher值为显示match到的url :/aa/**</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-efa60ac5b3a14a86.png" class="" title="img" loading="lazy">
<p>具体为什么，见下文。</p>
<h3 id="他们之间的关系是什么？"><a class="header-anchor" href="#他们之间的关系是什么？">¶</a>他们之间的关系是什么？</h3>
<p>他们所属的功能模块不同，前者spring security的，后者是spring security oauth2里的。他们都是Adapter，他们都会产生一个filter Chain，他们两者可以相互配合来对不同的Url进行权限控制。</p>
<p>但是，我们经常在写代码的时候经常会出现这种情况，当我们在做oauth2的时候，当把两个类同时放在项目的时候，都声明了对http url的不同处理，但是就是ResourceServerConfigurerAdapter会把的http配置信息完全被覆盖掉，最后形成了，所有的请求只会在ResourceServerConfigurerAdapter的fitler chain中处理，导致用户不知道这两者到底是怎么回事。</p>
<p>这其实是因为对spring security的配置不熟悉导致的，也就是<code>antMatcher()``和authorizeRequests().antMatchers()。</code></p>
<p>让我们看两个例子：</p>
<p>例1：</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-4099df07d820862a.png" class="" title="img" loading="lazy">
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-a3fe8277c35aa841.png" class="" title="img" loading="lazy">
<p>上面这个例子，本意是想/api/* 端点须要被认证且要有USER权限;/user/**的端点须要被认证，但是最终的结果是WebSecurityConfigurerAdapter相关的配置信息没生效。</p>
<p>我们使用postman来测试一下：</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-b91ad56aae06b4ec.png" class="" title="img" loading="lazy">
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-30fbb2fa74e082d0.png" class="" title="img" loading="lazy">
<p>从这结果我们可以看出来：/user/* 的端点没有被保护起来，/api/*的端点实际是被ResourceServerConfigurerAdapter产生的filter chain进行处理的。</p>
<p>这和我们想要的效果不一样呢，该怎么办呢，我们来看看例子2：</p>
<p>例2：</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-9183ec9e6ca3a652.png" class="" title="img" loading="lazy">
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-19cadc7af6ac9a13.png" class="" title="img" loading="lazy">
<p>postman测试：</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-8ee459e52dfbc1ef.png" class="" title="img" loading="lazy">
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-ef0a75ff270a3d0c.png" class="" title="img" loading="lazy">
<p>可以看出来/api/<em>的端点实际是被ResourceServerConfigurerAdapter产生的filter chain进行处理的。而/user/</em> 的端点也被保护起来，但是这次被处理的是由WebSecurityConfigurerAdapter产生的filter chain进行处理的。</p>
<p>让我们来看stackoverflow上的解释：</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-e3736042702b1194.png" class="" title="img" loading="lazy">
<p>大体意思就是<code>antMatcher()``是HttpSecurity的一个方法，他只告诉了Spring我只配置了一个我这个Adapter能处理哪个的url，</code>它与authorizeRequests()没有任何关系。</p>
<p>然后使用authorizeRequests().antMatchers()是告诉你在antMatchers()中指定的一个或多个路径,比如执行permitAll()或hasRole()。他们在第一个http.antMatcher()匹配时就会生效。</p>
<p>所以，WebSecurityConfigurerAdapter与ResourceServerConfigurerAdapter同时使用，其实和spring security的多个HttpSecurity配置是一样的，原理也差不多是一样的。</p>
<p>用官方的例子：</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/9676606-a1bcd695b220088b.png" class="" title="img" loading="lazy">
<p>1、按照正常的方式配置验证</p>
<p>2、创建一个包含 @Order的 WebSecurityConfigurerAdapter实例来指定哪一个 WebSecurityConfigurerAdapter应该被首先考虑。</p>
<p>3、 http.antMatcher表明这个 HttpSecurity 只适用于以 /api/开头的URL。</p>
<p>4、创建另一个 WebSecurityConfigurerAdapter实例。如果URL没有以 /api/开头，这个配置将会被使用。这个配置在 <code>ApiWebSecurityConfigurationAdapter</code> 之后生效，因为其含有一个 @Order值为1.没有 @Order默认是最后一个生效。</p>
<p>38人点赞</p>
<p><a href="">日记本</a></p>
<p>作者：water_lang<br>
链接：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/fe1194ca8ecd">https://www.jianshu.com/p/fe1194ca8ecd</a><br>
来源：简书<br>
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
<h2 id="三、Spring-Security-之-SecurityContext"><a class="header-anchor" href="#三、Spring-Security-之-SecurityContext">¶</a>三、<a target="_blank" rel="noopener" href="https://www.cnblogs.com/longfurcat/p/10293819.html">Spring Security 之 SecurityContext</a></h2>
<h3 id="前言"><a class="header-anchor" href="#前言">¶</a>前言</h3>
<p>本文主要整理一下SecurityContext的存储方式。</p>
<h3 id="SecurityContext接口"><a class="header-anchor" href="#SecurityContext接口">¶</a>SecurityContext接口</h3>
<p>顾名思义，安全上下文。即存储认证授权的相关信息，实际上就是存储&quot;<strong>当前用户</strong>&quot;账号信息和相关权限。这个接口只有两个方法，Authentication对象的getter、setter。</p>
<pre class="line-numbers language-none"><code class="language-none">package org.springframework.security.core.context;

import java.io.Serializable;
import org.springframework.security.core.Authentication;

public interface SecurityContext extends Serializable &#123;
    Authentication getAuthentication();

    void setAuthentication(Authentication var1);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Authentication接口又是干嘛的？"><a class="header-anchor" href="#Authentication接口又是干嘛的？">¶</a>Authentication接口又是干嘛的？</h3>
<p>注意：SecurityContext存储的Authentication对象是经过认证的，所以它会带有权限，它的getAuthorities()方法会返回相关权限。</p>
<pre class="line-numbers language-none"><code class="language-none">package org.springframework.security.core;

import java.io.Serializable;
import java.security.Principal;
import java.util.Collection;

public interface Authentication extends Principal, Serializable &#123;
    Collection&lt;? extends GrantedAuthority&gt; getAuthorities();

    Object getCredentials();

    Object getDetails();

    Object getPrincipal();

    boolean isAuthenticated();

    void setAuthenticated(boolean var1) throws IllegalArgumentException;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="SecurityContextHolder工具类"><a class="header-anchor" href="#SecurityContextHolder工具类">¶</a>SecurityContextHolder工具类</h3>
<p>前面说的&quot;<strong>当前用户</strong>&quot;实际上指的是当前这个请求所对应的用户，那么怎么知道当前用户是谁呢？由于一个请求从开始到结束都由一个线程处理，这个线程中途也不会去处理其他的请求。所以在这段时间内，相当于这个线程跟当前用户是一一对应的。SecurityContextHolder工具类就是把SecurityContext存储在当前线程中。</p>
<p>SecurityContextHolder可以用来设置和获取SecurityContext。它主要是给框架内部使用的，可以利用它获取当前用户的SecurityContext进行请求检查，和访问控制等。</p>
<p>在Web环境下，SecurityContextHolder是利用ThreadLocal来存储SecurityContext的。</p>
<h3 id="请求结束，SecurityContext存储在哪里？"><a class="header-anchor" href="#请求结束，SecurityContext存储在哪里？">¶</a><strong>请求结束，SecurityContext存储在哪里？</strong></h3>
<p>我们知道Sevlet中线程是被池化复用的，一旦处理完当前的请求，它可能马上就会被分配去处理其他的请求。而且也不能保证用户下次的请求会被分配到同一个线程。所以存在线程里面，请求一旦结束，就没了。如果没有保存，不是每次请求都要重新认证登录？想想看，如果没有权限框架我们是怎么处理的？</p>
<p>想到了吧，如果不用权限框架，我们一般是把认证结果存在Session中的。同理，它也把认证结果存储到Session了。</p>
<p>对应的Key是：“<strong>SPRING_SECURITY_CONTEXT</strong>”</p>
<h3 id="流程视图"><a class="header-anchor" href="#流程视图">¶</a>流程视图</h3>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/1313132-20190120155653707-1681055739.png" class="" title="img" loading="lazy">
<h3 id="SecurityContextPersistenceFilter拦截器"><a class="header-anchor" href="#SecurityContextPersistenceFilter拦截器">¶</a>SecurityContextPersistenceFilter拦截器</h3>
<p>SecurityContextPersistenceFilter是Security的拦截器，而且是拦截链中的第一个拦截器，请求来临时它会从HttpSession中把SecurityContext取出来，然后放入SecurityContextHolder。在所有拦截器都处理完成后，再把SecurityContext存入HttpSession，并清除SecurityContextHolder内的引用。</p>
<p>注：其中repo对象是HttpSessionSecurityContextRepository</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>FILTER_APPLIED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// ensure that filter is only applied once per request</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> debug <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>FILTER_APPLIED<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>forceEagerSessionCreation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug <span class="token operator">&amp;&amp;</span> session<span class="token punctuation">.</span><span class="token function">isNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Eagerly created session: "</span> <span class="token operator">+</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">HttpRequestResponseHolder</span> holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequestResponseHolder</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>
                response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//利用HttpSecurityContextRepository从HttpSesion中获取SecurityContext对象</span>
        <span class="token comment">//如果没有HttpSession，即浏览器第一次访问服务器，还没有产生会话。</span>
        <span class="token comment">//它会创建一个空的SecurityContext对象</span>
        <span class="token class-name">SecurityContext</span> contextBeforeChainExecution <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">loadContext</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//把SecurityContext放入到SecurityContextHolder中</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>contextBeforeChainExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//执行拦截链，这个链会逐层向下执行</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>
        <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span> 
            <span class="token comment">//当拦截器都执行完的时候把当前线程对应的SecurityContext从SecurityContextHolder中取出来</span>
            <span class="token class-name">SecurityContext</span> contextAfterChainExecution <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span>
                    <span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Crucial removal of SecurityContextHolder contents - do this before anything</span>
            <span class="token comment">// else.</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//利用HttpSecurityContextRepository把SecurityContext写入HttpSession</span>
            repo<span class="token punctuation">.</span><span class="token function">saveContext</span><span class="token punctuation">(</span>contextAfterChainExecution<span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    holder<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>FILTER_APPLIED<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"SecurityContextHolder now cleared, as request processing completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Tomcat建立会话的流程"><a class="header-anchor" href="#Tomcat建立会话的流程">¶</a>Tomcat建立会话的流程</h3>
<p>有人可能对Tomcat建立会话的流程还不熟悉，这里稍微整理一下。是这样的，当客户浏览器打开后第一次访问Tomcat服务器，Tomcat会创建一个HttpSesion对象，存入一个ConcurrentHashMap，Key是SessionId，Value就是HttpSession。然后请求完成后，在返回的报文中添加<strong>Set-Cookie：JSESSIONID=xxx</strong>，然后客户端浏览器会保存这个Cookie。当浏览器再次访问这个服务器的时候，都会带上这个Cookie。Tomcat接收到这个请求后，根据JSESSIONID把对应的HttpSession对象取出来，放入HttpSerlvetRequest对象里面。</p>
<p><strong>重点：</strong></p>
<p>1.HttpSession会一直存在服务端，实际上是存在运行内存中。除非Session过期 OR Tomcat奔溃 OR 服务器奔溃，否则会话信息不会消失。</p>
<p>2.如无特殊处理，Cookie JSESSIONID会在浏览器关闭的时候清除。</p>
<p>3.Tomcat中HttpSesion的默认过期时间为30分钟。</p>
<p>4.这些处理都在Security的拦截链之前完成。</p>
<p>——————————————————2019年1月21日更正——————————————</p>
<p>浏览器访问Web项目并不会创建Session，只有在编程调用request.getSession()方法后Session才会建立，浏览器才会有JSESSIONID的Cookie。</p>
<p>一般是认证成功后，调用getSession()（其实在这之前Session并不存在），获得Session对象，然后把信息存里面。</p>
<p>所以，一般的，在登录之前，你不管怎么访问网站，都不会建立会话。</p>
<h2 id="四、核心过滤器Filter"><a class="header-anchor" href="#四、核心过滤器Filter">¶</a>四、核心过滤器Filter</h2>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq924862077/article/details/83040564">https://blog.csdn.net/qq924862077/article/details/83040564</a></p>
</blockquote>
<p>当然配合Spring web的Filter注入实现，Spring Security提供了另外一个Filter的实现类FilterChainProxy，其对外包装了以下13个Filter，其实13个Filter是在接口SecurityFilterChain的实现类DefaultSecurityFilterChain中通过List保存的。</p>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/2018101317375330" class="" title="img" loading="lazy">
<p>接下来我们依次介绍一下这个13个Filter。</p>
<h3 id="1、WebAsyncManagerIntegrationFilter"><a class="header-anchor" href="#1、WebAsyncManagerIntegrationFilter">¶</a>1、WebAsyncManagerIntegrationFilter</h3>
<ul>
<li>根据请求封装获取WebAsyncManager</li>
<li>从WebAsyncManager获取/注册SecurityContextCallableProcessingInterceptor</li>
</ul>
<h3 id="2、SecurityContextPersistenceFilter"><a class="header-anchor" href="#2、SecurityContextPersistenceFilter">¶</a>2、SecurityContextPersistenceFilter</h3>
<p>两个主要职责：请求来临时，创建SecurityContext安全上下文信息，请求结束时清空SecurityContextHolder。</p>
<h3 id="3、HeaderWriterFilter"><a class="header-anchor" href="#3、HeaderWriterFilter">¶</a>3、HeaderWriterFilter</h3>
<p>用来给http响应添加一些Header,比如X-Frame-Options, X-XSS-Protection*，X-Content-Type-Options.</p>
<h3 id="4、LogoutFilter"><a class="header-anchor" href="#4、LogoutFilter">¶</a>4、LogoutFilter</h3>
<p>退出拦截器，退出的简单操作就是删除Session，根据Spring Security初始化配置的退出地址来匹配请求。</p>
<p>当判断请求是退出时，会调用LogoutHandler的logout删除session，具体实现在SecurityContextLogoutHandler的logout方法中。</p>
<h3 id="5、UsernamePasswordAuthenticationFilter"><a class="header-anchor" href="#5、UsernamePasswordAuthenticationFilter">¶</a>5、UsernamePasswordAuthenticationFilter</h3>
<p>用户名和密码校验Filter，是特别重要的一个Filter，我们会在用户登录验证博客中专门进行分析学习一下，当然这个Filter只会对配置的登录请求/login进行业务处理，其他请求不做任何业务处理，其处理逻辑在父类AbstractAuthenticationProcessingFilter中。</p>
<h3 id="6、DefaultLoginPageGeneratingFilter"><a class="header-anchor" href="#6、DefaultLoginPageGeneratingFilter">¶</a>6、DefaultLoginPageGeneratingFilter</h3>
<p>​     当是登录地址请求，登录失败请求或者登出请求则跳转到登录页面。</p>
<h3 id="7、BasicAuthenticationFilter"><a class="header-anchor" href="#7、BasicAuthenticationFilter">¶</a>7、BasicAuthenticationFilter</h3>
<p>​    处理BASIC authentication认证方式，简单理解和UsernamePasswordAuthenticationFilter类似，不过UsernamePasswordAuthenticationFilter是通过表单提交的，而Authorization认证方式是将用户名密码数据添加到请求header中罢了。</p>
<h3 id="8、RequestCacheAwareFilter"><a class="header-anchor" href="#8、RequestCacheAwareFilter">¶</a>8、RequestCacheAwareFilter</h3>
<p>内部维护了一个RequestCache，用于缓存request请求</p>
<h3 id="9、SecurityContextHolderAwareRequestFilter"><a class="header-anchor" href="#9、SecurityContextHolderAwareRequestFilter">¶</a>9、SecurityContextHolderAwareRequestFilter</h3>
<p>​    此过滤器对ServletRequest进行了一次包装，使得request具有更加丰富的API</p>
<h3 id="10、AnonymousAuthenticationFilter"><a class="header-anchor" href="#10、AnonymousAuthenticationFilter">¶</a>10、AnonymousAuthenticationFilter</h3>
<p>​      匿名身份过滤器，这个过滤器个人认为很重要，需要将它与UsernamePasswordAuthenticationFilter 放在一起比较理解，spring security为了兼容未登录的访问，也走了一套认证流程，只不过是一个匿名的身份。</p>
<h3 id="11、SessionManagementFilter"><a class="header-anchor" href="#11、SessionManagementFilter">¶</a>11、SessionManagementFilter</h3>
<p>​      和session相关的过滤器，内部维护了一个SessionAuthenticationStrategy，两者组合使用，常用来防止session-fixation protection attack，以及限制同一用户开启多个会话的数量</p>
<h3 id="12、ExceptionTranslationFilter"><a class="header-anchor" href="#12、ExceptionTranslationFilter">¶</a>12、ExceptionTranslationFilter</h3>
<p>​    ExceptionTranslationFilter异常转换过滤器位于整个springSecurityFilterChain的后方，用来转换整个链路中出现的异常，将其转化，顾名思义，转化以意味本身并不处理。一般其只处理两大类异常：AccessDeniedException访问异常和AuthenticationException认证异常。这个过滤器非常重要，因为它将Java中的异常和HTTP的响应连接在了一起，这样在处理异常时，我们不用考虑密码错误该跳到什么页面，账号锁定该如何，只需要关注自己的业务逻辑，抛出相应的异常便可。如果该过滤器检测到AuthenticationException，则将会交给内部的AuthenticationEntryPoint去处理，如果检测到AccessDeniedException，需要先判断当前用户是不是匿名用户，如果是匿名访问，则和前面一样运行AuthenticationEntryPoint，否则会委托给AccessDeniedHandler去处理，而AccessDeniedHandler的默认实现，是AccessDeniedHandlerImpl。所以ExceptionTranslationFilter内部的AuthenticationEntryPoint是至关重要的，顾名思义：认证的入口点。</p>
<h3 id="13、FilterSecurityInterceptor"><a class="header-anchor" href="#13、FilterSecurityInterceptor">¶</a>13、FilterSecurityInterceptor</h3>
<p>​    个人理解任务这个拦截器是Spring Security中最重要的，首先这个拦截器就是进行角色相关的处理，也是登录结果是否成功最后一个判断的拦截器，针对不需要认证和需要认证的请求会进行不同的验证处理，同样在登录博客中会对其做的功能进行详细的说明。</p>
<h2 id="Flux-security过滤链"><a class="header-anchor" href="#Flux-security过滤链">¶</a>Flux security过滤链</h2>
<img src="/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/image-20200907110057084.png" class="" title="image-20200907110057084" loading="lazy">
<h3 id="ServerWebExchangeReactorContextWebFilter"><a class="header-anchor" href="#ServerWebExchangeReactorContextWebFilter">¶</a>ServerWebExchangeReactorContextWebFilter</h3>
<h3 id="HttpHeaderWriterWebFilter"><a class="header-anchor" href="#HttpHeaderWriterWebFilter">¶</a>HttpHeaderWriterWebFilter</h3>
<h3 id="ReactorContextWebFilter"><a class="header-anchor" href="#ReactorContextWebFilter">¶</a>ReactorContextWebFilter</h3>
<h3 id="AuthenticationWebFilter"><a class="header-anchor" href="#AuthenticationWebFilter">¶</a>AuthenticationWebFilter</h3>
<h3 id="SecurityContextServerWebExchangeWebFilter"><a class="header-anchor" href="#SecurityContextServerWebExchangeWebFilter">¶</a>SecurityContextServerWebExchangeWebFilter</h3>
<h3 id="ServerRequestCacheWebFilter"><a class="header-anchor" href="#ServerRequestCacheWebFilter">¶</a>ServerRequestCacheWebFilter</h3>
<h3 id="LogoutWebFilter"><a class="header-anchor" href="#LogoutWebFilter">¶</a>LogoutWebFilter</h3>
<h3 id="ExceptionTranslationWebFilter"><a class="header-anchor" href="#ExceptionTranslationWebFilter">¶</a>ExceptionTranslationWebFilter</h3>
<h3 id="AuthorizationWebFilter"><a class="header-anchor" href="#AuthorizationWebFilter">¶</a>AuthorizationWebFilter</h3>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>momo</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/" title="security方法详解">https://ppxiaodi.gitee.io/2021/03/29/CollectionNote/java/SpringSecurity/%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/03/29/CollectionNote/java/SpringSecurity/Webflux%E9%85%8D%E7%BD%AEsecurity/" rel="prev" title="Webflux配置security"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">Webflux配置security</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/03/29/CollectionNote/java/mybatis/%E5%A4%A7%E4%BA%8E%E5%B0%8F%E4%BA%8E%E8%BD%AC%E4%B9%89/" rel="next" title="mybatis转义符"><span class="post-nav-text">mybatis转义符</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> momo</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.7.0</span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div id="local-search-result"></div></div></div></body></html>