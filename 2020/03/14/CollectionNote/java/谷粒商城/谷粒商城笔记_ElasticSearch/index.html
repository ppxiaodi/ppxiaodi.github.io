<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="momo"><meta name="copyright" content="momo"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>谷粒商城笔记_ElasticSearch | 我的笔记</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"ppxiaodi.gitee.io","root":"/","title":"momo的小站","version":"1.7.0","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><meta name="description" content="谷粒商城笔记_ElasticSearch  本文由 简悦 SimpRead 转码， 原文地址 blog.csdn.net  ¶文章目录    1. ELASTIC SEARCH   0、简介 1、安装 elastic search 2、初步检索   1）_CAT 2）索引一个文档 3）查看文档 4）更新文档_update 5）删除文档或索引 6）ES 的批量操作——bulk 7）样本测试数据">
<meta property="og:type" content="article">
<meta property="og:title" content="谷粒商城笔记_ElasticSearch">
<meta property="og:url" content="https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/index.html">
<meta property="og:site_name" content="我的笔记">
<meta property="og:description" content="谷粒商城笔记_ElasticSearch  本文由 简悦 SimpRead 转码， 原文地址 blog.csdn.net  ¶文章目录    1. ELASTIC SEARCH   0、简介 1、安装 elastic search 2、初步检索   1）_CAT 2）索引一个文档 3）查看文档 4）更新文档_update 5）删除文档或索引 6）ES 的批量操作——bulk 7）样本测试数据">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/ac324af45c240156678ec41f2100a590.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/748cb588db208b5899edcf3a78a5b778.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/b3ece1f65996373df86eaea4df3d9024.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/1e8d14f7a6577285b82dab75ee6e46cd.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/865ed8da7f1b642b750b7e44ff03f2d6.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/434a6047bf92fe12cf62440645e8900f.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/2058b8b9e4afc4ae93da433feab1c2a3.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/d00dd8ae618098bdeda1107b7d815138.png">
<meta property="article:published_time" content="2020-03-13T16:00:00.000Z">
<meta property="article:modified_time" content="2021-07-11T08:54:54.212Z">
<meta property="article:author" content="momo">
<meta property="article:tag" content="java">
<meta property="article:tag" content="谷粒商城">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/ac324af45c240156678ec41f2100a590.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="momo"><img width="96" loading="lazy" src="/yun.png" alt="momo"></a><div class="site-author-name"><a href="/about/">momo</a></div><a class="site-name" href="/about/site.html">我的笔记</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">198</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">58</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">47</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=kZJzggTTCf4SpvEQ8lXWoi5ZjhAx0ILZ&amp;jump_from=webapi" title="QQ 群 1050458482" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YunYouJun" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/jizhideyunyoujun" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/yunyoujun/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/yunyoujun/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/about/white-qrcode-and-search.jpg" title="微信公众号" target="_blank" style="color:#1AAD19"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-2-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/YunYouJun" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@yunyoujun.cn" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.link" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-train-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">谷粒商城笔记_ElasticSearch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95"><span class="toc-number">1.0.1.</span> <span class="toc-text">文章目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0%E3%80%81%E7%AE%80%E4%BB%8B"><span class="toc-number">1.0.2.</span> <span class="toc-text">0、简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%AE%89%E8%A3%85-elastic-search"><span class="toc-number">1.0.3.</span> <span class="toc-text">1、安装 elastic search</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%88%9D%E6%AD%A5%E6%A3%80%E7%B4%A2"><span class="toc-number">1.0.4.</span> <span class="toc-text">2、初步检索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89-CAT"><span class="toc-number">1.0.4.1.</span> <span class="toc-text">1）_CAT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E7%B4%A2%E5%BC%95%E4%B8%80%E4%B8%AA%E6%96%87%E6%A1%A3"><span class="toc-number">1.0.4.2.</span> <span class="toc-text">2）索引一个文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E6%9F%A5%E7%9C%8B%E6%96%87%E6%A1%A3"><span class="toc-number">1.0.4.3.</span> <span class="toc-text">3）查看文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%BC%89%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3-update"><span class="toc-number">1.0.4.4.</span> <span class="toc-text">4）更新文档_update</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%EF%BC%89%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3%E6%88%96%E7%B4%A2%E5%BC%95"><span class="toc-number">1.0.4.5.</span> <span class="toc-text">5）删除文档或索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%EF%BC%89ES-%E7%9A%84%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E2%80%94%E2%80%94bulk"><span class="toc-number">1.0.4.6.</span> <span class="toc-text">6）ES 的批量操作——bulk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%EF%BC%89%E6%A0%B7%E6%9C%AC%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="toc-number">1.0.4.7.</span> <span class="toc-text">7）样本测试数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%BF%9B%E9%98%B6%E6%A3%80%E7%B4%A2"><span class="toc-number">1.0.5.</span> <span class="toc-text">3、进阶检索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89search-Api"><span class="toc-number">1.0.5.1.</span> <span class="toc-text">1）search Api</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89Query-DSL"><span class="toc-number">1.0.5.2.</span> <span class="toc-text">2）Query DSL</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.0.5.2.1.</span> <span class="toc-text">（1）基本语法格式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E8%BF%94%E5%9B%9E%E9%83%A8%E5%88%86%E5%AD%97%E6%AE%B5"><span class="toc-number">1.0.5.2.2.</span> <span class="toc-text">（2）返回部分字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89match-%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.0.5.2.3.</span> <span class="toc-text">（3）match 匹配查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%884%EF%BC%89-match-phrase-%E7%9F%AD%E5%8F%A5%E5%8C%B9%E9%85%8D"><span class="toc-number">1.0.5.2.4.</span> <span class="toc-text">（4） match_phrase [短句匹配]</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%885%EF%BC%89multi-math%E3%80%90%E5%A4%9A%E5%AD%97%E6%AE%B5%E5%8C%B9%E9%85%8D%E3%80%91"><span class="toc-number">1.0.5.2.5.</span> <span class="toc-text">（5）multi_math【多字段匹配】</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%886%EF%BC%89bool-%E7%94%A8%E6%9D%A5%E5%81%9A%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.0.5.2.6.</span> <span class="toc-text">（6）bool 用来做复合查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%887%EF%BC%89Filter%E3%80%90%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4%E3%80%91"><span class="toc-number">1.0.5.2.7.</span> <span class="toc-text">（7）Filter【结果过滤】</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%888%EF%BC%89term"><span class="toc-number">1.0.5.2.8.</span> <span class="toc-text">（8）term</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%889%EF%BC%89Aggregation%EF%BC%88%E8%81%9A%E5%90%88%EF%BC%89"><span class="toc-number">1.0.5.2.9.</span> <span class="toc-text">（9）Aggregation（聚合）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AD%90%E8%81%9A%E5%90%88"><span class="toc-number">1.0.5.2.9.1.</span> <span class="toc-text">子聚合</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#nested-%E5%AF%B9%E8%B1%A1%E8%81%9A%E5%90%88"><span class="toc-number">1.0.5.2.10.</span> <span class="toc-text">nested 对象聚合</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89Mapping"><span class="toc-number">1.0.5.3.</span> <span class="toc-text">3）Mapping</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.0.5.3.1.</span> <span class="toc-text">（1）字段类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E6%98%A0%E5%B0%84"><span class="toc-number">1.0.5.3.2.</span> <span class="toc-text">（2）映射</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E6%96%B0%E7%89%88%E6%9C%AC%E6%94%B9%E5%8F%98"><span class="toc-number">1.0.5.3.3.</span> <span class="toc-text">（3）新版本改变</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84-PUT-my-index"><span class="toc-number">1.0.5.3.3.1.</span> <span class="toc-text">创建映射 PUT &#x2F;my_index</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84-GET-my-index"><span class="toc-number">1.0.5.3.3.2.</span> <span class="toc-text">查看映射 GET &#x2F;my_index</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E5%AD%97%E6%AE%B5%E6%98%A0%E5%B0%84-my-index-mapping"><span class="toc-number">1.0.5.3.3.3.</span> <span class="toc-text">添加新的字段映射 &#x2F; my_index&#x2F;_mapping</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%8D%E8%83%BD%E6%9B%B4%E6%96%B0%E6%98%A0%E5%B0%84"><span class="toc-number">1.0.5.3.3.4.</span> <span class="toc-text">不能更新映射</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="toc-number">1.0.5.3.3.5.</span> <span class="toc-text">数据迁移</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%BC%89%E5%88%86%E8%AF%8D"><span class="toc-number">1.0.5.4.</span> <span class="toc-text">4）分词</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E5%AE%89%E8%A3%85ik%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">1.0.5.4.1.</span> <span class="toc-text">（1）安装ik分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1%EF%BC%89%E6%9F%A5%E7%9C%8B-elasticsearch-%E7%89%88%E6%9C%AC%E5%8F%B7%EF%BC%9A"><span class="toc-number">1.0.5.4.1.1.</span> <span class="toc-text">1）查看 elasticsearch 版本号：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2%EF%BC%89%E8%BF%9B%E5%85%A5-es-%E5%AE%B9%E5%99%A8%E5%86%85%E9%83%A8-plugin-%E7%9B%AE%E5%BD%95"><span class="toc-number">1.0.5.4.1.2.</span> <span class="toc-text">2）进入 es 容器内部 plugin 目录</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">1.0.5.4.2.</span> <span class="toc-text">（2）测试分词器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%8D%E5%BA%93"><span class="toc-number">1.0.5.4.3.</span> <span class="toc-text">（3）自定义词库</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81elasticsearch-Rest-Client"><span class="toc-number">1.0.6.</span> <span class="toc-text">4、elasticsearch-Rest-Client</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%899300-TCP"><span class="toc-number">1.0.6.1.</span> <span class="toc-text">1）9300: TCP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%899200-HTTP"><span class="toc-number">1.0.6.2.</span> <span class="toc-text">2）9200: HTTP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E9%99%84%E5%BD%95%EF%BC%9A%E5%AE%89%E8%A3%85-Nginx"><span class="toc-number">1.0.7.</span> <span class="toc-text">5、附录：安装 Nginx</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringBoot-%E6%95%B4%E5%90%88-ElasticSearch"><span class="toc-number">1.1.</span> <span class="toc-text">SpringBoot 整合 ElasticSearch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">1.1.1.</span> <span class="toc-text">1、导入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="toc-number">1.1.2.</span> <span class="toc-text">2、编写测试类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E6%B5%8B%E8%AF%95%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">1）测试保存数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E6%B5%8B%E8%AF%95%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">2）测试获取数据</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%8A%E6%A3%80%E7%B4%A2%E7%BB%93%E6%9E%9C%E5%B0%81%E8%A3%85%E4%B8%BA-java-bean"><span class="toc-number">1.1.2.2.1.</span> <span class="toc-text">把检索结果封装为 java bean</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%A3%80%E7%B4%A2%E5%88%B0%E7%9A%84%E5%88%86%E6%9E%90%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.2.2.2.</span> <span class="toc-text">获取检索到的分析信息</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#product-es-%E5%87%86%E5%A4%87"><span class="toc-number">1.2.</span> <span class="toc-text">product-es 准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-sku-%E5%9C%A8-es-%E4%B8%AD%E5%A6%82%E4%BD%95%E5%AD%98%E5%82%A8"><span class="toc-number">1.2.1.</span> <span class="toc-text">分析 sku 在 es 中如何存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B-product-%E7%B4%A2%E5%BC%95"><span class="toc-number">1.2.2.</span> <span class="toc-text">建立 product 索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nested-%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.2.3.</span> <span class="toc-text">nested 嵌入式对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#product-java-%E5%AE%9E%E6%88%98"><span class="toc-number">1.3.</span> <span class="toc-text">product-java 实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81VO-%E4%B8%8E-url"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">1、VO 与 url</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#search-%E7%BB%93%E6%9E%9C-VO"><span class="toc-number">1.3.0.1.1.</span> <span class="toc-text">search 结果 VO</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81ES-%E8%AF%AD%E5%8F%A5-DSL"><span class="toc-number">1.3.1.</span> <span class="toc-text">2、ES 语句 DSL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%A3%80%E7%B4%A2%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.2.</span> <span class="toc-text">3、检索代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%AF%B7%E6%B1%82%E5%B1%82"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">1) 请求层</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DSL-%E8%BD%AC-java"><span class="toc-number">1.3.2.1.1.</span> <span class="toc-text">DSL 转 java</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%8E%A5%E6%94%B6%E6%A3%80%E7%B4%A2%E5%93%8D%E5%BA%94"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2) 接收检索响应</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E9%A1%B5%E9%9D%A2%E6%95%88%E6%9E%9C"><span class="toc-number">1.3.3.</span> <span class="toc-text">检索页面效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">1) 基本数据渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%AD%9B%E9%80%89%E6%9D%A1%E4%BB%B6%E6%B8%B2%E6%9F%93"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">2) 筛选条件渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%86%E9%A1%B5%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">3) 分页数据渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E9%A1%B5%E9%9D%A2%E6%8E%92%E5%BA%8F%E5%92%8C%E4%BB%B7%E6%A0%BC%E5%8C%BA%E9%97%B4"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">4) 页面排序和价格区间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E9%9D%A2%E5%8C%85%E5%B1%91%E5%AF%BC%E8%88%AA"><span class="toc-number">1.3.3.5.</span> <span class="toc-text">5) 面包屑导航</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E6%9D%A1%E4%BB%B6%E7%AD%9B%E9%80%89%E8%81%94%E5%8A%A8"><span class="toc-number">1.3.3.6.</span> <span class="toc-text">6) 条件筛选联动</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="momo"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="我的笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">谷粒商城笔记_ElasticSearch</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2020-03-14 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-14T00:00:00+08:00">2020-03-14</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-07-11 16:54:54" itemprop="dateModified" datetime="2021-07-11T16:54:54+08:00">2021-07-11</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/java/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">java</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">谷粒商城</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/java/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">java</span></a><a class="tag-item" href="/tags/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">谷粒商城</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h1>谷粒商城笔记_ElasticSearch</h1>
<blockquote>
<p>本文由 <a target="_blank" rel="noopener" href="http://ksria.com/simpread/">简悦 SimpRead</a> 转码， 原文地址 <a target="_blank" rel="noopener" href="https://blog.csdn.net/hancoder/article/details/113922398">blog.csdn.net</a></p>
</blockquote>
<h3 id="文章目录"><a class="header-anchor" href="#文章目录">¶</a>文章目录</h3>
<ul>
<li>
<ul>
<li><a href="#1_ELASTIC_SEARCH_3">1. ELASTIC SEARCH</a></li>
<li>
<ul>
<li><a href="#0_5">0、简介</a></li>
<li><a href="#1elastic_search_69">1、安装 elastic search</a></li>
<li><a href="#2_205">2、初步检索</a></li>
<li>
<ul>
<li><a href="#1_CAT_207">1）_CAT</a></li>
<li><a href="#2_253">2）索引一个文档</a></li>
<li><a href="#3_386">3）查看文档</a></li>
<li><a href="#4_update_474">4）更新文档_update</a></li>
<li><a href="#5_568">5）删除文档或索引</a></li>
<li><a href="#6ESbulk_664">6）ES 的批量操作——bulk</a></li>
<li><a href="#7_848">7）样本测试数据</a></li>
</ul>
</li>
<li><a href="#3_883">3、进阶检索</a></li>
<li>
<ul>
<li><a href="#1search_Api_885">1）search Api</a></li>
<li><a href="#2Query_DSL_942">2）Query DSL</a></li>
<li>
<ul>
<li><a href="#1_946">（1）基本语法格式</a></li>
<li><a href="#2_998">（2）返回部分字段</a></li>
<li><a href="#3match_1057">（3）match 匹配查询</a></li>
<li><a href="#4_match_phrase__1198">（4） match_phrase [短句匹配]</a></li>
<li><a href="#5multi_math_1421">（5）multi_math【多字段匹配】</a></li>
<li><a href="#6bool_1543">（6）bool 用来做复合查询</a></li>
<li><a href="#7Filter_1839">（7）Filter【结果过滤】</a></li>
<li><a href="#8term_2022">（8）term</a></li>
<li><a href="#9Aggregation_2100">（9）Aggregation（聚合）</a></li>
<li>
<ul>
<li><a href="#_2205">子聚合</a></li>
</ul>
</li>
<li><a href="#nested_2516">nested 对象聚合</a></li>
</ul>
</li>
<li><a href="#3Mapping_2541">3）Mapping</a></li>
<li>
<ul>
<li><a href="#1_2545">（1）字段类型</a></li>
<li><a href="#2_2602">（2）映射</a></li>
<li><a href="#3_2724">（3）新版本改变</a></li>
<li>
<ul>
<li><a href="#PUT_my_index_2755">创建映射 PUT /my_index</a></li>
<li><a href="#GET_my_index_2792">查看映射 GET /my_index</a></li>
<li><a href="#my_index_mapping_2841">添加新的字段映射 / my_index/_mapping</a></li>
<li><a href="#_2857">不能更新映射</a></li>
<li><a href="#_2861">数据迁移</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4_3070">4）分词</a></li>
<li>
<ul>
<li><a href="#1ik_3138">（1）安装 <code>ik 分词器 </code></a></li>
<li>
<ul>
<li><a href="#1elasticsearch_3153">1）查看 elasticsearch 版本号：</a></li>
<li><a href="#2esplugin_3178">2）进入 es 容器内部 plugin 目录</a></li>
</ul>
</li>
<li><a href="#2_3216">（2）测试分词器</a></li>
<li><a href="#3_3369">（3）自定义词库</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4elasticsearchRestClient_3479">4、elasticsearch-Rest-Client</a></li>
<li>
<ul>
<li><a href="#19300_TCP_3483">1）9300: TCP</a></li>
<li><a href="#29200_HTTP_3489">2）9200: HTTP</a></li>
</ul>
</li>
<li><a href="#5Nginx_3506">5、附录：安装 Nginx</a></li>
</ul>
</li>
<li><a href="#SpringBootElasticSearch_3566">SpringBoot 整合 ElasticSearch</a></li>
<li>
<ul>
<li><a href="#1_3572">1、导入依赖</a></li>
<li><a href="#2_3614">2、编写测试类</a></li>
<li>
<ul>
<li><a href="#1_3616">1）测试保存数据</a></li>
<li><a href="#2_3649">2）测试获取数据</a></li>
<li>
<ul>
<li><a href="#java_bean_3720">把检索结果封装为 java bean</a></li>
<li><a href="#_3743">获取检索到的分析信息</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#productes_3789">product-es 准备</a></li>
<li>
<ul>
<li><a href="#skues_3800">分析 sku 在 es 中如何存储</a></li>
<li><a href="#product_3854">== 建立 product 索引 ==</a></li>
<li><a href="#nested_3914">nested 嵌入式对象</a></li>
</ul>
</li>
<li><a href="#productjava_3934">product-java 实战</a></li>
<li>
<ul>
<li>
<ul>
<li><a href="#1VOurl_3952">1、VO 与 url</a></li>
<li>
<ul>
<li><a href="#searchVO_4008">search 结果 VO</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2ESDSL_4084">2、ES 语句 DSL</a></li>
<li><a href="#3_4194">3、检索代码</a></li>
<li>
<ul>
<li><a href="#1___4198">1) 请求层</a></li>
<li>
<ul>
<li><a href="#DSLjava_4235">DSL 转 java</a></li>
</ul>
</li>
<li><a href="#2__4351">2) 接收检索响应</a></li>
</ul>
</li>
<li><a href="#_4489">检索页面效果</a></li>
<li>
<ul>
<li><a href="#1___4491">1) 基本数据渲染</a></li>
<li><a href="#2__4546">2) 筛选条件渲染</a></li>
<li><a href="#3__4673">3) 分页数据渲染</a></li>
<li><a href="#4__4715">4) 页面排序和价格区间</a></li>
<li><a href="#5__4791">5) 面包屑导航</a></li>
<li><a href="#6__4840">6) 条件筛选联动</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol>
<li>ELASTIC SEARCH</li>
</ol>
<hr>
<h3 id="0、简介"><a class="header-anchor" href="#0、简介">¶</a>0、简介</h3>
<p>mysql 用作持久化存储，ES 用作检索</p>
<p>基本概念：</p>
<ol>
<li>index 索引</li>
</ol>
<p>动词：相当于 mysql 的 insert</p>
<p>名词：相当于 mysql 的 db</p>
<ol start="2">
<li>Type 类型</li>
</ol>
<p>在 index 中，可以定义一个或多个类型</p>
<p>类似于 mysql 的 table，每一种类型的数据放在一起</p>
<p>index 库 &gt; type 表 &gt; document 文档</p>
<ol start="3">
<li>Document 文档</li>
</ol>
<p>保存在某个 index 下，某种 type 的一个数据 document，文档是 json 格式的，document 就像是 mysql 中的某个 table 里面的内容。每一行对应的列叫属性</p>
<img src="/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/ac324af45c240156678ec41f2100a590.png" class="" loading="lazy">
<p>为什么 ES 搜索快？倒排索引</p>
<p>保存的记录</p>
<ul>
<li>红海行动</li>
<li>探索红海行动</li>
<li>红海特别行动</li>
<li>红海记录片</li>
<li>特工红海特别探索</li>
</ul>
<p>将内容分词就记录到索引中</p>
<table><thead><tr><th>词</th><th>记录</th></tr></thead><tbody><tr><td>红海</td><td>1,2,3,4,5</td></tr><tr><td>行动</td><td>1,2,3</td></tr><tr><td>探索</td><td>2,5</td></tr><tr><td>特别</td><td>3,5</td></tr><tr><td>纪录片</td><td>4,</td></tr><tr><td>特工</td><td>5</td></tr></tbody></table>
<p>检索：</p>
<p>1）、红海<strong>特工</strong>行动？查出后计算相关性得分：3 号记录命中了 2 次，且 3 号本身才有 3 个单词，2/3，所以 3 号最匹配<br>
2）、红海行动？</p>
<p>关系型数据库中两个数据表示是独立的，即使他们里面有相同名称的列也不影响使用，但 ES 中不是这样的。elasticsearch 是基于 Lucene 开发的搜索引擎，而 ES 中不同 type 下名称相同的 filed 最终在 Lucene 中的处理方式是一样的。</p>
<p>• 两个不同 type 下的两个 user_name，在 ES 同一个索引下其实被认为是同一个 filed，你必须在两个不同的 type 中定义相同的 filed 映射。否则，不同 type 中的相同字段名称就会在处理中出现冲突的情况，导致 Lucene 处理效率下降。<br>
• 去掉 type 就是为了提高 ES 处理数据的效率。<br>
• Elasticsearch 7.x<br>
• URL 中的 type 参数为可选。比如，索引一个文档不再要求提供文档类型。<br>
• Elasticsearch 8.x<br>
• 不再支持 URL 中的 type 参数。<br>
• 解决：将索引从多类型迁移到单类型，每种类型文档一个独立索引</p>
<h3 id="1、安装-elastic-search"><a class="header-anchor" href="#1、安装-elastic-search">¶</a>1、安装 elastic search</h3>
<p>dokcer 中安装 elastic search</p>
<p>（1）下载 ealastic search（存储和检索）和 kibana（可视化检索）</p>
<pre class="line-numbers language-none"><code class="language-none">docker pull elasticsearch:7.4.2
docker pull kibana:7.4.2
版本要统一<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>（2）配置</p>
<pre class="line-numbers language-none"><code class="language-none"># 将docker里的目录挂载到linux的&#x2F;mydata目录中
# 修改&#x2F;mydata就可以改掉docker里的
mkdir -p &#x2F;mydata&#x2F;elasticsearch&#x2F;config
mkdir -p &#x2F;mydata&#x2F;elasticsearch&#x2F;data

# es可以被远程任何机器访问
echo &quot;http.host: 0.0.0.0&quot; &gt;&#x2F;mydata&#x2F;elasticsearch&#x2F;config&#x2F;elasticsearch.yml

# 递归更改权限，es需要访问
chmod -R 777 &#x2F;mydata&#x2F;elasticsearch&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（3）启动 Elastic search</p>
<pre class="line-numbers language-none"><code class="language-none"># 9200是用户交互端口 9300是集群心跳端口
# -e指定是单阶段运行
# -e指定占用的内存大小，生产时可以设置32G
docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \
-e  &quot;discovery.type&#x3D;single-node&quot; \
-e ES_JAVA_OPTS&#x3D;&quot;-Xms64m -Xmx512m&quot; \
-v &#x2F;mydata&#x2F;elasticsearch&#x2F;config&#x2F;elasticsearch.yml:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;config&#x2F;elasticsearch.yml \
-v &#x2F;mydata&#x2F;elasticsearch&#x2F;data:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;data \
-v  &#x2F;mydata&#x2F;elasticsearch&#x2F;plugins:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;plugins \
-d elasticsearch:7.4.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>因为容器里的文件映射到了外面，所以删除容器和新建容器数据还在</p>
</blockquote>
<blockquote>
<p>第一次查 docker ps 启动了，第二次查的时候发现关闭了，docker logs elasticsearch</p>
<p><a target="_blank" rel="noopener" href="http://192.168.56.10:9200">http://192.168.56.10:9200</a></p>
<p>数据挂载到外面，但是访问权限不足</p>
<p>把 / mydata/elasticsearch 下文件夹的权限设置好，上面已经设置过了</p>
</blockquote>
<p>设置开机启动 elasticsearch</p>
<pre class="line-numbers language-none"><code class="language-none">docker update elasticsearch --restart&#x3D;always<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>遇到了更新阿里源也下载不下来 kibana 镜像的情况，先在别的网络下载下来后传到 vagrant 中</p>
<pre class="line-numbers language-none"><code class="language-none">docker save -o kibana.tar kibana:7.4.2 

docker load -i kibana.tar 

如何通过其他工具链接ssh

修改&#x2F;etc&#x2F;ssh&#x2F;sshd_config
修改 PasswordAuthentication yes

systemctl restart sshd.service  或 service sshd restart

连接192.168.56.10:22端口成功，用户名root，密码vagrant

也可以通过vagrant ssh-config查看ip和端口，此时是127.0.0.1:2222<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在安装离线 docker 镜像的时候还提示内存不足，看了下是因为外部挂载的内存也算在了 vagrant 中，即使外部删了很多文件，vagrant 中 df -h 硬盘占用率也不下降。我在外部删完文件后在内部又 rm -rf XXX 强行接触占用</p>
</blockquote>
<p>（4）启动 kibana：</p>
<pre class="line-numbers language-none"><code class="language-none">docker run --name kibana -e ELASTICSEARCH_HOSTS&#x3D;http:&#x2F;&#x2F;192.168.56.10:9200 -p 5601:5601 -d kibana:7.4.2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>设置开机启动 kibana</p>
<pre class="line-numbers language-none"><code class="language-none">docker update kibana  --restart&#x3D;always<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（5）测试</p>
<p>查看 elasticsearch 版本信息： <a target="_blank" rel="noopener" href="http://192.168.56.10:9200">http://192.168.56.10:9200</a></p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;name&quot;: &quot;66718a266132&quot;,
    &quot;cluster_name&quot;: &quot;elasticsearch&quot;,
    &quot;cluster_uuid&quot;: &quot;xhDnsLynQ3WyRdYmQk5xhQ&quot;,
    &quot;version&quot;: &#123;
        &quot;number&quot;: &quot;7.4.2&quot;,
        &quot;build_flavor&quot;: &quot;default&quot;,
        &quot;build_type&quot;: &quot;docker&quot;,
        &quot;build_hash&quot;: &quot;2f90bbf7b93631e52bafb59b3b049cb44ec25e96&quot;,
        &quot;build_date&quot;: &quot;2019-10-28T20:40:44.881551Z&quot;,
        &quot;build_snapshot&quot;: false,
        &quot;lucene_version&quot;: &quot;8.2.0&quot;,
        &quot;minimum_wire_compatibility_version&quot;: &quot;6.8.0&quot;,
        &quot;minimum_index_compatibility_version&quot;: &quot;6.0.0-beta1&quot;
    &#125;,
    &quot;tagline&quot;: &quot;You Know, for Search&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>显示 elasticsearch 节点信息 <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/_cat/nodes">http://192.168.56.10:9200/_cat/nodes</a></p>
<pre class="line-numbers language-none"><code class="language-none">127.0.0.1 14 99 25 0.29 0.40 0.22 dilm * 66718a266132

66718a266132代表上面的结点
*代表是主节点<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>访问 Kibana： <a target="_blank" rel="noopener" href="http://192.168.56.10:5601/app/kibana">http://192.168.56.10:5601/app/kibana</a></p>
<h3 id="2、初步检索"><a class="header-anchor" href="#2、初步检索">¶</a>2、初步检索</h3>
<h4 id="1）-CAT"><a class="header-anchor" href="#1）-CAT">¶</a>1）_CAT</h4>
<p>（1）<code>GET /_cat/nodes</code>：查看所有节点</p>
<p>如：<a target="_blank" rel="noopener" href="http://192.168.56.10:9200/_cat/nodes">http://192.168.56.10:9200/_cat/nodes</a></p>
<pre class="line-numbers language-none"><code class="language-none">127.0.0.1 12 97 3 0.00 0.01 0.05 dilm * 66718a266132

66718a266132代表结点
*代表是主节点<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>（2）<code>GET /_cat/health</code>：查看 es 健康状况</p>
<p>如： <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/_cat/health">http://192.168.56.10:9200/_cat/health</a></p>
<pre class="line-numbers language-none"><code class="language-none">1613741055 13:24:15 elasticsearch green 1 1 0 0 0 0 0 0 - 100.0%<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注：green 表示健康值正常</p>
<p>（3）<code>GET /_cat/master</code>：查看主节点</p>
<p>如： <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/_cat/master">http://192.168.56.10:9200/_cat/master</a></p>
<pre class="line-numbers language-none"><code class="language-none">089F76WwSaiJcO6Crk7MpA 127.0.0.1 127.0.0.1 66718a266132

主节点唯一编号
虚拟机地址<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>（4）<code>GET/_cat/indicies</code>：查看所有索引 ，等价于 mysql 数据库的 show databases;</p>
<p>如：<a target="_blank" rel="noopener" href="http://192.168.56.10:9200/_cat/indices">http://192.168.56.10:9200/_cat/indices</a></p>
<pre class="line-numbers language-none"><code class="language-none">green  open .kibana_task_manager_1   DhtDmKrsRDOUHPJm1EFVqQ 1 0 2 3 40.8kb 40.8kb
green  open .apm-agent-configuration vxzRbo9sQ1SvMtGkx6aAHQ 1 0 0 0   230b   230b
green  open .kibana_1                rdJ5pejQSKWjKxRtx-EIkQ 1 0 5 1 18.2kb 18.2kb

这3个索引是kibana创建的<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2）索引一个文档"><a class="header-anchor" href="#2）索引一个文档">¶</a>2）索引一个文档</h4>
<p>保存一个数据，保存在哪个索引的哪个类型下（哪张数据库哪张表下），保存时用唯一标识指定</p>
<pre class="line-numbers language-none"><code class="language-none">PUT customer&#x2F;external&#x2F;1
 
http:&#x2F;&#x2F;192.168.56.10:9200&#x2F;customer&#x2F;external&#x2F;1

在customer索引下的external类型下保存1号数据为<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">&#123;
 &quot;name&quot;:&quot;John Doe&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>PUT 和 POST 都可以</p>
<ul>
<li>POST 新增。如果不指定 id，会自动生成 id。指定 id 就会修改这个数据，并新增版本号；</li>
<li>PUT 可以新增也可以修改。<strong>PUT 必须指定 id</strong>；由于 PUT 需要指定 id，我们一般用来做修改操作，不指定 id 会报错。
<ul>
<li>唯一区分是 post 不指定 id 时永远为创建</li>
</ul>
</li>
</ul>
<p>下面是在 postman 中的测试数据：</p>
<img src="/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/748cb588db208b5899edcf3a78a5b778.png" class="" loading="lazy">
<p>创建数据成功后，显示 201 created 表示插入记录成功。</p>
<pre class="line-numbers language-none"><code class="language-none">返回数据：
带有下划线开头的，称为元数据，反映了当前的基本信息。  
&#123;
    &quot;_index&quot;: &quot;customer&quot;, 表明该数据在哪个数据库下；
    &quot;_type&quot;: &quot;external&quot;, 表明该数据在哪个类型下；
    &quot;_id&quot;: &quot;1&quot;,  表明被保存数据的id；
    &quot;_version&quot;: 1,  被保存数据的版本
    &quot;result&quot;: &quot;created&quot;, 这里是创建了一条数据，如果重新put一条数据，则该状态会变为updated，并且版本号也会发生变化。
    &quot;_shards&quot;: &#123;
        &quot;total&quot;: 2,
        &quot;successful&quot;: 1,
        &quot;failed&quot;: 0
    &#125;,
    &quot;_seq_no&quot;: 0,
    &quot;_primary_term&quot;: 1
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面选用 POST 方式：</p>
<p>添加数据的时候，<strong>不指定 ID</strong>，会自动的生成 id，并且类型是新增：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;_index&quot;: &quot;customer&quot;,
    &quot;_type&quot;: &quot;external&quot;,
    &quot;_id&quot;: &quot;5MIjvncBKdY1wAQm-wNZ&quot;,
    &quot;_version&quot;: 1,
    &quot;result&quot;: &quot;created&quot;,
    &quot;_shards&quot;: &#123;
        &quot;total&quot;: 2,
        &quot;successful&quot;: 1,
        &quot;failed&quot;: 0
    &#125;,
    &quot;_seq_no&quot;: 11,
    &quot;_primary_term&quot;: 6
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>再次使用 POST 插入数据，<strong>不指定 ID</strong>，仍然是新增的：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;_index&quot;: &quot;customer&quot;,
    &quot;_type&quot;: &quot;external&quot;,
    &quot;_id&quot;: &quot;5cIkvncBKdY1wAQmcQNk&quot;,
    &quot;_version&quot;: 1,
    &quot;result&quot;: &quot;created&quot;,
    &quot;_shards&quot;: &#123;
        &quot;total&quot;: 2,
        &quot;successful&quot;: 1,
        &quot;failed&quot;: 0
    &#125;,
    &quot;_seq_no&quot;: 12,
    &quot;_primary_term&quot;: 6
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>添加数据的时候，<strong>指定 ID</strong>，会使用该 id，并且类型是新增：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;_index&quot;: &quot;customer&quot;,
    &quot;_type&quot;: &quot;external&quot;,
    &quot;_id&quot;: &quot;2&quot;,
    &quot;_version&quot;: 1,
    &quot;result&quot;: &quot;created&quot;,
    &quot;_shards&quot;: &#123;
        &quot;total&quot;: 2,
        &quot;successful&quot;: 1,
        &quot;failed&quot;: 0
    &#125;,
    &quot;_seq_no&quot;: 13,
    &quot;_primary_term&quot;: 6
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>再次使用 POST 插入数据，<strong>指定同样的 ID</strong>，类型为 updated</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;_index&quot;: &quot;customer&quot;,
    &quot;_type&quot;: &quot;external&quot;,
    &quot;_id&quot;: &quot;2&quot;,
    &quot;_version&quot;: 2,
    &quot;result&quot;: &quot;updated&quot;,
    &quot;_shards&quot;: &#123;
        &quot;total&quot;: 2,
        &quot;successful&quot;: 1,
        &quot;failed&quot;: 0
    &#125;,
    &quot;_seq_no&quot;: 14,
    &quot;_primary_term&quot;: 6
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="3）查看文档"><a class="header-anchor" href="#3）查看文档">¶</a>3）查看文档</h4>
<p>GET /customer/external/1</p>
<p><a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1">http://192.168.56.10:9200/customer/external/1</a></p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;_index&quot;: &quot;customer&quot;,
    &quot;_type&quot;: &quot;external&quot;,
    &quot;_id&quot;: &quot;1&quot;,
    &quot;_version&quot;: 10,
    &quot;_seq_no&quot;: 18,&#x2F;&#x2F;并发控制字段，每次更新都会+1，用来做乐观锁
    &quot;_primary_term&quot;: 6,&#x2F;&#x2F;同上，主分片重新分配，如重启，就会变化
    &quot;found&quot;: true,
    &quot;_source&quot;: &#123;
        &quot;name&quot;: &quot;John Doe&quot;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过 “<code>if_seq_no=1&amp;if_primary_term=1</code>”，当序列号匹配的时候，才进行修改，否则不修改。</p>
<p>实例：将 id=1 的数据更新为 name=1，然后再次更新为 name=2，起始<code>1_seq_no=18，_primary_term=6</code></p>
<p>（1）将 name 更新为 1</p>
<p>PUT <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1?if_seq_no=18&amp;if_primary_term=6">http://192.168.56.10:9200/customer/external/1?if_seq_no=18&amp;if_primary_term=6</a></p>
<img src="/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/b3ece1f65996373df86eaea4df3d9024.png" class="" loading="lazy">
<p>（2）将 name 更新为 2，更新过程中使用 seq_no=18</p>
<p>PUT <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1?if_seq_no=18&amp;if_primary_term=6">http://192.168.56.10:9200/customer/external/1?if_seq_no=18&amp;if_primary_term=6</a></p>
<p>结果为：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;error&quot;: &#123;
        &quot;root_cause&quot;: [
            &#123;
                &quot;type&quot;: &quot;version_conflict_engine_exception&quot;,
                &quot;reason&quot;: &quot;[1]: version conflict, required seqNo [18], primary term [6]. current document has seqNo [19] and primary term [6]&quot;,
                &quot;index_uuid&quot;: &quot;mG9XiCQISPmfBAmL1BPqIw&quot;,
                &quot;shard&quot;: &quot;0&quot;,
                &quot;index&quot;: &quot;customer&quot;
            &#125;
        ],
        &quot;type&quot;: &quot;version_conflict_engine_exception&quot;,
        &quot;reason&quot;: &quot;[1]: version conflict, required seqNo [18], primary term [6]. current document has seqNo [19] and primary term [6]&quot;,
        &quot;index_uuid&quot;: &quot;mG9XiCQISPmfBAmL1BPqIw&quot;,
        &quot;shard&quot;: &quot;0&quot;,
        &quot;index&quot;: &quot;customer&quot;
    &#125;,
    &quot;status&quot;: 409
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>出现更新错误。</p>
<p>（3）查询新的数据</p>
<p>GET <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1">http://192.168.56.10:9200/customer/external/1</a></p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;_index&quot;: &quot;customer&quot;,
    &quot;_type&quot;: &quot;external&quot;,
    &quot;_id&quot;: &quot;1&quot;,
    &quot;_version&quot;: 11,
    &quot;_seq_no&quot;: 19,
    &quot;_primary_term&quot;: 6,
    &quot;found&quot;: true,
    &quot;_source&quot;: &#123;
        &quot;name&quot;: &quot;1&quot;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能够看到_seq_no 变为 19</p>
<p>（4）再次更新，更新成功</p>
<p>PUT <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1?if_seq_no=19&amp;if_primary_term=1">http://192.168.56.10:9200/customer/external/1?if_seq_no=19&amp;if_primary_term=1</a></p>
<h4 id="4）更新文档-update"><a class="header-anchor" href="#4）更新文档-update">¶</a>4）更新文档_update</h4>
<pre class="line-numbers language-none"><code class="language-none">POST customer&#x2F;externel&#x2F;1&#x2F;_update
&#123;
    &quot;doc&quot;:&#123;
        &quot;name&quot;:&quot;111&quot;
    &#125;
&#125;
或者
POST customer&#x2F;externel&#x2F;1
&#123;
    &quot;doc&quot;:&#123;
        &quot;name&quot;:&quot;222&quot;
    &#125;
&#125;
或者
PUT customer&#x2F;externel&#x2F;1
&#123;
    &quot;doc&quot;:&#123;
        &quot;name&quot;:&quot;222&quot;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不同：带有 update 情况下</p>
<ul>
<li>POST 操作会对比源文档数据，如果相同不会有什么操作，文档 version 不增加。</li>
<li>PUT 操作总会重新保存并增加 version 版本</li>
</ul>
<p>POST 时带<code>_update</code>对比元数据如果一样就不进行任何操作。</p>
<p>看场景：</p>
<ul>
<li>对于大并发更新，不带 update</li>
<li>对于大并发查询偶尔更新，带 update；对比更新，重新计算分配规则</li>
</ul>
<p>（1）POST 更新文档，带有_update</p>
<p><a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1/_update">http://192.168.56.10:9200/customer/external/1/_update</a></p>
<img src="/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/1e8d14f7a6577285b82dab75ee6e46cd.png" class="" loading="lazy">
<img src="/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/865ed8da7f1b642b750b7e44ff03f2d6.png" class="" loading="lazy">
<p>如果再次执行更新，则不执行任何操作，序列号也不发生变化</p>
<pre class="line-numbers language-none"><code class="language-none">返回
&#123;
    &quot;_index&quot;: &quot;customer&quot;,
    &quot;_type&quot;: &quot;external&quot;,
    &quot;_id&quot;: &quot;1&quot;,
    &quot;_version&quot;: 12,
    &quot;result&quot;: &quot;noop&quot;, &#x2F;&#x2F; 无操作
    &quot;_shards&quot;: &#123;
        &quot;total&quot;: 0,
        &quot;successful&quot;: 0,
        &quot;failed&quot;: 0
    &#125;,
    &quot;_seq_no&quot;: 20,
    &quot;_primary_term&quot;: 6
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>POST 更新方式，会对比原来的数据，和原来的相同，则不执行任何操作（version 和_seq_no）都不变。</p>
<p>（2）POST 更新文档，不带_update</p>
<p>在更新过程中，重复执行更新操作，数据也能够更新成功，不会和原来的数据进行对比。</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;_index&quot;: &quot;customer&quot;,
    &quot;_type&quot;: &quot;external&quot;,
    &quot;_id&quot;: &quot;1&quot;,
    &quot;_version&quot;: 13,
    &quot;result&quot;: &quot;updated&quot;,
    &quot;_shards&quot;: &#123;
        &quot;total&quot;: 2,
        &quot;successful&quot;: 1,
        &quot;failed&quot;: 0
    &#125;,
    &quot;_seq_no&quot;: 21,
    &quot;_primary_term&quot;: 6
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="5）删除文档或索引"><a class="header-anchor" href="#5）删除文档或索引">¶</a>5）删除文档或索引</h4>
<pre class="line-numbers language-none"><code class="language-none">DELETE customer&#x2F;external&#x2F;1
DELETE customer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>注：elasticsearch 并没有提供删除类型的操作，只提供了删除索引和文档的操作。</p>
<p>实例：删除 id=1 的数据，删除后继续查询</p>
<p>DELETE <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1">http://192.168.56.10:9200/customer/external/1</a></p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;_index&quot;: &quot;customer&quot;,
    &quot;_type&quot;: &quot;external&quot;,
    &quot;_id&quot;: &quot;1&quot;,
    &quot;_version&quot;: 14,
    &quot;result&quot;: &quot;deleted&quot;,
    &quot;_shards&quot;: &#123;
        &quot;total&quot;: 2,
        &quot;successful&quot;: 1,
        &quot;failed&quot;: 0
    &#125;,
    &quot;_seq_no&quot;: 22,
    &quot;_primary_term&quot;: 6
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>再次执行 DELETE <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1">http://192.168.56.10:9200/customer/external/1</a></p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;_index&quot;: &quot;customer&quot;,
    &quot;_type&quot;: &quot;external&quot;,
    &quot;_id&quot;: &quot;1&quot;,
    &quot;_version&quot;: 15,
    &quot;result&quot;: &quot;not_found&quot;,
    &quot;_shards&quot;: &#123;
        &quot;total&quot;: 2,
        &quot;successful&quot;: 1,
        &quot;failed&quot;: 0
    &#125;,
    &quot;_seq_no&quot;: 23,
    &quot;_primary_term&quot;: 6
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>GET <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1">http://192.168.56.10:9200/customer/external/1</a></p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;_index&quot;: &quot;customer&quot;,
    &quot;_type&quot;: &quot;external&quot;,
    &quot;_id&quot;: &quot;1&quot;,
    &quot;found&quot;: false
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实例：删除整个 costomer 索引数据</p>
<p>删除前，所有的索引 <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/_cat/indices">http://192.168.56.10:9200/_cat/indices</a></p>
<pre class="line-numbers language-none"><code class="language-none">green  open .kibana_task_manager_1   DhtDmKrsRDOUHPJm1EFVqQ 1 0 2 0 31.3kb 31.3kb
green  open .apm-agent-configuration vxzRbo9sQ1SvMtGkx6aAHQ 1 0 0 0   283b   283b
green  open .kibana_1                rdJ5pejQSKWjKxRtx-EIkQ 1 0 8 3 28.8kb 28.8kb
yellow open customer                 mG9XiCQISPmfBAmL1BPqIw 1 1 9 1  8.6kb  8.6kb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>删除 “customer” 索引</p>
<p>DELTE <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer">http://192.168.56.10:9200/customer</a></p>
<pre class="line-numbers language-none"><code class="language-none">响应
&#123;
    &quot;acknowledged&quot;: true
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>删除后，所有的索引 <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/_cat/indices">http://192.168.56.10:9200/_cat/indices</a></p>
<pre class="line-numbers language-none"><code class="language-none">green open .kibana_task_manager_1   DhtDmKrsRDOUHPJm1EFVqQ 1 0 2 0 31.3kb 31.3kb
green open .apm-agent-configuration vxzRbo9sQ1SvMtGkx6aAHQ 1 0 0 0   283b   283b
green open .kibana_1                rdJ5pejQSKWjKxRtx-EIkQ 1 0 8 3 28.8kb 28.8kb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="6）ES-的批量操作——bulk"><a class="header-anchor" href="#6）ES-的批量操作——bulk">¶</a>6）ES 的批量操作——bulk</h4>
<p>匹配导入数据</p>
<p>POST <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/_bulk">http://192.168.56.10:9200/customer/external/_bulk</a></p>
<pre class="line-numbers language-none"><code class="language-none">两行为一个整体
&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;
&#123;&quot;name&quot;:&quot;a&quot;&#125;
&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;
&#123;&quot;name&quot;:&quot;b&quot;&#125;
注意格式json和text均不可，要去kibana里Dev Tools<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>语法格式：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;action:&#123;metadata&#125;&#125;\n
&#123;request body  &#125;\n

&#123;action:&#123;metadata&#125;&#125;\n
&#123;request body  &#125;\n<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的批量操作，当发生某一条执行发生失败时，其他的数据仍然能够接着执行，也就是说彼此之间是独立的。</p>
<p>bulk api 以此按顺序执行所有的 action（动作）。如果一个单个的动作因任何原因失败，它将继续处理它后面剩余的动作。当 bulk api 返回时，它将提供每个动作的状态（与发送的顺序相同），所以您可以检查是否一个指定的动作是否失败了。</p>
<p>实例 1: 执行多条数据</p>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F;customer&#x2F;external&#x2F;_bulk
&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;
&#123;&quot;name&quot;:&quot;John Doe&quot;&#125;
&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;
&#123;&quot;name&quot;:&quot;John Doe&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行结果</p>
<pre class="line-numbers language-none"><code class="language-none">#! Deprecation: [types removal] Specifying types in bulk requests is deprecated.
&#123;
  &quot;took&quot; : 318,  花费了多少ms
  &quot;errors&quot; : false, 没有发生任何错误
  &quot;items&quot; : [ 每个数据的结果
    &#123;
      &quot;index&quot; : &#123; 保存
        &quot;_index&quot; : &quot;customer&quot;, 索引
        &quot;_type&quot; : &quot;external&quot;, 类型
        &quot;_id&quot; : &quot;1&quot;, 文档
        &quot;_version&quot; : 1, 版本
        &quot;result&quot; : &quot;created&quot;, 创建
        &quot;_shards&quot; : &#123;
          &quot;total&quot; : 2,
          &quot;successful&quot; : 1,
          &quot;failed&quot; : 0
        &#125;,
        &quot;_seq_no&quot; : 0,
        &quot;_primary_term&quot; : 1,
        &quot;status&quot; : 201 新建完成
      &#125;
    &#125;,
    &#123;
      &quot;index&quot; : &#123; 第二条记录
        &quot;_index&quot; : &quot;customer&quot;,
        &quot;_type&quot; : &quot;external&quot;,
        &quot;_id&quot; : &quot;2&quot;,
        &quot;_version&quot; : 1,
        &quot;result&quot; : &quot;created&quot;,
        &quot;_shards&quot; : &#123;
          &quot;total&quot; : 2,
          &quot;successful&quot; : 1,
          &quot;failed&quot; : 0
        &#125;,
        &quot;_seq_no&quot; : 1,
        &quot;_primary_term&quot; : 1,
        &quot;status&quot; : 201
      &#125;
    &#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实例 2：对于整个索引执行批量操作</p>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F;_bulk
&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;&#125;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;&#125;&#125;
&#123;&quot;title&quot;:&quot;my first blog post&quot;&#125;
&#123;&quot;index&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;&#125;&#125;
&#123;&quot;title&quot;:&quot;my second blog post&quot;&#125;
&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;&#125;&#125;
&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;my updated blog post&quot;&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行结果：</p>
<pre class="line-numbers language-none"><code class="language-none">#! Deprecation: [types removal] Specifying types in bulk requests is deprecated.
&#123;
  &quot;took&quot; : 304,
  &quot;errors&quot; : false,
  &quot;items&quot; : [
    &#123;
      &quot;delete&quot; : &#123; 删除
        &quot;_index&quot; : &quot;website&quot;,
        &quot;_type&quot; : &quot;blog&quot;,
        &quot;_id&quot; : &quot;123&quot;,
        &quot;_version&quot; : 1,
        &quot;result&quot; : &quot;not_found&quot;, 没有该记录
        &quot;_shards&quot; : &#123;
          &quot;total&quot; : 2,
          &quot;successful&quot; : 1,
          &quot;failed&quot; : 0
        &#125;,
        &quot;_seq_no&quot; : 0,
        &quot;_primary_term&quot; : 1,
        &quot;status&quot; : 404 没有该
      &#125;
    &#125;,
    &#123;
      &quot;create&quot; : &#123;  创建
        &quot;_index&quot; : &quot;website&quot;,
        &quot;_type&quot; : &quot;blog&quot;,
        &quot;_id&quot; : &quot;123&quot;,
        &quot;_version&quot; : 2,
        &quot;result&quot; : &quot;created&quot;,
        &quot;_shards&quot; : &#123;
          &quot;total&quot; : 2,
          &quot;successful&quot; : 1,
          &quot;failed&quot; : 0
        &#125;,
        &quot;_seq_no&quot; : 1,
        &quot;_primary_term&quot; : 1,
        &quot;status&quot; : 201
      &#125;
    &#125;,
    &#123;
      &quot;index&quot; : &#123;  保存
        &quot;_index&quot; : &quot;website&quot;,
        &quot;_type&quot; : &quot;blog&quot;,
        &quot;_id&quot; : &quot;5sKNvncBKdY1wAQmeQNo&quot;,
        &quot;_version&quot; : 1,
        &quot;result&quot; : &quot;created&quot;,
        &quot;_shards&quot; : &#123;
          &quot;total&quot; : 2,
          &quot;successful&quot; : 1,
          &quot;failed&quot; : 0
        &#125;,
        &quot;_seq_no&quot; : 2,
        &quot;_primary_term&quot; : 1,
        &quot;status&quot; : 201
      &#125;
    &#125;,
    &#123;
      &quot;update&quot; : &#123; 更新
        &quot;_index&quot; : &quot;website&quot;,
        &quot;_type&quot; : &quot;blog&quot;,
        &quot;_id&quot; : &quot;123&quot;,
        &quot;_version&quot; : 3,
        &quot;result&quot; : &quot;updated&quot;,
        &quot;_shards&quot; : &#123;
          &quot;total&quot; : 2,
          &quot;successful&quot; : 1,
          &quot;failed&quot; : 0
        &#125;,
        &quot;_seq_no&quot; : 3,
        &quot;_primary_term&quot; : 1,
        &quot;status&quot; : 200
      &#125;
    &#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="7）样本测试数据"><a class="header-anchor" href="#7）样本测试数据">¶</a>7）样本测试数据</h4>
<p>准备了一份顾客银行账户信息的虚构的 JSON 文档样本。每个文档都有下列的 schema（模式）。</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
	&quot;account_number&quot;: 1,
	&quot;balance&quot;: 39225,
	&quot;firstname&quot;: &quot;Amber&quot;,
	&quot;lastname&quot;: &quot;Duke&quot;,
	&quot;age&quot;: 32,
	&quot;gender&quot;: &quot;M&quot;,
	&quot;address&quot;: &quot;880 Holmes Lane&quot;,
	&quot;employer&quot;: &quot;Pyrami&quot;,
	&quot;email&quot;: &quot;amberduke@pyrami.com&quot;,
	&quot;city&quot;: &quot;Brogan&quot;,
	&quot;state&quot;: &quot;IL&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch/blob/master/docs/src/test/resources/accounts.json">https://github.com/elastic/elasticsearch/blob/master/docs/src/test/resources/accounts.json</a> ，导入测试数据，</p>
<pre class="line-numbers language-none"><code class="language-none">POST bank&#x2F;account&#x2F;_bulk
上面的数据<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;192.168.56.10:9200&#x2F;_cat&#x2F;indices
刚导入了1000条
yellow open bank                     99m64ElxRuiH46wV7RjXZA 1 1 1000 0 427.8kb 427.8kb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="3、进阶检索"><a class="header-anchor" href="#3、进阶检索">¶</a>3、进阶检索</h3>
<h4 id="1）search-Api"><a class="header-anchor" href="#1）search-Api">¶</a>1）search Api</h4>
<p>ES 支持两种基本方式检索；</p>
<ul>
<li>通过 REST request uri 发送搜索参数 （uri + 检索参数）；</li>
<li>通过 REST request body 来发送它们（uri + 请求体）；</li>
</ul>
<p>信息检索</p>
<p>API： <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/getting-started-search.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.x/getting-started-search.html</a></p>
<pre class="line-numbers language-none"><code class="language-none">请求参数方式检索
GET bank&#x2F;_search?q&#x3D;*&amp;sort&#x3D;account_number:asc

检索bank下所有信息，包括type和docs
GET bank&#x2F;_search<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>took</code> – 花费多少 ms 搜索</li>
<li><code>timed_out</code> – 是否超时</li>
<li><code>_shards</code> – 多少分片被搜索了，以及多少成功 / 失败的搜索分片</li>
<li><code>max_score</code> –文档相关性最高得分</li>
<li><code>hits.total.value</code> - 多少匹配文档被找到</li>
<li><code>hits.sort</code> - 结果的排序 key，没有的话按照 score 排序</li>
<li><code>hits._score</code> - 相关得分 (not applicable when using <code>match_all</code>)</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">q&#x3D;* 查询所有
sort 排序字段
asc升序<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search?q&#x3D;*&amp;sort&#x3D;account_number:asc

检索了1000条数据，但是根据相关性算法，只返回10条<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>uri + 请求体进行检索</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,
  &quot;sort&quot;: [
    &#123; &quot;account_number&quot;: &quot;asc&quot; &#125;,
    &#123;&quot;balance&quot;:&quot;desc&quot;&#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>POSTMAN 中 get 不能携带请求体，我们变为 post 也是一样的，我们 post 一个 jsob 风格的查询请求体到_search</p>
<p>需要了解，一旦搜索的结果被返回，es 就完成了这次请求，不能切不会维护任何服务端的资源或者结果的 cursor 游标</p>
<h4 id="2）Query-DSL"><a class="header-anchor" href="#2）Query-DSL">¶</a>2）Query DSL</h4>
<p>什么 get 的请求体叫 query DSL</p>
<h5 id="（1）基本语法格式"><a class="header-anchor" href="#（1）基本语法格式">¶</a>（1）基本语法格式</h5>
<p>Elasticsearch 提供了一个可以执行查询的 Json 风格的 DSL(domain-specific language 领域特定语言)。这个被称为 Query DSL，该查询语言非常全面。</p>
<p>一个查询语句的典型结构</p>
<pre class="line-numbers language-none"><code class="language-none">QUERY_NAME:&#123;
   ARGUMENT:VALUE,
   ARGUMENT:VALUE,
    ...
&#125;
    
如果针对于某个字段，那么它的结构如下：
&#123;
  QUERY_NAME:&#123;
     FIELD_NAME:&#123;
       ARGUMENT:VALUE,
       ARGUMENT:VALUE,...
      &#125;   
   &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">示例
GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;,
  &quot;from&quot;: 0,
  &quot;size&quot;: 5,
  &quot;_source&quot;:[&quot;balance&quot;],
  &quot;sort&quot;: [
    &#123;
      &quot;account_number&quot;: &#123;
        &quot;order&quot;: &quot;desc&quot;
      &#125;
    &#125;
  ]
&#125;
_source为要返回的字段<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>query 定义如何查询；</p>
<ul>
<li>match_all 查询类型【代表查询所有的所有】，es 中可以在 query 中组合非常多的查询类型完成复杂查询；</li>
<li>除了 query 参数之外，我们可也传递其他的参数以改变查询结果，如 sort，size；</li>
<li>from+size 限定，完成分页功能；</li>
<li>sort 排序，多字段排序，会在前序字段相等时后续字段内部排序，否则以前序为准；</li>
</ul>
<h5 id="（2）返回部分字段"><a class="header-anchor" href="#（2）返回部分字段">¶</a>（2）返回部分字段</h5>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;,
  &quot;from&quot;: 0,
  &quot;size&quot;: 5,
  &quot;sort&quot;: [
    &#123;
      &quot;account_number&quot;: &#123;
        &quot;order&quot;: &quot;desc&quot;
      &#125;
    &#125;
  ],
  &quot;_source&quot;: [&quot;balance&quot;,&quot;firstname&quot;]
  
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 18,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 1000,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : null,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;999&quot;,
        &quot;_score&quot; : null,
        &quot;_source&quot; : &#123;
          &quot;firstname&quot; : &quot;Dorothy&quot;,
          &quot;balance&quot; : 6087
        &#125;,
        &quot;sort&quot; : [
        ]
      &#125;,
      省略。。。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="（3）match-匹配查询"><a class="header-anchor" href="#（3）match-匹配查询">¶</a>（3）match 匹配查询</h5>
<ul>
<li>基本类型（非字符串），精确控制</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match&quot;: &#123;
      &quot;account_number&quot;: &quot;20&quot;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>match 返回 account_number=20 的数据。</p>
<p>查询结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 1,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 1,  &#x2F;&#x2F; 得到一条
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 1.0,  最大得分
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;20&quot;,
        &quot;_score&quot; : 1.0,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 20,
          &quot;balance&quot; : 16418,
          &quot;firstname&quot; : &quot;Elinor&quot;,
          &quot;lastname&quot; : &quot;Ratliff&quot;,
          &quot;age&quot; : 36,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;282 Kings Place&quot;,
          &quot;employer&quot; : &quot;Scentric&quot;,
          &quot;email&quot; : &quot;elinorratliff@scentric.com&quot;,
          &quot;city&quot; : &quot;Ribera&quot;,
          &quot;state&quot; : &quot;WA&quot;
        &#125;
      &#125;
    ]
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>字符串，全文检索</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match&quot;: &#123;
      &quot;address&quot;: &quot;kings&quot;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>全文检索，最终会按照评分进行排序，会对检索条件进行分词匹配。</p>
<p>查询结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 30,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 2,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 5.990829,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;20&quot;,
        &quot;_score&quot; : 5.990829,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 20,
          &quot;balance&quot; : 16418,
          &quot;firstname&quot; : &quot;Elinor&quot;,
          &quot;lastname&quot; : &quot;Ratliff&quot;,
          &quot;age&quot; : 36,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;282 Kings Place&quot;,
          &quot;employer&quot; : &quot;Scentric&quot;,
          &quot;email&quot; : &quot;elinorratliff@scentric.com&quot;,
          &quot;city&quot; : &quot;Ribera&quot;,
          &quot;state&quot; : &quot;WA&quot;
        &#125;
      &#125;,
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;722&quot;,
        &quot;_score&quot; : 5.990829,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 722,
          &quot;balance&quot; : 27256,
          &quot;firstname&quot; : &quot;Roberts&quot;,
          &quot;lastname&quot; : &quot;Beasley&quot;,
          &quot;age&quot; : 34,
          &quot;gender&quot; : &quot;F&quot;,
          &quot;address&quot; : &quot;305 Kings Hwy&quot;,
          &quot;employer&quot; : &quot;Quintity&quot;,
          &quot;email&quot; : &quot;robertsbeasley@quintity.com&quot;,
          &quot;city&quot; : &quot;Hayden&quot;,
          &quot;state&quot; : &quot;PA&quot;
        &#125;
      &#125;
    ]
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="（4）-match-phrase-短句匹配"><a class="header-anchor" href="#（4）-match-phrase-短句匹配">¶</a>（4） match_phrase [短句匹配]</h5>
<p>将需要匹配的值当成一整个单词（不分词）进行检索</p>
<blockquote>
<p>前面的是包含 mill 或 road 就查出来，我们现在要都包含才查出</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_phrase&quot;: &#123;
      &quot;address&quot;: &quot;mill road&quot;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查处 address 中包含 mill road 的所有记录，并给出相关性得分</p>
<p>查看结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 32,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 1,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 8.926605,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;970&quot;,
        &quot;_score&quot; : 8.926605,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 970,
          &quot;balance&quot; : 19648,
          &quot;firstname&quot; : &quot;Forbes&quot;,
          &quot;lastname&quot; : &quot;Wallace&quot;,
          &quot;age&quot; : 28,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;990 Mill Road&quot;,
          &quot;employer&quot; : &quot;Pheast&quot;,
          &quot;email&quot; : &quot;forbeswallace@pheast.com&quot;,
          &quot;city&quot; : &quot;Lopezo&quot;,
          &quot;state&quot; : &quot;AK&quot;
        &#125;
      &#125;
    ]
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>match_phrase 和 match 的区别，观察如下实例：</p>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_phrase&quot;: &#123;
      &quot;address&quot;: &quot;990 Mill&quot;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 0,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 1,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 10.806405,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;970&quot;,
        &quot;_score&quot; : 10.806405,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 970,
          &quot;balance&quot; : 19648,
          &quot;firstname&quot; : &quot;Forbes&quot;,
          &quot;lastname&quot; : &quot;Wallace&quot;,
          &quot;age&quot; : 28,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;990 Mill Road&quot;,
          &quot;employer&quot; : &quot;Pheast&quot;,
          &quot;email&quot; : &quot;forbeswallace@pheast.com&quot;,
          &quot;city&quot; : &quot;Lopezo&quot;,
          &quot;state&quot; : &quot;AK&quot;
        &#125;
      &#125;
    ]
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 match 的<code>keyword</code></p>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match&quot;: &#123;
      &quot;address.keyword&quot;: &quot;990 Mill&quot;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询结果，一条也未匹配到</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 0,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 0,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : null,
    &quot;hits&quot; : [ ]
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改匹配条件为 “990 Mill Road”</p>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match&quot;: &#123;
      &quot;address.keyword&quot;: &quot;990 Mill Road&quot;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询出一条数据</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 1,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 1,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 6.5032897,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;970&quot;,
        &quot;_score&quot; : 6.5032897,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 970,
          &quot;balance&quot; : 19648,
          &quot;firstname&quot; : &quot;Forbes&quot;,
          &quot;lastname&quot; : &quot;Wallace&quot;,
          &quot;age&quot; : 28,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;990 Mill Road&quot;,
          &quot;employer&quot; : &quot;Pheast&quot;,
          &quot;email&quot; : &quot;forbeswallace@pheast.com&quot;,
          &quot;city&quot; : &quot;Lopezo&quot;,
          &quot;state&quot; : &quot;AK&quot;
        &#125;
      &#125;
    ]
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文本字段的匹配，使用 keyword，匹配的条件就是要显示字段的全部值，要进行精确匹配的。</p>
<p>match_phrase 是做短语匹配，只要文本中包含匹配条件，就能匹配到。</p>
<h5 id="（5）multi-math【多字段匹配】"><a class="header-anchor" href="#（5）multi-math【多字段匹配】">¶</a>（5）multi_math【多字段匹配】</h5>
<p><strong>state 或者 address 中包含 mill</strong>，并且在查询过程中，会对于查询条件进行分词。</p>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;multi_match&quot;: &#123;
      &quot;query&quot;: &quot;mill&quot;,
      &quot;fields&quot;: [
        &quot;state&quot;,
        &quot;address&quot;
      ]
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 28,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 4,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 5.4032025,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;970&quot;,
        &quot;_score&quot; : 5.4032025,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 970,
          &quot;balance&quot; : 19648,
          &quot;firstname&quot; : &quot;Forbes&quot;,
          &quot;lastname&quot; : &quot;Wallace&quot;,
          &quot;age&quot; : 28,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;990 Mill Road&quot;,
          &quot;employer&quot; : &quot;Pheast&quot;,
          &quot;email&quot; : &quot;forbeswallace@pheast.com&quot;,
          &quot;city&quot; : &quot;Lopezo&quot;,
          &quot;state&quot; : &quot;AK&quot;
        &#125;
      &#125;,
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;136&quot;,
        &quot;_score&quot; : 5.4032025,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 136,
          &quot;balance&quot; : 45801,
          &quot;firstname&quot; : &quot;Winnie&quot;,
          &quot;lastname&quot; : &quot;Holland&quot;,
          &quot;age&quot; : 38,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;198 Mill Lane&quot;,
          &quot;employer&quot; : &quot;Neteria&quot;,
          &quot;email&quot; : &quot;winnieholland@neteria.com&quot;,
          &quot;city&quot; : &quot;Urie&quot;,
          &quot;state&quot; : &quot;IL&quot;
        &#125;
      &#125;,
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;345&quot;,
        &quot;_score&quot; : 5.4032025,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 345,
          &quot;balance&quot; : 9812,
          &quot;firstname&quot; : &quot;Parker&quot;,
          &quot;lastname&quot; : &quot;Hines&quot;,
          &quot;age&quot; : 38,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;715 Mill Avenue&quot;,
          &quot;employer&quot; : &quot;Baluba&quot;,
          &quot;email&quot; : &quot;parkerhines@baluba.com&quot;,
          &quot;city&quot; : &quot;Blackgum&quot;,
          &quot;state&quot; : &quot;KY&quot;
        &#125;
      &#125;,
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;472&quot;,
        &quot;_score&quot; : 5.4032025,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 472,
          &quot;balance&quot; : 25571,
          &quot;firstname&quot; : &quot;Lee&quot;,
          &quot;lastname&quot; : &quot;Long&quot;,
          &quot;age&quot; : 32,
          &quot;gender&quot; : &quot;F&quot;,
          &quot;address&quot; : &quot;288 Mill Street&quot;,
          &quot;employer&quot; : &quot;Comverges&quot;,
          &quot;email&quot; : &quot;leelong@comverges.com&quot;,
          &quot;city&quot; : &quot;Movico&quot;,
          &quot;state&quot; : &quot;MT&quot;
        &#125;
      &#125;
    ]
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="（6）bool-用来做复合查询"><a class="header-anchor" href="#（6）bool-用来做复合查询">¶</a>（6）bool 用来做复合查询</h5>
<p>复合语句可以合并，任何其他查询语句，包括符合语句。这也就意味着，复合语句之间可以互相嵌套，可以表达非常复杂的逻辑。</p>
<ul>
<li>must：必须达到 must 所列举的所有条件</li>
<li>must_not：必须不匹配 must_not 所列举的所有条件。</li>
<li>should：应该满足 should 所列举的条件。满足条件最好，不满足也可以，<strong>满足得分更高</strong></li>
</ul>
<p>实例：查询 gender=m，并且 address=mill 的数据</p>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
   &quot;query&quot;:&#123;
        &quot;bool&quot;:&#123;
             &quot;must&quot;:[
              &#123;&quot;match&quot;:&#123;&quot;address&quot;:&quot;mill&quot;&#125;&#125;,
              &#123;&quot;match&quot;:&#123;&quot;gender&quot;:&quot;M&quot;&#125;&#125;
             ]
         &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 1,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 3,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 6.0824604,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;970&quot;,
        &quot;_score&quot; : 6.0824604,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 970,
          &quot;balance&quot; : 19648,
          &quot;firstname&quot; : &quot;Forbes&quot;,
          &quot;lastname&quot; : &quot;Wallace&quot;,
          &quot;age&quot; : 28,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;990 Mill Road&quot;,
          &quot;employer&quot; : &quot;Pheast&quot;,
          &quot;email&quot; : &quot;forbeswallace@pheast.com&quot;,
          &quot;city&quot; : &quot;Lopezo&quot;,
          &quot;state&quot; : &quot;AK&quot;
        &#125;
      &#125;,
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;136&quot;,
        &quot;_score&quot; : 6.0824604,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 136,
          &quot;balance&quot; : 45801,
          &quot;firstname&quot; : &quot;Winnie&quot;,
          &quot;lastname&quot; : &quot;Holland&quot;,
          &quot;age&quot; : 38,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;198 Mill Lane&quot;,
          &quot;employer&quot; : &quot;Neteria&quot;,
          &quot;email&quot; : &quot;winnieholland@neteria.com&quot;,
          &quot;city&quot; : &quot;Urie&quot;,
          &quot;state&quot; : &quot;IL&quot;
        &#125;
      &#125;,
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;345&quot;,
        &quot;_score&quot; : 6.0824604,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 345,
          &quot;balance&quot; : 9812,
          &quot;firstname&quot; : &quot;Parker&quot;,
          &quot;lastname&quot; : &quot;Hines&quot;,
          &quot;age&quot; : 38,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;715 Mill Avenue&quot;,
          &quot;employer&quot; : &quot;Baluba&quot;,
          &quot;email&quot; : &quot;parkerhines@baluba.com&quot;,
          &quot;city&quot; : &quot;Blackgum&quot;,
          &quot;state&quot; : &quot;KY&quot;
        &#125;
      &#125;
    ]
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>must_not：必须不是指定的情况</strong></p>
<p>实例：查询 gender=m，并且 address=mill 的数据，但是 age 不等于 38 的</p>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;bool&quot;: &#123;
      &quot;must&quot;: [
        &#123; &quot;match&quot;: &#123; &quot;gender&quot;: &quot;M&quot; &#125;&#125;,
        &#123; &quot;match&quot;: &#123;&quot;address&quot;: &quot;mill&quot;&#125;&#125;
      ],
      &quot;must_not&quot;: [
        &#123; &quot;match&quot;: &#123; &quot;age&quot;: &quot;38&quot; &#125;&#125;
      ]
   &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 4,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 1,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 6.0824604,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;970&quot;,
        &quot;_score&quot; : 6.0824604,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 970,
          &quot;balance&quot; : 19648,
          &quot;firstname&quot; : &quot;Forbes&quot;,
          &quot;lastname&quot; : &quot;Wallace&quot;,
          &quot;age&quot; : 28,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;990 Mill Road&quot;,
          &quot;employer&quot; : &quot;Pheast&quot;,
          &quot;email&quot; : &quot;forbeswallace@pheast.com&quot;,
          &quot;city&quot; : &quot;Lopezo&quot;,
          &quot;state&quot; : &quot;AK&quot;
        &#125;
      &#125;
    ]
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>should：应该达到 should 列举的条件，如果到达会增加相关文档的评分，并不会改变查询的结果。如果 query 中只有 should 且只有一种匹配规则，那么 should 的条件就会被作为默认匹配条件二区改变查询结果。</strong></p>
<p>实例：匹配 lastName 应该等于 Wallace 的数据</p>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;bool&quot;: &#123;
      &quot;must&quot;: [
        &#123;
          &quot;match&quot;: &#123;
            &quot;gender&quot;: &quot;M&quot;
          &#125;
        &#125;,
        &#123;
          &quot;match&quot;: &#123;
            &quot;address&quot;: &quot;mill&quot;
          &#125;
        &#125;
      ],
      &quot;must_not&quot;: [
        &#123;
          &quot;match&quot;: &#123;
            &quot;age&quot;: &quot;18&quot;
          &#125;
        &#125;
      ],
      &quot;should&quot;: [
        &#123;
          &quot;match&quot;: &#123;
            &quot;lastname&quot;: &quot;Wallace&quot;
          &#125;
        &#125;
      ]
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 5,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 3,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 12.585751,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;970&quot;,
        &quot;_score&quot; : 12.585751,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 970,
          &quot;balance&quot; : 19648,
          &quot;firstname&quot; : &quot;Forbes&quot;,
          &quot;lastname&quot; : &quot;Wallace&quot;,
          &quot;age&quot; : 28,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;990 Mill Road&quot;,
          &quot;employer&quot; : &quot;Pheast&quot;,
          &quot;email&quot; : &quot;forbeswallace@pheast.com&quot;,
          &quot;city&quot; : &quot;Lopezo&quot;,
          &quot;state&quot; : &quot;AK&quot;
        &#125;
      &#125;,
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;136&quot;,
        &quot;_score&quot; : 6.0824604,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 136,
          &quot;balance&quot; : 45801,
          &quot;firstname&quot; : &quot;Winnie&quot;,
          &quot;lastname&quot; : &quot;Holland&quot;,
          &quot;age&quot; : 38,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;198 Mill Lane&quot;,
          &quot;employer&quot; : &quot;Neteria&quot;,
          &quot;email&quot; : &quot;winnieholland@neteria.com&quot;,
          &quot;city&quot; : &quot;Urie&quot;,
          &quot;state&quot; : &quot;IL&quot;
        &#125;
      &#125;,
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;345&quot;,
        &quot;_score&quot; : 6.0824604,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 345,
          &quot;balance&quot; : 9812,
          &quot;firstname&quot; : &quot;Parker&quot;,
          &quot;lastname&quot; : &quot;Hines&quot;,
          &quot;age&quot; : 38,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;715 Mill Avenue&quot;,
          &quot;employer&quot; : &quot;Baluba&quot;,
          &quot;email&quot; : &quot;parkerhines@baluba.com&quot;,
          &quot;city&quot; : &quot;Blackgum&quot;,
          &quot;state&quot; : &quot;KY&quot;
        &#125;
      &#125;
    ]
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能够看到相关度越高，得分也越高。</p>
<h5 id="（7）Filter【结果过滤】"><a class="header-anchor" href="#（7）Filter【结果过滤】">¶</a>（7）Filter【结果过滤】</h5>
<blockquote>
<p>上面的 must 和 should 影响相关性得分，而 must_not 仅仅是一个 filter ，不贡献得分</p>
<p>must 改为 filter 就使 must 不贡献得分</p>
<p>如果只有 filter 条件的话，我们会发现得分都是 0</p>
<p>一个 key 多个值可以用 terms</p>
</blockquote>
<p>并不是所有的查询都需要产生分数，特别是哪些仅用于 filtering 过滤的文档。为了不计算分数，elasticsearch 会自动检查场景并且优化查询的执行。</p>
<p>不参与评分更快</p>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;bool&quot;: &#123;
      &quot;must&quot;: [
        &#123; &quot;match&quot;: &#123;&quot;address&quot;: &quot;mill&quot; &#125; &#125;
      ],
      &quot;filter&quot;: &#123;  # query.bool.filter
        &quot;range&quot;: &#123;
          &quot;balance&quot;: &#123;
            &quot;gte&quot;: &quot;10000&quot;,
            &quot;lte&quot;: &quot;20000&quot;
          &#125;
        &#125;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里先是查询所有匹配 address=mill 的文档，然后再根据 10000&lt;=balance&lt;=20000 进行过滤查询结果</p>
<p>查询结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 2,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 1,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 5.4032025,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;970&quot;,
        &quot;_score&quot; : 5.4032025,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 970,
          &quot;balance&quot; : 19648,
          &quot;firstname&quot; : &quot;Forbes&quot;,
          &quot;lastname&quot; : &quot;Wallace&quot;,
          &quot;age&quot; : 28,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;990 Mill Road&quot;,
          &quot;employer&quot; : &quot;Pheast&quot;,
          &quot;email&quot; : &quot;forbeswallace@pheast.com&quot;,
          &quot;city&quot; : &quot;Lopezo&quot;,
          &quot;state&quot; : &quot;AK&quot;
        &#125;
      &#125;
    ]
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Each <code>must</code>, <code>should</code>, and <code>must_not</code> element in a Boolean query is referred to as a query clause. How well a document meets the criteria in each <code>must</code> or <code>should</code> clause contributes to the document’s <em>relevance score</em>. The higher the score, the better the document matches your search criteria. By default, Elasticsearch returns documents ranked by these relevance scores.</p>
<p>在 boolean 查询中，<code>must</code>, <code>should</code> 和<code>must_not</code> 元素都被称为查询子句 。 文档是否符合每个 “must” 或“should”子句中的标准，决定了文档的“相关性得分”。 得分越高，文档越符合您的搜索条件。 默认情况下，Elasticsearch 返回根据这些相关性得分排序的文档。</p>
<p>The criteria in a <code>must_not</code> clause is treated as a <em>filter</em>. It affects whether or not the document is included in the results, but does not contribute to how documents are scored. You can also explicitly specify arbitrary filters to include or exclude documents based on structured data.</p>
<p><code>“must_not”子句中的条件被视为“过滤器”。</code> 它影响文档是否包含在结果中， 但不影响文档的评分方式。 还可以显式地指定任意过滤器来包含或排除基于结构化数据的文档。</p>
<p>filter 在使用过程中，并不会计算相关性得分：</p>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;bool&quot;: &#123;
      &quot;must&quot;: [
        &#123;
          &quot;match&quot;: &#123;
            &quot;address&quot;: &quot;mill&quot;
          &#125;
        &#125;
      ],
      &quot;filter&quot;: &#123;
        &quot;range&quot;: &#123;
          &quot;balance&quot;: &#123;
            &quot;gte&quot;: &quot;10000&quot;,
            &quot;lte&quot;: &quot;20000&quot;
          &#125;
        &#125;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 1,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 213,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 0.0,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;20&quot;,
        &quot;_score&quot; : 0.0,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 20,
          &quot;balance&quot; : 16418,
          &quot;firstname&quot; : &quot;Elinor&quot;,
          &quot;lastname&quot; : &quot;Ratliff&quot;,
          &quot;age&quot; : 36,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;282 Kings Place&quot;,
          &quot;employer&quot; : &quot;Scentric&quot;,
          &quot;email&quot; : &quot;elinorratliff@scentric.com&quot;,
          &quot;city&quot; : &quot;Ribera&quot;,
          &quot;state&quot; : &quot;WA&quot;
        &#125;
      &#125;,
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,
        &quot;_id&quot; : &quot;37&quot;,
        &quot;_score&quot; : 0.0,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 37,
          &quot;balance&quot; : 18612,
          &quot;firstname&quot; : &quot;Mcgee&quot;,
          &quot;lastname&quot; : &quot;Mooney&quot;,
          &quot;age&quot; : 39,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;826 Fillmore Place&quot;,
          &quot;employer&quot; : &quot;Reversus&quot;,
          &quot;email&quot; : &quot;mcgeemooney@reversus.com&quot;,
          &quot;city&quot; : &quot;Tooleville&quot;,
          &quot;state&quot; : &quot;OK&quot;
        &#125;
      &#125;,
        省略。。。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>能看到所有文档的 “_score” : 0.0。</strong></p>
<h5 id="（8）term"><a class="header-anchor" href="#（8）term">¶</a>（8）term</h5>
<p>和 match 一样。匹配某个属性的值。</p>
<ul>
<li>全文检索字段用 match，</li>
<li>其他非 text 字段匹配用 term。</li>
</ul>
<p>不要使用 term 来进行文本字段查询</p>
<p>es 默认存储 text 值时用分词分析，所以要搜索 text 值，使用 match</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/query-dsl-term-query.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.6/query-dsl-term-query.html</a></p>
<ul>
<li>字段. keyword：要一一匹配到</li>
<li>match_phrase：子串包含即可</li>
</ul>
<p>使用 term 匹配查询</p>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;term&quot;: &#123;
      &quot;address&quot;: &quot;mill Road&quot;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 0,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 0, 没有
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : null,
    &quot;hits&quot; : [ ]
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一条也没有匹配到</p>
<p>而更换为 match 匹配时，能够匹配到 32 个文档</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 5,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 32,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 8.926605,
    &quot;hits&quot; : [<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也就是说，<strong>全文检索字段用 match，其他非 text 字段匹配用 term</strong>。</p>
<h5 id="（9）Aggregation（聚合）"><a class="header-anchor" href="#（9）Aggregation（聚合）">¶</a>（9）Aggregation（聚合）</h5>
<blockquote>
<p>前面介绍了存储、检索，但还没介绍分析</p>
</blockquote>
<p>聚合提供了从数据中分组和提取数据的能力。最简单的聚合方法大致等于 SQL <code>Group by</code>和 SQL<code>聚合函数</code>。</p>
<p>在 elasticsearch 中，执行搜索返回 this（命中结果），并且同时返回聚合结果，把以响应中的所有 hits（命中结果）分隔开的能力。这是非常强大且有效的，你可以执行查询和多个聚合，并且在一次使用中得到各自的（任何一个的）返回结果，使用一次简洁和简化的 API 啦避免网络往返。</p>
<p>aggs：执行聚合。聚合语法如下：</p>
<pre class="line-numbers language-none"><code class="language-none">&quot;aggs&quot;:&#123; # 聚合
    &quot;aggs_name这次聚合的名字，方便展示在结果集中&quot;:&#123;
        &quot;AGG_TYPE聚合的类型(avg,term,terms)&quot;:&#123;&#125;
     &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>terms：看值的可能性分布</li>
<li>avg：看值的分布平均</li>
</ul>
<p>例：<strong>搜索 address 中包含 mill 的所有人的年龄分布以及平均年龄，但不显示这些人的详情</strong></p>
<pre class="line-numbers language-none"><code class="language-none"># 分别为包含mill、，平均年龄、
GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123; # 查询出包含mill的
    &quot;match&quot;: &#123;
      &quot;address&quot;: &quot;Mill&quot;
    &#125;
  &#125;,
  &quot;aggs&quot;: &#123; #基于查询聚合
    &quot;ageAgg&quot;: &#123;  # 聚合的名字，随便起
      &quot;terms&quot;: &#123; # 看值的可能性分布
        &quot;field&quot;: &quot;age&quot;,
        &quot;size&quot;: 10
      &#125;
    &#125;,
    &quot;ageAvg&quot;: &#123; 
      &quot;avg&quot;: &#123; # 看age值的平均
        &quot;field&quot;: &quot;age&quot;
      &#125;
    &#125;,
    &quot;balanceAvg&quot;: &#123;
      &quot;avg&quot;: &#123; # 看balance的平均
        &quot;field&quot;: &quot;balance&quot;
      &#125;
    &#125;
  &#125;,
  &quot;size&quot;: 0  # 不看详情
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 2,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 4, &#x2F;&#x2F; 命中4条
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : null,
    &quot;hits&quot; : [ ]
  &#125;,
  &quot;aggregations&quot; : &#123;
    &quot;ageAgg&quot; : &#123; &#x2F;&#x2F; 第一个聚合的结果
      &quot;doc_count_error_upper_bound&quot; : 0,
      &quot;sum_other_doc_count&quot; : 0,
      &quot;buckets&quot; : [
        &#123;
          &quot;key&quot; : 38,
          &quot;doc_count&quot; : 2
        &#125;,
        &#123;
          &quot;key&quot; : 28,
          &quot;doc_count&quot; : 1
        &#125;,
        &#123;
          &quot;key&quot; : 32,
          &quot;doc_count&quot; : 1
        &#125;
      ]
    &#125;,
    &quot;ageAvg&quot; : &#123; &#x2F;&#x2F; 第二个聚合的结果
      &quot;value&quot; : 34.0
    &#125;,
    &quot;balanceAvg&quot; : &#123;
      &quot;value&quot; : 25208.0
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="子聚合"><a class="header-anchor" href="#子聚合">¶</a>子聚合</h6>
<p>复杂：<br>
按照年龄聚合，并且求这些年龄段的这些人的平均薪资</p>
<blockquote>
<p>写到一个聚合里是基于上个聚合进行子聚合。</p>
<p>下面求每个 age 分布的平均 balance</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;,
  &quot;aggs&quot;: &#123;
    &quot;ageAgg&quot;: &#123;
      &quot;terms&quot;: &#123; # 看分布
        &quot;field&quot;: &quot;age&quot;,
        &quot;size&quot;: 100
      &#125;,
      &quot;aggs&quot;: &#123; # 与terms并列
        &quot;ageAvg&quot;: &#123; #平均
          &quot;avg&quot;: &#123;
            &quot;field&quot;: &quot;balance&quot;
          &#125;
        &#125;
      &#125;
    &#125;
  &#125;,
  &quot;size&quot;: 0
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 49,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 1000,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : null,
    &quot;hits&quot; : [ ]
  &#125;,
  &quot;aggregations&quot; : &#123;
    &quot;ageAgg&quot; : &#123;
      &quot;doc_count_error_upper_bound&quot; : 0,
      &quot;sum_other_doc_count&quot; : 0,
      &quot;buckets&quot; : [
        &#123;
          &quot;key&quot; : 31,
          &quot;doc_count&quot; : 61,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 28312.918032786885
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 39,
          &quot;doc_count&quot; : 60,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 25269.583333333332
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 26,
          &quot;doc_count&quot; : 59,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 23194.813559322032
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 32,
          &quot;doc_count&quot; : 52,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 23951.346153846152
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 35,
          &quot;doc_count&quot; : 52,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 22136.69230769231
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 36,
          &quot;doc_count&quot; : 52,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 22174.71153846154
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 22,
          &quot;doc_count&quot; : 51,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 24731.07843137255
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 28,
          &quot;doc_count&quot; : 51,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 28273.882352941175
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 33,
          &quot;doc_count&quot; : 50,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 25093.94
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 34,
          &quot;doc_count&quot; : 49,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 26809.95918367347
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 30,
          &quot;doc_count&quot; : 47,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 22841.106382978724
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 21,
          &quot;doc_count&quot; : 46,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 26981.434782608696
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 40,
          &quot;doc_count&quot; : 45,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 27183.17777777778
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 20,
          &quot;doc_count&quot; : 44,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 27741.227272727272
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 23,
          &quot;doc_count&quot; : 42,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 27314.214285714286
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 24,
          &quot;doc_count&quot; : 42,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 28519.04761904762
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 25,
          &quot;doc_count&quot; : 42,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 27445.214285714286
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 37,
          &quot;doc_count&quot; : 42,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 27022.261904761905
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 27,
          &quot;doc_count&quot; : 39,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 21471.871794871793
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 38,
          &quot;doc_count&quot; : 39,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 26187.17948717949
          &#125;
        &#125;,
        &#123;
          &quot;key&quot; : 29,
          &quot;doc_count&quot; : 35,
          &quot;ageAvg&quot; : &#123;
            &quot;value&quot; : 29483.14285714286
          &#125;
        &#125;
      ]
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>复杂子聚合：查出所有年龄分布，并且这些<strong>年龄段</strong>中 M 的平均薪资和 F 的平均薪资以及这个年龄段的总体平均薪资</p>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;,
  &quot;aggs&quot;: &#123;
    &quot;ageAgg&quot;: &#123;
      &quot;terms&quot;: &#123;  #  看age分布
        &quot;field&quot;: &quot;age&quot;,
        &quot;size&quot;: 100
      &#125;,
      &quot;aggs&quot;: &#123; # 子聚合
        &quot;genderAgg&quot;: &#123;
          &quot;terms&quot;: &#123; # 看gender分布
            &quot;field&quot;: &quot;gender.keyword&quot; # 注意这里，文本字段应该用.keyword
          &#125;,
          &quot;aggs&quot;: &#123; # 子聚合
            &quot;balanceAvg&quot;: &#123;
              &quot;avg&quot;: &#123; # 男性的平均
                &quot;field&quot;: &quot;balance&quot;
              &#125;
            &#125;
          &#125;
        &#125;,
        &quot;ageBalanceAvg&quot;: &#123;
          &quot;avg&quot;: &#123; #age分布的平均（男女）
            &quot;field&quot;: &quot;balance&quot;
          &#125;
        &#125;
      &#125;
    &#125;
  &#125;,
  &quot;size&quot;: 0
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 119,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 1000,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : null,
    &quot;hits&quot; : [ ]
  &#125;,
  &quot;aggregations&quot; : &#123;
    &quot;ageAgg&quot; : &#123;
      &quot;doc_count_error_upper_bound&quot; : 0,
      &quot;sum_other_doc_count&quot; : 0,
      &quot;buckets&quot; : [
        &#123;
          &quot;key&quot; : 31,
          &quot;doc_count&quot; : 61,
          &quot;genderAgg&quot; : &#123;
            &quot;doc_count_error_upper_bound&quot; : 0,
            &quot;sum_other_doc_count&quot; : 0,
            &quot;buckets&quot; : [
              &#123;
                &quot;key&quot; : &quot;M&quot;,
                &quot;doc_count&quot; : 35,
                &quot;balanceAvg&quot; : &#123;
                  &quot;value&quot; : 29565.628571428573
                &#125;
              &#125;,
              &#123;
                &quot;key&quot; : &quot;F&quot;,
                &quot;doc_count&quot; : 26,
                &quot;balanceAvg&quot; : &#123;
                  &quot;value&quot; : 26626.576923076922
                &#125;
              &#125;
            ]
          &#125;,
          &quot;ageBalanceAvg&quot; : &#123;
            &quot;value&quot; : 28312.918032786885
          &#125;
        &#125;
      ]
        .......&#x2F;&#x2F;省略其他
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="nested-对象聚合"><a class="header-anchor" href="#nested-对象聚合">¶</a>nested 对象聚合</h5>
<pre class="line-numbers language-none"><code class="language-none">GET articles&#x2F;_search
&#123;
  &quot;size&quot;: 0, 
  &quot;aggs&quot;: &#123;
    &quot;nested&quot;: &#123;
      &quot;nested&quot;: &#123;
        &quot;path&quot;: &quot;payment&quot;
      &#125;,
      &quot;aggs&quot;: &#123;
        &quot;amount_avg&quot;: &#123;
          &quot;avg&quot;: &#123;
            &quot;field&quot;: &quot;payment.amount&quot;
          &#125;
        &#125;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="3）Mapping"><a class="header-anchor" href="#3）Mapping">¶</a>3）Mapping</h4>
<p>映射定义文档如何被存储检索的</p>
<h5 id="（1）字段类型"><a class="header-anchor" href="#（1）字段类型">¶</a>（1）字段类型</h5>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/mapping-types.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.x/mapping-types.html</a></p>
<ul>
<li>核心类型</li>
<li>复合类型</li>
<li>地理类型</li>
<li>特定类型</li>
</ul>
<p>核心数据类型</p>
<p>（1）字符串</p>
<ul>
<li><code>text</code> ⽤于全⽂索引，搜索时会自动使用分词器进⾏分词再匹配</li>
<li><code>keyword</code> 不分词，搜索时需要匹配完整的值</li>
</ul>
<p>（2）数值型</p>
<ul>
<li>整型： byte，short，integer，long</li>
<li>浮点型： float, half_float, scaled_float，double</li>
</ul>
<p>（3）日期类型：date</p>
<p>（4）范围型</p>
<p>integer_range， long_range， float_range，double_range，date_range</p>
<p>gt 是大于，lt 是小于，e 是 equals 等于。</p>
<p>age_limit 的区间包含了此值的文档都算是匹配。</p>
<p>（5）布尔</p>
<ul>
<li>boolean</li>
</ul>
<p>（6）⼆进制</p>
<ul>
<li>binary 会把值当做经过 base64 编码的字符串，默认不存储，且不可搜索</li>
</ul>
<p>复杂数据类型</p>
<p>（1）对象</p>
<ul>
<li>object 一个对象中可以嵌套对象。</li>
</ul>
<p>（2）数组</p>
<ul>
<li>Array</li>
</ul>
<p>嵌套类型</p>
<ul>
<li>nested 用于 json 对象数组</li>
</ul>
<img src="/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/434a6047bf92fe12cf62440645e8900f.png" class="" loading="lazy">
<h5 id="（2）映射"><a class="header-anchor" href="#（2）映射">¶</a>（2）映射</h5>
<p>Mapping(映射)<br>
Maping 是用来定义一个文档（document），以及它所包含的属性（field）是如何存储和索引的。比如：使用 maping 来定义：</p>
<ul>
<li>
<p>哪些字符串属性应该被看做全文本属性（full text fields）；</p>
</li>
<li>
<p>哪些属性包含数字，日期或地理位置；</p>
</li>
<li>
<p>文档中的所有属性是否都嫩被索引（all 配置）；</p>
</li>
<li>
<p>日期的格式；</p>
</li>
<li>
<p>自定义映射规则来执行动态添加属性；</p>
</li>
<li>
<p>查看 mapping 信息：GET bank/_mapping</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;bank&quot; : &#123;
    &quot;mappings&quot; : &#123;
      &quot;properties&quot; : &#123;
        &quot;account_number&quot; : &#123;
          &quot;type&quot; : &quot;long&quot; # long类型
        &#125;,
        &quot;address&quot; : &#123;
          &quot;type&quot; : &quot;text&quot;, # 文本类型，会进行全文检索，进行分词
          &quot;fields&quot; : &#123;
            &quot;keyword&quot; : &#123; # addrss.keyword
              &quot;type&quot; : &quot;keyword&quot;,
              &quot;ignore_above&quot; : 256
            &#125;
          &#125;
        &#125;,
        &quot;age&quot; : &#123;
          &quot;type&quot; : &quot;long&quot;
        &#125;,
        &quot;balance&quot; : &#123;
          &quot;type&quot; : &quot;long&quot;
        &#125;,
        &quot;city&quot; : &#123;
          &quot;type&quot; : &quot;text&quot;,
          &quot;fields&quot; : &#123;
            &quot;keyword&quot; : &#123;
              &quot;type&quot; : &quot;keyword&quot;,
              &quot;ignore_above&quot; : 256
            &#125;
          &#125;
        &#125;,
        &quot;email&quot; : &#123;
          &quot;type&quot; : &quot;text&quot;,
          &quot;fields&quot; : &#123;
            &quot;keyword&quot; : &#123;
              &quot;type&quot; : &quot;keyword&quot;,
              &quot;ignore_above&quot; : 256
            &#125;
          &#125;
        &#125;,
        &quot;employer&quot; : &#123;
          &quot;type&quot; : &quot;text&quot;,
          &quot;fields&quot; : &#123;
            &quot;keyword&quot; : &#123;
              &quot;type&quot; : &quot;keyword&quot;,
              &quot;ignore_above&quot; : 256
            &#125;
          &#125;
        &#125;,
        &quot;firstname&quot; : &#123;
          &quot;type&quot; : &quot;text&quot;,
          &quot;fields&quot; : &#123;
            &quot;keyword&quot; : &#123;
              &quot;type&quot; : &quot;keyword&quot;,
              &quot;ignore_above&quot; : 256
            &#125;
          &#125;
        &#125;,
        &quot;gender&quot; : &#123;
          &quot;type&quot; : &quot;text&quot;,
          &quot;fields&quot; : &#123;
            &quot;keyword&quot; : &#123;
              &quot;type&quot; : &quot;keyword&quot;,
              &quot;ignore_above&quot; : 256
            &#125;
          &#125;
        &#125;,
        &quot;lastname&quot; : &#123;
          &quot;type&quot; : &quot;text&quot;,
          &quot;fields&quot; : &#123;
            &quot;keyword&quot; : &#123;
              &quot;type&quot; : &quot;keyword&quot;,
              &quot;ignore_above&quot; : 256
            &#125;
          &#125;
        &#125;,
        &quot;state&quot; : &#123;
          &quot;type&quot; : &quot;text&quot;,
          &quot;fields&quot; : &#123;
            &quot;keyword&quot; : &#123;
              &quot;type&quot; : &quot;keyword&quot;,
              &quot;ignore_above&quot; : 256
            &#125;
          &#125;
        &#125;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>修改 mapping 信息</p>
</li>
</ul>
<img src="/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/2058b8b9e4afc4ae93da433feab1c2a3.png" class="" loading="lazy">
<h5 id="（3）新版本改变"><a class="header-anchor" href="#（3）新版本改变">¶</a>（3）新版本改变</h5>
<p>ElasticSearch7 - 去掉 type 概念</p>
<ol>
<li>
<p>关系型数据库中两个数据表示是独立的，即使他们里面有相同名称的列也不影响使用，但 ES 中不是这样的。elasticsearch 是基于 Lucene 开发的搜索引擎，而 ES 中不同 type 下名称相同的 filed 最终在 Lucene 中的处理方式是一样的。</p>
<ul>
<li>两个不同 type 下的两个 user_name，在 ES 同一个索引下其实被认为是同一个 filed，你必须在两个不同的 type 中定义相同的 filed 映射。否则，不同 type 中的相同字段名称就会在处理中出现冲突的情况，导致 Lucene 处理效率下降。</li>
<li>去掉 type 就是为了提高 ES 处理数据的效率。</li>
</ul>
</li>
<li>
<p>Elasticsearch 7.x URL 中的 type 参数为可选。比如，索引一个文档不再要求提供文档类型。</p>
</li>
<li>
<p>Elasticsearch 8.x 不再支持 URL 中的 type 参数。</p>
</li>
<li>
<p>解决：<br>
将索引从多类型迁移到单类型，每种类型文档一个独立索引</p>
<p>将已存在的索引下的类型数据，全部迁移到指定位置即可。详见数据迁移</p>
</li>
</ol>
<blockquote>
<p><strong>Elasticsearch 7.x</strong></p>
<ul>
<li>Specifying types in requests is deprecated. For instance, indexing a document no longer requires a document <code>type</code>. The new index APIs are <code>PUT &#123;index&#125;/_doc/&#123;id&#125;</code> in case of explicit ids and <code>POST &#123;index&#125;/_doc</code> for auto-generated ids. Note that in 7.0, <code>_doc</code> is a permanent part of the path, and represents the endpoint name rather than the document type.</li>
<li>The <code>include_type_name</code> parameter in the index creation, index template, and mapping APIs will default to <code>false</code>. Setting the parameter at all will result in a deprecation warning.</li>
<li>The <code>_default_</code> mapping type is removed.</li>
</ul>
<p><strong>Elasticsearch 8.x</strong></p>
<ul>
<li>Specifying types in requests is no longer supported.</li>
<li>The <code>include_type_name</code> parameter is removed.</li>
</ul>
</blockquote>
<h6 id="创建映射-PUT-my-index"><a class="header-anchor" href="#创建映射-PUT-my-index">¶</a>创建映射 PUT /my_index</h6>
<blockquote>
<p>第一次存储数据的时候 es 就猜出了映射</p>
<p>第一次存储数据前可以指定映射</p>
</blockquote>
<p>创建索引并指定映射</p>
<pre class="line-numbers language-none"><code class="language-none">PUT &#x2F;my_index
&#123;
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;age&quot;: &#123;
        &quot;type&quot;: &quot;integer&quot;
      &#125;,
      &quot;email&quot;: &#123;
        &quot;type&quot;: &quot;keyword&quot; # 指定为keyword
      &#125;,
      &quot;name&quot;: &#123;
        &quot;type&quot;: &quot;text&quot; # 全文检索。保存时候分词，检索时候进行分词匹配
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;acknowledged&quot; : true,
  &quot;shards_acknowledged&quot; : true,
  &quot;index&quot; : &quot;my_index&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="查看映射-GET-my-index"><a class="header-anchor" href="#查看映射-GET-my-index">¶</a>查看映射 GET /my_index</h6>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;my_index<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;my_index&quot; : &#123;
    &quot;aliases&quot; : &#123; &#125;,
    &quot;mappings&quot; : &#123;
      &quot;properties&quot; : &#123;
        &quot;age&quot; : &#123;
          &quot;type&quot; : &quot;integer&quot;
        &#125;,
        &quot;email&quot; : &#123;
          &quot;type&quot; : &quot;keyword&quot;
        &#125;,
        &quot;employee-id&quot; : &#123;
          &quot;type&quot; : &quot;keyword&quot;,
          &quot;index&quot; : false
        &#125;,
        &quot;name&quot; : &#123;
          &quot;type&quot; : &quot;text&quot;
        &#125;
      &#125;
    &#125;,
    &quot;settings&quot; : &#123;
      &quot;index&quot; : &#123;
        &quot;creation_date&quot; : &quot;1588410780774&quot;,
        &quot;number_of_shards&quot; : &quot;1&quot;,
        &quot;number_of_replicas&quot; : &quot;1&quot;,
        &quot;uuid&quot; : &quot;ua0lXhtkQCOmn7Kh3iUu0w&quot;,
        &quot;version&quot; : &#123;
          &quot;created&quot; : &quot;7060299&quot;
        &#125;,
        &quot;provided_name&quot; : &quot;my_index&quot;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="添加新的字段映射-my-index-mapping"><a class="header-anchor" href="#添加新的字段映射-my-index-mapping">¶</a>添加新的字段映射 / my_index/_mapping</h6>
<pre class="line-numbers language-none"><code class="language-none">PUT &#x2F;my_index&#x2F;_mapping
&#123;
  &quot;properties&quot;: &#123;
    &quot;employee-id&quot;: &#123;
      &quot;type&quot;: &quot;keyword&quot;,
      &quot;index&quot;: false # 字段不能被检索。检索
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的 “index”: false，表明新增的字段不能被检索，只是一个冗余字段。</p>
<h6 id="不能更新映射"><a class="header-anchor" href="#不能更新映射">¶</a>不能更新映射</h6>
<p>对于已经存在的字段映射，我们不能更新。更新必须创建新的索引，进行数据迁移。</p>
<h6 id="数据迁移"><a class="header-anchor" href="#数据迁移">¶</a>数据迁移</h6>
<p>先创建 new_twitter 的正确映射。</p>
<p>然后使用如下方式进行数据迁移。</p>
<pre class="line-numbers language-none"><code class="language-none">6.0以后写法
POST reindex
&#123;
  &quot;source&quot;:&#123;
      &quot;index&quot;:&quot;twitter&quot;
   &#125;,
  &quot;dest&quot;:&#123;
      &quot;index&quot;:&quot;new_twitters&quot;
   &#125;
&#125;


老版本写法
POST reindex
&#123;
  &quot;source&quot;:&#123;
      &quot;index&quot;:&quot;twitter&quot;,
      &quot;twitter&quot;:&quot;twitter&quot;
   &#125;,
  &quot;dest&quot;:&#123;
      &quot;index&quot;:&quot;new_twitters&quot;
   &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>更多详情见： <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/docs-reindex.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.6/docs-reindex.html</a></p>
<p>案例：原来类型为 account，新版本没有类型了，所以我们把他去掉</p>
<p>GET /bank/_search</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;took&quot; : 0,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 1000,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 1.0,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;bank&quot;,
        &quot;_type&quot; : &quot;account&quot;,&#x2F;&#x2F;原来类型为account，新版本没有类型了，所以我们把他去掉
        &quot;_id&quot; : &quot;1&quot;,
        &quot;_score&quot; : 1.0,
        &quot;_source&quot; : &#123;
          &quot;account_number&quot; : 1,
          &quot;balance&quot; : 39225,
          &quot;firstname&quot; : &quot;Amber&quot;,
          &quot;lastname&quot; : &quot;Duke&quot;,
          &quot;age&quot; : 32,
          &quot;gender&quot; : &quot;M&quot;,
          &quot;address&quot; : &quot;880 Holmes Lane&quot;,
          &quot;employer&quot; : &quot;Pyrami&quot;,
          &quot;email&quot; : &quot;amberduke@pyrami.com&quot;,
          &quot;city&quot; : &quot;Brogan&quot;,
          &quot;state&quot; : &quot;IL&quot;
        &#125;
      &#125;,
      ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;bank&#x2F;_search
查出
&quot;age&quot;:&#123;&quot;type&quot;:&quot;long&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>想要将年龄修改为 integer</p>
<p>先创建新的索引</p>
<pre class="line-numbers language-none"><code class="language-none">PUT &#x2F;newbank
&#123;
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;account_number&quot;: &#123;
        &quot;type&quot;: &quot;long&quot;
      &#125;,
      &quot;address&quot;: &#123;
        &quot;type&quot;: &quot;text&quot;
      &#125;,
      &quot;age&quot;: &#123;
        &quot;type&quot;: &quot;integer&quot;
      &#125;,
      &quot;balance&quot;: &#123;
        &quot;type&quot;: &quot;long&quot;
      &#125;,
      &quot;city&quot;: &#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;email&quot;: &#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;employer&quot;: &#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;firstname&quot;: &#123;
        &quot;type&quot;: &quot;text&quot;
      &#125;,
      &quot;gender&quot;: &#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;lastname&quot;: &#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;fields&quot;: &#123;
          &quot;keyword&quot;: &#123;
            &quot;type&quot;: &quot;keyword&quot;,
            &quot;ignore_above&quot;: 256
          &#125;
        &#125;
      &#125;,
      &quot;state&quot;: &#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看 “newbank” 的映射：</p>
<p>GET /newbank/_mapping</p>
<pre class="line-numbers language-none"><code class="language-none">能够看到age的映射类型被修改为了integer.
&quot;age&quot;:&#123;&quot;type&quot;:&quot;integer&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>将 bank 中的数据迁移到 newbank 中</p>
<pre class="line-numbers language-none"><code class="language-none">POST _reindex
&#123;
  &quot;source&quot;: &#123;
    &quot;index&quot;: &quot;bank&quot;,
    &quot;type&quot;: &quot;account&quot;
  &#125;,
  &quot;dest&quot;: &#123;
    &quot;index&quot;: &quot;newbank&quot;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行输出：</p>
<pre class="line-numbers language-none"><code class="language-none">#! Deprecation: [types removal] Specifying types in reindex requests is deprecated.
&#123;
  &quot;took&quot; : 768,
  &quot;timed_out&quot; : false,
  &quot;total&quot; : 1000,
  &quot;updated&quot; : 0,
  &quot;created&quot; : 1000,
  &quot;deleted&quot; : 0,
  &quot;batches&quot; : 1,
  &quot;version_conflicts&quot; : 0,
  &quot;noops&quot; : 0,
  &quot;retries&quot; : &#123;
    &quot;bulk&quot; : 0,
    &quot;search&quot; : 0
  &#125;,
  &quot;throttled_millis&quot; : 0,
  &quot;requests_per_second&quot; : -1.0,
  &quot;throttled_until_millis&quot; : 0,
  &quot;failures&quot; : [ ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看 newbank 中的数据</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;newbank&#x2F;_search

输出
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 1000,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : 1.0,
    &quot;hits&quot; : [
      &#123;
        &quot;_index&quot; : &quot;newbank&quot;,
        &quot;_type&quot; : &quot;_doc&quot;, # 没有了类型<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="4）分词"><a class="header-anchor" href="#4）分词">¶</a>4）分词</h4>
<p>一个 tokenizer（分词器）接收一个字符流，将之分割为独立的<code>tokens</code>（<strong>词元</strong>，通常是独立的单词），然后输出 tokens 流。</p>
<p>例如：whitespace tokenizer 遇到空白字符时分割文本。它会将文本<code>&quot;Quick brown fox!&quot;</code>分割为<code>[Quick,brown,fox!]</code></p>
<p>该 tokenizer（分词器）还负责记录各个 terms(词条) 的顺序或 position 位置（用于 phrase 短语和 word proximity 词近邻查询），以及 term（词条）所代表的原始 word（单词）的 start（起始）和 end（结束）的 character offsets（字符串偏移量）（用于高亮显示搜索的内容）。</p>
<p>elasticsearch 提供了很多<strong>内置的分词器</strong>（标准分词器），可以用来构建 custom analyzers（自定义分词器）。</p>
<p>关于分词器： <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/analysis.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.6/analysis.html</a></p>
<pre class="line-numbers language-none"><code class="language-none">POST _analyze
&#123;
  &quot;analyzer&quot;: &quot;standard&quot;,
  &quot;text&quot;: &quot;The 2 Brown-Foxes bone.&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;tokens&quot; : [
    &#123;
      &quot;token&quot; : &quot;the&quot;,
      &quot;start_offset&quot; : 0,
      &quot;end_offset&quot; : 3,
      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,
      &quot;position&quot; : 0
    &#125;,
    &#123;
      &quot;token&quot; : &quot;2&quot;,
      &quot;start_offset&quot; : 4,
      &quot;end_offset&quot; : 5,
      &quot;type&quot; : &quot;&lt;NUM&gt;&quot;,
      &quot;position&quot; : 1
    &#125;,
    &#123;
      &quot;token&quot; : &quot;brown&quot;,
      &quot;start_offset&quot; : 6,
      &quot;end_offset&quot; : 11,
      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,
      &quot;position&quot; : 2
    &#125;,
    &#123;
      &quot;token&quot; : &quot;foxes&quot;,
      &quot;start_offset&quot; : 12,
      &quot;end_offset&quot; : 17,
      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,
      &quot;position&quot; : 3
    &#125;,
    &#123;
      &quot;token&quot; : &quot;bone&quot;,
      &quot;start_offset&quot; : 18,
      &quot;end_offset&quot; : 22,
      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,
      &quot;position&quot; : 4
    &#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于中文，我们需要安装额外的分词器</p>
<h5 id="（1）安装ik分词器"><a class="header-anchor" href="#（1）安装ik分词器">¶</a>（1）安装<code>ik分词器</code></h5>
<p>所有的语言分词，默认使用的都是 “Standard Analyzer”，但是这些分词器针对于中文的分词，并不友好。为此需要安装中文的分词器。</p>
<p>注意：不能用默认 elasticsearch-plugin install xxx.zip 进行自动安装<br>
<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></p>
<p>在前面安装的 elasticsearch 时，我们已经将 elasticsearch 容器的 “<code>/usr/share/elasticsearch/plugins</code>” 目录，映射到宿主机的 “ <code>/mydata/elasticsearch/plugins</code>” 目录下，所以比较方便的做法就是下载 “<code>/elasticsearch-analysis-ik-7.4.2.zip</code>” 文件，然后<strong>解压到该文件夹</strong>下即可。安装完毕后，需要重启 elasticsearch 容器。</p>
<p>如果不嫌麻烦，还可以采用如下的方式。</p>
<h6 id="1）查看-elasticsearch-版本号："><a class="header-anchor" href="#1）查看-elasticsearch-版本号：">¶</a>1）查看 elasticsearch 版本号：</h6>
<pre class="line-numbers language-none"><code class="language-none">[vagrant@localhost ~]$ curl http:&#x2F;&#x2F;localhost:9200
&#123;
  &quot;name&quot; : &quot;66718a266132&quot;,
  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,
  &quot;cluster_uuid&quot; : &quot;xhDnsLynQ3WyRdYmQk5xhQ&quot;,
  &quot;version&quot; : &#123;
    &quot;number&quot; : &quot;7.4.2&quot;,
    &quot;build_flavor&quot; : &quot;default&quot;,
    &quot;build_type&quot; : &quot;docker&quot;,
    &quot;build_hash&quot; : &quot;2f90bbf7b93631e52bafb59b3b049cb44ec25e96&quot;,
    &quot;build_date&quot; : &quot;2019-10-28T20:40:44.881551Z&quot;,
    &quot;build_snapshot&quot; : false,
    &quot;lucene_version&quot; : &quot;8.2.0&quot;,
    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,
    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;
  &#125;,
  &quot;tagline&quot; : &quot;You Know, for Search&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2）进入-es-容器内部-plugin-目录"><a class="header-anchor" href="#2）进入-es-容器内部-plugin-目录">¶</a>2）进入 es 容器内部 plugin 目录</h6>
<ul>
<li>docker exec -it 容器 id /bin/bash</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">[vagrant@localhost ~]$ sudo docker exec -it elasticsearch &#x2F;bin&#x2F;bash

[root@66718a266132 elasticsearch]# pwd
&#x2F;usr&#x2F;share&#x2F;elasticsearch
[root@66718a266132 elasticsearch]# pwd
&#x2F;usr&#x2F;share&#x2F;elasticsearch
[root@66718a266132 elasticsearch]# yum install wget
#下载ik7.4.2
[root@66718a266132 elasticsearch]# wget https:&#x2F;&#x2F;github.com&#x2F;medcl&#x2F;elasticsearch-analysis-ik&#x2F;releases&#x2F;download&#x2F;v7.4.2&#x2F;elasticsearch-analysis-ik-7.4.2.zip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>unzip 下载的文件</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">[root@66718a266132 elasticsearch]# unzip elasticsearch-analysis-ik-7.4.2.zip -d ik

#移动到plugins目录下
[root@66718a266132 elasticsearch]# mv ik plugins&#x2F;
chmod -R 777 plugins&#x2F;ik

docker restart elasticsearch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>rm -rf *.zip</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">[root@66718a266132 elasticsearch]# rm -rf elasticsearch-analysis-ik-7.6.2.zip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>怎么 ssh vagrant 可以看第一篇笔记</p>
</blockquote>
<p>确认是否安装好了分词器</p>
<h5 id="（2）测试分词器"><a class="header-anchor" href="#（2）测试分词器">¶</a>（2）测试分词器</h5>
<p>使用默认分词器</p>
<pre class="line-numbers language-none"><code class="language-none">GET _analyze
&#123;
   &quot;text&quot;:&quot;我是中国人&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>请观察执行结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;tokens&quot; : [
    &#123;
      &quot;token&quot; : &quot;我&quot;,
      &quot;start_offset&quot; : 0,
      &quot;end_offset&quot; : 1,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 0
    &#125;,
    &#123;
      &quot;token&quot; : &quot;是&quot;,
      &quot;start_offset&quot; : 1,
      &quot;end_offset&quot; : 2,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 1
    &#125;,
    &#123;
      &quot;token&quot; : &quot;中&quot;,
      &quot;start_offset&quot; : 2,
      &quot;end_offset&quot; : 3,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 2
    &#125;,
    &#123;
      &quot;token&quot; : &quot;国&quot;,
      &quot;start_offset&quot; : 3,
      &quot;end_offset&quot; : 4,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 3
    &#125;,
    &#123;
      &quot;token&quot; : &quot;人&quot;,
      &quot;start_offset&quot; : 4,
      &quot;end_offset&quot; : 5,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 4
    &#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">GET _analyze
&#123;
   &quot;analyzer&quot;: &quot;ik_smart&quot;, 
   &quot;text&quot;:&quot;我是中国人&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;tokens&quot; : [
    &#123;
      &quot;token&quot; : &quot;我&quot;,
      &quot;start_offset&quot; : 0,
      &quot;end_offset&quot; : 1,
      &quot;type&quot; : &quot;CN_CHAR&quot;,
      &quot;position&quot; : 0
    &#125;,
    &#123;
      &quot;token&quot; : &quot;是&quot;,
      &quot;start_offset&quot; : 1,
      &quot;end_offset&quot; : 2,
      &quot;type&quot; : &quot;CN_CHAR&quot;,
      &quot;position&quot; : 1
    &#125;,
    &#123;
      &quot;token&quot; : &quot;中国人&quot;,
      &quot;start_offset&quot; : 2,
      &quot;end_offset&quot; : 5,
      &quot;type&quot; : &quot;CN_WORD&quot;,
      &quot;position&quot; : 2
    &#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">GET _analyze
&#123;
   &quot;analyzer&quot;: &quot;ik_max_word&quot;, 
   &quot;text&quot;:&quot;我是中国人&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;tokens&quot; : [
    &#123;
      &quot;token&quot; : &quot;我&quot;,
      &quot;start_offset&quot; : 0,
      &quot;end_offset&quot; : 1,
      &quot;type&quot; : &quot;CN_CHAR&quot;,
      &quot;position&quot; : 0
    &#125;,
    &#123;
      &quot;token&quot; : &quot;是&quot;,
      &quot;start_offset&quot; : 1,
      &quot;end_offset&quot; : 2,
      &quot;type&quot; : &quot;CN_CHAR&quot;,
      &quot;position&quot; : 1
    &#125;,
    &#123;
      &quot;token&quot; : &quot;中国人&quot;,
      &quot;start_offset&quot; : 2,
      &quot;end_offset&quot; : 5,
      &quot;type&quot; : &quot;CN_WORD&quot;,
      &quot;position&quot; : 2
    &#125;,
    &#123;
      &quot;token&quot; : &quot;中国&quot;,
      &quot;start_offset&quot; : 2,
      &quot;end_offset&quot; : 4,
      &quot;type&quot; : &quot;CN_WORD&quot;,
      &quot;position&quot; : 3
    &#125;,
    &#123;
      &quot;token&quot; : &quot;国人&quot;,
      &quot;start_offset&quot; : 3,
      &quot;end_offset&quot; : 5,
      &quot;type&quot; : &quot;CN_WORD&quot;,
      &quot;position&quot; : 4
    &#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>调整 vagrant 内存为 4G</p>
</blockquote>
<h5 id="（3）自定义词库"><a class="header-anchor" href="#（3）自定义词库">¶</a>（3）自定义词库</h5>
<blockquote>
<p>比如我们要把尚硅谷算作一个词</p>
</blockquote>
<ul>
<li>修改 / usr/share/elasticsearch/plugins/ik/config 中的 IKAnalyzer.cfg.xml</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE properties SYSTEM &quot;http:&#x2F;&#x2F;java.sun.com&#x2F;dtd&#x2F;properties.dtd&quot;&gt;
&lt;properties&gt;
	&lt;comment&gt;IK Analyzer 扩展配置&lt;&#x2F;comment&gt;
	&lt;!--用户可以在这里配置自己的扩展字典 --&gt;
	&lt;entry key&#x3D;&quot;ext_dict&quot;&gt;&lt;&#x2F;entry&gt;
	 &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;
	&lt;entry key&#x3D;&quot;ext_stopwords&quot;&gt;&lt;&#x2F;entry&gt;
	&lt;!--用户可以在这里配置远程扩展字典 --&gt;
	&lt;entry key&#x3D;&quot;remote_ext_dict&quot;&gt;http:&#x2F;&#x2F;192.168.56.10&#x2F;es&#x2F;fenci.txt&lt;&#x2F;entry&gt; 
	&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;
	&lt;!-- &lt;entry key&#x3D;&quot;remote_ext_stopwords&quot;&gt;words_location&lt;&#x2F;entry&gt; --&gt;
&lt;&#x2F;properties&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改完成后，需要重启 elasticsearch 容器，否则修改不生效。docker restart elasticsearch</p>
<p>更新完成后，es 只会对于新增的数据用更新分词。历史数据是不会重新分词的。如果想要历史数据重新分词，需要执行：</p>
<pre class="line-numbers language-none"><code class="language-none">POST my_index&#x2F;_update_by_query?conflicts&#x3D;proceed<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>安装笔记 1 里的安装 nginx 安装好 nginx</p>
<pre class="line-numbers language-none"><code class="language-none">mkdir &#x2F;mydata&#x2F;nginx&#x2F;html&#x2F;es
cd &#x2F;mydata&#x2F;nginx&#x2F;html&#x2F;es
vim fenci.txt
输入尚硅谷<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试 <a target="_blank" rel="noopener" href="http://192.168.56.10/es/fenci.txt">http://192.168.56.10/es/fenci.txt</a></p>
</blockquote>
<p>，然后创建 “fenci.txt” 文件，内容如下：</p>
<pre class="line-numbers language-none"><code class="language-none">echo &quot;樱桃萨其马，带你甜蜜入夏&quot; &gt; &#x2F;mydata&#x2F;nginx&#x2F;html&#x2F;fenci.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>测试效果：</p>
<pre class="line-numbers language-none"><code class="language-none">GET _analyze
&#123;
   &quot;analyzer&quot;: &quot;ik_max_word&quot;, 
   &quot;text&quot;:&quot;樱桃萨其马，带你甜蜜入夏&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;tokens&quot; : [
    &#123;
      &quot;token&quot; : &quot;樱桃&quot;,
      &quot;start_offset&quot; : 0,
      &quot;end_offset&quot; : 2,
      &quot;type&quot; : &quot;CN_WORD&quot;,
      &quot;position&quot; : 0
    &#125;,
    &#123;
      &quot;token&quot; : &quot;萨其马&quot;,
      &quot;start_offset&quot; : 2,
      &quot;end_offset&quot; : 5,
      &quot;type&quot; : &quot;CN_WORD&quot;,
      &quot;position&quot; : 1
    &#125;,
    &#123;
      &quot;token&quot; : &quot;带你&quot;,
      &quot;start_offset&quot; : 6,
      &quot;end_offset&quot; : 8,
      &quot;type&quot; : &quot;CN_WORD&quot;,
      &quot;position&quot; : 2
    &#125;,
    &#123;
      &quot;token&quot; : &quot;甜蜜&quot;,
      &quot;start_offset&quot; : 8,
      &quot;end_offset&quot; : 10,
      &quot;type&quot; : &quot;CN_WORD&quot;,
      &quot;position&quot; : 3
    &#125;,
    &#123;
      &quot;token&quot; : &quot;入夏&quot;,
      &quot;start_offset&quot; : 10,
      &quot;end_offset&quot; : 12,
      &quot;type&quot; : &quot;CN_WORD&quot;,
      &quot;position&quot; : 4
    &#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4、elasticsearch-Rest-Client"><a class="header-anchor" href="#4、elasticsearch-Rest-Client">¶</a>4、elasticsearch-Rest-Client</h3>
<p>java 操作 es 有两种方式</p>
<h4 id="1）9300-TCP"><a class="header-anchor" href="#1）9300-TCP">¶</a>1）9300: TCP</h4>
<ul>
<li>spring-data-elasticsearch:transport-api.jar;
<ul>
<li>springboot 版本不同，ransport-api.jar 不同，不能适配 es 版本</li>
<li>7.x 已经不建议使用，8 以后就要废弃</li>
</ul>
</li>
</ul>
<h4 id="2）9200-HTTP"><a class="header-anchor" href="#2）9200-HTTP">¶</a>2）9200: HTTP</h4>
<p>有诸多包</p>
<ul>
<li>jestClient: 非官方，更新慢；</li>
<li>RestTemplate：模拟 HTTP 请求，ES 很多操作需要自己封装，麻烦；</li>
<li>HttpClient：同上；</li>
<li><code>Elasticsearch-Rest-Client</code>：官方 RestClient，封装了 ES 操作，API 层次分明，上手简单；</li>
</ul>
<p>最终选择 Elasticsearch-Rest-Client（elasticsearch-rest-high-level-client）</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high.html</a></p>
<h3 id="5、附录：安装-Nginx"><a class="header-anchor" href="#5、附录：安装-Nginx">¶</a>5、附录：安装 Nginx</h3>
<ul>
<li>
<p>随便启动一个 nginx 实例，只是为了复制出配置</p>
<pre class="line-numbers language-none"><code class="language-none">docker run -p80:80 --name nginx -d nginx:1.10<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>将容器内的配置文件拷贝到 / mydata/nginx/conf/ 下</p>
<pre class="line-numbers language-none"><code class="language-none">mkdir -p &#x2F;mydata&#x2F;nginx&#x2F;html
mkdir -p &#x2F;mydata&#x2F;nginx&#x2F;logs
mkdir -p &#x2F;mydata&#x2F;nginx&#x2F;conf
docker container cp nginx:&#x2F;etc&#x2F;nginx&#x2F;*  &#x2F;mydata&#x2F;nginx&#x2F;conf&#x2F; 
#由于拷贝完成后会在config中存在一个nginx文件夹，所以需要将它的内容移动到conf中
mv &#x2F;mydata&#x2F;nginx&#x2F;conf&#x2F;nginx&#x2F;* &#x2F;mydata&#x2F;nginx&#x2F;conf&#x2F;
rm -rf &#x2F;mydata&#x2F;nginx&#x2F;conf&#x2F;nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>终止原容器：</p>
<pre class="line-numbers language-none"><code class="language-none">docker stop nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>执行命令删除原容器：</p>
<pre class="line-numbers language-none"><code class="language-none">docker rm nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>创建新的 Nginx，执行以下命令</p>
<pre class="line-numbers language-none"><code class="language-none">docker run -p 80:80 --name nginx \
 -v &#x2F;mydata&#x2F;nginx&#x2F;html:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html \
 -v &#x2F;mydata&#x2F;nginx&#x2F;logs:&#x2F;var&#x2F;log&#x2F;nginx \
 -v &#x2F;mydata&#x2F;nginx&#x2F;conf&#x2F;:&#x2F;etc&#x2F;nginx \
 -d nginx:1.10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>设置开机启动 nginx</p>
<pre class="line-numbers language-none"><code class="language-none">docker update nginx --restart&#x3D;always<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>创建 “/mydata/nginx/html/index.html” 文件，测试是否能够正常访问</p>
<pre class="line-numbers language-none"><code class="language-none">echo &#39;&lt;h2&gt;hello nginx!&lt;&#x2F;h2&gt;&#39; &gt;index.html<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>访问：<a target="_blank" rel="noopener" href="http://ngix">http://ngix</a> 所在主机的 IP:80/index.html</p>
</li>
</ul>
<h2 id="SpringBoot-整合-ElasticSearch"><a class="header-anchor" href="#SpringBoot-整合-ElasticSearch">¶</a>SpringBoot 整合 ElasticSearch</h2>
<p>创建项目 gulimall-search</p>
<p>选择依赖 web，但不要在里面选择 es</p>
<h3 id="1、导入依赖"><a class="header-anchor" href="#1、导入依赖">¶</a>1、导入依赖</h3>
<p>这里的版本要和所按照的 ELK 版本匹配。</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;dependency&gt;
    &lt;groupId&gt;org.elasticsearch.client&lt;&#x2F;groupId&gt;
    &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;&#x2F;artifactId&gt;
    &lt;version&gt;7.4.2&lt;&#x2F;version&gt;
&lt;&#x2F;dependency&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 spring-boot-dependencies 中所依赖的 ES 版本位 6.8.5，要改掉</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;properties&gt;
    &lt;java.version&gt;1.8&lt;&#x2F;java.version&gt;
    &lt;elasticsearch.version&gt;7.4.2&lt;&#x2F;elasticsearch.version&gt;
&lt;&#x2F;properties&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>请求测试项，比如 es 添加了安全访问规则，访问 es 需要添加一个安全头，就可以通过 requestOptions 设置</p>
<p>官方建议把 requestOptions 创建成单实例</p>
<pre class="line-numbers language-none"><code class="language-none">@Configuration
public class GuliESConfig &#123;

    public static final RequestOptions COMMON_OPTIONS;

    static &#123;
        RequestOptions.Builder builder &#x3D; RequestOptions.DEFAULT.toBuilder();

        COMMON_OPTIONS &#x3D; builder.build();
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此外还有多种方法</p>
<h3 id="2、编写测试类"><a class="header-anchor" href="#2、编写测试类">¶</a>2、编写测试类</h3>
<h4 id="1）测试保存数据"><a class="header-anchor" href="#1）测试保存数据">¶</a>1）测试保存数据</h4>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-document-index.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-document-index.html</a></p>
<p>保存方式分为同步和异步，异步方式多了个 listener 回调</p>
<pre class="line-numbers language-none"><code class="language-none">@Test
public void indexData() throws IOException &#123;
    
    &#x2F;&#x2F; 设置索引
    IndexRequest indexRequest &#x3D; new IndexRequest (&quot;users&quot;);
    indexRequest.id(&quot;1&quot;);

    User user &#x3D; new User();
    user.setUserName(&quot;张三&quot;);
    user.setAge(20);
    user.setGender(&quot;男&quot;);
    String jsonString &#x3D; JSON.toJSONString(user);
    
    &#x2F;&#x2F;设置要保存的内容，指定数据和类型
    indexRequest.source(jsonString, XContentType.JSON);
    
    &#x2F;&#x2F;执行创建索引和保存数据
    IndexResponse index &#x3D; client.index(indexRequest, GulimallElasticSearchConfig.COMMON_OPTIONS);

    System.out.println(index);

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2）测试获取数据"><a class="header-anchor" href="#2）测试获取数据">¶</a>2）测试获取数据</h4>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-search.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-search.html</a></p>
<pre class="line-numbers language-none"><code class="language-none">@Test
    public void find() throws IOException &#123;
        &#x2F;&#x2F; 1 创建检索请求
        SearchRequest searchRequest &#x3D; new SearchRequest();
        searchRequest.indices(&quot;bank&quot;);
        SearchSourceBuilder sourceBuilder &#x3D; new SearchSourceBuilder();
        &#x2F;&#x2F; 构造检索条件
&#x2F;&#x2F;        sourceBuilder.query();
&#x2F;&#x2F;        sourceBuilder.from();
&#x2F;&#x2F;        sourceBuilder.size();
&#x2F;&#x2F;        sourceBuilder.aggregation();
        sourceBuilder.query(QueryBuilders.matchQuery(&quot;address&quot;,&quot;mill&quot;));
        System.out.println(sourceBuilder.toString());

        searchRequest.source(sourceBuilder);

        &#x2F;&#x2F; 2 执行检索
        SearchResponse response &#x3D; client.search(searchRequest, GuliESConfig.COMMON_OPTIONS);
        &#x2F;&#x2F; 3 分析响应结果
        System.out.println(response.toString());
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">&#123;&quot;took&quot;:198,&quot;timed_out&quot;:false,&quot;_shards&quot;:&#123;&quot;total&quot;:1,&quot;successful&quot;:1,&quot;skipped&quot;:0,&quot;failed&quot;:0&#125;,
 &quot;hits&quot;:&#123;
     &quot;total&quot;:&#123;&quot;value&quot;:4,&quot;relation&quot;:&quot;eq&quot;&#125;,
     &quot;max_score&quot;:5.4032025,&quot;hits&quot;:[&#123;&quot;_index&quot;:&quot;bank&quot;,&quot;_type&quot;:&quot;account&quot;,&quot;_id&quot;:&quot;970&quot;,&quot;_score&quot;:5.4032025,&quot;_source&quot;:&#123;&quot;account_number&quot;:970,&quot;balance&quot;:19648,&quot;firstname&quot;:&quot;Forbes&quot;,&quot;lastname&quot;:&quot;Wallace&quot;,&quot;age&quot;:28,&quot;gender&quot;:&quot;M&quot;,&quot;address&quot;:&quot;990 Mill Road&quot;,&quot;employer&quot;:&quot;Pheast&quot;,&quot;email&quot;:&quot;forbeswallace@pheast.com&quot;,&quot;city&quot;:&quot;Lopezo&quot;,&quot;state&quot;:&quot;AK&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;bank&quot;,&quot;_type&quot;:&quot;account&quot;,&quot;_id&quot;:&quot;136&quot;,&quot;_score&quot;:5.4032025,&quot;_source&quot;:&#123;&quot;account_number&quot;:136,&quot;balance&quot;:45801,&quot;firstname&quot;:&quot;Winnie&quot;,&quot;lastname&quot;:&quot;Holland&quot;,&quot;age&quot;:38,&quot;gender&quot;:&quot;M&quot;,&quot;address&quot;:&quot;198 Mill Lane&quot;,&quot;employer&quot;:&quot;Neteria&quot;,&quot;email&quot;:&quot;winnieholland@neteria.com&quot;,&quot;city&quot;:&quot;Urie&quot;,&quot;state&quot;:&quot;IL&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;bank&quot;,&quot;_type&quot;:&quot;account&quot;,&quot;_id&quot;:&quot;345&quot;,&quot;_score&quot;:5.4032025,&quot;_source&quot;:&#123;&quot;account_number&quot;:345,&quot;balance&quot;:9812,&quot;firstname&quot;:&quot;Parker&quot;,&quot;lastname&quot;:&quot;Hines&quot;,&quot;age&quot;:38,&quot;gender&quot;:&quot;M&quot;,&quot;address&quot;:&quot;715 Mill Avenue&quot;,&quot;employer&quot;:&quot;Baluba&quot;,&quot;email&quot;:&quot;parkerhines@baluba.com&quot;,&quot;city&quot;:&quot;Blackgum&quot;,&quot;state&quot;:&quot;KY&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;bank&quot;,&quot;_type&quot;:&quot;account&quot;,&quot;_id&quot;:&quot;472&quot;,&quot;_score&quot;:5.4032025,&quot;_source&quot;:&#123;&quot;account_number&quot;:472,&quot;balance&quot;:25571,&quot;firstname&quot;:&quot;Lee&quot;,&quot;lastname&quot;:&quot;Long&quot;,&quot;age&quot;:32,&quot;gender&quot;:&quot;F&quot;,&quot;address&quot;:&quot;288 Mill Street&quot;,&quot;employer&quot;:&quot;Comverges&quot;,&quot;email&quot;:&quot;leelong@comverges.com&quot;,&quot;city&quot;:&quot;Movico&quot;,&quot;state&quot;:&quot;MT&quot;&#125;&#125;]&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">@Test
    public void find() throws IOException &#123;
        &#x2F;&#x2F; 1 创建检索请求
        SearchRequest searchRequest &#x3D; new SearchRequest();
        searchRequest.indices(&quot;bank&quot;);
        SearchSourceBuilder sourceBuilder &#x3D; new SearchSourceBuilder();
        &#x2F;&#x2F; 构造检索条件
&#x2F;&#x2F;        sourceBuilder.query();
&#x2F;&#x2F;        sourceBuilder.from();
&#x2F;&#x2F;        sourceBuilder.size();
&#x2F;&#x2F;        sourceBuilder.aggregation();
        sourceBuilder.query(QueryBuilders.matchQuery(&quot;address&quot;,&quot;mill&quot;));
        &#x2F;&#x2F;AggregationBuilders工具类构建AggregationBuilder
        &#x2F;&#x2F; 构建第一个聚合条件:按照年龄的值分布
        TermsAggregationBuilder agg1 &#x3D; AggregationBuilders.terms(&quot;agg1&quot;).field(&quot;age&quot;).size(10);&#x2F;&#x2F; 聚合名称
&#x2F;&#x2F; 参数为AggregationBuilder
        sourceBuilder.aggregation(agg1);
        &#x2F;&#x2F; 构建第二个聚合条件:平均薪资
        AvgAggregationBuilder agg2 &#x3D; AggregationBuilders.avg(&quot;agg2&quot;).field(&quot;balance&quot;);
        sourceBuilder.aggregation(agg2);

        System.out.println(&quot;检索条件&quot;+sourceBuilder.toString());

        searchRequest.source(sourceBuilder);

        &#x2F;&#x2F; 2 执行检索
        SearchResponse response &#x3D; client.search(searchRequest, GuliESConfig.COMMON_OPTIONS);
        &#x2F;&#x2F; 3 分析响应结果
        System.out.println(response.toString());
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="把检索结果封装为-java-bean"><a class="header-anchor" href="#把检索结果封装为-java-bean">¶</a>把检索结果封装为 java bean</h5>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; 3.1 获取java bean
SearchHits hits &#x3D; response.getHits();
SearchHit[] hits1 &#x3D; hits.getHits();
for (SearchHit hit : hits1) &#123;
    hit.getId();
    hit.getIndex();
    String sourceAsString &#x3D; hit.getSourceAsString();
    Account account &#x3D; JSON.parseObject(sourceAsString, Account.class);
    System.out.println(account);

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">Account(accountNumber&#x3D;970, balance&#x3D;19648, firstname&#x3D;Forbes, lastname&#x3D;Wallace, age&#x3D;28, gender&#x3D;M, address&#x3D;990 Mill Road, employer&#x3D;Pheast, email&#x3D;forbeswallace@pheast.com, city&#x3D;Lopezo, state&#x3D;AK)
Account(accountNumber&#x3D;136, balance&#x3D;45801, firstname&#x3D;Winnie, lastname&#x3D;Holland, age&#x3D;38, gender&#x3D;M, address&#x3D;198 Mill Lane, employer&#x3D;Neteria, email&#x3D;winnieholland@neteria.com, city&#x3D;Urie, state&#x3D;IL)
Account(accountNumber&#x3D;345, balance&#x3D;9812, firstname&#x3D;Parker, lastname&#x3D;Hines, age&#x3D;38, gender&#x3D;M, address&#x3D;715 Mill Avenue, employer&#x3D;Baluba, email&#x3D;parkerhines@baluba.com, city&#x3D;Blackgum, state&#x3D;KY)
Account(accountNumber&#x3D;472, balance&#x3D;25571, firstname&#x3D;Lee, lastname&#x3D;Long, age&#x3D;32, gender&#x3D;F, address&#x3D;288 Mill Street, employer&#x3D;Comverges, email&#x3D;leelong@comverges.com, city&#x3D;Movico, state&#x3D;MT)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="获取检索到的分析信息"><a class="header-anchor" href="#获取检索到的分析信息">¶</a>获取检索到的分析信息</h5>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; 3.2 获取检索到的分析信息
        Aggregations aggregations &#x3D; response.getAggregations();
        Terms agg21 &#x3D; aggregations.get(&quot;agg2&quot;);
        for (Terms.Bucket bucket : agg21.getBuckets()) &#123;
            String keyAsString &#x3D; bucket.getKeyAsString();
            System.out.println(keyAsString);
        &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>搜索 address 中包含 mill 的所有人的年龄分布以及平均年龄，平均薪资</strong></p>
<pre class="line-numbers language-none"><code class="language-none">GET bank&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match&quot;: &#123;
      &quot;address&quot;: &quot;Mill&quot;
    &#125;
  &#125;,
  &quot;aggs&quot;: &#123;
    &quot;ageAgg&quot;: &#123;
      &quot;terms&quot;: &#123;
        &quot;field&quot;: &quot;age&quot;,
        &quot;size&quot;: 10
      &#125;
    &#125;,
    &quot;ageAvg&quot;: &#123;
      &quot;avg&quot;: &#123;
        &quot;field&quot;: &quot;age&quot;
      &#125;
    &#125;,
    &quot;balanceAvg&quot;: &#123;
      &quot;avg&quot;: &#123;
        &quot;field&quot;: &quot;balance&quot;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="product-es-准备"><a class="header-anchor" href="#product-es-准备">¶</a>product-es 准备</h2>
<p>P128</p>
<p>ES 在内存中，所以在检索中优于 mysql。ES 也支持集群，数据分片存储。</p>
<p>需求：</p>
<ul>
<li>上架的商品才可以在网站展示。</li>
<li>上架的商品需要可以被检索。</li>
</ul>
<h3 id="分析-sku-在-es-中如何存储"><a class="header-anchor" href="#分析-sku-在-es-中如何存储">¶</a>分析 sku 在 es 中如何存储</h3>
<p>商品 mapping</p>
<p>分析：商品上架在 es 中是存 sku 还是 spu？</p>
<ul>
<li>1）、检索的时候输入名字，是需要按照 sku 的 title 进行全文检索的</li>
<li>2）、检素使用商品规格，规格是 spu 的公共属性，每个 spu 是一样的</li>
<li>3）、按照分类 id 进去的都是直接列出 spu 的，还可以切换。</li>
<li>4〕、我们如果将 sku 的全量信息保存到 es 中（包括 spu 属性〕就太多字段了</li>
</ul>
<p>方案 1：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    skuId:1
    spuId:11
    skyTitile:华为xx
    price:999
    saleCount:99
    attr:[
        &#123;尺寸:5&#125;,
        &#123;CPU:高通945&#125;,
        &#123;分辨率:全高清&#125;
	]
缺点：如果每个sku都存储规格参数(如尺寸)，会有冗余存储，因为每个spu对应的sku的规格参数都一样<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>方案 2：</p>
<pre class="line-numbers language-none"><code class="language-none">sku索引
&#123;
    spuId:1
    skuId:11
&#125;
attr索引
&#123;
    skuId:11
    attr:[
        &#123;尺寸:5&#125;,
        &#123;CPU:高通945&#125;,
        &#123;分辨率:全高清&#125;
	]
&#125;
先找到4000个符合要求的spu，再根据4000个spu查询对应的属性，封装了4000个id，long 8B*4000&#x3D;32000B&#x3D;32KB
1K个人检索，就是32MB


结论：如果将规格参数单独建立索引，会出现检索时出现大量数据传输的问题，会引起网络网络<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因此选用方案 1，以空间换时间</p>
<h3 id="建立-product-索引"><a class="header-anchor" href="#建立-product-索引">¶</a>建立 product 索引</h3>
<p>最终选用的数据模型：</p>
<pre class="line-numbers language-none"><code class="language-none">PUT product
&#123;
    &quot;mappings&quot;:&#123;
        &quot;properties&quot;: &#123;
            &quot;skuId&quot;:&#123; &quot;type&quot;: &quot;long&quot; &#125;,
            &quot;spuId&quot;:&#123; &quot;type&quot;: &quot;keyword&quot; &#125;,  # 不可分词
            &quot;skuTitle&quot;: &#123;
                &quot;type&quot;: &quot;text&quot;,
                &quot;analyzer&quot;: &quot;ik_smart&quot;  # 中文分词器
            &#125;,
            &quot;skuPrice&quot;: &#123; &quot;type&quot;: &quot;keyword&quot; &#125;,
            &quot;skuImg&quot;  : &#123; &quot;type&quot;: &quot;keyword&quot; &#125;,
            &quot;saleCount&quot;:&#123; &quot;type&quot;:&quot;long&quot; &#125;,
            &quot;hasStock&quot;: &#123; &quot;type&quot;: &quot;boolean&quot; &#125;,
            &quot;hotScore&quot;: &#123; &quot;type&quot;: &quot;long&quot;  &#125;,
            &quot;brandId&quot;:  &#123; &quot;type&quot;: &quot;long&quot; &#125;,
            &quot;catalogId&quot;: &#123; &quot;type&quot;: &quot;long&quot;  &#125;,
            &quot;brandName&quot;: &#123;&quot;type&quot;: &quot;keyword&quot;&#125;,
            &quot;brandImg&quot;:&#123;
                &quot;type&quot;: &quot;keyword&quot;,
                &quot;index&quot;: false,  # 不可被检索，不生成index
                &quot;doc_values&quot;: false # 不可被聚合
            &#125;,
            &quot;catalogName&quot;: &#123;&quot;type&quot;: &quot;keyword&quot; &#125;,
            &quot;attrs&quot;: &#123;
                &quot;type&quot;: &quot;nested&quot;,
                &quot;properties&quot;: &#123;
                    &quot;attrId&quot;: &#123;&quot;type&quot;: &quot;long&quot;  &#125;,
                    &quot;attrName&quot;: &#123;
                        &quot;type&quot;: &quot;keyword&quot;,
                        &quot;index&quot;: false,
                        &quot;doc_values&quot;: false
                    &#125;,
                    &quot;attrValue&quot;: &#123;&quot;type&quot;: &quot;keyword&quot; &#125;
                &#125;
            &#125;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中</p>
<ul>
<li>“type”: “keyword” 保持数据精度问题，可以检索，但不分词</li>
<li>“index”:false 代表不可被检索</li>
<li>“doc_values”: false 不可被聚合，es 就不会维护一些聚合的信息</li>
</ul>
<p>冗余存储的字段：不用来检索，也不用来分析，节省空间</p>
<blockquote>
<p>库存是 bool。</p>
<p>检索品牌 id，但是不检索品牌名字、图片</p>
<p>用 skuTitle 检索</p>
</blockquote>
<h3 id="nested-嵌入式对象"><a class="header-anchor" href="#nested-嵌入式对象">¶</a>nested 嵌入式对象</h3>
<p>属性是 “type”: “nested”, 因为是内部的属性进行检索</p>
<p>数组类型的对象会被扁平化处理（对象的每个属性会分别存储到一起）</p>
<pre class="line-numbers language-none"><code class="language-none">user.name&#x3D;[&quot;aaa&quot;,&quot;bbb&quot;]
user.addr&#x3D;[&quot;ccc&quot;,&quot;ddd&quot;]

这种存储方式，可能会发生如下错误：
错误检索到&#123;aaa,ddd&#125;，这个组合是不存在的<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>数组的扁平化处理会使检索能检索到本身不存在的，为了解决这个问题，就采用了嵌入式属性，数组里是对象时用嵌入式属性（不是对象无需用嵌入式属性）</p>
<p>nested 阅读：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40341116/article/details/80778599">https://blog.csdn.net/weixin_40341116/article/details/80778599</a></p>
<p>使用聚合：<a target="_blank" rel="noopener" href="https://blog.csdn.net/kabike/article/details/101460578">https://blog.csdn.net/kabike/article/details/101460578</a></p>
<h2 id="product-java-实战"><a class="header-anchor" href="#product-java-实战">¶</a>product-java 实战</h2>
<p>新建 gulimall-search 微服务</p>
<p>依赖：thymeleaf</p>
<p>修改源文档 index.html 中的路径，加上 / static 前缀，交由 nginx 响应</p>
<p>修改 hosts <a target="_blank" rel="noopener" href="http://search.gulimall.com">search.gulimall.com</a></p>
<p>修改 nginx 的配置文件 *.gulimall.com; 要注意这种配置方式不包含 <a target="_blank" rel="noopener" href="http://gulimall.com">gulimall.com</a></p>
<pre class="line-numbers language-none"><code class="language-none">server_name gulimall.com  *.gulimall.com;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>修改 index.html 成 list.html。添加对应 controller</p>
<h4 id="1、VO-与-url"><a class="header-anchor" href="#1、VO-与-url">¶</a>1、VO 与 url</h4>
<p>创建 SearchParam 用于检索 VO</p>
<ul>
<li>全文检索：skuTitle-》keyword</li>
<li>排序：saleCount（销量）、hotScore（热度分）、skuPrice（价格）</li>
<li>过滤：hasStock、skuPrice 区间、brandId、catalog3Id、attrs</li>
<li>聚合：attrs</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">keyword&#x3D;小米&amp;
sort&#x3D;saleCount_desc&#x2F;asc&amp;
hasStock&#x3D;0&#x2F;1&amp;
skuPrice&#x3D;400_1900&amp;
brandId&#x3D;1&amp;
catalog3Id&#x3D;1&amp;
attrs&#x3D;1_3G:4G:5G&amp;
attrs&#x3D;2_骁龙845&amp;
attrs&#x3D;4_高清屏<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;**
封装页面所有可能传递过来的关键字
 * catalog3Id&#x3D;225&amp;keyword&#x3D;华为&amp;sort&#x3D;saleCount_asc&amp;hasStock&#x3D;0&#x2F;1&amp;brandId&#x3D;25&amp;brandId&#x3D;30
 *&#x2F;
@Data
public class SearchParam &#123;

    &#x2F;&#x2F; 页面传递过来的全文匹配关键字
    private String keyword;

    &#x2F;** 三级分类id*&#x2F;
    private Long catalog3Id;
    &#x2F;&#x2F;排序条件：sort&#x3D;price&#x2F;salecount&#x2F;hotscore_desc&#x2F;asc
    private String sort;
    &#x2F;&#x2F; 仅显示有货
    private Integer hasStock;

    &#x2F;*** 价格区间 *&#x2F;
    private String skuPrice;

    &#x2F;*** 品牌id 可以多选 *&#x2F;
    private List&lt;Long&gt; brandId;

    &#x2F;*** 按照属性进行筛选 *&#x2F;
    private List&lt;String&gt; attrs;

    &#x2F;*** 页码*&#x2F;
    private Integer pageNum &#x3D; 1;

    &#x2F;*** 原生所有查询属性*&#x2F;
    private String _queryString;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="search-结果-VO"><a class="header-anchor" href="#search-结果-VO">¶</a>search 结果 VO</h5>
<p>查询得到商品、总记录数、总页码<br>
品牌 list 用于在品牌栏显示，分类 list 用于在分类栏显示</p>
<p>其他栏每栏用 AttrVo 表示</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;**
 * &lt;p&gt;Title: SearchResponse&lt;&#x2F;p&gt;
 * Description：包含页面需要的所有信息
 *&#x2F;
@Data
public class SearchResult &#123;

    &#x2F;** * 查询到的所有商品信息*&#x2F;
    private List&lt;SkuEsModel&gt; products;

    &#x2F;*** 当前页码*&#x2F;
    private Integer pageNum;
    &#x2F;** 总记录数*&#x2F;
    private Long total;
    &#x2F;** * 总页码*&#x2F;
    private Integer totalPages;

    &#x2F;** 当前查询到的结果, 所有涉及到的品牌*&#x2F;
    private List&lt;BrandVo&gt; brands;
    &#x2F;*** 当前查询到的结果, 所有涉及到的分类*&#x2F;
    private List&lt;CatalogVo&gt; catalogs;
	&#x2F;** * 当前查询的结果 所有涉及到所有属性*&#x2F;
    private List&lt;AttrVo&gt; attrs;

	&#x2F;** 导航页   页码遍历结果集(分页)  *&#x2F;
	private List&lt;Integer&gt; pageNavs;
&#x2F;&#x2F;	&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;以上是返回给页面的所有信息&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

    &#x2F;** 导航数据*&#x2F;
    private List&lt;NavVo&gt; navs &#x3D; new ArrayList&lt;&gt;();

    &#x2F;** 便于判断当前id是否被使用*&#x2F;
    private List&lt;Long&gt; attrIds &#x3D; new ArrayList&lt;&gt;();

    @Data
    public static class NavVo &#123;
        private String name;
        private String navValue;
        private String link;
    &#125;

    @Data
    public static class BrandVo &#123;

        private Long brandId;
        private String brandName;
        private String brandImg;
    &#125;

    @Data
    public static class CatalogVo &#123;
        private Long catalogId;
        private String catalogName;
    &#125;

    @Data
    public static class AttrVo &#123;

        private Long attrId;
        private String attrName;
        private List&lt;String&gt; attrValue;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2、ES-语句-DSL"><a class="header-anchor" href="#2、ES-语句-DSL">¶</a>2、ES 语句 DSL</h3>
<ul>
<li>嵌入式的属性</li>
<li>highlight：设置该值后，返回的时候就包装过了</li>
<li>查出结果后，附属栏也要对应变化</li>
<li>嵌入式的聚合时候也要注意</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">GET gulimall_product&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;bool&quot;: &#123;
      &quot;must&quot;: [ &#123;&quot;match&quot;: &#123;  &quot;skuTitle&quot;: &quot;华为&quot; &#125;&#125; ],
      &quot;filter&quot;: [
        &#123; &quot;term&quot;: &#123; &quot;catalogId&quot;: &quot;225&quot; &#125; &#125;,
        &#123; &quot;terms&quot;: &#123;&quot;brandId&quot;: [ &quot;2&quot;] &#125; &#125;, #terms
        &#123; &quot;term&quot;: &#123; &quot;hasStock&quot;: &quot;false&quot;&#125; &#125;,
        &#123;
          &quot;range&quot;: &#123;
            &quot;skuPrice&quot;: &#123;
              &quot;gte&quot;: 1000,
              &quot;lte&quot;: 7000
            &#125;
          &#125;
        &#125;,
        &#123;
          &quot;nested&quot;: &#123;
            &quot;path&quot;: &quot;attrs&quot;,
            &quot;query&quot;: &#123;
              &quot;bool&quot;: &#123;
                &quot;must&quot;: [
                  &#123;
                    &quot;term&quot;: &#123; &quot;attrs.attrId&quot;: &#123; &quot;value&quot;: &quot;6&quot;&#125; &#125;
                  &#125;
                ]
              &#125;
            &#125;
          &#125;
        &#125;
      ]
    &#125;
  &#125;,
  &quot;sort&quot;: [ &#123;&quot;skuPrice&quot;: &#123;&quot;order&quot;: &quot;desc&quot; &#125; &#125; ],
  &quot;from&quot;: 0,
  &quot;size&quot;: 5,
  &quot;highlight&quot;: &#123;  # 高亮
    &quot;fields&quot;: &#123;&quot;skuTitle&quot;: &#123;&#125;&#125;,
    &quot;pre_tags&quot;: &quot;&lt;b style&#x3D;&#39;color:red&#39;&gt;&quot;, 
    &quot;post_tags&quot;: &quot;&lt;&#x2F;b&gt;&quot;
  &#125;,
  &quot;aggs&quot;: &#123;
    &quot;brandAgg&quot;: &#123;
      &quot;terms&quot;: &#123;
        &quot;field&quot;: &quot;brandId&quot;,
        &quot;size&quot;: 10
      &#125;,
      &quot;aggs&quot;: &#123;
        &quot;brandNameAgg&quot;: &#123;
          &quot;terms&quot;: &#123;
            &quot;field&quot;: &quot;brandName&quot;,
            &quot;size&quot;: 10
          &#125;
        &#125;,
      
        &quot;brandImgAgg&quot;: &#123;
          &quot;terms&quot;: &#123;
            &quot;field&quot;: &quot;brandImg&quot;,
            &quot;size&quot;: 10
          &#125;
        &#125;
        
      &#125;
    &#125;,
    &quot;catalogAgg&quot;:&#123;
      &quot;terms&quot;: &#123;
        &quot;field&quot;: &quot;catalogId&quot;,
        &quot;size&quot;: 10
      &#125;,
      &quot;aggs&quot;: &#123;
        &quot;catalogNameAgg&quot;: &#123;
          &quot;terms&quot;: &#123;
            &quot;field&quot;: &quot;catalogName&quot;,
            &quot;size&quot;: 10
          &#125;
        &#125;
      &#125;
    &#125;,
    &quot;attrs&quot;:&#123;
      &quot;nested&quot;: &#123;&quot;path&quot;: &quot;attrs&quot; &#125;,
      &quot;aggs&quot;: &#123;
        &quot;attrIdAgg&quot;: &#123;
          &quot;terms&quot;: &#123;
            &quot;field&quot;: &quot;attrs.attrId&quot;,
            &quot;size&quot;: 10
          &#125;,
          &quot;aggs&quot;: &#123;
            &quot;attrNameAgg&quot;: &#123;
              &quot;terms&quot;: &#123;
                &quot;field&quot;: &quot;attrs.attrName&quot;,
                &quot;size&quot;: 10
              &#125;
            &#125;
          &#125;
        &#125;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3、检索代码"><a class="header-anchor" href="#3、检索代码">¶</a>3、检索代码</h3>
<h4 id="1-请求层"><a class="header-anchor" href="#1-请求层">¶</a>1) 请求层</h4>
<p>主要逻辑在 service 层进行，service 层将封装好的<code>SearchParam</code>组建查询条件，再将返回后的结果封装成<code>SearchResult</code></p>
<pre class="line-numbers language-none"><code class="language-none">@GetMapping(value &#x3D; &#123;&quot;&#x2F;search.html&quot;,&quot;&#x2F;&quot;&#125;)
public String getSearchPage(SearchParam searchParam, 
                            Model model, HttpServletRequest request) &#123;
    searchParam.set_queryString(request.getQueryString());
    SearchResult result&#x3D;searchService.getSearchResult(searchParam);
    model.addAttribute(&quot;result&quot;, result);
    return &quot;search&quot;;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>DSL 转 java 主要逻辑：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; service
public SearchResult getSearchResult(SearchParam searchParam) &#123;
    SearchResult searchResult&#x3D; null;
    &#x2F;&#x2F; 通过请求参数构建查询请求
    SearchRequest request &#x3D; bulidSearchRequest(searchParam);
    try &#123;
        SearchResponse searchResponse &#x3D; restHighLevelClient.search(request, 
                                                                   GulimallElasticSearchConfig.COMMON_OPTIONS);
        &#x2F;&#x2F; 将es响应数据封装成结果
        searchResult &#x3D; bulidSearchResult(searchParam,searchResponse);
    &#125; catch (IOException e) &#123;
        e.printStackTrace();
    &#125;
    return searchResult;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="DSL-转-java"><a class="header-anchor" href="#DSL-转-java">¶</a>DSL 转 java</h5>
<pre class="line-numbers language-none"><code class="language-none">private SearchRequest bulidSearchRequest(SearchParam searchParam) &#123;
    &#x2F;&#x2F; 用于构建DSL语句 
    SearchSourceBuilder searchSourceBuilder &#x3D; new SearchSourceBuilder();
    &#x2F;&#x2F;1. 构建bool query
    BoolQueryBuilder boolQueryBuilder &#x3D; new BoolQueryBuilder();
    &#x2F;&#x2F;1.1 bool must
    if (!StringUtils.isEmpty(searchParam.getKeyword())) &#123;
        boolQueryBuilder.must(QueryBuilders.matchQuery(&quot;skuTitle&quot;, searchParam.getKeyword()));
    &#125;

    &#x2F;&#x2F;1.2 bool filter
    &#x2F;&#x2F;1.2.1 catalog
    if (searchParam.getCatalog3Id()!&#x3D;null)&#123;
        boolQueryBuilder.filter(QueryBuilders.termQuery(&quot;catalogId&quot;, searchParam.getCatalog3Id()));
    &#125;
    &#x2F;&#x2F;1.2.2 brand
    if (searchParam.getBrandId()!&#x3D;null&amp;&amp;searchParam.getBrandId().size()&gt;0) &#123;
        boolQueryBuilder.filter(QueryBuilders.termsQuery(&quot;brandId&quot;,searchParam.getBrandId()));
    &#125;
    &#x2F;&#x2F;1.2.3 hasStock
    if (searchParam.getHasStock() !&#x3D; null) &#123;
        boolQueryBuilder.filter(QueryBuilders.termQuery(&quot;hasStock&quot;, searchParam.getHasStock() &#x3D;&#x3D; 1));
    &#125;
    &#x2F;&#x2F;1.2.4 priceRange
    RangeQueryBuilder rangeQueryBuilder &#x3D; QueryBuilders.rangeQuery(&quot;skuPrice&quot;);
    if (!StringUtils.isEmpty(searchParam.getSkuPrice())) &#123;
        String[] prices &#x3D; searchParam.getSkuPrice().split(&quot;_&quot;);
        if (prices.length &#x3D;&#x3D; 1) &#123;
            if (searchParam.getSkuPrice().startsWith(&quot;_&quot;)) &#123;
                rangeQueryBuilder.lte(Integer.parseInt(prices[0]));
            &#125;else &#123;
                rangeQueryBuilder.gte(Integer.parseInt(prices[0]));
            &#125;
        &#125; else if (prices.length &#x3D;&#x3D; 2) &#123;
            &#x2F;&#x2F;_6000会截取成[&quot;&quot;,&quot;6000&quot;]
            if (!prices[0].isEmpty()) &#123;
                rangeQueryBuilder.gte(Integer.parseInt(prices[0]));
            &#125;
            rangeQueryBuilder.lte(Integer.parseInt(prices[1]));
        &#125;
        boolQueryBuilder.filter(rangeQueryBuilder);
    &#125;
    &#x2F;&#x2F;1.2.5 attrs-nested
    &#x2F;&#x2F;attrs&#x3D;1_5寸:8寸&amp;2_16G:8G
    List&lt;String&gt; attrs &#x3D; searchParam.getAttrs();
    BoolQueryBuilder queryBuilder &#x3D; new BoolQueryBuilder();
    if (attrs!&#x3D;null&amp;&amp;attrs.size() &gt; 0) &#123;
        attrs.forEach(attr-&gt;&#123;
            String[] attrSplit &#x3D; attr.split(&quot;_&quot;);
            queryBuilder.must(QueryBuilders.termQuery(&quot;attrs.attrId&quot;, attrSplit[0]));
            String[] attrValues &#x3D; attrSplit[1].split(&quot;:&quot;);
            queryBuilder.must(QueryBuilders.termsQuery(&quot;attrs.attrValue&quot;, attrValues));
        &#125;);
    &#125;
    NestedQueryBuilder nestedQueryBuilder &#x3D; QueryBuilders.nestedQuery(&quot;attrs&quot;, queryBuilder, ScoreMode.None);
    boolQueryBuilder.filter(nestedQueryBuilder);
    &#x2F;&#x2F;1.X bool query构建完成
    searchSourceBuilder.query(boolQueryBuilder);

    &#x2F;&#x2F;2. sort  eg:sort&#x3D;saleCount_desc&#x2F;asc
    if (!StringUtils.isEmpty(searchParam.getSort())) &#123;
        String[] sortSplit &#x3D; searchParam.getSort().split(&quot;_&quot;);
        searchSourceBuilder.sort(sortSplit[0], sortSplit[1].equalsIgnoreCase(&quot;asc&quot;) ? SortOrder.ASC : SortOrder.DESC);
    &#125;

    &#x2F;&#x2F;3. 分页
    searchSourceBuilder.from((searchParam.getPageNum() - 1) * EsConstant.PRODUCT_PAGESIZE);
    searchSourceBuilder.size(EsConstant.PRODUCT_PAGESIZE);

    &#x2F;&#x2F;4. 高亮highlight
    if (!StringUtils.isEmpty(searchParam.getKeyword())) &#123;
        HighlightBuilder highlightBuilder &#x3D; new HighlightBuilder();
        highlightBuilder.field(&quot;skuTitle&quot;);
        highlightBuilder.preTags(&quot;&lt;b style&#x3D;&#39;color:red&#39;&gt;&quot;);
        highlightBuilder.postTags(&quot;&lt;&#x2F;b&gt;&quot;);
        searchSourceBuilder.highlighter(highlightBuilder);
    &#125;

    &#x2F;&#x2F;5. 聚合
    &#x2F;&#x2F;5.1 按照brand聚合
    TermsAggregationBuilder brandAgg &#x3D; AggregationBuilders.terms(&quot;brandAgg&quot;).field(&quot;brandId&quot;);
    TermsAggregationBuilder brandNameAgg &#x3D; AggregationBuilders.terms(&quot;brandNameAgg&quot;).field(&quot;brandName&quot;);
    TermsAggregationBuilder brandImgAgg &#x3D; AggregationBuilders.terms(&quot;brandImgAgg&quot;).field(&quot;brandImg&quot;);
    brandAgg.subAggregation(brandNameAgg);
    brandAgg.subAggregation(brandImgAgg);
    searchSourceBuilder.aggregation(brandAgg);

    &#x2F;&#x2F;5.2 按照catalog聚合
    TermsAggregationBuilder catalogAgg &#x3D; AggregationBuilders.terms(&quot;catalogAgg&quot;).field(&quot;catalogId&quot;);
    TermsAggregationBuilder catalogNameAgg &#x3D; AggregationBuilders.terms(&quot;catalogNameAgg&quot;).field(&quot;catalogName&quot;);
    catalogAgg.subAggregation(catalogNameAgg);
    searchSourceBuilder.aggregation(catalogAgg);

    &#x2F;&#x2F;5.3 按照attrs聚合
    NestedAggregationBuilder nestedAggregationBuilder &#x3D; new NestedAggregationBuilder(&quot;attrs&quot;, &quot;attrs&quot;);
    &#x2F;&#x2F;按照attrId聚合
    TermsAggregationBuilder attrIdAgg &#x3D; AggregationBuilders.terms(&quot;attrIdAgg&quot;).field(&quot;attrs.attrId&quot;);
    &#x2F;&#x2F;按照attrId聚合之后再按照attrName和attrValue聚合
    TermsAggregationBuilder attrNameAgg &#x3D; AggregationBuilders.terms(&quot;attrNameAgg&quot;).field(&quot;attrs.attrName&quot;);
    TermsAggregationBuilder attrValueAgg &#x3D; AggregationBuilders.terms(&quot;attrValueAgg&quot;).field(&quot;attrs.attrValue&quot;);
    attrIdAgg.subAggregation(attrNameAgg);
    attrIdAgg.subAggregation(attrValueAgg);

    nestedAggregationBuilder.subAggregation(attrIdAgg);
    searchSourceBuilder.aggregation(nestedAggregationBuilder);

    log.debug(&quot;构建的DSL语句 &#123;&#125;&quot;,searchSourceBuilder.toString());

    SearchRequest request &#x3D; new SearchRequest(new String[]&#123;EsConstant.PRODUCT_INDEX&#125;, searchSourceBuilder);
    return request;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-接收检索响应"><a class="header-anchor" href="#2-接收检索响应">¶</a>2) 接收检索响应</h4>
<ul>
<li>得到检索到的商品</li>
<li>还有聚合信息</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">private SearchResult bulidSearchResult(SearchParam searchParam, SearchResponse searchResponse) &#123;
    SearchResult result &#x3D; new SearchResult();
    
    SearchHits hits &#x3D; searchResponse.getHits();
    &#x2F;&#x2F;1. 封装查询到的商品信息
    if (hits.getHits()!&#x3D;null&amp;&amp;hits.getHits().length&gt;0)&#123;
        List&lt;SkuEsModel&gt; skuEsModels &#x3D; new ArrayList&lt;&gt;();
        for (SearchHit hit : hits) &#123;
            String sourceAsString &#x3D; hit.getSourceAsString();
            SkuEsModel skuEsModel &#x3D; JSON.parseObject(sourceAsString, SkuEsModel.class);
            &#x2F;&#x2F;设置高亮属性
            if (!StringUtils.isEmpty(searchParam.getKeyword())) &#123;
                HighlightField skuTitle &#x3D; hit.getHighlightFields().get(&quot;skuTitle&quot;);
                String highLight &#x3D; skuTitle.getFragments()[0].string();
                skuEsModel.setSkuTitle(highLight);
            &#125;
            skuEsModels.add(skuEsModel);
        &#125;
        result.setProduct(skuEsModels);
    &#125;

    &#x2F;&#x2F;2. 封装分页信息
    &#x2F;&#x2F;2.1 当前页码
    result.setPageNum(searchParam.getPageNum());
    &#x2F;&#x2F;2.2 总记录数
    long total &#x3D; hits.getTotalHits().value;
    result.setTotal(total);
    &#x2F;&#x2F;2.3 总页码
    Integer totalPages &#x3D; (int)total % EsConstant.PRODUCT_PAGESIZE &#x3D;&#x3D; 0 ?
            (int)total &#x2F; EsConstant.PRODUCT_PAGESIZE : (int)total &#x2F; EsConstant.PRODUCT_PAGESIZE + 1;
    result.setTotalPages(totalPages);
    List&lt;Integer&gt; pageNavs &#x3D; new ArrayList&lt;&gt;();
    for (int i &#x3D; 1; i &lt;&#x3D; totalPages; i++) &#123;
        pageNavs.add(i);
    &#125;
    result.setPageNavs(pageNavs);

    &#x2F;&#x2F;3. 查询结果涉及到的品牌
    List&lt;SearchResult.BrandVo&gt; brandVos &#x3D; new ArrayList&lt;&gt;();
    Aggregations aggregations &#x3D; searchResponse.getAggregations();
    &#x2F;&#x2F;ParsedLongTerms用于接收terms聚合的结果，并且可以把key转化为Long类型的数据
    ParsedLongTerms brandAgg &#x3D; aggregations.get(&quot;brandAgg&quot;);
    for (Terms.Bucket bucket : brandAgg.getBuckets()) &#123;
        &#x2F;&#x2F;3.1 得到品牌id
        Long brandId &#x3D; bucket.getKeyAsNumber().longValue();

        Aggregations subBrandAggs &#x3D; bucket.getAggregations();
        &#x2F;&#x2F;3.2 得到品牌图片
        ParsedStringTerms brandImgAgg&#x3D;subBrandAggs.get(&quot;brandImgAgg&quot;);
        String brandImg &#x3D; brandImgAgg.getBuckets().get(0).getKeyAsString();
        &#x2F;&#x2F;3.3 得到品牌名字
        Terms brandNameAgg&#x3D;subBrandAggs.get(&quot;brandNameAgg&quot;);
        String brandName &#x3D; brandNameAgg.getBuckets().get(0).getKeyAsString();
        SearchResult.BrandVo brandVo &#x3D; new SearchResult.BrandVo(brandId, brandName, brandImg);
        brandVos.add(brandVo);
    &#125;
    result.setBrands(brandVos);

    &#x2F;&#x2F;4. 查询涉及到的所有分类
    List&lt;SearchResult.CatalogVo&gt; catalogVos &#x3D; new ArrayList&lt;&gt;();
    ParsedLongTerms catalogAgg &#x3D; aggregations.get(&quot;catalogAgg&quot;);
    for (Terms.Bucket bucket : catalogAgg.getBuckets()) &#123;
        &#x2F;&#x2F;4.1 获取分类id
        Long catalogId &#x3D; bucket.getKeyAsNumber().longValue();
        Aggregations subcatalogAggs &#x3D; bucket.getAggregations();
        &#x2F;&#x2F;4.2 获取分类名
        ParsedStringTerms catalogNameAgg&#x3D;subcatalogAggs.get(&quot;catalogNameAgg&quot;);
        String catalogName &#x3D; catalogNameAgg.getBuckets().get(0).getKeyAsString();
        SearchResult.CatalogVo catalogVo &#x3D; new SearchResult.CatalogVo(catalogId, catalogName);
        catalogVos.add(catalogVo);
    &#125;
    result.setCatalogs(catalogVos);

    &#x2F;&#x2F;5 查询涉及到的所有属性
    List&lt;SearchResult.AttrVo&gt; attrVos &#x3D; new ArrayList&lt;&gt;();
    &#x2F;&#x2F;ParsedNested用于接收内置属性的聚合
    ParsedNested parsedNested&#x3D;aggregations.get(&quot;attrs&quot;);
    ParsedLongTerms attrIdAgg&#x3D;parsedNested.getAggregations().get(&quot;attrIdAgg&quot;);
    for (Terms.Bucket bucket : attrIdAgg.getBuckets()) &#123;
        &#x2F;&#x2F;5.1 查询属性id
        Long attrId &#x3D; bucket.getKeyAsNumber().longValue();

        Aggregations subAttrAgg &#x3D; bucket.getAggregations();
        &#x2F;&#x2F;5.2 查询属性名
        ParsedStringTerms attrNameAgg&#x3D;subAttrAgg.get(&quot;attrNameAgg&quot;);
        String attrName &#x3D; attrNameAgg.getBuckets().get(0).getKeyAsString();
        &#x2F;&#x2F;5.3 查询属性值
        ParsedStringTerms attrValueAgg &#x3D; subAttrAgg.get(&quot;attrValueAgg&quot;);
        List&lt;String&gt; attrValues &#x3D; new ArrayList&lt;&gt;();
        for (Terms.Bucket attrValueAggBucket : attrValueAgg.getBuckets()) &#123;
            String attrValue &#x3D; attrValueAggBucket.getKeyAsString();
            attrValues.add(attrValue);
            List&lt;SearchResult.NavVo&gt; navVos &#x3D; new ArrayList&lt;&gt;();
        &#125;
        SearchResult.AttrVo attrVo &#x3D; new SearchResult.AttrVo(attrId, attrName, attrValues);
        attrVos.add(attrVo);
    &#125;
    result.setAttrs(attrVos);

    &#x2F;&#x2F; 6. 构建面包屑导航
    List&lt;String&gt; attrs &#x3D; searchParam.getAttrs();
    if (attrs !&#x3D; null &amp;&amp; attrs.size() &gt; 0) &#123;
        List&lt;SearchResult.NavVo&gt; navVos &#x3D; attrs.stream().map(attr -&gt; &#123;
            String[] split &#x3D; attr.split(&quot;_&quot;);
            SearchResult.NavVo navVo &#x3D; new SearchResult.NavVo();
            &#x2F;&#x2F;6.1 设置属性值
            navVo.setNavValue(split[1]);
            &#x2F;&#x2F;6.2 查询并设置属性名
            try &#123;
                R r &#x3D; productFeignService.info(Long.parseLong(split[0]));
                if (r.getCode() &#x3D;&#x3D; 0) &#123;
                    AttrResponseVo attrResponseVo &#x3D; JSON.parseObject(JSON.toJSONString(r.get(&quot;attr&quot;)), new TypeReference&lt;AttrResponseVo&gt;() &#123;
                    &#125;);
                    navVo.setNavName(attrResponseVo.getAttrName());
                &#125;
            &#125; catch (Exception e) &#123;
                log.error(&quot;远程调用商品服务查询属性失败&quot;, e);
            &#125;
            &#x2F;&#x2F;6.3 设置面包屑跳转链接
            String queryString &#x3D; searchParam.get_queryString();
            String replace &#x3D; queryString.replace(&quot;&amp;attrs&#x3D;&quot; + attr, &quot;&quot;).replace(&quot;attrs&#x3D;&quot; + attr+&quot;&amp;&quot;, &quot;&quot;).replace(&quot;attrs&#x3D;&quot; + attr, &quot;&quot;);
            navVo.setLink(&quot;http:&#x2F;&#x2F;search.gulimall.com&#x2F;search.html&quot; + (replace.isEmpty()?&quot;&quot;:&quot;?&quot;+replace));
            return navVo;
        &#125;).collect(Collectors.toList());
        result.setNavs(navVos);
    &#125;
    return result;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>P182 完</p>
<h3 id="检索页面效果"><a class="header-anchor" href="#检索页面效果">¶</a>检索页面效果</h3>
<h4 id="1-基本数据渲染"><a class="header-anchor" href="#1-基本数据渲染">¶</a>1) 基本数据渲染</h4>
<p>将商品的基本属性渲染出来</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;div class&#x3D;&quot;rig_tab&quot;&gt;
    &lt;!-- 遍历各个商品--&gt;
    &lt;div th:each&#x3D;&quot;product : $&#123;result.getProduct()&#125;&quot;&gt;
        &lt;div class&#x3D;&quot;ico&quot;&gt;
            &lt;i class&#x3D;&quot;iconfont icon-weiguanzhu&quot;&gt;&lt;&#x2F;i&gt;
            &lt;a href&#x3D;&quot;&#x2F;static&#x2F;search&#x2F;#&quot;&gt;关注&lt;&#x2F;a&gt;
        &lt;&#x2F;div&gt;
        &lt;p class&#x3D;&quot;da&quot;&gt;
            &lt;a th:href&#x3D;&quot;|http:&#x2F;&#x2F;item.gulimall.com&#x2F;$&#123;product.skuId&#125;.html|&quot; &gt;
                &lt;!--图片 --&gt;
                &lt;img   class&#x3D;&quot;dim&quot; th:src&#x3D;&quot;$&#123;product.skuImg&#125;&quot;&gt;
            &lt;&#x2F;a&gt;
        &lt;&#x2F;p&gt;
        &lt;ul class&#x3D;&quot;tab_im&quot;&gt;
            &lt;li&gt;&lt;a href&#x3D;&quot;&#x2F;static&#x2F;search&#x2F;#&quot; title&#x3D;&quot;黑色&quot;&gt;
                &lt;img th:src&#x3D;&quot;$&#123;product.skuImg&#125;&quot;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
        &lt;&#x2F;ul&gt;
        &lt;p class&#x3D;&quot;tab_R&quot;&gt;
              &lt;!-- 价格 --&gt;
            &lt;span th:text&#x3D;&quot;&#39;￥&#39; + $&#123;product.skuPrice&#125;&quot;&gt;¥5199.00&lt;&#x2F;span&gt;
        &lt;&#x2F;p&gt;
        &lt;p class&#x3D;&quot;tab_JE&quot;&gt;
            &lt;!-- 标题 --&gt;
            &lt;!-- 使用utext标签,使检索时高亮不会被转义--&gt;
            &lt;a href&#x3D;&quot;&#x2F;static&#x2F;search&#x2F;#&quot; th:utext&#x3D;&quot;$&#123;product.skuTitle&#125;&quot;&gt;
                Apple iPhone 7 Plus (A1661) 32G 黑色 移动联通电信4G手机
            &lt;&#x2F;a&gt;
        &lt;&#x2F;p&gt;
        &lt;p class&#x3D;&quot;tab_PI&quot;&gt;已有&lt;span&gt;11万+&lt;&#x2F;span&gt;热门评价
            &lt;a href&#x3D;&quot;&#x2F;static&#x2F;search&#x2F;#&quot;&gt;二手有售&lt;&#x2F;a&gt;
        &lt;&#x2F;p&gt;
        &lt;p class&#x3D;&quot;tab_CP&quot;&gt;&lt;a href&#x3D;&quot;&#x2F;static&#x2F;search&#x2F;#&quot; title&#x3D;&quot;谷粒商城Apple产品专营店&quot;&gt;谷粒商城Apple产品...&lt;&#x2F;a&gt;
            &lt;a href&#x3D;&#39;#&#39; title&#x3D;&quot;联系供应商进行咨询&quot;&gt;
                &lt;img src&#x3D;&quot;&#x2F;static&#x2F;search&#x2F;img&#x2F;xcxc.png&quot;&gt;
            &lt;&#x2F;a&gt;
        &lt;&#x2F;p&gt;
        &lt;div class&#x3D;&quot;tab_FO&quot;&gt;
            &lt;div class&#x3D;&quot;FO_one&quot;&gt;
                &lt;p&gt;自营
                    &lt;span&gt;谷粒商城自营,品质保证&lt;&#x2F;span&gt;
                &lt;&#x2F;p&gt;
                &lt;p&gt;满赠
                    &lt;span&gt;该商品参加满赠活动&lt;&#x2F;span&gt;
                &lt;&#x2F;p&gt;
            &lt;&#x2F;div&gt;
        &lt;&#x2F;div&gt;
    &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-筛选条件渲染"><a class="header-anchor" href="#2-筛选条件渲染">¶</a>2) 筛选条件渲染</h4>
<p>将结果的品牌、分类、商品属性进行遍历显示，并且点击某个属性值时 可以通过拼接 url 进行跳转</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;div class&#x3D;&quot;JD_nav_logo&quot;&gt;
    &lt;!--品牌--&gt;
    &lt;div class&#x3D;&quot;JD_nav_wrap&quot;&gt;
        &lt;div class&#x3D;&quot;sl_key&quot;&gt;
            &lt;span&gt;品牌：&lt;&#x2F;span&gt;
        &lt;&#x2F;div&gt;
        &lt;div class&#x3D;&quot;sl_value&quot;&gt;
            &lt;div class&#x3D;&quot;sl_value_logo&quot;&gt;
                &lt;ul&gt;
                    &lt;li th:each&#x3D;&quot;brand: $&#123;result.getBrands()&#125;&quot;&gt;
                        &lt;!--替换url--&gt;
                        &lt;a href&#x3D;&quot;#&quot;  th:href&#x3D;&quot;$&#123;&#39;javascript:searchProducts(&quot;brandId&quot;,&#39;+brand.brandId+&#39;)&#39;&#125;&quot;&gt;
                            &lt;img src&#x3D;&quot;&#x2F;static&#x2F;search&#x2F;img&#x2F;598033b4nd6055897.jpg&quot; alt&#x3D;&quot;&quot; th:src&#x3D;&quot;$&#123;brand.brandImg&#125;&quot;&gt;
                            &lt;div th:text&#x3D;&quot;$&#123;brand.brandName&#125;&quot;&gt;
                                华为(HUAWEI)
                            &lt;&#x2F;div&gt;
                        &lt;&#x2F;a&gt;
                    &lt;&#x2F;li&gt;
                &lt;&#x2F;ul&gt;
            &lt;&#x2F;div&gt;
        &lt;&#x2F;div&gt;
        &lt;div class&#x3D;&quot;sl_ext&quot;&gt;
            &lt;a href&#x3D;&quot;#&quot;&gt;
                更多
                &lt;i style&#x3D;&#39;background: url(&quot;image&#x2F;search.ele.png&quot;)no-repeat 3px 7px&#39;&gt;&lt;&#x2F;i&gt;
                &lt;b style&#x3D;&#39;background: url(&quot;image&#x2F;search.ele.png&quot;)no-repeat 3px -44px&#39;&gt;&lt;&#x2F;b&gt;
            &lt;&#x2F;a&gt;
            &lt;a href&#x3D;&quot;#&quot;&gt;
                多选
                &lt;i&gt;+&lt;&#x2F;i&gt;
                &lt;span&gt;+&lt;&#x2F;span&gt;
            &lt;&#x2F;a&gt;
        &lt;&#x2F;div&gt;
    &lt;&#x2F;div&gt;
    &lt;!--分类--&gt;
    &lt;div class&#x3D;&quot;JD_pre&quot; th:each&#x3D;&quot;catalog: $&#123;result.getCatalogs()&#125;&quot;&gt;
        &lt;div class&#x3D;&quot;sl_key&quot;&gt;
            &lt;span&gt;分类：&lt;&#x2F;span&gt;
        &lt;&#x2F;div&gt;
        &lt;div class&#x3D;&quot;sl_value&quot;&gt;
            &lt;ul&gt;
                &lt;li&gt;&lt;a href&#x3D;&quot;#&quot; th:text&#x3D;&quot;$&#123;catalog.getCatalogName()&#125;&quot; th:href&#x3D;&quot;$&#123;&#39;javascript:searchProducts(&quot;catalogId&quot;,&#39;+catalog.catalogId+&#39;)&#39;&#125;&quot;&gt;0-安卓（Android）&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
            &lt;&#x2F;ul&gt;
        &lt;&#x2F;div&gt;
    &lt;&#x2F;div&gt;
    &lt;!--价格--&gt;
    &lt;div class&#x3D;&quot;JD_pre&quot;&gt;
        &lt;div class&#x3D;&quot;sl_key&quot;&gt;
            &lt;span&gt;价格：&lt;&#x2F;span&gt;
        &lt;&#x2F;div&gt;
        &lt;div class&#x3D;&quot;sl_value&quot;&gt;
            &lt;ul&gt;
                &lt;li&gt;&lt;a href&#x3D;&quot;#&quot;&gt;0-499&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
                &lt;li&gt;&lt;a href&#x3D;&quot;#&quot;&gt;500-999&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
                &lt;li&gt;&lt;a href&#x3D;&quot;#&quot;&gt;1000-1699&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
                &lt;li&gt;&lt;a href&#x3D;&quot;#&quot;&gt;1700-2799&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
                &lt;li&gt;&lt;a href&#x3D;&quot;#&quot;&gt;2800-4499&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
                &lt;li&gt;&lt;a href&#x3D;&quot;#&quot;&gt;4500-11999&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
                &lt;li&gt;&lt;a href&#x3D;&quot;#&quot;&gt;12000以上&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
                &lt;li class&#x3D;&quot;sl_value_li&quot;&gt;
                    &lt;input type&#x3D;&quot;text&quot;&gt;
                    &lt;p&gt;-&lt;&#x2F;p&gt;
                    &lt;input type&#x3D;&quot;text&quot;&gt;
                    &lt;a href&#x3D;&quot;#&quot;&gt;确定&lt;&#x2F;a&gt;
                &lt;&#x2F;li&gt;
            &lt;&#x2F;ul&gt;
        &lt;&#x2F;div&gt;
    &lt;&#x2F;div&gt;
    &lt;!--商品属性--&gt;
    &lt;div class&#x3D;&quot;JD_pre&quot; th:each&#x3D;&quot;attr: $&#123;result.getAttrs()&#125;&quot; &gt;
        &lt;div class&#x3D;&quot;sl_key&quot;&gt;
            &lt;span th:text&#x3D;&quot;$&#123;attr.getAttrName()&#125;&quot;&gt;系统：&lt;&#x2F;span&gt;
        &lt;&#x2F;div&gt;
        &lt;div class&#x3D;&quot;sl_value&quot;&gt;
            &lt;ul&gt;
                &lt;li th:each&#x3D;&quot;val: $&#123;attr.getAttrValue()&#125;&quot;&gt;
                    &lt;a href&#x3D;&quot;#&quot;  th:text&#x3D;&quot;$&#123;val&#125;&quot;
                       th:href&#x3D;&quot;$&#123;&#39;javascript:searchProducts(&quot;attrs&quot;,&quot;&#39;+attr.attrId+&#39;_&#39;+val+&#39;&quot;)&#39;&#125;&quot;&gt;0-安卓（Android）&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
            &lt;&#x2F;ul&gt;
        &lt;&#x2F;div&gt;
    &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">function searchProducts(name, value) &#123;
    &#x2F;&#x2F;原來的页面
    location.href &#x3D; replaceParamVal(location.href,name,value,true)
&#125;;

   &#x2F;**
     * @param url 目前的url
     * @param paramName 需要替换的参数属性名
     * @param replaceVal 需要替换的参数的新属性值
     * @param forceAdd 该参数是否可以重复查询(attrs&#x3D;1_3G:4G:5G&amp;attrs&#x3D;2_骁龙845&amp;attrs&#x3D;4_高清屏)
     * @returns &#123;string&#125; 替换或添加后的url
     *&#x2F;
function replaceParamVal(url, paramName, replaceVal,forceAdd) &#123;
    var oUrl &#x3D; url.toString();
    var nUrl;
    if (oUrl.indexOf(paramName) !&#x3D; -1) &#123;
        if( forceAdd &amp;&amp; oUrl.indexOf(paramName+&quot;&#x3D;&quot;+replaceVal)&#x3D;&#x3D;-1) &#123;
            if (oUrl.indexOf(&quot;?&quot;) !&#x3D; -1) &#123;
                nUrl &#x3D; oUrl + &quot;&amp;&quot; + paramName + &quot;&#x3D;&quot; + replaceVal;
            &#125; else &#123;
                nUrl &#x3D; oUrl + &quot;?&quot; + paramName + &quot;&#x3D;&quot; + replaceVal;
            &#125;
        &#125; else &#123;
            var re &#x3D; eval(&#39;&#x2F;(&#39; + paramName + &#39;&#x3D;)([^&amp;]*)&#x2F;gi&#39;);
            nUrl &#x3D; oUrl.replace(re, paramName + &#39;&#x3D;&#39; + replaceVal);
        &#125;
    &#125; else &#123;
        if (oUrl.indexOf(&quot;?&quot;) !&#x3D; -1) &#123;
            nUrl &#x3D; oUrl + &quot;&amp;&quot; + paramName + &quot;&#x3D;&quot; + replaceVal;
        &#125; else &#123;
            nUrl &#x3D; oUrl + &quot;?&quot; + paramName + &quot;&#x3D;&quot; + replaceVal;
        &#125;
    &#125;
    return nUrl;
&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="3-分页数据渲染"><a class="header-anchor" href="#3-分页数据渲染">¶</a>3) 分页数据渲染</h4>
<p>将页码绑定至属性 pn，当点击某页码时，通过获取 pn 值进行 url 拼接跳转页面</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;div class&#x3D;&quot;filter_page&quot;&gt;
    &lt;div class&#x3D;&quot;page_wrap&quot;&gt;
        &lt;span class&#x3D;&quot;page_span1&quot;&gt;
               &lt;!-- 不是第一页时显示上一页 --&gt;
            &lt;a class&#x3D;&quot;page_a&quot; href&#x3D;&quot;#&quot; th:if&#x3D;&quot;$&#123;result.pageNum&gt;1&#125;&quot; th:attr&#x3D;&quot;pn&#x3D;$&#123;result.getPageNum()-1&#125;&quot;&gt;
                 上一页
            &lt;&#x2F;a&gt;
             &lt;!-- 将各个页码遍历显示，并将当前页码绑定至属性pn --&gt;
            &lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;page_a&quot;
               th:each&#x3D;&quot;page: $&#123;result.pageNavs&#125;&quot;
               th:text&#x3D;&quot;$&#123;page&#125;&quot;
               th:style&#x3D;&quot;$&#123;page&#x3D;&#x3D;result.pageNum?&#39;border: 0;color:#ee2222;background: #fff&#39;:&#39;&#39;&#125;&quot;
               th:attr&#x3D;&quot;pn&#x3D;$&#123;page&#125;&quot;
            &gt;1&lt;&#x2F;a&gt;
              &lt;!-- 不是最后一页时显示下一页 --&gt;
            &lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;page_a&quot; th:if&#x3D;&quot;$&#123;result.pageNum&lt;result.totalPages&#125;&quot; th:attr&#x3D;&quot;pn&#x3D;$&#123;result.getPageNum()+1&#125;&quot;&gt;
                下一页 &gt;
            &lt;&#x2F;a&gt;
        &lt;&#x2F;span&gt;
        &lt;span class&#x3D;&quot;page_span2&quot;&gt;
            &lt;em&gt;共&lt;b th:text&#x3D;&quot;$&#123;result.totalPages&#125;&quot;&gt;169&lt;&#x2F;b&gt;页  到第&lt;&#x2F;em&gt;
            &lt;input type&#x3D;&quot;number&quot; value&#x3D;&quot;1&quot; class&#x3D;&quot;page_input&quot;&gt;
            &lt;em&gt;页&lt;&#x2F;em&gt;
            &lt;a href&#x3D;&quot;#&quot;&gt;确定&lt;&#x2F;a&gt;
        &lt;&#x2F;span&gt;
    &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">$(&quot;.page_a&quot;).click(function () &#123;
    var pn&#x3D;$(this).attr(&quot;pn&quot;);
    location.href&#x3D;replaceParamVal(location.href,&quot;pageNum&quot;,pn,false);
    console.log(replaceParamVal(location.href,&quot;pageNum&quot;,pn,false))
&#125;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="4-页面排序和价格区间"><a class="header-anchor" href="#4-页面排序和价格区间">¶</a>4) 页面排序和价格区间</h4>
<p>页面排序功能需要保证，点击某个按钮时，样式会变红，并且其他的样式保持最初的样子；</p>
<p>点击某个排序时首先按升序显示，再次点击再变为降序，并且还会显示上升或下降箭头</p>
<p>页面排序跳转的思路是通过点击某个按钮时会向其<code>class</code>属性添加 / 去除<code>desc</code>，并根据属性值进行 url 拼接</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;div class&#x3D;&quot;filter_top&quot;&gt;
    &lt;div class&#x3D;&quot;filter_top_left&quot; th:with&#x3D;&quot;p &#x3D; $&#123;param.sort&#125;, priceRange &#x3D; $&#123;param.skuPrice&#125;&quot;&gt;
        &lt;!-- 通过判断当前class是否有desc来进行样式的渲染和箭头的显示--&gt;
        &lt;a sort&#x3D;&quot;hotScore&quot;
           th:class&#x3D;&quot;$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#39;hotScore&#39;) &amp;&amp; #strings.endsWith(p,&#39;desc&#39;)) ? &#39;sort_a desc&#39; : &#39;sort_a&#39;&#125;&quot;
           th:attr&#x3D;&quot;style&#x3D;$&#123;(#strings.isEmpty(p) || #strings.startsWith(p,&#39;hotScore&#39;)) ?
               &#39;color: #fff; border-color: #e4393c; background: #e4393c;&#39;:&#39;color: #333; border-color: #ccc; background: #fff;&#39; &#125;&quot;&gt;
            综合排序[[$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#39;hotScore&#39;) &amp;&amp;
            #strings.endsWith(p,&#39;desc&#39;)) ?&#39;↓&#39;:&#39;↑&#39; &#125;]]&lt;&#x2F;a&gt;
        &lt;a sort&#x3D;&quot;saleCount&quot;
           th:class&#x3D;&quot;$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#39;saleCount&#39;) &amp;&amp; #strings.endsWith(p,&#39;desc&#39;)) ? &#39;sort_a desc&#39; : &#39;sort_a&#39;&#125;&quot;
           th:attr&#x3D;&quot;style&#x3D;$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#39;saleCount&#39;)) ?
               &#39;color: #fff; border-color: #e4393c; background: #e4393c;&#39;:&#39;color: #333; border-color: #ccc; background: #fff;&#39; &#125;&quot;&gt;
            销量[[$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#39;saleCount&#39;) &amp;&amp;
            #strings.endsWith(p,&#39;desc&#39;))?&#39;↓&#39;:&#39;↑&#39;  &#125;]]&lt;&#x2F;a&gt;
        &lt;a sort&#x3D;&quot;skuPrice&quot;
           th:class&#x3D;&quot;$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#39;skuPrice&#39;) &amp;&amp; #strings.endsWith(p,&#39;desc&#39;)) ? &#39;sort_a desc&#39; : &#39;sort_a&#39;&#125;&quot;
           th:attr&#x3D;&quot;style&#x3D;$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#39;skuPrice&#39;)) ?
               &#39;color: #fff; border-color: #e4393c; background: #e4393c;&#39;:&#39;color: #333; border-color: #ccc; background: #fff;&#39; &#125;&quot;&gt;
            价格[[$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#39;skuPrice&#39;) &amp;&amp;
            #strings.endsWith(p,&#39;desc&#39;))?&#39;↓&#39;:&#39;↑&#39;  &#125;]]&lt;&#x2F;a&gt;
        &lt;a sort&#x3D;&quot;hotScore&quot; class&#x3D;&quot;sort_a&quot;&gt;评论分&lt;&#x2F;a&gt;
        &lt;a sort&#x3D;&quot;hotScore&quot; class&#x3D;&quot;sort_a&quot;&gt;上架时间&lt;&#x2F;a&gt;
        &lt;!--价格区间搜索--&gt;
        &lt;input id&#x3D;&quot;skuPriceFrom&quot; type&#x3D;&quot;number&quot;
               th:value&#x3D;&quot;$&#123;#strings.isEmpty(priceRange)?&#39;&#39;:#strings.substringBefore(priceRange,&#39;_&#39;)&#125;&quot;
               style&#x3D;&quot;width: 100px; margin-left: 30px&quot;&gt;
        -
        &lt;input id&#x3D;&quot;skuPriceTo&quot; type&#x3D;&quot;number&quot;
               th:value&#x3D;&quot;$&#123;#strings.isEmpty(priceRange)?&#39;&#39;:#strings.substringAfter(priceRange,&#39;_&#39;)&#125;&quot;
               style&#x3D;&quot;width: 100px&quot;&gt;
        &lt;button id&#x3D;&quot;skuPriceSearchBtn&quot;&gt;确定&lt;&#x2F;button&gt;
    &lt;&#x2F;div&gt;
    &lt;div class&#x3D;&quot;filter_top_right&quot;&gt;
        &lt;span class&#x3D;&quot;fp-text&quot;&gt;
           &lt;b&gt;1&lt;&#x2F;b&gt;&lt;em&gt;&#x2F;&lt;&#x2F;em&gt;&lt;i&gt;169&lt;&#x2F;i&gt;
       &lt;&#x2F;span&gt;
        &lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;prev&quot;&gt;&lt;&lt;&#x2F;a&gt;
        &lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;next&quot;&gt; &gt; &lt;&#x2F;a&gt;
    &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">$(&quot;.sort_a&quot;).click(function () &#123;
    	&#x2F;&#x2F;添加、剔除desc
        $(this).toggleClass(&quot;desc&quot;);
    	&#x2F;&#x2F;获取sort属性值并进行url跳转
        let sort &#x3D; $(this).attr(&quot;sort&quot;);
        sort &#x3D; $(this).hasClass(&quot;desc&quot;) ? sort + &quot;_desc&quot; : sort + &quot;_asc&quot;;
        location.href &#x3D; replaceParamVal(location.href, &quot;sort&quot;, sort,false);
        return false;
    &#125;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>价格区间搜索函数</p>
<pre class="line-numbers language-none"><code class="language-none">$(&quot;#skuPriceSearchBtn&quot;).click(function () &#123;
    var skuPriceFrom &#x3D; $(&quot;#skuPriceFrom&quot;).val();
    var skuPriceTo &#x3D; $(&quot;#skuPriceTo&quot;).val();
    location.href &#x3D; replaceParamVal(location.href, &quot;skuPrice&quot;, skuPriceFrom + &quot;_&quot; + skuPriceTo, false);
&#125;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="5-面包屑导航"><a class="header-anchor" href="#5-面包屑导航">¶</a>5) 面包屑导航</h4>
<p>在封装结果时，将查询的属性值进行封装</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; 6. 构建面包屑导航
        List&lt;String&gt; attrs &#x3D; searchParam.getAttrs();
        if (attrs !&#x3D; null &amp;&amp; attrs.size() &gt; 0) &#123;
            List&lt;SearchResult.NavVo&gt; navVos &#x3D; attrs.stream().map(attr -&gt; &#123;
                String[] split &#x3D; attr.split(&quot;_&quot;);
                SearchResult.NavVo navVo &#x3D; new SearchResult.NavVo();
                &#x2F;&#x2F;6.1 设置属性值
                navVo.setNavValue(split[1]);
                &#x2F;&#x2F;6.2 查询并设置属性名
                try &#123;
                    R r &#x3D; productFeignService.info(Long.parseLong(split[0]));
                    if (r.getCode() &#x3D;&#x3D; 0) &#123;
                        AttrResponseVo attrResponseVo &#x3D; JSON.parseObject(JSON.toJSONString(r.get(&quot;attr&quot;)), new TypeReference&lt;AttrResponseVo&gt;() &#123;
                        &#125;);
                        navVo.setNavName(attrResponseVo.getAttrName());
                    &#125;
                &#125; catch (Exception e) &#123;
                    log.error(&quot;远程调用商品服务查询属性失败&quot;, e);
                &#125;
                &#x2F;&#x2F;6.3 设置面包屑跳转链接(当点击该链接时剔除点击属性)
                String queryString &#x3D; searchParam.get_queryString();
                String replace &#x3D; queryString.replace(&quot;&amp;attrs&#x3D;&quot; + attr, &quot;&quot;).replace(&quot;attrs&#x3D;&quot; + attr+&quot;&amp;&quot;, &quot;&quot;).replace(&quot;attrs&#x3D;&quot; + attr, &quot;&quot;);
                navVo.setLink(&quot;http:&#x2F;&#x2F;search.gulimall.com&#x2F;search.html&quot; + (replace.isEmpty()?&quot;&quot;:&quot;?&quot;+replace));
                return navVo;
            &#125;).collect(Collectors.toList());
            result.setNavs(navVos);
        &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>页面渲染</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;div class&#x3D;&quot;JD_ipone_one c&quot;&gt;
    &lt;!-- 遍历面包屑功能 --&gt;
    &lt;a th:href&#x3D;&quot;$&#123;nav.link&#125;&quot; th:each&#x3D;&quot;nav:$&#123;result.navs&#125;&quot;&gt;&lt;span th:text&#x3D;&quot;$&#123;nav.navName&#125;&quot;&gt;&lt;&#x2F;span&gt;：&lt;span th:text&#x3D;&quot;$&#123;nav.navValue&#125;&quot;&gt;&lt;&#x2F;span&gt; x&lt;&#x2F;a&gt;
&lt;&#x2F;div&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="http://search.gulimall.com/search.html/keyword">search.gulimall.com/search.html/keyword</a> = 华为 &amp; pageNum=2&amp;attrs=6_2019</p>
<img src="/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/d00dd8ae618098bdeda1107b7d815138.png" class="" loading="lazy">
<h4 id="6-条件筛选联动"><a class="header-anchor" href="#6-条件筛选联动">¶</a>6) 条件筛选联动</h4>
<p>就是将品牌和分类也封装进面包屑数据中，并且在页面进行 th:if 的判断，当 url 有该属性的查询条件时就不进行显示了</p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>momo</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/" title="谷粒商城笔记_ElasticSearch">https://ppxiaodi.gitee.io/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_ElasticSearch/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A44/" rel="prev" title="谷粒商城笔记_分布式集群4"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">谷粒商城笔记_分布式集群4</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2020/03/14/CollectionNote/java/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0_%E5%9F%BA%E7%A1%80%E7%AF%871/" rel="next" title="谷粒商城笔记_基础篇1"><span class="post-nav-text">谷粒商城笔记_基础篇1</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> momo</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.7.0</span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div id="local-search-result"></div></div></div></body></html>