<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="momo"><meta name="copyright" content="momo"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>RabbitMQ快速入门 | 我的笔记</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"ppxiaodi.gitee.io","root":"/","title":"momo的小站","version":"1.7.0","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><meta name="description" content="RabbitMQ快速入门  本文由 简悦 SimpRead 转码， 原文地址 blog.csdn.net  在介绍 RabbitMQ 之前，我们先来看下面一个电商项目的场景：   商品的原始数据保存在数据库中，增删改查都在数据库中完成。   搜索服务数据来源是索引库（Elasticsearch），如果数据库商品发生变化，索引库数据不能及时更新。   商品详情做了页面静态化处理，静态页面数据也不会随">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ快速入门">
<meta property="og:url" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="我的笔记">
<meta property="og:description" content="RabbitMQ快速入门  本文由 简悦 SimpRead 转码， 原文地址 blog.csdn.net  在介绍 RabbitMQ 之前，我们先来看下面一个电商项目的场景：   商品的原始数据保存在数据库中，增删改查都在数据库中完成。   搜索服务数据来源是索引库（Elasticsearch），如果数据库商品发生变化，索引库数据不能及时更新。   商品详情做了页面静态化处理，静态页面数据也不会随">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190610225910220.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190610232537261.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190610235357662.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611002031376.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611104021569.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611105359281.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611105511818.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611111613865.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611111805436.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611111903348.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611111945679.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611111805436-1621760594165.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611112952144.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611112511235.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611112813726.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611113438997.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611111805436-1621760609158.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611114015524.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611114213414.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/201906111143324.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611114508182.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611115053951.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611201227139.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611124709504.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611124745242.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611141348560.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611141202657.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611142240194.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611200955466.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611150212871.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611150133359.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611151532501.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611154144816.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611154905286.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611193035125.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611193105639.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611200118579.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611194652489.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611194730149.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611195509217.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190612112420397.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190612125827992.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190612115104481.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190612113450136.png">
<meta property="article:published_time" content="2021-05-22T16:00:00.000Z">
<meta property="article:modified_time" content="2022-01-09T16:02:36.011Z">
<meta property="article:author" content="momo">
<meta property="article:tag" content="rabbitMQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190610225910220.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="momo"><img width="96" loading="lazy" src="/yun.png" alt="momo"></a><div class="site-author-name"><a href="/about/">momo</a></div><a class="site-name" href="/about/site.html">我的笔记</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">199</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">58</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">47</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=kZJzggTTCf4SpvEQ8lXWoi5ZjhAx0ILZ&amp;jump_from=webapi" title="QQ 群 1050458482" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YunYouJun" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/jizhideyunyoujun" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/yunyoujun/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/yunyoujun/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/about/white-qrcode-and-search.jpg" title="微信公众号" target="_blank" style="color:#1AAD19"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-2-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/YunYouJun" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@yunyoujun.cn" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.link" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-train-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">RabbitMQ快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.1.</span> <span class="toc-text">什么是消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E4%B8%AD%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E9%80%9A%E5%B8%B8%E6%9C%89%E5%A6%82%E4%B8%8B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A"><span class="toc-number">1.2.</span> <span class="toc-text">开发中消息队列通常有如下应用场景：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AMQP-%E5%92%8C-JMS"><span class="toc-number">1.3.</span> <span class="toc-text">AMQP 和 JMS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81-MQ-%E4%BA%A7%E5%93%81"><span class="toc-number">1.4.</span> <span class="toc-text">常见 MQ 产品</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">1.5.</span> <span class="toc-text">RabbitMQ 快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E4%B8%8E%E5%AE%89%E8%A3%85"><span class="toc-number">1.5.1.</span> <span class="toc-text">下载与安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RabbitMQ-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.2.</span> <span class="toc-text">RabbitMQ 的工作原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">六种消息模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A0%E5%9F%BA%E6%9C%AC%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B%EF%BC%9A"><span class="toc-number">2.1.</span> <span class="toc-text">①基本消息模型：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-number">2.1.1.</span> <span class="toc-text">生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF"><span class="toc-number">2.1.2.</span> <span class="toc-text">消费者接收消息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6%EF%BC%88ACK%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">消息确认机制（ACK）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8-ACK-%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.1.</span> <span class="toc-text">自动 ACK 存在的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%94%E7%A4%BA%E6%89%8B%E5%8A%A8-ACK"><span class="toc-number">2.2.2.</span> <span class="toc-text">演示手动 ACK</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A1work-%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.3.</span> <span class="toc-text">②work 消息模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-v2"><span class="toc-number">2.3.1.</span> <span class="toc-text">生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">消费者 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85-2"><span class="toc-number">2.3.3.</span> <span class="toc-text">消费者 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%BD%E8%80%85%E5%A4%9A%E5%8A%B3"><span class="toc-number">2.3.4.</span> <span class="toc-text">能者多劳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E6%A8%A1%E5%9E%8B%E5%88%86%E7%B1%BB"><span class="toc-number">2.3.5.</span> <span class="toc-text">订阅模型分类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A2-Publish-subscribe%EF%BC%88%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%B1%BB%E5%9E%8B%EF%BC%9A-Fanout%EF%BC%8C%E4%B9%9F%E7%A7%B0%E4%B8%BA%E5%B9%BF%E6%92%AD-%EF%BC%89"><span class="toc-number">2.4.</span> <span class="toc-text">③**Publish&#x2F;subscribe（交换机类型：**Fanout，也称为广播 ）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-v3"><span class="toc-number">2.4.1.</span> <span class="toc-text">生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85-1-%EF%BC%88%E6%B3%A8%E5%86%8C%E6%88%90%E5%8A%9F%E5%8F%91%E7%BB%99%E7%9F%AD%E4%BF%A1%E6%9C%8D%E5%8A%A1%EF%BC%89"><span class="toc-number">2.4.2.</span> <span class="toc-text">消费者 1 （注册成功发给短信服务）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85-2%EF%BC%88%E6%B3%A8%E5%86%8C%E6%88%90%E5%8A%9F%E5%8F%91%E7%BB%99%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%EF%BC%89"><span class="toc-number">2.4.3.</span> <span class="toc-text">消费者 2（注册成功发给邮件服务）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%80%83%EF%BC%9A"><span class="toc-number">2.4.4.</span> <span class="toc-text">思考：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A3Routing-%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%9E%8B%EF%BC%88%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%B1%BB%E5%9E%8B%EF%BC%9Adirect%EF%BC%89"><span class="toc-number">2.5.</span> <span class="toc-text">④Routing 路由模型（交换机类型：direct）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-v4"><span class="toc-number">2.5.1.</span> <span class="toc-text">生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85-1-v2"><span class="toc-number">2.5.2.</span> <span class="toc-text">消费者 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85-2-v2"><span class="toc-number">2.5.3.</span> <span class="toc-text">消费者 2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A4Topics-%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A8%A1%E5%BC%8F%EF%BC%88%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%B1%BB%E5%9E%8B%EF%BC%9Atopics%EF%BC%89"><span class="toc-number">2.6.</span> <span class="toc-text">⑤Topics 通配符模式（交换机类型：topics）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-v5"><span class="toc-number">2.6.1.</span> <span class="toc-text">生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85-1-v3"><span class="toc-number">2.6.2.</span> <span class="toc-text">消费者 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85-2-v3"><span class="toc-number">2.6.3.</span> <span class="toc-text">消费者 2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A5RPC"><span class="toc-number">2.7.</span> <span class="toc-text">⑥RPC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E4%BA%AB%E4%B8%A4%E9%81%93%E9%9D%A2%E8%AF%95%E9%A2%98%EF%BC%9A"><span class="toc-number">2.7.1.</span> <span class="toc-text">分享两道面试题：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E6%8D%A2%E6%9C%BA%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">2.7.2.</span> <span class="toc-text">交换机持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">2.7.3.</span> <span class="toc-text">队列持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">2.7.4.</span> <span class="toc-text">消息持久化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-%E6%95%B4%E5%90%88-RibbitMQ"><span class="toc-number">2.8.</span> <span class="toc-text">Spring 整合 RibbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA-SpringBoot-%E7%8E%AF%E5%A2%83"><span class="toc-number">2.8.1.</span> <span class="toc-text">搭建 SpringBoot 环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-mq-rabbitmq-producer"><span class="toc-number">2.8.2.</span> <span class="toc-text">生产者 (mq-rabbitmq-producer)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85-mq-rabbitmq-consumer"><span class="toc-number">2.8.3.</span> <span class="toc-text">消费者 (mq-rabbitmq-consumer)</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="momo"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="我的笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">RabbitMQ快速入门</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2021-05-23 00:00:00" itemprop="dateCreated datePublished" datetime="2021-05-23T00:00:00+08:00">2021-05-23</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2022-01-10 00:02:36" itemprop="dateModified" datetime="2022-01-10T00:02:36+08:00">2022-01-10</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/rabbitMQ/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">rabbitMQ</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/rabbitMQ/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">rabbitMQ</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h1>RabbitMQ快速入门</h1>
<blockquote>
<p>本文由 <a target="_blank" rel="noopener" href="http://ksria.com/simpread/">简悦 SimpRead</a> 转码， 原文地址 <a target="_blank" rel="noopener" href="https://blog.csdn.net/kavito/article/details/91403659?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.control">blog.csdn.net</a></p>
</blockquote>
<p><strong>在介绍 RabbitMQ 之前，我们先来看下面一个电商项目的场景</strong>：</p>
<ul>
<li>
<p>商品的原始数据保存在数据库中，增删改查都在数据库中完成。</p>
</li>
<li>
<p>搜索服务数据来源是索引库（Elasticsearch），如果数据库商品发生变化，索引库数据不能及时更新。</p>
</li>
<li>
<p>商品详情做了页面静态化处理，静态页面数据也不会随着数据库商品更新而变化。</p>
</li>
</ul>
<p><strong>如果我们在后台修改了商品的价格，搜索页面和商品详情页显示的依然是旧的价格，这样显然不对。该如何解决？</strong></p>
<p>我们可能会想到这么做：</p>
<ul>
<li>
<p>方案 1：每当后台对商品做增删改操作，同时修改索引库数据及更新静态页面。</p>
</li>
<li>
<p>方案 2：搜索服务和商品页面静态化服务对外提供操作接口，后台在商品增删改后，调用接口。</p>
</li>
</ul>
<p>这两种方案都有个严重的问题：就是代码耦合，后台服务中需要嵌入搜索和商品页面服务，违背了微服务的<code>独立</code>原则。</p>
<p>这时，我们就会采用另外一种解决办法，那就是<strong>消息队列</strong>！</p>
<p>商品服务对商品增删改以后，无需去操作索引库和静态页面，只需向 MQ 发送一条消息（比如包含商品 id 的消息），也不关心消息被谁接收。 搜索服务和静态页面服务监听 MQ，接收消息，然后分别去处理索引库和静态页面（根据商品 id 去更新索引库和商品详情静态页面）。</p>
<h2 id="什么是消息队列"><a class="header-anchor" href="#什么是消息队列">¶</a>什么是消息队列</h2>
<p>MQ 全称为 Message Queue，即消息队列。“消息队列” 是在消息的传输过程中保存消息的容器。它是典型的：生产者、消费者模型。生产者不断向消息队列中生产消息，消费者不断的从队列中获取消息。因为消息的生产和消费都是异步的，而且只关心消息的发送和接收，没有业务逻辑的侵入，这样就实现了生产者和消费者的解耦。</p>
<h2 id="开发中消息队列通常有如下应用场景："><a class="header-anchor" href="#开发中消息队列通常有如下应用场景：">¶</a>开发中消息队列通常有如下应用场景：</h2>
<p><strong>1、任务异步处理：</strong></p>
<p>高并发环境下，由于来不及同步处理，请求往往会发生堵塞，比如说，大量的 insert，update 之类的请求同时到达 <a target="_blank" rel="noopener" href="http://lib.csdn.net/base/mysql">MySQL</a>，直接导致无数的行锁表锁，甚至最后请求会堆积过多，从而触发 too many connections 错误。通过使用消息队列，我们可以异步处理请求，从而缓解系统的压力。将不需要同步处理的并且耗时长的操作由消息队列通知消息接收方进行异步处理。减少了应用程序的响应时间。</p>
<p><strong>2</strong>**、应用程序解耦合**：</p>
<p>MQ 相当于一个中介，生产方通过 MQ 与消费方交互，它将应用程序进行解耦合。</p>
<h2 id="AMQP-和-JMS"><a class="header-anchor" href="#AMQP-和-JMS">¶</a>AMQP 和 JMS</h2>
<p>MQ 是消息通信的模型，并发具体实现。现在实现 MQ 的有两种主流方式：AMQP、JMS。</p>
<p>两者间的区别和联系：</p>
<ul>
<li>
<p>JMS 是定义了统一的接口，来对消息操作进行统一；AMQP 是通过规定协议来统一数据交互的格式</p>
</li>
<li>
<p>JMS 限定了必须使用 Java 语言；AMQP 只是协议，不规定实现方式，因此是跨语言的。</p>
</li>
<li>
<p>JMS 规定了两种消息模型；而 AMQP 的消息模型更加丰富</p>
</li>
</ul>
<h2 id="常见-MQ-产品"><a class="header-anchor" href="#常见-MQ-产品">¶</a>常见 MQ 产品</h2>
<ul>
<li>
<p>ActiveMQ：基于 JMS</p>
</li>
<li>
<p>RabbitMQ：基于 AMQP 协议，erlang 语言开发，稳定性好</p>
</li>
<li>
<p>RocketMQ：基于 JMS，阿里巴巴产品，目前交由 Apache 基金会</p>
</li>
<li>
<p>Kafka：分布式消息系统，高吞吐量</p>
</li>
</ul>
<h2 id="RabbitMQ-快速入门"><a class="header-anchor" href="#RabbitMQ-快速入门">¶</a>RabbitMQ 快速入门</h2>
<p>RabbitMQ 是由 erlang 语言开发，基于 AMQP（Advanced Message Queue 高级消息队列协议）协议实现的消息队列，它是一种应用程序之间的通信方法，消息队列在分布式系统开发中应用非常广泛。RabbitMQ 官方地址：<a target="_blank" rel="noopener" href="http://www.rabbitmq.com">http://www.rabbitmq.com</a></p>
<h3 id="下载与安装"><a class="header-anchor" href="#下载与安装">¶</a>下载与安装</h3>
<p>RabbitMQ 由 Erlang 语言开发，需要安装与 RabbitMQ 版本对应的 Erlang 语言环境，具体的就不解释了，自行搜索教程。RabbitMQ 官网下载地址：<a target="_blank" rel="noopener" href="http://www.rabbitmq.com/download.html">http://www.rabbitmq.com/download.html</a></p>
<h3 id="RabbitMQ-的工作原理"><a class="header-anchor" href="#RabbitMQ-的工作原理">¶</a>RabbitMQ 的工作原理</h3>
<p>下图是 RabbitMQ 的基本结构：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190610225910220.png" class="" loading="lazy">
<p>组成部分说明：</p>
<ul>
<li>Broker：消息队列服务进程，此进程包括两个部分：Exchange 和 Queue</li>
<li>Exchange：消息队列交换机，按一定的规则将消息路由转发到某个队列，对消息进行过虑。</li>
<li>Queue：消息队列，存储消息的队列，消息到达队列并转发给指定的</li>
<li>Producer：消息生产者，即生产方客户端，生产方客户端将消息发送</li>
<li>Consumer：消息消费者，即消费方客户端，接收 MQ 转发的消息。</li>
</ul>
<p>生产者发送消息流程：</p>
<p>1、生产者和 Broker 建立 TCP 连接。</p>
<p>2、生产者和 Broker 建立通道。</p>
<p>3、生产者通过通道消息发送给 Broker，由 Exchange 将消息进行转发。</p>
<p>4、Exchange 将消息转发到指定的 Queue（队列）</p>
<p>消费者接收消息流程：</p>
<p>1、消费者和 Broker 建立 TCP 连接</p>
<p>2、消费者和 Broker 建立通道</p>
<p>3、消费者监听指定的 Queue（队列）</p>
<p>4、当有消息到达 Queue 时 Broker 默认将消息推送给消费者。</p>
<p>5、消费者接收到消息。</p>
<p>6、ack 回复</p>
<h1><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/getstarted.html">六种消息模型</a></h1>
<h2 id="①基本消息模型："><a class="header-anchor" href="#①基本消息模型：">¶</a>①基本消息模型：</h2>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190610232537261.png" class="" loading="lazy">
<p>在上图的模型中，有以下概念：</p>
<ul>
<li>
<p>P：生产者，也就是要发送消息的程序</p>
</li>
<li>
<p>C：消费者：消息的接受者，会一直等待消息到来。</p>
</li>
<li>
<p>queue：消息队列，图中红色部分。可以缓存消息；生产者向其中投递消息，消费者从其中取出消息。</p>
</li>
</ul>
<h3 id="生产者"><a class="header-anchor" href="#生产者">¶</a>生产者</h3>
<p>新建一个 maven 工程，添加 amqp-client 依赖</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.rabbitmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>amqp-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.7.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>连接工具类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionUtil</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 建立与RabbitMQ的连接
     * @return
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//定义连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置服务地址</span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"192.168.1.103"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//端口</span>
        factory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置账号信息，用户名、密码、vhost</span>
        factory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/kavito"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置虚拟机，一个mq服务可以设置多个虚拟机，每个虚拟机就相当于一个独立的mq</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"kavito"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过工厂获取连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> connection<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>生产者发送消息：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Send</span> <span class="token punctuation">&#123;</span>
 
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"simple_queue"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1、获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2、从连接中创建通道，使用通道才能完成消息相关的操作</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3、声明（创建）队列</span>
        <span class="token comment">//参数：String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object> arguments</span>
        <span class="token comment">/**
         * 参数明细
         * 1、queue 队列名称
         * 2、durable 是否持久化，如果持久化，mq重启后队列还在
         * 3、exclusive 是否独占连接，队列只允许在该连接中访问，如果connection连接关闭队列则自动删除,如果将此参数设置true可用于临时队列的创建
         * 4、autoDelete 自动删除，队列不再使用时是否自动删除此队列，如果将此参数和exclusive参数设置为true就可以实现临时队列（队列不用了就自动删除）
         * 5、arguments 参数，可以设置一个队列的扩展参数，比如：可设置存活时间
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4、消息内容</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"Hello World!"</span><span class="token punctuation">;</span>
        <span class="token comment">// 向指定的队列中发送消息</span>
        <span class="token comment">//参数：String exchange, String routingKey, BasicProperties props, byte[] body</span>
        <span class="token comment">/**
         * 参数明细：
         * 1、exchange，交换机，如果不指定将使用mq的默认交换机（设置为""）
         * 2、routingKey，路由key，交换机根据路由key来将消息转发到指定的队列，如果使用默认交换机，routingKey设置为队列的名称
         * 3、props，消息的属性
         * 4、body，消息内容
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> QUEUE_NAME<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [x] Sent '"</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//关闭通道和连接(资源关闭最好用try-catch-finally语句处理)</span>
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>控制台：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190610235357662.png" class="" loading="lazy">
<p>web 管理页面：服务器地址 / 端口号 （本地：<a target="_blank" rel="noopener" href="http://127.0.0.1:15672">127.0.0.1:15672</a>，默认用户及密码：guest guest）</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611002031376.png" class="" loading="lazy">
<p>点击队列名称，进入详情页，可以查看消息：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611104021569.png" class="" loading="lazy">
<h3 id="消费者接收消息"><a class="header-anchor" href="#消费者接收消息">¶</a>消费者接收消息</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Recv</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"simple_queue"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建会话通道,生产者和mq服务所有通信都在channel通道中完成</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明队列</span>
        <span class="token comment">//参数：String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object> arguments</span>
        <span class="token comment">/**
         * 参数明细
         * 1、queue 队列名称
         * 2、durable 是否持久化，如果持久化，mq重启后队列还在
         * 3、exclusive 是否独占连接，队列只允许在该连接中访问，如果connection连接关闭队列则自动删除,如果将此参数设置true可用于临时队列的创建
         * 4、autoDelete 自动删除，队列不再使用时是否自动删除此队列，如果将此参数和exclusive参数设置为true就可以实现临时队列（队列不用了就自动删除）
         * 5、arguments 参数，可以设置一个队列的扩展参数，比如：可设置存活时间
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//实现消费方法</span>
        <span class="token class-name">DefaultConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span>
            <span class="token comment">/**
             * 当接收到消息后此方法将被调用
             * @param consumerTag  消费者标签，用来标识消费者的，在监听队列时设置channel.basicConsume
             * @param envelope 信封，通过envelope
             * @param properties 消息属性
             * @param body 消息内容
             * @throws IOException
             */</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span><span class="token class-name">BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//交换机</span>
                <span class="token class-name">String</span> exchange <span class="token operator">=</span> envelope<span class="token punctuation">.</span><span class="token function">getExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//消息id，mq在channel中用来标识消息的id，可用于确认消息已接收</span>
                <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// body 即消息体</span>
                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [x] received : "</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 监听队列，第二个参数：是否自动进行消息确认。</span>
        <span class="token comment">//参数：String queue, boolean autoAck, Consumer callback</span>
        <span class="token comment">/**
         * 参数明细：
         * 1、queue 队列名称
         * 2、autoAck 自动回复，当消费者接收到消息后要告诉mq消息已接收，如果将此参数设置为tru表示会自动回复mq，如果设置为false要通过编程实现回复
         * 3、callback，消费方法，当消费者接收到消息要执行的方法
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>控制台打印：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611105359281.png" class="" loading="lazy">
<p>再看看队列的消息, 已经被消费了</p>
<p><img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611105511818.png" class="" loading="lazy"></p>
<p>我们发现，消费者已经获取了消息，但是程序没有停止，一直在监听队列中是否有新的消息。一旦有新的消息进入队列，就会立即打印.</p>
<h2 id="消息确认机制（ACK）"><a class="header-anchor" href="#消息确认机制（ACK）">¶</a>消息确认机制（ACK）</h2>
<p>通过刚才的案例可以看出，消息一旦被消费者接收，队列中的消息就会被删除。</p>
<p>那么问题来了：RabbitMQ 怎么知道消息被接收了呢？</p>
<p>如果消费者领取消息后，还没执行操作就挂掉了呢？或者抛出了异常？消息消费失败，但是 RabbitMQ 无从得知，这样消息就丢失了！</p>
<p>因此，RabbitMQ 有一个 ACK 机制。当消费者获取消息后，会向 RabbitMQ 发送回执 ACK，告知消息已经被接收。不过这种回执 ACK 分两种情况：</p>
<ul>
<li>
<p>自动 ACK：消息一旦被接收，消费者自动发送 ACK</p>
</li>
<li>
<p>手动 ACK：消息接收后，不会发送 ACK，需要手动调用</p>
</li>
</ul>
<p>大家觉得哪种更好呢？</p>
<p>这需要看消息的重要性：</p>
<ul>
<li>
<p>如果消息不太重要，丢失也没有影响，那么自动 ACK 会比较方便</p>
</li>
<li>
<p>如果消息非常重要，不容丢失。那么最好在消费完成后手动 ACK，否则接收消息后就自动 ACK，RabbitMQ 就会把消息从队列中删除。如果此时消费者宕机，那么消息就丢失了。</p>
</li>
</ul>
<p>我们之前的测试都是自动 ACK 的，如果要手动 ACK，需要改动我们的代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Recv2</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"simple_queue"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建通道</span>
        <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 定义队列的消费者</span>
        <span class="token class-name">DefaultConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span><span class="token class-name">BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// body 即消息体</span>
                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [x] received : "</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 手动进行ACK</span>
                <span class="token comment">/*
                 *  void basicAck(long deliveryTag, boolean multiple) throws IOException;
                 *  deliveryTag:用来标识消息的id
                 *  multiple：是否批量.true:将一次性ack所有小于deliveryTag的消息。
                 */</span>
                
                channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">// 监听队列，第二个参数false，手动进行ACKs</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后一行代码设置第二个参数为 false</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="自动-ACK-存在的问题"><a class="header-anchor" href="#自动-ACK-存在的问题">¶</a>自动 ACK 存在的问题</h3>
<p>修改消费者，添加异常，如下：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611111613865.png" class="" loading="lazy">
<p>生产者不做任何修改，直接运行，消息发送成功：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611111805436.png" class="" loading="lazy">
<p>运行消费者，程序抛出异常：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611111903348.png" class="" loading="lazy">
<p>管理界面：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611111945679.png" class="" loading="lazy">
<p>消费者抛出异常，但是消息依然被消费，实际上我们还没获取到消息。</p>
<h3 id="演示手动-ACK"><a class="header-anchor" href="#演示手动-ACK">¶</a>演示手动 ACK</h3>
<p>重新运行生产者发送消息：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611111805436-1621760594165.png" class="" loading="lazy">
<p>同样，在手动进行 ack 前抛出异常，运行 Recv2</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611112952144.png" class="" loading="lazy">
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611112511235.png" class="" loading="lazy">
<p>再看看管理界面：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611112813726.png" class="" loading="lazy">
<p>消息没有被消费掉！</p>
<p>还有另外一种情况：修改消费者 Recv2，把监听队列第二个参数自动改成手动,（去掉之前制造的异常） ，并且消费方法中没手动进行 ACK</p>
<p><img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611113438997.png" class="" loading="lazy"></p>
<p>生产者代码不变，再次运行：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611111805436-1621760609158.png" class="" loading="lazy">
<p>运行消费者 ：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611114015524.png" class="" loading="lazy">
<p>但是，查看管理界面，发现：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611114213414.png" class="" loading="lazy">
<p>停掉消费者的程序，发现：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/201906111143324.png" class="" loading="lazy">
<p>这是因为虽然我们设置了手动 ACK，但是代码中并没有进行消息确认！所以消息并未被真正消费掉。当我们关掉这个消费者，消息的状态再次变为 Ready。</p>
<p>正确的做法是：</p>
<p>我们要在监听队列时设置第二个参数为 false, 代码中手动进行 ACK</p>
<p><img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611114508182.png" class="" loading="lazy"></p>
<p>再次运行消费者，查看 web 管理页面：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611115053951.png" class="" loading="lazy">
<p>消费者消费成功！</p>
<p>生产者避免数据丢失：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/vipstone/p/9350075.html">https://www.cnblogs.com/vipstone/p/9350075.html</a></p>
<h2 id="②work-消息模型"><a class="header-anchor" href="#②work-消息模型">¶</a>②work 消息模型</h2>
<p>工作队列或者<strong>竞争消费者</strong>模式</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611201227139.png" class="" loading="lazy">
<p>work queues 与入门程序相比，多了一个消费端，两个消费端共同消费同一个队列中的消息，但是一个消息只能被一个消费者获取。</p>
<p>这个消息模型在 Web 应用程序中特别有用，可以处理短的 HTTP 请求窗口中无法处理复杂的任务。</p>
<p>接下来我们来模拟这个流程：</p>
<p>P：生产者：任务的发布者</p>
<p>C1：消费者 1：领取任务并且完成任务，假设完成速度较慢（模拟耗时）</p>
<p>C2：消费者 2：领取任务并且完成任务，假设完成速度较快</p>
<h3 id="生产者-v2"><a class="header-anchor" href="#生产者-v2">¶</a>生产者</h3>
<p>生产者循环发送 50 条消息</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Send</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"test_work_queue"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取通道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 循环发布任务</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 消息内容</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"task .. "</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> QUEUE_NAME<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [x] Sent '"</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 关闭通道和连接</span>
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="消费者-1"><a class="header-anchor" href="#消费者-1">¶</a>消费者 1</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Recv</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"test_work_queue"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建会话通道,生产者和mq服务所有通信都在channel通道中完成</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//实现消费方法</span>
        <span class="token class-name">DefaultConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span><span class="token class-name">BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// body 即消息体</span>
                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [消费者1] received : "</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//模拟任务耗时1s</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">// 监听队列，第二个参数：是否自动进行消息确认。</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="消费者-2"><a class="header-anchor" href="#消费者-2">¶</a>消费者 2</h3>
<p>代码不贴了，与消费者 1 基本类似，只是消费者 2 没有设置消费耗时时间。</p>
<p>接下来，两个消费者一同启动，然后发送 50 条消息：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611124709504.png" class="" loading="lazy">
<p><img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611124745242.png" class="" loading="lazy"></p>
<p>可以发现，两个消费者各自消费了不同 25 条消息，这就实现了任务的分发。</p>
<h3 id="能者多劳"><a class="header-anchor" href="#能者多劳">¶</a>能者多劳</h3>
<p>刚才的实现有问题吗？</p>
<ul>
<li>
<p>消费者 1 比消费者 2 的效率要低，一次任务的耗时较长</p>
</li>
<li>
<p>然而两人最终消费的消息数量是一样的</p>
</li>
<li>
<p>消费者 2 大量时间处于空闲状态，消费者 1 一直忙碌</p>
</li>
</ul>
<p>现在的状态属于是把任务平均分配，正确的做法应该是消费越快的人，消费的越多。</p>
<p>怎么实现呢？</p>
<p>通过 BasicQos 方法设置 prefetchCount = 1。这样 RabbitMQ 就会使得每个 Consumer 在同一个时间点最多处理 1 个 Message。换句话说，在接收到该 Consumer 的 ack 前，他它不会将新的 Message 分发给它。相反，它会将其分派给不是仍然忙碌的下一个 Consumer。</p>
<p>值得注意的是：prefetchCount 在手动 ack 的情况下才生效，自动 ack 不生效。</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611141348560.png" class="" loading="lazy">
<p>再次测试：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611141202657.png" class="" loading="lazy">
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611142240194.png" class="" loading="lazy">
<h3 id="订阅模型分类"><a class="header-anchor" href="#订阅模型分类">¶</a>订阅模型分类</h3>
<p>说明下：</p>
<p>1、一个生产者多个消费者<br>
2、每个消费者都有一个自己的队列<br>
3、生产者没有将消息直接发送给队列，而是发送给 exchange(交换机、转发器)<br>
4、每个队列都需要绑定到交换机上<br>
5、生产者发送的消息，经过交换机到达队列，实现一个消息被多个消费者消费<br>
例子：注册 -&gt; 发邮件、发短信</p>
<p>X（Exchanges）：交换机一方面：接收生产者发送的消息。另一方面：知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于 Exchange 的类型。</p>
<p>Exchange 类型有以下几种：</p>
<p>Fanout：广播，将消息交给所有绑定到交换机的队列</p>
<p>Direct：定向，把消息交给符合指定 routing key 的队列</p>
<p>Topic：通配符，把消息交给符合 routing pattern（路由模式） 的队列</p>
<p>Header：header 模式与 routing 不同的地方在于，header 模式取消 routingkey，使用 header 中的 key/value（键值对）匹配队列。</p>
<p>Header 模式不展开了，感兴趣可以参考这篇文章 <a target="_blank" rel="noopener" href="https://blog.csdn.net/zhu_tianwei/article/details/40923131">https://blog.csdn.net/zhu_tianwei/article/details/40923131</a></p>
<p><strong>Exchange（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与 Exchange 绑定，或者没有符合路由规则的队列，那么消息会丢失！</p>
<h2 id="③-Publish-subscribe（交换机类型：-Fanout，也称为广播-）"><a class="header-anchor" href="#③-Publish-subscribe（交换机类型：-Fanout，也称为广播-）">¶</a>③**Publish/subscribe（交换机类型：**Fanout，也称为广播 <strong>）</strong></h2>
<p>Publish/subscribe 模型示意图 ：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611200955466.png" class="" loading="lazy">
<h3 id="生产者-v3"><a class="header-anchor" href="#生产者-v3">¶</a>生产者</h3>
<p>和前面两种模式不同：</p>
<ul>
<li>
<p>1） 声明 Exchange，不再声明 Queue</p>
</li>
<li>
<p>2） 发送消息到 Exchange，不再发送到 Queue</p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Send</span> <span class="token punctuation">&#123;</span>
 
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> EXCHANGE_NAME <span class="token operator">=</span> <span class="token string">"test_fanout_exchange"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取通道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明exchange，指定类型为fanout</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"fanout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 消息内容</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"注册成功！！"</span><span class="token punctuation">;</span>
        <span class="token comment">// 发布消息到Exchange</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [生产者] Sent '"</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="消费者-1-（注册成功发给短信服务）"><a class="header-anchor" href="#消费者-1-（注册成功发给短信服务）">¶</a>消费者 1 （注册成功发给短信服务）</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Recv</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"fanout_exchange_queue_sms"</span><span class="token punctuation">;</span><span class="token comment">//短信队列</span>
 
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> EXCHANGE_NAME <span class="token operator">=</span> <span class="token string">"test_fanout_exchange"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取通道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// 绑定队列到交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// 定义队列的消费者</span>
        <span class="token class-name">DefaultConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span><span class="token class-name">BasicProperties</span> properties<span class="token punctuation">,</span>
                                       <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// body 即消息体</span>
                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [短信服务] received : "</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">// 监听队列，自动返回完成</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="消费者-2（注册成功发给邮件服务）"><a class="header-anchor" href="#消费者-2（注册成功发给邮件服务）">¶</a>消费者 2（注册成功发给邮件服务）</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Recv2</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"fanout_exchange_queue_email"</span><span class="token punctuation">;</span><span class="token comment">//邮件队列</span>
 
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> EXCHANGE_NAME <span class="token operator">=</span> <span class="token string">"test_fanout_exchange"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取通道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// 绑定队列到交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 定义队列的消费者</span>
        <span class="token class-name">DefaultConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span><span class="token class-name">BasicProperties</span> properties<span class="token punctuation">,</span>
                                       <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// body 即消息体</span>
                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [邮件服务] received : "</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">// 监听队列，自动返回完成</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们运行两个消费者，然后发送 1 条消息：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611150212871.png" class="" loading="lazy">
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611150133359.png" class="" loading="lazy">
<h3 id="思考："><a class="header-anchor" href="#思考：">¶</a>思考：</h3>
<p>1、publish/subscribe 与 work queues 有什么区别。</p>
<p>区别：</p>
<p>1）work queues 不用定义交换机，而 publish/subscribe 需要定义交换机。</p>
<p>2）publish/subscribe 的生产方是面向交换机发送消息，work queues 的生产方是面向队列发送消息 (底层使用默认交换机)。</p>
<p>3）publish/subscribe 需要设置队列和交换机的绑定，work queues 不需要设置，实际上 work queues 会将队列绑定到默认的交换机 。</p>
<p>相同点：</p>
<p>所以两者实现的发布 / 订阅的效果是一样的，多个消费端监听同一个队列不会重复消费消息。</p>
<p>2、实际工作用 publish/subscribe 还是 work queues。</p>
<p>建议使用 publish/subscribe，发布订阅模式比工作队列模式更强大（也可以做到同一队列竞争），并且发布订阅模式可以指定自己专用的交换机。</p>
<h2 id="④Routing-路由模型（交换机类型：direct）"><a class="header-anchor" href="#④Routing-路由模型（交换机类型：direct）">¶</a>④Routing 路由模型（交换机类型：direct）</h2>
<p>Routing 模型示意图：</p>
<p><img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611151532501.png" class="" loading="lazy"></p>
<p>P：生产者，向 Exchange 发送消息，发送消息时，会指定一个 routing key。</p>
<p>X：Exchange（交换机），接收生产者的消息，然后把消息递交给 与 routing key 完全匹配的队列</p>
<p>C1：消费者，其所在队列指定了需要 routing key 为 error 的消息</p>
<p>C2：消费者，其所在队列指定了需要 routing key 为 info、error、warning 的消息</p>
<p>接下来看代码：</p>
<h3 id="生产者-v4"><a class="header-anchor" href="#生产者-v4">¶</a>生产者</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Send</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> EXCHANGE_NAME <span class="token operator">=</span> <span class="token string">"test_direct_exchange"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取通道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明exchange，指定类型为direct</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>DIRECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息内容，</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"注册成功！请短信回复[T]退订"</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送消息，并且指定routing key 为：sms，只有短信服务能接收到消息</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"sms"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [x] Sent '"</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="消费者-1-v2"><a class="header-anchor" href="#消费者-1-v2">¶</a>消费者 1</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Recv</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"direct_exchange_queue_sms"</span><span class="token punctuation">;</span><span class="token comment">//短信队列</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> EXCHANGE_NAME <span class="token operator">=</span> <span class="token string">"test_direct_exchange"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取通道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 绑定队列到交换机，同时指定需要订阅的routing key。可以指定多个</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"sms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//指定接收发送方指定routing key为sms的消息</span>
        <span class="token comment">//channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, "email");</span>
 
        <span class="token comment">// 定义队列的消费者</span>
        <span class="token class-name">DefaultConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span><span class="token class-name">BasicProperties</span> properties<span class="token punctuation">,</span>
                                       <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// body 即消息体</span>
                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [短信服务] received : "</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">// 监听队列，自动ACK</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="消费者-2-v2"><a class="header-anchor" href="#消费者-2-v2">¶</a>消费者 2</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Recv2</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"direct_exchange_queue_email"</span><span class="token punctuation">;</span><span class="token comment">//邮件队列</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> EXCHANGE_NAME <span class="token operator">=</span> <span class="token string">"test_direct_exchange"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取通道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 绑定队列到交换机，同时指定需要订阅的routing key。可以指定多个</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"email"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//指定接收发送方指定routing key为email的消息</span>
 
        <span class="token comment">// 定义队列的消费者</span>
        <span class="token class-name">DefaultConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span><span class="token class-name">BasicProperties</span> properties<span class="token punctuation">,</span>
                                       <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// body 即消息体</span>
                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [邮件服务] received : "</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">// 监听队列，自动ACK</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们发送 sms 的 RoutingKey，发现结果：只有指定短信的消费者 1 收到消息了</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611154144816.png" class="" loading="lazy">
<h2 id="⑤Topics-通配符模式（交换机类型：topics）"><a class="header-anchor" href="#⑤Topics-通配符模式（交换机类型：topics）">¶</a>⑤Topics 通配符模式（交换机类型：topics）</h2>
<p>Topics 模型示意图：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611154905286.png" class="" loading="lazy">
<p>每个消费者监听自己的队列，并且设置带统配符的 routingkey, 生产者将消息发给 broker，由交换机根据 routingkey 来转发消息到指定的队列。</p>
<p>Routingkey 一般都是有一个或者多个单词组成，多个单词之间以 “.” 分割，例如：inform.sms</p>
<p>通配符规则：</p>
<p><code>#</code>：匹配一个或多个词</p>
<p><code>*</code>：匹配不多不少恰好 1 个词</p>
<p>举例：</p>
<p><code>audit.#</code>：能够匹配<code>audit.irs.corporate</code> 或者 <code>audit.irs</code></p>
<p><code>audit.*</code>：只能匹配<code>audit.irs</code></p>
<p>从示意图可知，我们将发送所有描述动物的消息。消息将使用由三个字（两个点）组成的 Routing key 发送。路由关键字中的第一个单词将描述速度，第二个颜色和第三个种类：“<speed>.<color>.<species>”。</p>
<p>我们创建了三个绑定：Q1 绑定了 “<em>.orange.</em><em>”，Q2 绑定了 “</em>.<em>.</em>.rabbit” 和 “lazy.＃”。</p>
<p>Q1 匹配所有的橙色动物。</p>
<p>Q2 匹配关于兔子以及懒惰动物的消息。</p>
<p>下面做个小练习，假如生产者发送如下消息，会进入哪个队列：</p>
<p>quick.orange.rabbit       Q1 Q2   routingKey=“quick.orange.rabbit” 的消息会同时路由到 Q1 与 Q2</p>
<p>lazy.orange.elephant    Q1 Q2</p>
<p>quick.orange.fox           Q1</p>
<p>lazy.pink.rabbit              Q2  (值得注意的是，虽然这个 routingKey 与 Q2 的两个 bindingKey 都匹配，但是只会投递 Q2 一次)</p>
<p>quick.brown.fox            不匹配任意队列，被丢弃</p>
<p>quick.orange.male.rabbit   不匹配任意队列，被丢弃</p>
<p>orange         不匹配任意队列，被丢弃</p>
<p>下面我们以指定 Routing key=“quick.orange.rabbit” 为例，验证上面的答案</p>
<h3 id="生产者-v5"><a class="header-anchor" href="#生产者-v5">¶</a>生产者</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Send</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> EXCHANGE_NAME <span class="token operator">=</span> <span class="token string">"test_topic_exchange"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取通道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明exchange，指定类型为topic</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息内容</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"这是一只行动迅速的橙色的兔子"</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送消息，并且指定routing key为：quick.orange.rabbit</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"quick.orange.rabbit"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [动物描述：] Sent '"</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="消费者-1-v3"><a class="header-anchor" href="#消费者-1-v3">¶</a>消费者 1</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Recv</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"topic_exchange_queue_Q1"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> EXCHANGE_NAME <span class="token operator">=</span> <span class="token string">"test_topic_exchange"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取通道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 绑定队列到交换机，同时指定需要订阅的routing key。订阅所有的橙色动物</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"*.orange.*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// 定义队列的消费者</span>
        <span class="token class-name">DefaultConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span><span class="token class-name">BasicProperties</span> properties<span class="token punctuation">,</span>
                                       <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// body 即消息体</span>
                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [消费者1] received : "</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">// 监听队列，自动ACK</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="消费者-2-v3"><a class="header-anchor" href="#消费者-2-v3">¶</a>消费者 2</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Recv2</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"topic_exchange_queue_Q2"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> EXCHANGE_NAME <span class="token operator">=</span> <span class="token string">"test_topic_exchange"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取到连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">ConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取通道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 绑定队列到交换机，同时指定需要订阅的routing key。订阅关于兔子以及懒惰动物的消息</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"*.*.rabbit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"lazy.＃"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// 定义队列的消费者</span>
        <span class="token class-name">DefaultConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span><span class="token class-name">BasicProperties</span> properties<span class="token punctuation">,</span>
                                       <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// body 即消息体</span>
                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [消费者2] received : "</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">// 监听队列，自动ACK</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果 C1、C2 是都接收到消息了：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611193035125.png" class="" loading="lazy">
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611193105639.png" class="" loading="lazy">
<h2 id="⑥RPC"><a class="header-anchor" href="#⑥RPC">¶</a>⑥RPC</h2>
<p>RPC 模型示意图：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611200118579.png" class="" loading="lazy">
<p>基本概念：</p>
<p>Callback queue 回调队列**，**客户端向服务器发送请求，服务器端处理请求后，将其处理结果保存在一个存储体中。而客户端为了获得处理结果，那么客户在向服务器发送请求时，同时发送一个回调队列地址 reply_to。</p>
<p>Correlation id 关联标识**，**客户端可能会发送多个请求给服务器，当服务器处理完后，客户端无法辨别在回调队列中的响应具体和那个请求时对应的。为了处理这种情况，客户端在发送每个请求时，同时会附带一个独有 correlation_id 属性，这样客户端在回调队列中根据 correlation_id 字段的值就可以分辨此响应属于哪个请求。</p>
<p>流程说明**：**</p>
<ul>
<li>当客户端启动的时候，它创建一个匿名独享的回调队列。</li>
<li>在 RPC 请求中，客户端发送带有两个属性的消息：一个是设置回调队列的 reply_to 属性，另一个是设置唯一值的 correlation_id 属性。</li>
<li>将请求发送到一个 rpc_queue 队列中。</li>
<li>服务器等待请求发送到这个队列中来。当请求出现的时候，它执行他的工作并且将带有执行结果的消息发送给 reply_to 字段指定的队列。</li>
<li>客户端等待回调队列里的数据。当有消息出现的时候，它会检查 correlation_id 属性。如果此属性的值与请求匹配，将它返回给应用</li>
</ul>
<h3 id="分享两道面试题："><a class="header-anchor" href="#分享两道面试题：">¶</a>分享两道面试题：</h3>
<p>面试题：</p>
<p>避免消息堆积？</p>
<p>1） 采用 workqueue，多个消费者监听同一队列。</p>
<p>2）接收到消息以后，而是通过线程池，异步消费。</p>
<p>如何避免消息丢失？</p>
<p>1） 消费者的 ACK 机制。可以防止消费者丢失消息。</p>
<p>但是，如果在消费者消费之前，MQ 就宕机了，消息就没了？</p>
<p>2）可以将消息进行持久化。要将消息持久化，前提是：队列、Exchange 都持久化</p>
<h3 id="交换机持久化"><a class="header-anchor" href="#交换机持久化">¶</a>交换机持久化</h3>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611194652489.png" class="" loading="lazy">
<h3 id="队列持久化"><a class="header-anchor" href="#队列持久化">¶</a>队列持久化</h3>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611194730149.png" class="" loading="lazy">
<h3 id="消息持久化"><a class="header-anchor" href="#消息持久化">¶</a>消息持久化</h3>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190611195509217.png" class="" loading="lazy">
<h2 id="Spring-整合-RibbitMQ"><a class="header-anchor" href="#Spring-整合-RibbitMQ">¶</a>Spring 整合 RibbitMQ</h2>
<p>下面还是模拟注册服务当用户注册成功后，向短信和邮件服务推送消息的场景</p>
<h3 id="搭建-SpringBoot-环境"><a class="header-anchor" href="#搭建-SpringBoot-环境">¶</a>搭建 SpringBoot 环境</h3>
<p>创建两个工程 mq-rabbitmq-producer 和 mq-rabbitmq-consumer，分别配置 1、2、3（第三步本例消费者用注解形式，可以不用配）</p>
<p><strong>1、添加 AMQP 的启动器：</strong></p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring‐boot‐starter‐test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>2、在<code>application.yml</code>中添加 RabbitMQ 的配置：</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>  
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mq<span class="token punctuation">-</span>rabbitmq<span class="token punctuation">-</span>producer
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.1.103
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> kavito
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">virtualHost</span><span class="token punctuation">:</span> /kavito
    <span class="token key atrule">template</span><span class="token punctuation">:</span>
      <span class="token key atrule">retry</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">initial-interval</span><span class="token punctuation">:</span> 10000ms
        <span class="token key atrule">max-interval</span><span class="token punctuation">:</span> 300000ms
        <span class="token key atrule">multiplier</span><span class="token punctuation">:</span> <span class="token number">2</span>
      <span class="token key atrule">exchange</span><span class="token punctuation">:</span> topic.exchange
    <span class="token key atrule">publisher-confirms</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>属性说明：</p>
<ul>
<li>
<p>template：有关<code>AmqpTemplate</code>的配置</p>
<ul>
<li>
<p>retry：失败重试</p>
<ul>
<li>
<p>enabled：开启失败重试</p>
</li>
<li>
<p>initial-interval：第一次重试的间隔时长</p>
</li>
<li>
<p>max-interval：最长重试间隔，超过这个间隔将不再重试</p>
</li>
<li>
<p>multiplier：下次重试间隔的倍数，此处是 2 即下次重试间隔是上次的 2 倍</p>
</li>
</ul>
</li>
<li>
<p>exchange：缺省的交换机名称，此处配置后，发送消息如果不指定交换机就会使用这个</p>
</li>
</ul>
</li>
<li>
<p>publisher-confirms：生产者确认机制，确保消息会正确发送，如果发送失败会有错误回执，从而触发重试</p>
</li>
</ul>
<p>当然如果 consumer 只是接收消息而不发送，就不用配置 template 相关内容。</p>
<p><strong>3、定义 RabbitConfig 配置类，配置 Exchange、Queue、及绑定交换机。</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitmqConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUEUE_EMAIL <span class="token operator">=</span> <span class="token string">"queue_email"</span><span class="token punctuation">;</span><span class="token comment">//email队列</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUEUE_SMS <span class="token operator">=</span> <span class="token string">"queue_sms"</span><span class="token punctuation">;</span><span class="token comment">//sms队列</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> EXCHANGE_NAME<span class="token operator">=</span><span class="token string">"topic.exchange"</span><span class="token punctuation">;</span><span class="token comment">//topics类型交换机</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ROUTINGKEY_EMAIL<span class="token operator">=</span><span class="token string">"topic.#.email.#"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ROUTINGKEY_SMS<span class="token operator">=</span><span class="token string">"topic.#.sms.#"</span><span class="token punctuation">;</span>
 
    <span class="token comment">//声明交换机</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Exchange</span> <span class="token function">exchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//durable(true) 持久化，mq重启之后交换机还在</span>
        <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span><span class="token punctuation">.</span><span class="token function">topicExchange</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token comment">//声明email队列</span>
    <span class="token comment">/*
     *   new Queue(QUEUE_EMAIL,true,false,false)
     *   durable="true" 持久化 rabbitmq重启的时候不需要创建新的队列
     *   auto-delete 表示消息队列没有在使用时将被自动删除 默认是false
     *   exclusive  表示该消息队列是否只在当前connection生效,默认是false
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>QUEUE_EMAIL<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">emailQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span>QUEUE_EMAIL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//声明sms队列</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>QUEUE_SMS<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">smsQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span>QUEUE_SMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token comment">//ROUTINGKEY_EMAIL队列绑定交换机，指定routingKey</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingEmail</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span>QUEUE_EMAIL<span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">)</span> <span class="token class-name">Exchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>ROUTINGKEY_EMAIL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//ROUTINGKEY_SMS队列绑定交换机，指定routingKey</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingSMS</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span>QUEUE_SMS<span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">,</span>
                              <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">)</span> <span class="token class-name">Exchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>ROUTINGKEY_SMS<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="生产者-mq-rabbitmq-producer"><a class="header-anchor" href="#生产者-mq-rabbitmq-producer">¶</a>生产者 (mq-rabbitmq-producer)</h3>
<p>为了方便测试，我直接把生产者代码放工程测试类：发送 routing key 是 “topic.sms.email” 的消息，那么 mq-rabbitmq-consumer 下那些监听的（与交换机 (topic.exchange) 绑定，并且订阅的 routingkey 中匹配了 “topic.sms.email” 规则的） 队列就会收到消息。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Send</span> <span class="token punctuation">&#123;</span>
 
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMsgByTopics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 
        <span class="token comment">/**
         * 参数：
         * 1、交换机名称
         * 2、routingKey
         * 3、消息内容
         */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"恭喜您，注册成功！userid="</span><span class="token operator">+</span>i<span class="token punctuation">;</span>
            rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">RabbitmqConfig</span><span class="token punctuation">.</span>EXCHANGE_NAME<span class="token punctuation">,</span><span class="token string">"topic.sms.email"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [x] Sent '"</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
 
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行测试类发送 5 条消息：</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190612112420397.png" class="" loading="lazy">
<p>web 管理界面： 可以看到已经创建了交换机以及 queue_email、queue_sms 2 个队列，并且向这两个队列分别发送了 5 条消息</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190612125827992.png" class="" loading="lazy">
<p><img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190612115104481.png" class="" loading="lazy"></p>
<h3 id="消费者-mq-rabbitmq-consumer"><a class="header-anchor" href="#消费者-mq-rabbitmq-consumer">¶</a>消费者 (mq-rabbitmq-consumer)</h3>
<p>编写一个监听器组件，通过注解配置消费者队列，以及队列与交换机之间绑定关系。（也可以像生产者那样通过配置类配置）</p>
<p>在 SpringAmqp 中，对消息的消费者进行了封装和抽象。一个 JavaBean 的方法，只要添加 @RabbitListener 注解，就可以成为了一个消费者。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReceiveHandler</span> <span class="token punctuation">&#123;</span>
 
    <span class="token comment">//监听邮件队列</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"queue_email"</span><span class="token punctuation">,</span> durable <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>
                    value <span class="token operator">=</span> <span class="token string">"topic.exchange"</span><span class="token punctuation">,</span>
                    ignoreDeclarationExceptions <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
                    type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span>TOPIC
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"topic.#.email.#"</span><span class="token punctuation">,</span><span class="token string">"email.*"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rece_email</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [邮件服务] received : "</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token comment">//监听短信队列</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"queue_sms"</span><span class="token punctuation">,</span> durable <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>
                    value <span class="token operator">=</span> <span class="token string">"topic.exchange"</span><span class="token punctuation">,</span>
                    ignoreDeclarationExceptions <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
                    type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span>TOPIC
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"topic.#.sms.#"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rece_sms</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" [短信服务] received : "</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>属性说明：</p>
<ul>
<li>
<p><code>@Componet</code>：类上的注解，注册到 Spring 容器</p>
</li>
<li>
<p><code>@RabbitListener</code>：方法上的注解，声明这个方法是一个消费者方法，需要指定下面的属性：</p>
<ul>
<li>
<p><code>bindings</code>：指定绑定关系，可以有多个。值是<code>@QueueBinding</code>的数组。<code>@QueueBinding</code>包含下面属性：</p>
<ul>
<li>
<p><code>value</code>：这个消费者关联的队列。值是<code>@Queue</code>，代表一个队列</p>
</li>
<li>
<p><code>exchange</code>：队列所绑定的交换机，值是<code>@Exchange</code>类型</p>
</li>
<li>
<p><code>key</code>：队列和交换机绑定的<code>RoutingKey，可指定多个</code></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>启动 mq-rabbitmq-comsumer 项目</p>
<img src="/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/20190612113450136.png" class="" loading="lazy">
<p>ok, 邮件服务和短息服务接收到消息后，就可以各自开展自己的业务了。</p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>momo</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" title="RabbitMQ快速入门">https://ppxiaodi.gitee.io/2021/05/23/CollectionNote/rabbitMQ/RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/05/31/CollectionNote/java/java_base/Integer%E4%B8%8ELong%E7%9A%84%E7%BC%93%E5%AD%98/" rel="prev" title="Integer与Long的缓存"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">Integer与Long的缓存</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/05/23/CollectionNote/rabbitMQ/docker%E5%AE%89%E8%A3%85rabbitMQ/" rel="next" title="docker安装rabbitMQ"><span class="post-nav-text">docker安装rabbitMQ</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> momo</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.7.0</span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div id="local-search-result"></div></div></div></body></html>