<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="momo"><meta name="copyright" content="momo"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>redis深度历险 | 我的笔记</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"ppxiaodi.gitee.io","root":"/","title":"momo的小站","version":"1.7.0","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><meta name="description" content="redis深度历险 ¶1.3 千帆竞发——分布式锁 ¶分布式锁的奥义 分布式锁使用 setnx (set if not exits) 指令，只允许一个客服端占有锁。 先来先占，用完了，再调用 del 指令释放锁。 script&gt; setnx lock:codeole true OK ... do something critical... &gt; del lock:codehole (integer)">
<meta property="og:type" content="article">
<meta property="og:title" content="redis深度历险">
<meta property="og:url" content="https://ppxiaodi.gitee.io/2020/12/11/CollectionNote/java/redis/redis%E6%B7%B1%E5%BA%A6%E5%8E%86%E9%99%A9/index.html">
<meta property="og:site_name" content="我的笔记">
<meta property="og:description" content="redis深度历险 ¶1.3 千帆竞发——分布式锁 ¶分布式锁的奥义 分布式锁使用 setnx (set if not exits) 指令，只允许一个客服端占有锁。 先来先占，用完了，再调用 del 指令释放锁。 script&gt; setnx lock:codeole true OK ... do something critical... &gt; del lock:codehole (integer)">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-12-10T16:00:00.000Z">
<meta property="article:modified_time" content="2021-07-11T08:54:54.017Z">
<meta property="article:author" content="momo">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="momo"><img width="96" loading="lazy" src="/yun.png" alt="momo"></a><div class="site-author-name"><a href="/about/">momo</a></div><a class="site-name" href="/about/site.html">我的笔记</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">198</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">58</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">47</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=kZJzggTTCf4SpvEQ8lXWoi5ZjhAx0ILZ&amp;jump_from=webapi" title="QQ 群 1050458482" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YunYouJun" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/jizhideyunyoujun" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/yunyoujun/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/yunyoujun/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/about/white-qrcode-and-search.jpg" title="微信公众号" target="_blank" style="color:#1AAD19"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-2-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/YunYouJun" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@yunyoujun.cn" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.link" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-train-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">redis深度历险</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%8D%83%E5%B8%86%E7%AB%9E%E5%8F%91%E2%80%94%E2%80%94%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">1.1.</span> <span class="toc-text">1.3 千帆竞发——分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%A5%A5%E4%B9%89"><span class="toc-number">1.1.1.</span> <span class="toc-text">分布式锁的奥义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.2.</span> <span class="toc-text">超时问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E7%BC%93%E5%85%B5%E4%B9%8B%E8%AE%A1%E2%80%93%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97"><span class="toc-number">1.2.</span> <span class="toc-text">1.4 缓兵之计–延时队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E7%A9%BA%E4%BA%86%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">1.2.2.</span> <span class="toc-text">队列空了怎么办</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E8%AF%BB"><span class="toc-number">1.2.3.</span> <span class="toc-text">阻塞读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BA%E9%97%B2%E8%BF%9E%E6%8E%A5%E8%87%AA%E5%8A%A8%E6%96%AD%E5%BC%80"><span class="toc-number">1.2.4.</span> <span class="toc-text">空闲连接自动断开</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E5%86%B2%E7%AA%81%E5%A4%84%E7%90%86"><span class="toc-number">1.2.5.</span> <span class="toc-text">锁冲突处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.6.</span> <span class="toc-text">延时队列的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.7.</span> <span class="toc-text">java代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E8%8A%82%E8%A1%A3%E7%BC%A9%E9%A3%9F%E2%80%94%E2%80%94%E4%BD%8D%E5%9B%BE"><span class="toc-number">1.3.</span> <span class="toc-text">1.5 节衣缩食——位图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-number">1.3.1.</span> <span class="toc-text">基本用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E5%92%8C%E6%9F%A5%E6%89%BE"><span class="toc-number">1.3.2.</span> <span class="toc-text">统计和查找</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AD%94%E6%9C%AF%E6%8C%87%E4%BB%A4-bitfield"><span class="toc-number">1.3.3.</span> <span class="toc-text">魔术指令 bitfield</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6-%E5%9B%9B%E4%B8%A4%E6%8B%A8%E5%8D%83%E6%96%A4%E2%80%94%E2%80%94HyperLogLog"><span class="toc-number">1.4.</span> <span class="toc-text">1.6 四两拨千斤——HyperLogLog</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.1.</span> <span class="toc-text">使用方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pfmerge-%E9%80%82%E5%90%88%E7%9A%84%E5%9C%BA%E5%90%88"><span class="toc-number">1.4.2.</span> <span class="toc-text">pfmerge 适合的场合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">1.4.3.</span> <span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-10-%E8%BF%91%E6%B0%B4%E6%A5%BC%E5%8F%B0%E2%80%94%E2%80%94GeoHash"><span class="toc-number">1.5.</span> <span class="toc-text">1.10 近水楼台——GeoHash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-11-scan"><span class="toc-number">1.6.</span> <span class="toc-text">1.11 scan</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://ppxiaodi.gitee.io/2020/12/11/CollectionNote/java/redis/redis%E6%B7%B1%E5%BA%A6%E5%8E%86%E9%99%A9/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="momo"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="我的笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">redis深度历险</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2020-12-11 00:00:00" itemprop="dateCreated datePublished" datetime="2020-12-11T00:00:00+08:00">2020-12-11</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-07-11 16:54:54" itemprop="dateModified" datetime="2021-07-11T16:54:54+08:00">2021-07-11</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/java/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">java</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/java/redis%E6%B7%B1%E5%BA%A6%E5%8E%86%E9%99%A9/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">redis深度历险</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/redis/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">redis</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h1>redis深度历险</h1>
<h2 id="1-3-千帆竞发——分布式锁"><a class="header-anchor" href="#1-3-千帆竞发——分布式锁">¶</a>1.3 千帆竞发——分布式锁</h2>
<h3 id="分布式锁的奥义"><a class="header-anchor" href="#分布式锁的奥义">¶</a>分布式锁的奥义</h3>
<p>分布式锁使用 <code>setnx</code> (set if not exits) 指令，只允许一个客服端占有锁。<br>
先来先占，用完了，再调用 del 指令释放锁。</p>
<pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token operator">></span> setnx lock:codeole <span class="token boolean">true</span>
OK
<span class="token punctuation">..</span>. <span class="token keyword">do</span> something critical<span class="token punctuation">..</span>.
<span class="token operator">></span> del lock:codehole
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>问题： 如果逻辑执行中出现异常，导致del指令没有调用，陷入死锁，锁永远得不到释放。</p>
<p>解决问题：于是我们拿到锁后，再给锁加上一个过期时间。</p>
<pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token operator">></span>setnx lock:codehole <span class="token boolean">true</span>
OK
<span class="token operator">></span>expire lock:codehole <span class="token number">5</span>
<span class="token punctuation">..</span>. <span class="token keyword">do</span> something critical<span class="token punctuation">..</span>.
<span class="token operator">></span>del lock:codehole
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>又出现新问题：如果获取锁后，在设置过期时间时，服务器进程突然挂掉，会导致expire得不到<br>
执行，也会导致死锁。</p>
<p>原因是，setnx和expire两条指令不是原子指令<br>
为了解决这个问题，redis开源社区涌现了许多分布式锁。<br>
redis 2.8版本中，作者加上了set指令的扩展参数，使得setnx和expire指令可以一起执行，<br>
彻底解决了分布式锁的乱象。</p>
<pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token operator">></span>set lock:codehole <span class="token boolean">true</span> ex <span class="token number">5</span> nx
OK
<span class="token punctuation">..</span>. <span class="token keyword">do</span> something critical<span class="token punctuation">..</span>.
<span class="token operator">></span>del lock:codehole<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面这个指令就是 setnx 和 expire 组合在一起的原子指令，它就是分布式锁的奥义所在。</p>
<h3 id="超时问题"><a class="header-anchor" href="#超时问题">¶</a>超时问题</h3>
<p>redis的分布式锁不能解决超时问题，加锁和释放锁之前逻辑执行太长，超出了锁的超时限制，<br>
这时候第一个线程持有的锁过期，临界区的逻辑还没有执行完，同时第二个线程就提前重新持有了这把锁，<br>
导致临界区代码不能得到严格串行执行。<br>
建议：redis分布式锁不要用于较长时间的任务。如果偶尔出现问题，造成的数据小错误，可能需要人工介入<br>
解决。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">tag <span class="token operator">=</span> random<span class="token punctuation">.</span>nextint<span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">#随机数</span>
<span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>tag<span class="token punctuation">,</span>nx<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>ex<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    do_something<span class="token punctuation">(</span><span class="token punctuation">)</span>
    redis<span class="token punctuation">.</span>delifequals<span class="token punctuation">(</span>key<span class="token punctuation">,</span>tag<span class="token punctuation">)</span>    <span class="token comment">#假想的delifequals指令</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>安全一点的解决方案：将 set 指令的 value 参数设置为一个随机数，释放锁时先匹配随机数是否一致，<br>
然后再删除key，这是为了确保当前线程占有的锁不会被其他线程释放，除非这个锁是因为过期了而被服务<br>
器自动释放的。</p>
<p>但是匹配 value 和删除 key 不是一个原子操作，Redis 也没有提供类似于delifequals 这样的指令，<br>
这就需要使用 Lua 脚本来处理了，因为 Lua 脚本可以保证连续多个指令的原子性执行。</p>
<pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token operator">#</span> delifequals
<span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"del"</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是这也不是一个完美的方案，它只是相对安全一点，因为如果真的超时了，当前线程的逻辑没有执行完，<br>
其他线程也会乘虚而入。</p>
<h2 id="1-4-缓兵之计–延时队列"><a class="header-anchor" href="#1-4-缓兵之计–延时队列">¶</a>1.4 缓兵之计–延时队列</h2>
<p>注意事项：没有ack保证，如果对消息的可靠性有着极高要求，那么它就不适合使用。</p>
<h3 id="原理"><a class="header-anchor" href="#原理">¶</a>原理</h3>
<p>使用list(列表)数据结构用来作为异步消息队列。<br>
用<code>rpush</code>和<code>lpush</code>操作入队列，用<code>lpop</code>和<code>rpop</code>操作出队列</p>
<h3 id="队列空了怎么办"><a class="header-anchor" href="#队列空了怎么办">¶</a>队列空了怎么办</h3>
<p>队列空了，客户端会陷入pop的空轮询死循环，如果客服端多了，增加redis<br>
慢查询，<br>
解决办法：客户端使用sleep<br>
新出现问题：导致消息延迟增大</p>
<h3 id="阻塞读"><a class="header-anchor" href="#阻塞读">¶</a>阻塞读</h3>
<p>使用<code>blpop/brpop</code>,这个两个指令前缀字符b代表的是blocking,即阻塞读。<br>
阻塞读在队列没有数据的时候，会立即进入休眠状态，一旦数据到来，则立刻醒过来。<br>
消息的延迟几乎为零。用<code>blpop/brpop</code> 替代前面的 <code>lpop/rpop</code>，就完美解决<br>
了上面的问题。</p>
<p>新出现问题：空闲连接的问题</p>
<h3 id="空闲连接自动断开"><a class="header-anchor" href="#空闲连接自动断开">¶</a>空闲连接自动断开</h3>
<p>如果线程一直阻塞在那里，Redis 的客户端连接就成了闲置连接，闲置过久，服务器一<br>
般会主动断开连接，减少闲置资源占用。这个时候 blpop/brpop 会抛出异常。所以编写<br>
客户端消费者的时候要小心，如果捕获到异常，还要重试。</p>
<h3 id="锁冲突处理"><a class="header-anchor" href="#锁冲突处理">¶</a>锁冲突处理</h3>
<p>客户端在处理请求时加锁没加成功，有三种策略来处理加锁失败。</p>
<p>1.直接抛出异常，通知用户稍后重试。<br>
2.sleep 一会儿，然后再重试。<br>
3.将请求转移至延时队列，过一会儿再试。</p>
<p>直接抛出特定类型的异常<br>
这种方式比较适合由用户发起的请求。用户看到错误对话框，会阅读对话框，再点击重试，起到<br>
人工延时的效果。如果考虑到用户体验，可以由前端的代码替代用户来进行延时重试控制。它本<br>
质上是对当前请求的放弃，由用户决定是否重新发起新的请求。</p>
<p>sleep<br>
sleep会阻塞当前的消息的处理线程。会导致队列的后续消息处理出现延迟。<br>
如果比较频繁或者队列里消息比较多，sleep可能不合适。如果个别死锁的key导致加锁不成功，<br>
线程会彻底堵死，导致后续消息永远得不到及时处理。</p>
<p>延时队列<br>
这这种比较合适异步消息处理，将当前冲突的请求扔到另一个队列延后处理。</p>
<h3 id="延时队列的实现"><a class="header-anchor" href="#延时队列的实现">¶</a>延时队列的实现</h3>
<p>延时队列使用<code>zset</code>(有序列表)实现。我们将消息序列化成一个字符串作为 zset 的value,<br>
这个消息的到期处理时间作为 score,然后用多个线程轮询zset 获取到期的任务进行处理。<br>
多个线程是为了保障可用性，万一挂了一个线程还有其他线程可以继续处理。因为有多个线程，<br>
所以需要考虑并发争抢任务，确保任务不会被多次执行。</p>
<p>Redis 的 zrem 方法是多线程多进程争抢任务的关键，它的返回值决定了当前实例有没有抢到任务，<br>
因为 loop 方法可能会被多个线程、多个进程调用，同一个任务可能会被多个进程、多个线程抢到，<br>
要通过 zrem 来决定唯一的属主。同时，我们要注意一定要对 handle_msg 进行异常捕获，避免<br>
因为个别任务处理问题导致循环异常退出。以下是 Java 版本的延时队列实现方法，因为要使用到<br>
JSON序列化，所以还需要 fastjson 库的支持。</p>
<h3 id="java代码"><a class="header-anchor" href="#java代码">¶</a>java代码</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">TypeReference</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token class-name">Jedis</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Type</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>UUID<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisDelayingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TaskItem</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">T</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//fastjson 序列化对象中存在 generic 类型时，需要使用TypeReference</span>
    <span class="token keyword">private</span> <span class="token class-name">Type</span> taskType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskItem</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Jedis</span> jedis<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> queueKey<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RedisDelayingQueue</span><span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis<span class="token punctuation">,</span> <span class="token class-name">String</span> queueKey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jedis <span class="token operator">=</span> jedis<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queueKey <span class="token operator">=</span> queueKey<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token class-name">T</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">TaskItem</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskItem</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//分配唯一的uuid</span>
        task<span class="token punctuation">.</span>id <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//塞入延时队列，5s后再试</span>
        jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span>queueKey<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5000</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//只取一条</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> values <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">zrangeByScore</span><span class="token punctuation">(</span>queueKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">String</span> s <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">zrem</span><span class="token punctuation">(</span>queueKey<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">TaskItem</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> task <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> taskType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleMsg</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMsg</span><span class="token punctuation">(</span><span class="token class-name">T</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"192.168.56.10"</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisDelayingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisDelayingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>jedis<span class="token punctuation">,</span> <span class="token string">"q-demo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    queue<span class="token punctuation">.</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token string">"codehole"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                queue<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
            producer<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            consumer<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            consumer<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            consumer<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="1-5-节衣缩食——位图"><a class="header-anchor" href="#1-5-节衣缩食——位图">¶</a>1.5 节衣缩食——位图</h2>
<p>需求问题：在我们平时的开发过程中，会有一些 bool 型数据需要存取，比如用户一年的签到记录，<br>
签了是 1，没签是 0，要记录 365天。如果使用普通的 key/value，每个用户要记录 365 个，<br>
当用户数上亿的时候，需要的存储空间是惊人的。</p>
<p>解决办法：为了解决这个问题，Redis 提供了位图数据结构，这样每天的签到记录只占据一个位，<br>
365 天就是 365 个位，46 个字节（一个稍长一点的字符串）就可以完全容纳下，这就大大节约<br>
了存储空间。位图的最小单位是比特（bit），每个 bit 的取值只能是 0 或 1。</p>
<p>位图不是特殊的数据结构，它的内容其实就是普通的字符串，也就是 byte 数组。我们可以使用普通<br>
的 get/set 直接获取和设置整个位图的内容，也可以使用位图操作getbit/setbit 等将 byte<br>
数组看成“位数组”来处理。</p>
<h3 id="基本用法"><a class="header-anchor" href="#基本用法">¶</a>基本用法</h3>
<p>Redis 的位数组是自动扩展的，如果设置了某个偏移位置超出了现有的内容范围，就会自动将位数组进行<br>
零扩充。</p>
<p>案例：接下来我们使用位操作将字符串设置为 hello,首先我们需要得到 hello 的 ASCII 码，<br>
用Python 命令行可以很方便地得到每个字符的 ASCII码的二进制值。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bin</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'h'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
‘<span class="token number">0b1101000</span>’             <span class="token comment">#高位 -> 低位</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bin</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'e'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
‘<span class="token number">0b1100101</span>’
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bin</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'l'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
‘<span class="token number">0b1101100</span>’
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bin</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'l'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
‘<span class="token number">0b1101100</span>’
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bin</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
‘<span class="token number">0b1101111</span>’<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来我们使用 redis-cli 设置第一个字符，也就是位数组的前 8 位，我们只需要设置值为 1 的位，<br>
h 字符只有 1/2/4 位需要设置，e 字符只有 9/10/13/15 位需要设置。值得注意的是位数组的顺序<br>
和字符的位顺序是相反的</p>
<pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> setbit s <span class="token number">1</span> <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> setbit s <span class="token number">2</span> <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> setbit s <span class="token number">4</span> <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> setbit s <span class="token number">9</span> <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> setbit s <span class="token number">10</span> <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>

<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> setbit s <span class="token number">13</span> <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> setbit s <span class="token number">15</span> <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get s
<span class="token string">"he"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面这个例子可以理解为“零存整取”，同样我们还可以“零存零取”或者“整存零取”。“零存”就是<br>
使用 setbit 对位值进行逐个设置，“整存”就是使用字符串一次性填充所有位数组，覆盖掉旧值。</p>
<p>零存零取<br>
使用单个位操作设置位值，使用单个位操作获取具体位值。</p>
<pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> setbit w <span class="token number">1</span> <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> setbit w <span class="token number">2</span> <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> setbit w <span class="token number">4</span> <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> getbit w <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> getbit w <span class="token number">2</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> getbit w <span class="token number">4</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> getbit w <span class="token number">5</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>整存零取</p>
<pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> w h
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> getbit w <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> getbit w <span class="token number">2</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> getbit w <span class="token number">4</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> getbit w <span class="token number">5</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果对应位的字节是不可打印字符，redis-cli 会显示该字符的十六进制形式。</p>
<pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> setbit x <span class="token number">0</span> <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> setbit x <span class="token number">1</span> <span class="token number">1</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get x
<span class="token string">"<span class="token entity" title="\xc0">\xc0</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="统计和查找"><a class="header-anchor" href="#统计和查找">¶</a>统计和查找</h3>
<p><code>bitcount</code> 用来统计指定位置范围内 1 的个数，<br>
<code>bitpos</code> 用来查找指定范围内出现的第一个 0 或 1。</p>
<pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> w hello
OK
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitcount w
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">21</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitcount w <span class="token number">0</span> <span class="token number">0</span>  <span class="token comment">#第一个字符中1的位数</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitcount w <span class="token number">0</span> <span class="token number">1</span> <span class="token comment">#前两个字符中1的位数</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">7</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitpos w <span class="token number">0</span> <span class="token comment">#第一个0位</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitpos w <span class="token number">1</span> <span class="token comment">#第一个1位</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitpos w <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token comment">#从第二个字符算起，第一个1位</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">9</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitpos w <span class="token number">1</span> <span class="token number">2</span> <span class="token number">2</span> <span class="token comment">#从第三个字符算起，第一个1位</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">17</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="魔术指令-bitfield"><a class="header-anchor" href="#魔术指令-bitfield">¶</a>魔术指令 bitfield</h3>
<p>前文我们设置 （setbit）和获取（getbit）指定位的值都是单个位的，如果要一次操作多个位，<br>
就必须使用管道来处理。不过 Redis 在 3.2 版本以后新增了一个功能强大的指令bitfield，<br>
有了这条指令，不用管道也可以一次进行多个位的操作。</p>
<p>不过 Redis 在 3.2 版本以后新增了一个功能强大的指令bitfield，有了这条指令，不用管道<br>
也可以一次进行多个位的操作。</p>
<p>bitfield 有三个子指令，分别是 get、set、incrby，它们都可以对指定位片段进行读写，但<br>
是最多只能处理 64 个连续的位，如果超过 64 位，就得使用多个子指令， bitfield 可以一次执<br>
行多个子指令。</p>
<pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> w hello
OK
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitfield w get u4 <span class="token number">0</span> <span class="token comment">#从第一个位开始取4个位，结果是无符号数(u)</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitfield w get u3 <span class="token number">2</span>  <span class="token comment">#第三个位开始取3个位，结果是无符号数(u)</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitfield w get i4 <span class="token number">0</span> <span class="token comment">#第一个位开始取4个位，结果是无符号数(i)</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitfield w get u3 <span class="token number">2</span>  <span class="token comment">#第三个位开始取3个位，结果是无符号数(i)</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> -3

<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitfield w get u4 <span class="token number">0</span> get u3 <span class="token number">2</span> get i4 <span class="token number">0</span> get u3 <span class="token number">2</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> -3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后我们使用 set 子指令将第二个字符 e 改成 a，a 的 ASCII码是 97。</p>
<pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bitfield w <span class="token builtin class-name">set</span> u8 <span class="token number">8</span> <span class="token number">97</span> <span class="token comment">#从第9个位开始，将接下来的8个位用无符号数97替换</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">101</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get w
<span class="token string">"hallo"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>再看第三个子指令 incrby，它用来对指定范围的位进行自增操作。既然提到自增，就有可能出现溢出。<br>
如果增加了正数，会出现上溢出，如果增加的是负数，会出现下溢出。Redis 默认的处理是折返。如果出<br>
现了溢出，就将溢出的符号位丢掉。如果是 8 位无符号数 255，加 1 后就会溢出，会全部变零。如果是<br>
8 位有符号数 127，加1 后就会溢出变成-128。</p>
 <pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> w hello
OK
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield w incrby u4 <span class="token number">2</span> <span class="token number">1</span> <span class="token comment">#从第三个位开始，对接下来的4位无符号数+1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">11</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield w incrby u4 <span class="token number">2</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">12</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield w incrby u4 <span class="token number">2</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">13</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield <span class="token number">2</span> incrby u4 <span class="token number">2</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">14</span>

<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield w incrby u4 <span class="token number">2</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">15</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield <span class="token number">2</span> incrby u4 <span class="token number">2</span> <span class="token number">1</span> <span class="token comment">#溢出折返了</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>bitfield 指令提供了溢出策略子指令 overflow，用户可以选择溢出行为，默认是<br>
折返（wrap），还可以选择失败（fail）——报错不执行，以及饱和截断（sat）——超过<br>
了范围就停留在最大或最小值。overflow 指令只影响接下来的第一条指令，这条指令执行完<br>
后溢出策略会变成默认值折返（wrap）。</p>
<p><code>饱和截断（sat）</code></p>
 <pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> w hello
OK
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield w overflow sat incrby u4 <span class="token number">2</span> <span class="token number">1</span> <span class="token comment">#从第三个位开始，对接下来的4位无符号数+1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">11</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield w overflow sat incrby u4 <span class="token number">2</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">12</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield w overflow sat incrby u4 <span class="token number">2</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">13</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield <span class="token number">2</span> overflow sat incrby u4 <span class="token number">2</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">14</span>

<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield w overflow sat incrby u4 <span class="token number">2</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">15</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield <span class="token number">2</span> overflow sat incrby u4 <span class="token number">2</span> <span class="token number">1</span> <span class="token comment">#保持最大值</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">15</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>失败不执行（fail）</code></p>
 <pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> w hello
OK
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield w overflow fail incrby u4 <span class="token number">2</span> <span class="token number">1</span> <span class="token comment">#从第三个位开始，对接下来的4位无符号数+1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">11</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield w overflow fail incrby u4 <span class="token number">2</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">12</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield w overflow fail incrby u4 <span class="token number">2</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">13</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield <span class="token number">2</span> overflow fail incrby u4 <span class="token number">2</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">14</span>

<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield w overflow fail incrby u4 <span class="token number">2</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token number">15</span>
<span class="token number">127.0</span>.0.0:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>bitfield <span class="token number">2</span> overflow fail incrby u4 <span class="token number">2</span> <span class="token number">1</span> <span class="token comment">#不执行</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="1-6-四两拨千斤——HyperLogLog"><a class="header-anchor" href="#1-6-四两拨千斤——HyperLogLog">¶</a>1.6 四两拨千斤——HyperLogLog</h2>
<h3 id="使用方法"><a class="header-anchor" href="#使用方法">¶</a>使用方法</h3>
<p>HyperLogLog 提供了两个指令 <code>pfadd</code> 和 <code>pfcount</code>，根据字面意思很好理解，<br>
一个是增加计数，一个是获取计数。<code>pfadd</code>和 set 集合的 <code>sadd</code> 的用法是一样的，<br>
来一个用户 ID，就将用户 ID 塞进去就是。<code>pfcount</code> 和 <code>scard</code> 的用法是一样的，<br>
直接获取计数值。</p>
<h3 id="pfmerge-适合的场合"><a class="header-anchor" href="#pfmerge-适合的场合">¶</a>pfmerge 适合的场合</h3>
<p>HyperLogLog 除了提供上面的 pfadd 和 pfcount 之外，还提供了第三个指令pfmerge，<br>
用于将多个 pf 计数值累加在一起形成一个新的 pf 值。</p>
<h3 id="注意事项"><a class="header-anchor" href="#注意事项">¶</a>注意事项</h3>
<p>HyperLogLog 这个数据结构不是免费的。这倒不是说使用这个数据结构要花钱，而是因为它需要占据<br>
12KB 的存储空间，所以不适合统计单个用户相关的数据。如果你的用户有上亿个，可以算算，这个空间<br>
成本是非常惊人的。但是相比 set 存储方案， HyperLogLog 所使用的空间那就只能算九牛之一毛了。</p>
<p>不过你也不必过于担心，因为 Redis 对 HyperLogLog 的存储进行了优化，在计数比较小时，它的存储<br>
空间采用稀疏矩阵存储，空间占用很小，仅仅在计数慢慢变大、稀疏矩阵占用空间渐渐超过了阈值时，才会一次<br>
性转变成稠密矩阵，才会占用12KB的空间。</p>
<h2 id="1-10-近水楼台——GeoHash"><a class="header-anchor" href="#1-10-近水楼台——GeoHash">¶</a>1.10 近水楼台——GeoHash</h2>
<p>Redis 在 3.2 版本以后增加了地理位置 Geo 模块，意味着我们可以使用 Redis 来实现类似摩拜单车的<br>
“附近的Mobike”、美团和饿了么的“附近的餐馆”这样的功能了。</p>
<h2 id="1-11-scan"><a class="header-anchor" href="#1-11-scan">¶</a>1.11 scan</h2>
 <pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> redis

client <span class="token operator">=</span> redis<span class="token punctuation">.</span>StrictRedis<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    j <span class="token operator">=</span> <span class="token string">"key"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    client<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>scan 提供了三个参数，第一个是 cursor 整数值，第二个是key 的正则模式，第三个是遍历的 limit hint。<br>
第一次遍历时，cursor 值为 0，然后将返回结果中第一个整数值作为下一次遍历的 cursor，一直遍历到返回的<br>
cursor 值为 0 时结束。</p>
 <pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> scan <span class="token number">0</span>  match key99* count <span class="token number">1000</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"16280"</span>
<span class="token number">2</span><span class="token punctuation">)</span>  <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"key9940"</span>
    <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"key9926"</span>
    <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"key99"</span>
    <span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"key9918"</span>
    <span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"key999"</span>
    <span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">"key9986"</span>
    <span class="token number">7</span><span class="token punctuation">)</span> <span class="token string">"key9974"</span>
    <span class="token number">8</span><span class="token punctuation">)</span> <span class="token string">"key9968"</span>
    <span class="token number">9</span><span class="token punctuation">)</span> <span class="token string">"key9934"</span>
   <span class="token number">10</span><span class="token punctuation">)</span> <span class="token string">"key9969"</span>

<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> scan <span class="token number">16280</span>  match key99* count <span class="token number">1000</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"12108"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"key9936"</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"key9989"</span>
   <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"key995"</span>
   <span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"key9914"</span>
   <span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"key996"</span>

<span class="token punctuation">..</span>.

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面的过程中可以看出，虽然提供的 limit 是 1000，但是返回的结果却只有10 个左右。因为这个 limit 不是限定返回结果的数量，<br>
而是限定服务器单次遍历的字典槽位数量（约等于）。如果将 limit 设置为 10，你会发现返回结果是空的，但是游标值不为零，意味着遍历还没结束。</p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>momo</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://ppxiaodi.gitee.io/2020/12/11/CollectionNote/java/redis/redis%E6%B7%B1%E5%BA%A6%E5%8E%86%E9%99%A9/" title="redis深度历险">https://ppxiaodi.gitee.io/2020/12/11/CollectionNote/java/redis/redis%E6%B7%B1%E5%BA%A6%E5%8E%86%E9%99%A9/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2020/12/11/CollectionNote/java/%E6%97%A5%E5%BF%97/logback%E6%97%A5%E5%BF%97%E4%B8%8EMDC%E6%9C%BA%E5%88%B6/" rel="prev" title="logback日志与MDC机制"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">logback日志与MDC机制</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2020/12/11/CollectionNote/java/%E6%97%B6%E9%97%B4/DateTimeFormat%E5%92%8CJsonFormat/" rel="next" title="DateTimeFormat和JsonFormat"><span class="post-nav-text">DateTimeFormat和JsonFormat</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> momo</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.7.0</span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div id="local-search-result"></div></div></div></body></html>