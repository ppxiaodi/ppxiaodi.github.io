<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="momo"><meta name="copyright" content="momo"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>3系统业务数据仓库 | 我的笔记</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"ppxiaodi.gitee.io","root":"/","title":"momo的小站","version":"1.7.0","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><meta name="description" content="第1章 电商业务与数据结构简介 ¶1.1 电商业务流程  ¶1.2 电商常识（SKU、SPU） SKU&#x3D;Stock Keeping Unit（库存量基本单位）。现在已经被引申为产品统一编号的简称，每种产品均对应有唯一的SKU号。 SPU(Standard Product Unit)：是商品信息聚合的最小单位，是一组可复用、易检索的标准化信息集合。 比如，咱们购买一台iPhoneX手机，iPhone">
<meta property="og:type" content="article">
<meta property="og:title" content="3系统业务数据仓库">
<meta property="og:url" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/index.html">
<meta property="og:site_name" content="我的笔记">
<meta property="og:description" content="第1章 电商业务与数据结构简介 ¶1.1 电商业务流程  ¶1.2 电商常识（SKU、SPU） SKU&#x3D;Stock Keeping Unit（库存量基本单位）。现在已经被引申为产品统一编号的简称，每种产品均对应有唯一的SKU号。 SPU(Standard Product Unit)：是商品信息聚合的最小单位，是一组可复用、易检索的标准化信息集合。 比如，咱们购买一台iPhoneX手机，iPhone">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xV3Ox.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xVX9J.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xZDC4.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xl01O.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xlTBj.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xlj3T.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x1PER.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x1QUI.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x1WZ9.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x1qqH.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x3CQS.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x31eJ.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x3tW6.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x3BeH.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x3Rl8.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x3z79.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/856Pot.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x84gK.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xGWZQ.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xJRl6.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GejcnJ.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GevANq.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GevaKe.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/Gev68f.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GexZdA.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GexJds.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/Gezpwj.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/Gezlfx.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GezbB4.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmDGu9.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmD6HI.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmDXCT.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmrlIP.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmP3LT.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmGUbD.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmGgr8.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/image-20200405222712168.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmJpxx.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmdBex.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/image-20200405222806509.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/Gm0V2Q-1586097028879.png">
<meta property="og:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmBqpD.png">
<meta property="article:published_time" content="2020-12-11T16:00:00.000Z">
<meta property="article:modified_time" content="2021-07-11T08:54:53.504Z">
<meta property="article:author" content="momo">
<meta property="article:tag" content="大数据">
<meta property="article:tag" content="电商数仓">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xV3Ox.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="momo"><img width="96" loading="lazy" src="/yun.png" alt="momo"></a><div class="site-author-name"><a href="/about/">momo</a></div><a class="site-name" href="/about/site.html">我的笔记</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">198</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">58</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">47</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=kZJzggTTCf4SpvEQ8lXWoi5ZjhAx0ILZ&amp;jump_from=webapi" title="QQ 群 1050458482" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YunYouJun" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/jizhideyunyoujun" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/yunyoujun/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/yunyoujun/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/about/white-qrcode-and-search.jpg" title="微信公众号" target="_blank" style="color:#1AAD19"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-2-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/YunYouJun" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@yunyoujun.cn" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.link" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-train-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">第1章 电商业务与数据结构简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E7%94%B5%E5%95%86%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 电商业务流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E7%94%B5%E5%95%86%E5%B8%B8%E8%AF%86%EF%BC%88SKU%E3%80%81SPU%EF%BC%89"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 电商常识（SKU、SPU）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E7%94%B5%E5%95%86%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 电商表结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-%E8%AE%A2%E5%8D%95%E8%A1%A8%EF%BC%88order-info%EF%BC%89"><span class="toc-number">1.3.1.</span> <span class="toc-text">1.3.1 订单表（order_info）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E8%A1%A8%EF%BC%88order-detail%EF%BC%89"><span class="toc-number">1.3.2.</span> <span class="toc-text">1.3.2 订单详情表（order_detail）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-3-%E5%95%86%E5%93%81%E8%A1%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">1.3.3 商品表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-4-%E7%94%A8%E6%88%B7%E8%A1%A8"><span class="toc-number">1.3.4.</span> <span class="toc-text">1.3.4 用户表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-5-%E5%95%86%E5%93%81%E4%B8%80%E7%BA%A7%E5%88%86%E7%B1%BB%E8%A1%A8"><span class="toc-number">1.3.5.</span> <span class="toc-text">1.3.5 商品一级分类表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-6-%E5%95%86%E5%93%81%E4%BA%8C%E7%BA%A7%E5%88%86%E7%B1%BB%E8%A1%A8"><span class="toc-number">1.3.6.</span> <span class="toc-text">1.3.6 商品二级分类表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-7-%E5%95%86%E5%93%81%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB%E8%A1%A8"><span class="toc-number">1.3.7.</span> <span class="toc-text">1.3.7 商品三级分类表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-8-%E6%94%AF%E4%BB%98%E6%B5%81%E6%B0%B4%E8%A1%A8"><span class="toc-number">1.3.8.</span> <span class="toc-text">1.3.8 支付流水表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">第2章 数仓理论（面试重点）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E8%A1%A8%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 表的分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-%E5%AE%9E%E4%BD%93%E8%A1%A8"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 实体表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-%E7%BB%B4%E5%BA%A6%E8%A1%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2 维度表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-%E4%BA%8B%E5%8A%A1%E5%9E%8B%E4%BA%8B%E5%AE%9E%E8%A1%A8"><span class="toc-number">2.1.3.</span> <span class="toc-text">2.1.3 事务型事实表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-4-%E5%91%A8%E6%9C%9F%E5%9E%8B%E4%BA%8B%E5%AE%9E%E8%A1%A8"><span class="toc-number">2.1.4.</span> <span class="toc-text">2.1.4 周期型事实表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%90%8C%E6%AD%A5%E7%AD%96%E7%95%A5"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 同步策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E5%AE%9E%E4%BD%93%E8%A1%A8%E5%90%8C%E6%AD%A5%E7%AD%96%E7%95%A5"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 实体表同步策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E7%BB%B4%E5%BA%A6%E8%A1%A8%E5%90%8C%E6%AD%A5%E7%AD%96%E7%95%A5"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 维度表同步策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-%E4%BA%8B%E5%8A%A1%E5%9E%8B%E4%BA%8B%E5%AE%9E%E8%A1%A8%E5%90%8C%E6%AD%A5%E7%AD%96%E7%95%A5"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3 事务型事实表同步策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-%E5%91%A8%E6%9C%9F%E5%9E%8B%E4%BA%8B%E5%AE%9E%E8%A1%A8%E5%90%8C%E6%AD%A5%E7%AD%96%E7%95%A5"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4 周期型事实表同步策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E8%8C%83%E5%BC%8F%E7%90%86%E8%AE%BA"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 范式理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E8%8C%83%E5%BC%8F%E6%A6%82%E5%BF%B5"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 范式概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-%E5%87%BD%E6%95%B0%E4%BE%9D%E8%B5%96"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2 函数依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-%E4%B8%89%E8%8C%83%E5%BC%8F%E5%8C%BA%E5%88%86"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3 三范式区分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%85%B3%E7%B3%BB%E5%BB%BA%E6%A8%A1%E4%B8%8E%E7%BB%B4%E5%BA%A6%E5%BB%BA%E6%A8%A1"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 关系建模与维度建模</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E9%9B%AA%E8%8A%B1%E6%A8%A1%E5%9E%8B%E3%80%81%E6%98%9F%E5%9E%8B%E6%A8%A1%E5%9E%8B%E5%92%8C%E6%98%9F%E5%BA%A7%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 雪花模型、星型模型和星座模型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">第3章 数仓搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-0-%E9%85%8D%E7%BD%AEHadoop%E6%94%AF%E6%8C%81Snappy%E5%8E%8B%E7%BC%A9"><span class="toc-number">3.1.</span> <span class="toc-text">3.0 配置Hadoop支持Snappy压缩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90"><span class="toc-number">3.2.</span> <span class="toc-text">3.1 业务数据生成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-%E5%BB%BA%E8%A1%A8%E8%AF%AD%E5%8F%A5"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.1.1 建表语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-%E7%94%9F%E6%88%90%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.1.2 生成业务数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%E6%95%B0%E4%BB%93"><span class="toc-number">3.3.</span> <span class="toc-text">3.2 业务数据导入数仓</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-Sqoop%E5%AE%89%E8%A3%85"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.2.1 Sqoop安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-Sqoop%E5%AF%BC%E5%85%A5%E5%91%BD%E4%BB%A4"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.2.2 Sqoop导入命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E5%88%86%E6%9E%90%E8%A1%A8"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.2.3 分析表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-4-Sqoop%E5%AE%9A%E6%97%B6%E5%AF%BC%E5%85%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">3.3.4.</span> <span class="toc-text">3.2.4 Sqoop定时导入脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-5-Sqoop%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">3.3.5.</span> <span class="toc-text">3.2.5 Sqoop导入数据异常处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-ODS%E5%B1%82"><span class="toc-number">3.4.</span> <span class="toc-text">3.3 ODS层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E8%A1%A8"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.3.1 创建订单表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E8%A1%A8"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.3.2 创建订单详情表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-%E5%88%9B%E5%BB%BA%E5%95%86%E5%93%81%E8%A1%A8"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.3.3 创建商品表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-4-%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E8%A1%A8"><span class="toc-number">3.4.4.</span> <span class="toc-text">3.3.4 创建用户表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-5-%E5%88%9B%E5%BB%BA%E5%95%86%E5%93%81%E4%B8%80%E7%BA%A7%E5%88%86%E7%B1%BB%E8%A1%A8"><span class="toc-number">3.4.5.</span> <span class="toc-text">3.3.5 创建商品一级分类表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-6-%E5%88%9B%E5%BB%BA%E5%95%86%E5%93%81%E4%BA%8C%E7%BA%A7%E5%88%86%E7%B1%BB%E8%A1%A8"><span class="toc-number">3.4.6.</span> <span class="toc-text">3.3.6 创建商品二级分类表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-7-%E5%88%9B%E5%BB%BA%E5%95%86%E5%93%81%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB%E8%A1%A8"><span class="toc-number">3.4.7.</span> <span class="toc-text">3.3.7 创建商品三级分类表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-8-%E5%88%9B%E5%BB%BA%E6%94%AF%E4%BB%98%E6%B5%81%E6%B0%B4%E8%A1%A8"><span class="toc-number">3.4.8.</span> <span class="toc-text">3.3.8 创建支付流水表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-9-ODS%E5%B1%82%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">3.4.9.</span> <span class="toc-text">3.3.9 ODS层数据导入脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-DWD%E5%B1%82"><span class="toc-number">3.5.</span> <span class="toc-text">3.4 DWD层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E8%A1%A8"><span class="toc-number">3.5.1.</span> <span class="toc-text">3.4.1 创建订单表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E8%A1%A8"><span class="toc-number">3.5.2.</span> <span class="toc-text">3.4.2 创建订单详情表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E8%A1%A8"><span class="toc-number">3.5.3.</span> <span class="toc-text">3.4.3 创建用户表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4-%E5%88%9B%E5%BB%BA%E6%94%AF%E4%BB%98%E6%B5%81%E6%B0%B4%E8%A1%A8"><span class="toc-number">3.5.4.</span> <span class="toc-text">3.4.4 创建支付流水表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-5-%E5%88%9B%E5%BB%BA%E5%95%86%E5%93%81%E8%A1%A8%EF%BC%88%E5%A2%9E%E5%8A%A0%E5%88%86%E7%B1%BB%EF%BC%89"><span class="toc-number">3.5.5.</span> <span class="toc-text">3.4.5 创建商品表（增加分类）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-6-DWD%E5%B1%82%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">3.5.6.</span> <span class="toc-text">3.4.6 DWD层数据导入脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-%E5%B0%8F%E7%BB%93"><span class="toc-number">3.5.7.</span> <span class="toc-text">3.4.3 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-DWS%E5%B1%82%E4%B9%8B%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E5%AE%BD%E8%A1%A8"><span class="toc-number">3.6.</span> <span class="toc-text">3.5 DWS层之用户行为宽表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E5%AE%BD%E8%A1%A8"><span class="toc-number">3.6.1.</span> <span class="toc-text">3.5.1 创建用户行为宽表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-%E5%90%91%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E5%AE%BD%E8%A1%A8%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">3.6.2.</span> <span class="toc-text">3.5.2 向用户行为宽表导入数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-3-%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E5%AE%BD%E8%A1%A8%E5%AF%BC%E5%85%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">3.6.3.</span> <span class="toc-text">3.5.3 用户行为数据宽表导入脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">第4章 需求一：GMV成交总额</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-ADS%E5%B1%82"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 ADS层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E4%BB%80%E4%B9%88%E6%98%AFGMV"><span class="toc-number">4.1.1.</span> <span class="toc-text">4.1.1 什么是GMV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E5%BB%BA%E8%A1%A8%E8%AF%AD%E5%8F%A5"><span class="toc-number">4.1.2.</span> <span class="toc-text">4.1.2 建表语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5"><span class="toc-number">4.1.3.</span> <span class="toc-text">4.1.3 数据导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-4-%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">4.1.4.</span> <span class="toc-text">4.1.4 数据导入脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">第5章 需求二：转化率之用户新鲜度及漏斗分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E4%BB%80%E4%B9%88%E6%98%AF%E8%BD%AC%E5%8C%96%E7%8E%87"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 什么是转化率</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-ADS%E5%B1%82%E4%B9%8B%E6%96%B0%E5%A2%9E%E7%94%A8%E6%88%B7%E5%8D%A0%E6%97%A5%E6%B4%BB%E8%B7%83%E7%94%A8%E6%88%B7%E6%AF%94%E7%8E%87%EF%BC%88%E7%94%A8%E6%88%B7%E6%96%B0%E9%B2%9C%E5%BA%A6%EF%BC%89"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 ADS层之新增用户占日活跃用户比率（用户新鲜度）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-%E5%BB%BA%E8%A1%A8%E8%AF%AD%E5%8F%A5"><span class="toc-number">5.2.1.</span> <span class="toc-text">5.2.1 建表语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5"><span class="toc-number">5.2.2.</span> <span class="toc-text">5.2.2 数据导入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-ADS%E5%B1%82%E4%B9%8B%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%BC%8F%E6%96%97%E5%88%86%E6%9E%90"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 ADS层之用户行为漏斗分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-%E5%BB%BA%E8%A1%A8%E8%AF%AD%E5%8F%A5"><span class="toc-number">5.3.1.</span> <span class="toc-text">5.3.1 建表语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5"><span class="toc-number">5.3.2.</span> <span class="toc-text">5.3.2 数据导入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">第6章 需求三：品牌复购率</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%A4%8D%E8%B4%AD%E7%8E%87%E8%AE%A1%E7%AE%97%E5%88%86%E6%9E%90"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 复购率计算分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-DWS%E5%B1%82"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 DWS层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-%E7%94%A8%E6%88%B7%E8%B4%AD%E4%B9%B0%E5%95%86%E5%93%81%E6%98%8E%E7%BB%86%E8%A1%A8%EF%BC%88%E5%AE%BD%E8%A1%A8%EF%BC%89"><span class="toc-number">6.2.1.</span> <span class="toc-text">6.2.1 用户购买商品明细表（宽表）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5"><span class="toc-number">6.2.2.</span> <span class="toc-text">6.2.2 数据导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-3-%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">6.2.3.</span> <span class="toc-text">6.2.3 数据导入脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-ADS%E5%B1%82%E5%93%81%E7%89%8C%E5%A4%8D%E8%B4%AD%E7%8E%87"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 ADS层品牌复购率</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-1-%E5%BB%BA%E8%A1%A8%E8%AF%AD%E5%8F%A5"><span class="toc-number">6.3.1.</span> <span class="toc-text">6.3.1 建表语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-2-%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5"><span class="toc-number">6.3.2.</span> <span class="toc-text">6.3.2 数据导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-3-%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">6.3.3.</span> <span class="toc-text">6.3.3 数据导入脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E7%BB%83%E4%B9%A0%EF%BC%9A%E6%B1%82%E6%AF%8F%E4%B8%AA%E7%AD%89%E7%BA%A7%E7%9A%84%E7%94%A8%E6%88%B7%E5%AF%B9%E5%BA%94%E7%9A%84%E5%A4%8D%E8%B4%AD%E7%8E%87%E5%89%8D%E5%8D%81%E7%9A%84%E5%95%86%E5%93%81%E6%8E%92%E8%A1%8C"><span class="toc-number">6.4.</span> <span class="toc-text">6.4 练习：求每个等级的用户对应的复购率前十的商品排行</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">第7章 数据可视化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E5%9C%A8MySQL%E4%B8%AD%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="toc-number">7.1.</span> <span class="toc-text">7.1 在MySQL中创建表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-1-%E6%AF%8F%E6%97%A5%E6%B4%BB%E8%B7%83%E7%BB%9F%E8%AE%A1"><span class="toc-number">7.1.1.</span> <span class="toc-text">7.1.1 每日活跃统计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-2-%E7%95%99%E5%AD%98%E7%8E%87%E7%BB%9F%E8%AE%A1"><span class="toc-number">7.1.2.</span> <span class="toc-text">7.1.2 留存率统计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-3-%E6%BC%8F%E6%96%97%E5%88%86%E6%9E%90"><span class="toc-number">7.1.3.</span> <span class="toc-text">7.1.3 漏斗分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-4-GMV%E7%BB%9F%E8%AE%A1"><span class="toc-number">7.1.4.</span> <span class="toc-text">7.1.4 GMV统计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-5-%E5%85%A8%E5%9B%BD%E5%95%86%E5%93%81%E9%94%80%E5%94%AE"><span class="toc-number">7.1.5.</span> <span class="toc-text">7.1.5 全国商品销售</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-WEB%E9%A1%B5%E9%9D%A2%E6%9F%A5%E7%9C%8B"><span class="toc-number">7.2.</span> <span class="toc-text">7.2 WEB页面查看</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-Sqoop%E5%AF%BC%E5%87%BA%E8%84%9A%E6%9C%AC"><span class="toc-number">7.3.</span> <span class="toc-text">7.3 Sqoop导出脚本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">8.</span> <span class="toc-text">第8章 Azkaban调度器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-Azkaban%E5%AE%89%E8%A3%85"><span class="toc-number">8.1.</span> <span class="toc-text">8.1 Azkaban安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-GMV%E6%8C%87%E6%A0%87%E8%8E%B7%E5%8F%96%E7%9A%84%E5%85%A8%E8%B0%83%E5%BA%A6%E6%B5%81%E7%A8%8B"><span class="toc-number">8.2.</span> <span class="toc-text">8.2 GMV指标获取的全调度流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">9.</span> <span class="toc-text">第9章 订单表拉链表</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%8B%89%E9%93%BE%E8%A1%A8"><span class="toc-number">9.1.</span> <span class="toc-text">9.1 什么是拉链表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%81%9A%E6%8B%89%E9%93%BE%E8%A1%A8"><span class="toc-number">9.2.</span> <span class="toc-text">9.2 为什么要做拉链表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E6%8B%89%E9%93%BE%E8%A1%A8%E5%BD%A2%E6%88%90%E8%BF%87%E7%A8%8B"><span class="toc-number">9.3.</span> <span class="toc-text">9.3 拉链表形成过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4-%E6%8B%89%E9%93%BE%E8%A1%A8%E5%88%B6%E4%BD%9C%E8%BF%87%E7%A8%8B%E5%9B%BE"><span class="toc-number">9.4.</span> <span class="toc-text">9.4 拉链表制作过程图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-5-%E6%8B%89%E9%93%BE%E8%A1%A8%E5%88%B6%E4%BD%9C%E8%BF%87%E7%A8%8B"><span class="toc-number">9.5.</span> <span class="toc-text">9.5 拉链表制作过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-5-1-%E6%AD%A5%E9%AA%A40%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E6%8B%89%E9%93%BE%E8%A1%A8%EF%BC%88%E9%A6%96%E6%AC%A1%E7%8B%AC%E7%AB%8B%E6%89%A7%E8%A1%8C%EF%BC%89"><span class="toc-number">9.5.1.</span> <span class="toc-text">9.5.1 步骤0：初始化拉链表（首次独立执行）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-5-2-%E6%AD%A5%E9%AA%A41%EF%BC%9A%E5%88%B6%E4%BD%9C%E5%BD%93%E6%97%A5%E5%8F%98%E5%8A%A8%E6%95%B0%E6%8D%AE%EF%BC%88%E5%8C%85%E6%8B%AC%E6%96%B0%E5%A2%9E%EF%BC%8C%E4%BF%AE%E6%94%B9%EF%BC%89%E6%AF%8F%E6%97%A5%E6%89%A7%E8%A1%8C"><span class="toc-number">9.5.2.</span> <span class="toc-text">9.5.2 步骤1：制作当日变动数据（包括新增，修改）每日执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-5-3-%E6%AD%A5%E9%AA%A42%EF%BC%9A%E5%85%88%E5%90%88%E5%B9%B6%E5%8F%98%E5%8A%A8%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%86%8D%E8%BF%BD%E5%8A%A0%E6%96%B0%E5%A2%9E%E4%BF%A1%E6%81%AF%EF%BC%8C%E6%8F%92%E5%85%A5%E5%88%B0%E4%B8%B4%E6%97%B6%E8%A1%A8%E4%B8%AD"><span class="toc-number">9.5.3.</span> <span class="toc-text">9.5.3 步骤2：先合并变动信息，再追加新增信息，插入到临时表中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-5-4-%E6%AD%A5%E9%AA%A43%EF%BC%9A%E6%8A%8A%E4%B8%B4%E6%97%B6%E8%A1%A8%E8%A6%86%E7%9B%96%E7%BB%99%E6%8B%89%E9%93%BE%E8%A1%A8"><span class="toc-number">9.5.4.</span> <span class="toc-text">9.5.4 步骤3：把临时表覆盖给拉链表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-5-5-%E6%95%B4%E7%90%86%E4%B8%BA%E6%AF%8F%E6%97%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">9.5.5.</span> <span class="toc-text">9.5.5 整理为每日脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">10.</span> <span class="toc-text">第10章 项目总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-%E7%86%9F%E6%82%898%E5%BC%A0%E8%A1%A8%E7%9A%84%E4%B8%9A%E5%8A%A1%E5%AD%97%E6%AE%B5%EF%BC%8C%E6%AF%8F%E5%BC%A0%E8%A1%A8%E8%AE%B0%E4%BD%8F3-5%E4%B8%AA%E5%AD%97%E6%AE%B5"><span class="toc-number">10.1.</span> <span class="toc-text">10.1 熟悉8张表的业务字段，每张表记住3-5个字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-%E6%95%B0%E4%BB%93%E7%90%86%E8%AE%BA"><span class="toc-number">10.2.</span> <span class="toc-text">10.2 数仓理论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-Sqoop%E5%8F%82%E6%95%B0"><span class="toc-number">10.3.</span> <span class="toc-text">10.3 Sqoop参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-1-Sqoop%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BANull%E5%AD%98%E5%82%A8%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">10.3.1.</span> <span class="toc-text">10.3.1 Sqoop导入导出Null存储一致性问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-2-Sqoop%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">10.3.2.</span> <span class="toc-text">10.3.2 Sqoop数据导出一致性问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-3-Sqoop%E5%BA%95%E5%B1%82%E8%BF%90%E8%A1%8C%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">10.3.3.</span> <span class="toc-text">10.3.3 Sqoop底层运行的任务是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-4-Sqoop%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA%E7%9A%84%E6%97%B6%E5%80%99%E4%B8%80%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%A4%9A%E9%95%BF%E6%97%B6%E9%97%B4"><span class="toc-number">10.3.4.</span> <span class="toc-text">10.3.4 Sqoop数据导出的时候一次执行多长时间</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-4-%E9%9C%80%E6%B1%82%E6%8C%87%E6%A0%87%E5%88%86%E6%9E%90"><span class="toc-number">10.4.</span> <span class="toc-text">10.4 需求指标分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-5-%E6%8B%89%E9%93%BE%E8%A1%A8"><span class="toc-number">10.5.</span> <span class="toc-text">10.5 拉链表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-6-Azkaban"><span class="toc-number">10.6.</span> <span class="toc-text">10.6 Azkaban</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-7-%E9%A1%B9%E7%9B%AE%E4%B8%AD%E8%A1%A8%E5%85%B3%E7%B3%BB"><span class="toc-number">10.7.</span> <span class="toc-text">10.7 项目中表关系</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="momo"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="我的笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">3系统业务数据仓库</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2020-12-12 00:00:00" itemprop="dateCreated datePublished" datetime="2020-12-12T00:00:00+08:00">2020-12-12</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-07-11 16:54:53" itemprop="dateModified" datetime="2021-07-11T16:54:53+08:00">2021-07-11</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">大数据</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">电商数仓</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">大数据</span></a><a class="tag-item" href="/tags/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">电商数仓</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h1>第1章 电商业务与数据结构简介</h1>
<h2 id="1-1-电商业务流程"><a class="header-anchor" href="#1-1-电商业务流程">¶</a>1.1 电商业务流程</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xV3Ox.png" class="" title="8xV3Ox.png" loading="lazy">
<h2 id="1-2-电商常识（SKU、SPU）"><a class="header-anchor" href="#1-2-电商常识（SKU、SPU）">¶</a>1.2 电商常识（SKU、SPU）</h2>
<p>SKU=Stock Keeping Unit（库存量基本单位）。现在已经被引申为产品统一编号的简称，每种产品均对应有唯一的SKU号。</p>
<p>SPU(Standard Product Unit)：是商品信息聚合的最小单位，是一组可复用、易检索的标准化信息集合。</p>
<p>比如，咱们购买一台iPhoneX手机，iPhoneX手机就是一个SPU，但是你购买的时候，不可能是以iPhoneX手机为单位买的，商家也不可能以iPhoneX为单位记录库存SKU。必须要以什么颜色什么版本的iPhoneX为单位。比如，你购买的是一台银色、128G内存的、支持联通网络的iPhoneX，商家也会以这个单位来记录库存数。那这个更细致的单位就叫库存单元（SKU）。</p>
<p>那SPU又是干什么的呢？</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xVX9J.png" class="" title="8xVX9J.png" loading="lazy">
<p>SPU表示一类商品。好处就是：可以共用商品图片，海报、销售属性等。</p>
<h2 id="1-3-电商表结构"><a class="header-anchor" href="#1-3-电商表结构">¶</a>1.3 电商表结构</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xZDC4.png" class="" title="8xZDC4.png" loading="lazy">
<h3 id="1-3-1-订单表（order-info）"><a class="header-anchor" href="#1-3-1-订单表（order-info）">¶</a>1.3.1 订单表（order_info）</h3>
<table>
<thead>
<tr>
<th>标签</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>订单编号</td>
</tr>
<tr>
<td>total_amount</td>
<td>订单金额</td>
</tr>
<tr>
<td>order_status</td>
<td>订单状态</td>
</tr>
<tr>
<td>user_id</td>
<td>用户id</td>
</tr>
<tr>
<td>payment_way</td>
<td>支付方式</td>
</tr>
<tr>
<td>out_trade_no</td>
<td>支付流水号</td>
</tr>
<tr>
<td>create_time</td>
<td>创建时间</td>
</tr>
<tr>
<td>operate_time</td>
<td>操作时间</td>
</tr>
</tbody>
</table>
<h3 id="1-3-2-订单详情表（order-detail）"><a class="header-anchor" href="#1-3-2-订单详情表（order-detail）">¶</a>1.3.2 订单详情表（order_detail）</h3>
<table>
<thead>
<tr>
<th>标签</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>订单编号</td>
</tr>
<tr>
<td>order_id</td>
<td>订单号</td>
</tr>
<tr>
<td>user_id</td>
<td>用户id</td>
</tr>
<tr>
<td>sku_id</td>
<td>商品id</td>
</tr>
<tr>
<td>sku_name</td>
<td>商品名称</td>
</tr>
<tr>
<td>order_price</td>
<td>商品价格</td>
</tr>
<tr>
<td>sku_num</td>
<td>商品数量</td>
</tr>
<tr>
<td>create_time</td>
<td>创建时间</td>
</tr>
</tbody>
</table>
<h3 id="1-3-3-商品表"><a class="header-anchor" href="#1-3-3-商品表">¶</a>1.3.3 商品表</h3>
<table>
<thead>
<tr>
<th>标签</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>skuId</td>
</tr>
<tr>
<td>spu_id</td>
<td>spuid</td>
</tr>
<tr>
<td>price</td>
<td>价格</td>
</tr>
<tr>
<td>sku_name</td>
<td>商品名称</td>
</tr>
<tr>
<td>sku_desc</td>
<td>商品描述</td>
</tr>
<tr>
<td>weight</td>
<td>重量</td>
</tr>
<tr>
<td>tm_id</td>
<td>品牌id</td>
</tr>
<tr>
<td>category3_id</td>
<td>品类id</td>
</tr>
<tr>
<td>create_time</td>
<td>创建时间</td>
</tr>
</tbody>
</table>
<h3 id="1-3-4-用户表"><a class="header-anchor" href="#1-3-4-用户表">¶</a>1.3.4 用户表</h3>
<table>
<thead>
<tr>
<th>标签</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>用户id</td>
</tr>
<tr>
<td>name</td>
<td>姓名</td>
</tr>
<tr>
<td>birthday</td>
<td>生日</td>
</tr>
<tr>
<td>gender</td>
<td>性别</td>
</tr>
<tr>
<td>email</td>
<td>邮箱</td>
</tr>
<tr>
<td>user_level</td>
<td>用户等级</td>
</tr>
<tr>
<td>create_time</td>
<td>创建时间</td>
</tr>
</tbody>
</table>
<h3 id="1-3-5-商品一级分类表"><a class="header-anchor" href="#1-3-5-商品一级分类表">¶</a>1.3.5 商品一级分类表</h3>
<table>
<thead>
<tr>
<th>标签</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>id</td>
</tr>
<tr>
<td>name</td>
<td>名称</td>
</tr>
</tbody>
</table>
<h3 id="1-3-6-商品二级分类表"><a class="header-anchor" href="#1-3-6-商品二级分类表">¶</a>1.3.6 商品二级分类表</h3>
<table>
<thead>
<tr>
<th>标签</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>id</td>
</tr>
<tr>
<td>name</td>
<td>名称</td>
</tr>
<tr>
<td>category1_id</td>
<td>一级品类id</td>
</tr>
</tbody>
</table>
<h3 id="1-3-7-商品三级分类表"><a class="header-anchor" href="#1-3-7-商品三级分类表">¶</a>1.3.7 商品三级分类表</h3>
<table>
<thead>
<tr>
<th>标签</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>id</td>
</tr>
<tr>
<td>name</td>
<td>名称</td>
</tr>
<tr>
<td>Category2_id</td>
<td>二级品类id</td>
</tr>
</tbody>
</table>
<h3 id="1-3-8-支付流水表"><a class="header-anchor" href="#1-3-8-支付流水表">¶</a>1.3.8 支付流水表</h3>
<table>
<thead>
<tr>
<th>标签</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>编号</td>
</tr>
<tr>
<td>out_trade_no</td>
<td>对外业务编号</td>
</tr>
<tr>
<td>order_id</td>
<td>订单编号</td>
</tr>
<tr>
<td>user_id</td>
<td>用户编号</td>
</tr>
<tr>
<td>alipay_trade_no</td>
<td>支付宝交易流水编号</td>
</tr>
<tr>
<td>total_amount</td>
<td>支付金额</td>
</tr>
<tr>
<td>subject</td>
<td>交易内容</td>
</tr>
<tr>
<td>payment_type</td>
<td>支付类型</td>
</tr>
<tr>
<td>payment_time</td>
<td>支付时间</td>
</tr>
</tbody>
</table>
<h1>第2章 数仓理论（面试重点）</h1>
<h2 id="2-1-表的分类"><a class="header-anchor" href="#2-1-表的分类">¶</a>2.1 表的分类</h2>
<h3 id="2-1-1-实体表"><a class="header-anchor" href="#2-1-1-实体表">¶</a>2.1.1 实体表</h3>
<p><strong>实体表</strong>，一般是指一个现实存在的业务对象，比如用户，商品，商家，销售员等等。</p>
<p>用户表：</p>
<table>
<thead>
<tr>
<th>用户id</th>
<th>姓名</th>
<th>生日</th>
<th>性别</th>
<th>邮箱</th>
<th>用户等级</th>
<th>创建时间</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>张三</td>
<td>2011-11-11</td>
<td>男</td>
<td><a href="mailto:zs@163.com">zs@163.com</a></td>
<td>2</td>
<td>2018-11-11</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>2011-11-11</td>
<td>女</td>
<td><a href="mailto:ls@163.com">ls@163.com</a></td>
<td>3</td>
<td>2018-11-11</td>
</tr>
<tr>
<td>3</td>
<td>王五</td>
<td>2011-11-11</td>
<td>中性</td>
<td><a href="mailto:ww@163.com">ww@163.com</a></td>
<td>1</td>
<td>2018-11-11</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<h3 id="2-1-2-维度表"><a class="header-anchor" href="#2-1-2-维度表">¶</a>2.1.2 维度表</h3>
<p><strong>维度表</strong>，一般是指对应一些业务状态，编号的解释表。也可以称之为码表。</p>
<p>比如地区表，订单状态，支付方式，审批状态，商品分类等等。</p>
<p>订单状态表：</p>
<table>
<thead>
<tr>
<th>订单状态编号</th>
<th>订单状态名称</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>未支付</td>
</tr>
<tr>
<td>2</td>
<td>支付</td>
</tr>
<tr>
<td>3</td>
<td>发货中</td>
</tr>
<tr>
<td>4</td>
<td>已发货</td>
</tr>
<tr>
<td>5</td>
<td>已完成</td>
</tr>
</tbody>
</table>
<p>商品分类表：</p>
<table>
<thead>
<tr>
<th>商品分类编号</th>
<th>分类名称</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>服装</td>
</tr>
<tr>
<td>2</td>
<td>保健</td>
</tr>
<tr>
<td>3</td>
<td>电器</td>
</tr>
<tr>
<td>4</td>
<td>图书</td>
</tr>
</tbody>
</table>
<h3 id="2-1-3-事务型事实表"><a class="header-anchor" href="#2-1-3-事务型事实表">¶</a>2.1.3 事务型事实表</h3>
<p><strong>事务型事实表</strong>，一般指随着业务发生不断产生的数据。特点是一旦发生不会再变化。</p>
<p>一般比如，交易流水，操作日志，出库入库记录等等。</p>
<p>交易流水表：</p>
<table>
<thead>
<tr>
<th>编号</th>
<th>对外业务编号</th>
<th>订单编号</th>
<th>用户编号</th>
<th>支付宝交易流水编号</th>
<th>支付金额</th>
<th>交易内容</th>
<th>支付类型</th>
<th>支付时间</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>7577697945</td>
<td>1</td>
<td>111</td>
<td>QEyF-63000323</td>
<td>223.00</td>
<td>海狗人参丸1</td>
<td>alipay</td>
<td>2019-02-10 00:50:02</td>
</tr>
<tr>
<td>2</td>
<td>0170099522</td>
<td>2</td>
<td>222</td>
<td>qdwV-25111279</td>
<td>589.00</td>
<td>海狗人参丸2</td>
<td>wechatpay</td>
<td>2019-02-10 00:50:02</td>
</tr>
<tr>
<td>3</td>
<td>1840931679</td>
<td>3</td>
<td>666</td>
<td>hSUS-65716585</td>
<td>485.00</td>
<td>海狗人参丸3</td>
<td>unionpay</td>
<td>2019-02-10 00:50:02</td>
</tr>
<tr>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
</tr>
</tbody>
</table>
<h3 id="2-1-4-周期型事实表"><a class="header-anchor" href="#2-1-4-周期型事实表">¶</a>2.1.4 周期型事实表</h3>
<p><strong>周期型事实表</strong>，一般指随着业务发生不断产生的数据。</p>
<p>与事务型不同的是，数据会随着业务周期性的推进而变化。</p>
<p>比如订单，其中订单状态会周期性变化。再比如，请假、贷款申请，随着批复状态在周期性变化。</p>
<p>订单表：</p>
<table>
<thead>
<tr>
<th>订单编号</th>
<th>订单金额</th>
<th>订单状态</th>
<th>用户id</th>
<th>支付方式</th>
<th>支付流水号</th>
<th>创建时间</th>
<th>操作时间</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>223.00</td>
<td>2</td>
<td>111</td>
<td>alipay</td>
<td>QEyF-63000323</td>
<td>2019-02-10 00:01:29</td>
<td>2019-02-10 00:01:29</td>
</tr>
<tr>
<td>2</td>
<td>589.00</td>
<td>2</td>
<td>222</td>
<td>wechatpay</td>
<td>qdwV-25111279</td>
<td>2019-02-10 00:05:02</td>
<td>2019-02-10 00:05:02</td>
</tr>
<tr>
<td>3</td>
<td>485.00</td>
<td>1</td>
<td>666</td>
<td>unionpay</td>
<td>hSUS-65716585</td>
<td>2019-02-10 00:50:02</td>
<td>2019-02-10 00:50:02</td>
</tr>
<tr>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
</tr>
</tbody>
</table>
<h2 id="2-2-同步策略"><a class="header-anchor" href="#2-2-同步策略">¶</a>2.2 同步策略</h2>
<p>数据同步策略的类型包括：全量表、增量表、新增及变化表、拉链表</p>
<ul>
<li>
<p>全量表：存储完整的数据。</p>
</li>
<li>
<p>增量表：存储新增加的数据。</p>
</li>
<li>
<p>新增及变化表：存储新增加的数据和变化的数据。</p>
</li>
<li>
<p>拉链表：对新增及变化表做定期合并。</p>
</li>
</ul>
<h3 id="2-2-1-实体表同步策略"><a class="header-anchor" href="#2-2-1-实体表同步策略">¶</a>2.2.1 实体表同步策略</h3>
<p>实体表：比如用户，商品，商家，销售员等</p>
<p>实体表数据量比较小：通常可以做每日全量，就是每天存一份完整数据。即每日全量。</p>
<h3 id="2-2-2-维度表同步策略"><a class="header-anchor" href="#2-2-2-维度表同步策略">¶</a>2.2.2 维度表同步策略</h3>
<p>维度表：比如订单状态，审批状态，商品分类</p>
<p>维度表数据量比较小：通常可以做每日全量，就是每天存一份完整数据。即每日全量。</p>
<p>说明：</p>
<p>1）针对可能会有变化的状态数据可以存储每日全量。</p>
<p>2）没变化的客观世界的维度（比如性别，地区，民族，政治成分，鞋子尺码）可以只存一份固定值。</p>
<h3 id="2-2-3-事务型事实表同步策略"><a class="header-anchor" href="#2-2-3-事务型事实表同步策略">¶</a>2.2.3 事务型事实表同步策略</h3>
<p>事务型事实表：比如，交易流水，操作日志，出库入库记录等。</p>
<p>因为数据不会变化，而且数据量巨大，所以每天只同步新增数据即可，所以可以做成每日增量表，即每日创建一个分区存储。</p>
<h3 id="2-2-4-周期型事实表同步策略"><a class="header-anchor" href="#2-2-4-周期型事实表同步策略">¶</a>2.2.4 周期型事实表同步策略</h3>
<p>周期型事实表：比如，订单、请假、贷款申请等</p>
<p>这类表从数据量的角度，存每日全量的话，数据量太大，冗余也太大。如果用每日增量的话无法反应数据变化。</p>
<p>每日新增及变化量，包括了当日的新增和修改。一般来说这个表，足够计算大部分当日数据的。但是这种依然无法解决能够得到某一个历史时间点（时间切片）的切片数据。</p>
<p>所以要用利用每日新增和变化表，制作一张拉链表，以方便的取到某个时间切片的快照数据。所以我们需要得到每日新增及变化量。</p>
<p>拉链表：</p>
<table>
<thead>
<tr>
<th>name姓名</th>
<th>start新名字创建时间</th>
<th>end名字更改时间</th>
</tr>
</thead>
<tbody>
<tr>
<td>张三</td>
<td>1990/1/1</td>
<td>2018/12/31</td>
</tr>
<tr>
<td>张小三</td>
<td>2019/1/1</td>
<td>2019/4/30</td>
</tr>
<tr>
<td>张大三</td>
<td>2019/5/1</td>
<td>9999-99-99</td>
</tr>
<tr>
<td>。。。</td>
<td>。。。</td>
<td>。。。</td>
</tr>
</tbody>
</table>
<pre class="line-numbers language-none"><code class="language-none">select * from user where start &#x3D;&lt;’2019-1-2’ and end&gt;&#x3D;’2019-1-2’<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="2-3-范式理论"><a class="header-anchor" href="#2-3-范式理论">¶</a>2.3 范式理论</h2>
<h3 id="2-3-1-范式概念"><a class="header-anchor" href="#2-3-1-范式概念">¶</a>2.3.1 范式概念</h3>
<p>关系型数据库设计时，遵照一定的规范要求，目的在于降低数据的冗余性，目前业界范式有：第一范式(1NF)、第二范式(2NF)、第三范式(3NF)、巴斯-科德范式(BCNF)、第四范式(4NF)、第五范式(5NF)。</p>
<p>范式可以理解为设计一张数据表的表结构，符合的标准级别。</p>
<p>使用范式的根本目的是：</p>
<p>1）减少数据冗余，尽量让每个数据只出现一次。</p>
<p>2）保证数据一致性</p>
<p>缺点是获取数据时，需要通过Join拼接出最后的数据。</p>
<h3 id="2-3-2-函数依赖"><a class="header-anchor" href="#2-3-2-函数依赖">¶</a>2.3.2 函数依赖</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xl01O.png" class="" title="8xl01O.png" loading="lazy">
<h3 id="2-3-3-三范式区分"><a class="header-anchor" href="#2-3-3-三范式区分">¶</a>2.3.3 三范式区分</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xlTBj.png" class="" title="8xlTBj.png" loading="lazy">
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xlj3T.png" class="" title="8xlj3T.png" loading="lazy">
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x1PER.png" class="" title="8x1PER.png" loading="lazy">
<h2 id="2-4-关系建模与维度建模"><a class="header-anchor" href="#2-4-关系建模与维度建模">¶</a>2.4 关系建模与维度建模</h2>
<ul>
<li>关系模型</li>
</ul>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x1QUI.png" class="" title="8x1QUI.png" loading="lazy">
<p>关系模型主要应用与OLTP系统中，为了保证数据的一致性以及避免冗余，所以大部分业务系统的表都是遵循第三范式的。</p>
<ul>
<li>维度模型</li>
</ul>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x1WZ9.png" class="" title="8x1WZ9.png" loading="lazy">
<p>维度模型主要应用于OLAP系统中，因为关系模型虽然冗余少，但是在大规模数据，跨表分析统计查询过程中，会造成多表关联，这会大大降低执行效率。</p>
<p>所以把相关各种表整理成两种：事实表和维度表两种。所有维度表围绕着事实表进行解释。</p>
<h2 id="2-5-雪花模型、星型模型和星座模型"><a class="header-anchor" href="#2-5-雪花模型、星型模型和星座模型">¶</a>2.5 雪花模型、星型模型和星座模型</h2>
<p>在维度建模的基础上又分为三种模型：星型模型、雪花模型、星座模型。</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x1qqH.png" class="" title="8x1qqH.png" loading="lazy">
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x3CQS.png" class="" title="8x3CQS.png" loading="lazy">
<h1>第3章 数仓搭建</h1>
<h2 id="3-0-配置Hadoop支持Snappy压缩"><a class="header-anchor" href="#3-0-配置Hadoop支持Snappy压缩">¶</a>3.0 配置Hadoop支持Snappy压缩</h2>
<p>1）将编译后支持Snappy压缩的Hadoop jar包解压缩，并将lib/native目录中所有文件上传到hadoop102的/opt/module/hadoop-2.7.2/lib/native目录，并分发到hadoop103<br>
hadoop104。</p>
<p>2）重新启动Hadoop。</p>
<p>3）检查支持的压缩方式</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 native]$ hadoop checknative
hadoop:  true &#x2F;opt&#x2F;module&#x2F;hadoop-2.7.2&#x2F;lib&#x2F;native&#x2F;libhadoop.so
zlib:    true &#x2F;lib64&#x2F;libz.so.1
snappy:  true &#x2F;opt&#x2F;module&#x2F;hadoop-2.7.2&#x2F;lib&#x2F;native&#x2F;libsnappy.so.1
lz4:     true revision:99
bzip2:   false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-1-业务数据生成"><a class="header-anchor" href="#3-1-业务数据生成">¶</a>3.1 业务数据生成</h2>
<h3 id="3-1-1-建表语句"><a class="header-anchor" href="#3-1-1-建表语句">¶</a>3.1.1 建表语句</h3>
<p>1）通过SQLyog创建数据库gmall</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x31eJ.png" class="" title="8x31eJ.png" loading="lazy">
<p>2）设置数据库编码</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x3tW6.png" class="" title="8x3tW6.png" loading="lazy">
<p>3）导入建表语句（1建表脚本）</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x3BeH.png" class="" title="8x3BeH.png" loading="lazy">
<p>选择-&gt;1建表脚本.sql</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x3Rl8.png" class="" title="8x3Rl8.png" loading="lazy">
<p>4）重复步骤3的导入方式，依次导入：2商品分类数据插入脚本、3函数脚本、4存储过程脚本。</p>
<h3 id="3-1-2-生成业务数据"><a class="header-anchor" href="#3-1-2-生成业务数据">¶</a>3.1.2 生成业务数据</h3>
<p>1）生成业务数据函数说明</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">init_data <span class="token punctuation">(</span> do_date_string <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> order_incr_num <span class="token keyword">INT</span><span class="token punctuation">,</span> user_incr_num <span class="token keyword">INT</span> <span class="token punctuation">,</span> sku_num <span class="token keyword">INT</span> <span class="token punctuation">,</span> if_truncate <span class="token keyword">BOOLEAN</span>  <span class="token punctuation">)</span>：<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>参数一：do_date_string生成数据日期</p>
<p>参数二：order_incr_num订单id个数</p>
<p>参数三：user_incr_num用户id个数</p>
<p>参数四：sku_num商品sku个数</p>
<p>参数五：if_truncate是否删除数据</p>
<p>2）案例测试：</p>
<p>（1）需求：生成日期2019年2月10日数据、订单1000个、用户200个、商品sku300个、删除原始数据。</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x3z79.png" class="" title="8x3z79.png" loading="lazy">
<pre class="line-numbers language-none"><code class="language-none">CALL init_data(&#39;2019-02-10&#39;,1000,200,300,TRUE);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（2）查询生成数据结果</p>
<pre class="line-numbers language-none"><code class="language-none">SELECT * from base_category1;
SELECT * from base_category2;
SELECT * from base_category3;

SELECT * from order_info;
SELECT * from order_detail;

SELECT * from sku_info;
SELECT * from user_info;

SELECT * from payment_info;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-2-业务数据导入数仓"><a class="header-anchor" href="#3-2-业务数据导入数仓">¶</a>3.2 业务数据导入数仓</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/856Pot.png" class="" title="856Pot.png" loading="lazy">
<h3 id="3-2-1-Sqoop安装"><a class="header-anchor" href="#3-2-1-Sqoop安装">¶</a>3.2.1 Sqoop安装</h3>
<p>详见尚硅谷大数据技术之Sqoop</p>
<h3 id="3-2-2-Sqoop导入命令"><a class="header-anchor" href="#3-2-2-Sqoop导入命令">¶</a>3.2.2 Sqoop导入命令</h3>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;opt&#x2F;module&#x2F;sqoop&#x2F;bin&#x2F;sqoop import \
--connect \
--username \
--password \
--target-dir \
--delete-target-dir \
--num-mappers \
--fields-terminated-by \
--query &quot;$2&quot; &#39; and $CONDITIONS;&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-2-3-分析表"><a class="header-anchor" href="#3-2-3-分析表">¶</a>3.2.3 分析表</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8x84gK.png" class="" title="8x84gK.png" loading="lazy">
<h3 id="3-2-4-Sqoop定时导入脚本"><a class="header-anchor" href="#3-2-4-Sqoop定时导入脚本">¶</a>3.2.4 Sqoop定时导入脚本</h3>
<p>1）在/home/atguigu/bin目录下创建脚本sqoop_import.sh</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ vim sqoop_import.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中填写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

db_date&#x3D;$2
echo $db_date
db_name&#x3D;gmall

import_data() &#123;
&#x2F;opt&#x2F;module&#x2F;sqoop&#x2F;bin&#x2F;sqoop import \
--connect jdbc:mysql:&#x2F;&#x2F;hadoop102:3306&#x2F;$db_name \
--username root \
--password 000000 \
--target-dir &#x2F;origin_data&#x2F;$db_name&#x2F;db&#x2F;$1&#x2F;$db_date \
--delete-target-dir \
--num-mappers 1 \
--fields-terminated-by &quot;\t&quot; \
--query &quot;$2&quot;&#39; and $CONDITIONS;&#39;
&#125;

import_sku_info()&#123;
  import_data &quot;sku_info&quot; &quot;select 
id, spu_id, price, sku_name, sku_desc, weight, tm_id,
category3_id, create_time
  from sku_info where 1&#x3D;1&quot;
&#125;

import_user_info()&#123;
  import_data &quot;user_info&quot; &quot;select 
id, name, birthday, gender, email, user_level, 
create_time 
from user_info where 1&#x3D;1&quot;
&#125;

import_base_category1()&#123;
  import_data &quot;base_category1&quot; &quot;select 
id, name from base_category1 where 1&#x3D;1&quot;
&#125;

import_base_category2()&#123;
  import_data &quot;base_category2&quot; &quot;select 
id, name, category1_id from base_category2 where 1&#x3D;1&quot;
&#125;

import_base_category3()&#123;
  import_data &quot;base_category3&quot; &quot;select id, name, category2_id from base_category3 where 1&#x3D;1&quot;
&#125;

import_order_detail()&#123;
  import_data   &quot;order_detail&quot;   &quot;select 
    od.id, 
    order_id, 
    user_id, 
    sku_id, 
    sku_name, 
    order_price, 
    sku_num, 
    o.create_time  
  from order_info o, order_detail od
  where o.id&#x3D;od.order_id
  and DATE_FORMAT(create_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;&quot;
&#125;

import_payment_info()&#123;
  import_data &quot;payment_info&quot;   &quot;select 
    id,  
    out_trade_no, 
    order_id, 
    user_id, 
    alipay_trade_no, 
    total_amount,  
    subject, 
    payment_type, 
    payment_time 
  from payment_info 
  where DATE_FORMAT(payment_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;&quot;
&#125;

import_order_info()&#123;
  import_data   &quot;order_info&quot;   &quot;select 
    id, 
    total_amount, 
    order_status, 
    user_id, 
    payment_way, 
    out_trade_no, 
    create_time, 
    operate_time  
  from order_info 
  where (DATE_FORMAT(create_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39; or DATE_FORMAT(operate_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;)&quot;
&#125;

case $1 in
  &quot;base_category1&quot;)
     import_base_category1
;;
  &quot;base_category2&quot;)
     import_base_category2
;;
  &quot;base_category3&quot;)
     import_base_category3
;;
  &quot;order_info&quot;)
     import_order_info
;;
  &quot;order_detail&quot;)
     import_order_detail
;;
  &quot;sku_info&quot;)
     import_sku_info
;;
  &quot;user_info&quot;)
     import_user_info
;;
  &quot;payment_info&quot;)
     import_payment_info
;;
   &quot;all&quot;)
   import_base_category1
   import_base_category2
   import_base_category3
   import_order_info
   import_order_detail
   import_sku_info
   import_user_info
   import_payment_info
;;
esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ chmod 777 sqoop_import.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）执行脚本导入数据</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ sqoop_import.sh all 2019-02-10<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）在SQLyog中生成2019年2月11日数据</p>
<pre class="line-numbers language-none"><code class="language-none">CALL init_data(&#39;2019-02-11&#39;,1000,200,300,TRUE);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>5）执行脚本导入数据</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ sqoop_import.sh all 2019-02-11<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="3-2-5-Sqoop导入数据异常处理"><a class="header-anchor" href="#3-2-5-Sqoop导入数据异常处理">¶</a>3.2.5 Sqoop导入数据异常处理</h3>
<p>1）问题描述：执行Sqoop导入数据脚本时，发生如下异常</p>
<pre class="line-numbers language-none"><code class="language-none">java.sql.SQLException: Streaming result set com.mysql.jdbc.RowDataDynamic@65d6b83b is still active. No statements may be issued when any streaming result sets are open and in use on a given connection. Ensure that you have called .close() on any active streaming result sets before attempting more queries.
	at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:930)
	at com.mysql.jdbc.MysqlIO.checkForOutstandingStreamingData(MysqlIO.java:2646)
	at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:1861)
	at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2101)
	at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2548)
	at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2477)
	at com.mysql.jdbc.StatementImpl.executeQuery(StatementImpl.java:1422)
	at com.mysql.jdbc.ConnectionImpl.getMaxBytesPerChar(ConnectionImpl.java:2945)
	at com.mysql.jdbc.Field.getMaxBytesPerCharacter(Field.java:582)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）问题解决方案：增加如下导入参数</p>
<pre class="line-numbers language-none"><code class="language-none">--driver com.mysql.jdbc.Driver \<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="3-3-ODS层"><a class="header-anchor" href="#3-3-ODS层">¶</a>3.3 ODS层</h2>
<p>完全仿照业务数据库中的表字段，一模一样的创建ODS层对应表。</p>
<h3 id="3-3-1-创建订单表"><a class="header-anchor" href="#3-3-1-创建订单表">¶</a>3.3.1 创建订单表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists ods_order_info;
create external table ods_order_info (
&#96;id&#96; string COMMENT &#39;订单编号&#39;,
&#96;total_amount&#96; decimal(10,2) COMMENT &#39;订单金额&#39;,
&#96;order_status&#96; string COMMENT &#39;订单状态&#39;,
&#96;user_id&#96; string COMMENT &#39;用户id&#39;,
&#96;payment_way&#96; string COMMENT &#39;支付方式&#39;,
&#96;out_trade_no&#96; string COMMENT &#39;支付流水号&#39;,
&#96;create_time&#96; string COMMENT &#39;创建时间&#39;,
&#96;operate_time&#96; string COMMENT &#39;操作时间&#39;
) COMMENT &#39;订单表&#39;
PARTITIONED BY (&#96;dt&#96; string)
row format delimited fields terminated by &#39;\t&#39;
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;ods&#x2F;ods_order_info&#x2F;&#39;
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-3-2-创建订单详情表"><a class="header-anchor" href="#3-3-2-创建订单详情表">¶</a>3.3.2 创建订单详情表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists ods_order_detail;
create external table ods_order_detail( 
&#96;id&#96; string COMMENT &#39;订单编号&#39;,
&#96;order_id&#96; string  COMMENT &#39;订单号&#39;, 
&#96;user_id&#96; string COMMENT &#39;用户id&#39;,
&#96;sku_id&#96; string COMMENT &#39;商品id&#39;,
&#96;sku_name&#96; string COMMENT &#39;商品名称&#39;,
&#96;order_price&#96; string COMMENT &#39;商品价格&#39;,
&#96;sku_num&#96; string COMMENT &#39;商品数量&#39;,
&#96;create_time&#96; string COMMENT &#39;创建时间&#39;
) COMMENT &#39;订单明细表&#39;
PARTITIONED BY (&#96;dt&#96; string)
row format delimited fields terminated by &#39;\t&#39; 
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;ods&#x2F;ods_order_detail&#x2F;&#39;
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-3-3-创建商品表"><a class="header-anchor" href="#3-3-3-创建商品表">¶</a>3.3.3 创建商品表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists ods_sku_info;
create external table ods_sku_info( 
&#96;id&#96; string COMMENT &#39;skuId&#39;,
&#96;spu_id&#96; string COMMENT &#39;spuid&#39;, 
&#96;price&#96; decimal(10,2) COMMENT &#39;价格&#39;,
&#96;sku_name&#96; string COMMENT &#39;商品名称&#39;,
&#96;sku_desc&#96; string COMMENT &#39;商品描述&#39;,
&#96;weight&#96; string COMMENT &#39;重量&#39;,
&#96;tm_id&#96; string COMMENT &#39;品牌id&#39;,
&#96;category3_id&#96; string COMMENT &#39;品类id&#39;,
&#96;create_time&#96; string COMMENT &#39;创建时间&#39;
) COMMENT &#39;商品表&#39;
PARTITIONED BY (&#96;dt&#96; string)
row format delimited fields terminated by &#39;\t&#39;
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;ods&#x2F;ods_sku_info&#x2F;&#39;
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-3-4-创建用户表"><a class="header-anchor" href="#3-3-4-创建用户表">¶</a>3.3.4 创建用户表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists ods_user_info;
create external table ods_user_info( 
&#96;id&#96; string COMMENT &#39;用户id&#39;,
&#96;name&#96;  string COMMENT &#39;姓名&#39;,
&#96;birthday&#96; string COMMENT &#39;生日&#39;,
&#96;gender&#96; string COMMENT &#39;性别&#39;,
&#96;email&#96; string COMMENT &#39;邮箱&#39;,
&#96;user_level&#96; string COMMENT &#39;用户等级&#39;,
&#96;create_time&#96; string COMMENT &#39;创建时间&#39;
) COMMENT &#39;用户信息&#39;
PARTITIONED BY (&#96;dt&#96; string)
row format delimited fields terminated by &#39;\t&#39;
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;ods&#x2F;ods_user_info&#x2F;&#39;
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-3-5-创建商品一级分类表"><a class="header-anchor" href="#3-3-5-创建商品一级分类表">¶</a>3.3.5 创建商品一级分类表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists ods_base_category1;
create external table ods_base_category1( 
&#96;id&#96; string COMMENT &#39;id&#39;,
&#96;name&#96;  string COMMENT &#39;名称&#39;
) COMMENT &#39;商品一级分类&#39;
PARTITIONED BY (&#96;dt&#96; string)
row format delimited fields terminated by &#39;\t&#39;
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;ods&#x2F;ods_base_category1&#x2F;&#39;
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-3-6-创建商品二级分类表"><a class="header-anchor" href="#3-3-6-创建商品二级分类表">¶</a>3.3.6 创建商品二级分类表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists ods_base_category2;
create external table ods_base_category2( 
&#96;id&#96; string COMMENT &#39; id&#39;,
&#96;name&#96; string COMMENT &#39;名称&#39;,
category1_id string COMMENT &#39;一级品类id&#39;
) COMMENT &#39;商品二级分类&#39;
PARTITIONED BY (&#96;dt&#96; string)
row format delimited fields terminated by &#39;\t&#39;
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;ods&#x2F;ods_base_category2&#x2F;&#39;
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-3-7-创建商品三级分类表"><a class="header-anchor" href="#3-3-7-创建商品三级分类表">¶</a>3.3.7 创建商品三级分类表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists ods_base_category3;
create external table ods_base_category3(
&#96;id&#96; string COMMENT &#39; id&#39;,
&#96;name&#96;  string COMMENT &#39;名称&#39;,
category2_id string COMMENT &#39;二级品类id&#39;
) COMMENT &#39;商品三级分类&#39;
PARTITIONED BY (&#96;dt&#96; string)
row format delimited fields terminated by &#39;\t&#39;
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;ods&#x2F;ods_base_category3&#x2F;&#39;
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-3-8-创建支付流水表"><a class="header-anchor" href="#3-3-8-创建支付流水表">¶</a>3.3.8 创建支付流水表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists ods_payment_info;
create external table ods_payment_info(
&#96;id&#96; bigint COMMENT &#39;编号&#39;,
&#96;out_trade_no&#96; string COMMENT &#39;对外业务编号&#39;,
&#96;order_id&#96; string COMMENT &#39;订单编号&#39;,
&#96;user_id&#96; string COMMENT &#39;用户编号&#39;,
&#96;alipay_trade_no&#96; string COMMENT &#39;支付宝交易流水编号&#39;,
&#96;total_amount&#96; decimal(16,2) COMMENT &#39;支付金额&#39;,
&#96;subject&#96; string COMMENT &#39;交易内容&#39;,
&#96;payment_type&#96; string COMMENT &#39;支付类型&#39;,
&#96;payment_time&#96; string COMMENT &#39;支付时间&#39;
)  COMMENT &#39;支付流水表&#39;
PARTITIONED BY (&#96;dt&#96; string)
row format delimited fields terminated by &#39;\t&#39;
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;ods&#x2F;ods_payment_info&#x2F;&#39;
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-3-9-ODS层数据导入脚本"><a class="header-anchor" href="#3-3-9-ODS层数据导入脚本">¶</a>3.3.9 ODS层数据导入脚本</h3>
<p>1）在/home/atguigu/bin目录下创建脚本ods_db.sh</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ vim ods_db.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中填写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

   APP&#x3D;gmall
   hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天
if [ -n &quot;$1&quot; ] ;then
	do_date&#x3D;$1
else 
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;
fi

sql&#x3D;&quot; 
load data inpath &#39;&#x2F;origin_data&#x2F;$APP&#x2F;db&#x2F;order_info&#x2F;$do_date&#39; OVERWRITE into table &quot;$APP&quot;.ods_order_info partition(dt&#x3D;&#39;$do_date&#39;);

load data inpath &#39;&#x2F;origin_data&#x2F;$APP&#x2F;db&#x2F;order_detail&#x2F;$do_date&#39; OVERWRITE into table &quot;$APP&quot;.ods_order_detail partition(dt&#x3D;&#39;$do_date&#39;);

load data inpath &#39;&#x2F;origin_data&#x2F;$APP&#x2F;db&#x2F;sku_info&#x2F;$do_date&#39; OVERWRITE into table &quot;$APP&quot;.ods_sku_info partition(dt&#x3D;&#39;$do_date&#39;);

load data inpath &#39;&#x2F;origin_data&#x2F;$APP&#x2F;db&#x2F;user_info&#x2F;$do_date&#39; OVERWRITE into table &quot;$APP&quot;.ods_user_info partition(dt&#x3D;&#39;$do_date&#39;);

load data inpath &#39;&#x2F;origin_data&#x2F;$APP&#x2F;db&#x2F;payment_info&#x2F;$do_date&#39; OVERWRITE into table &quot;$APP&quot;.ods_payment_info partition(dt&#x3D;&#39;$do_date&#39;);

load data inpath &#39;&#x2F;origin_data&#x2F;$APP&#x2F;db&#x2F;base_category1&#x2F;$do_date&#39; OVERWRITE into table &quot;$APP&quot;.ods_base_category1 partition(dt&#x3D;&#39;$do_date&#39;);

load data inpath &#39;&#x2F;origin_data&#x2F;$APP&#x2F;db&#x2F;base_category2&#x2F;$do_date&#39; OVERWRITE into table &quot;$APP&quot;.ods_base_category2 partition(dt&#x3D;&#39;$do_date&#39;);

load data inpath &#39;&#x2F;origin_data&#x2F;$APP&#x2F;db&#x2F;base_category3&#x2F;$do_date&#39; OVERWRITE into table &quot;$APP&quot;.ods_base_category3 partition(dt&#x3D;&#39;$do_date&#39;); 
&quot;
$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ chmod 777 ods_db.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）执行脚本导入数据</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ ods_db.sh 2019-02-10
[atguigu@hadoop102 bin]$ ods_db.sh 2019-02-11<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>4）查询导入数据</p>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt; 
select * from ods_order_info where dt&#x3D;&#39;2019-02-10&#39; limit 1;
select * from ods_order_info where dt&#x3D;&#39;2019-02-11&#39; limit 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="3-4-DWD层"><a class="header-anchor" href="#3-4-DWD层">¶</a>3.4 DWD层</h2>
<p>对ODS层数据进行判空过滤。对商品分类表进行维度退化（降维）。</p>
<h3 id="3-4-1-创建订单表"><a class="header-anchor" href="#3-4-1-创建订单表">¶</a>3.4.1 创建订单表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists dwd_order_info;
create external table dwd_order_info (
&#96;id&#96; string COMMENT &#39;&#39;,
&#96;total_amount&#96; decimal(10,2) COMMENT &#39;&#39;,
&#96;order_status&#96; string COMMENT &#39; 1 2 3 4 5&#39;,
&#96;user_id&#96; string COMMENT &#39;id&#39;,
&#96;payment_way&#96; string COMMENT &#39;&#39;,
&#96;out_trade_no&#96; string COMMENT &#39;&#39;,
&#96;create_time&#96; string COMMENT &#39;&#39;,
&#96;operate_time&#96; string COMMENT &#39;&#39;
) 
PARTITIONED BY (&#96;dt&#96; string)
stored as parquet
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;dwd&#x2F;dwd_order_info&#x2F;&#39;
tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-4-2-创建订单详情表"><a class="header-anchor" href="#3-4-2-创建订单详情表">¶</a>3.4.2 创建订单详情表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists dwd_order_detail;
create external table dwd_order_detail( 
&#96;id&#96; string COMMENT &#39;&#39;,
&#96;order_id&#96; decimal(10,2) COMMENT &#39;&#39;, 
&#96;user_id&#96; string COMMENT &#39;id&#39;,
&#96;sku_id&#96; string COMMENT &#39;id&#39;,
&#96;sku_name&#96; string COMMENT &#39;&#39;,
&#96;order_price&#96; string COMMENT &#39;&#39;,
&#96;sku_num&#96; string COMMENT &#39;&#39;,
&#96;create_time&#96; string COMMENT &#39;&#39;
)
PARTITIONED BY (&#96;dt&#96; string)
stored as parquet
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;dwd&#x2F;dwd_order_detail&#x2F;&#39;
tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-4-3-创建用户表"><a class="header-anchor" href="#3-4-3-创建用户表">¶</a>3.4.3 创建用户表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists dwd_user_info;
create external table dwd_user_info( 
&#96;id&#96; string COMMENT &#39;id&#39;,
&#96;name&#96; string COMMENT &#39;&#39;, 
&#96;birthday&#96; string COMMENT &#39;&#39;,
&#96;gender&#96; string COMMENT &#39;&#39;,
&#96;email&#96; string COMMENT &#39;&#39;,
&#96;user_level&#96; string COMMENT &#39;&#39;,
&#96;create_time&#96; string COMMENT &#39;&#39;
) 
PARTITIONED BY (&#96;dt&#96; string)
stored as parquet
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;dwd&#x2F;dwd_user_info&#x2F;&#39;
tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-4-4-创建支付流水表"><a class="header-anchor" href="#3-4-4-创建支付流水表">¶</a>3.4.4 创建支付流水表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists dwd_payment_info;
create external table dwd_payment_info(
&#96;id&#96; bigint COMMENT &#39;&#39;,
&#96;out_trade_no&#96; string COMMENT &#39;&#39;,
&#96;order_id&#96; string COMMENT &#39;&#39;,
&#96;user_id&#96; string COMMENT &#39;&#39;,
&#96;alipay_trade_no&#96; string COMMENT &#39;&#39;,
&#96;total_amount&#96; decimal(16,2) COMMENT &#39;&#39;,
&#96;subject&#96; string COMMENT &#39;&#39;,
&#96;payment_type&#96; string COMMENT &#39;&#39;,
&#96;payment_time&#96; string COMMENT &#39;&#39;
)  
PARTITIONED BY (&#96;dt&#96; string)
stored as parquet
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;dwd&#x2F;dwd_payment_info&#x2F;&#39;
tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-4-5-创建商品表（增加分类）"><a class="header-anchor" href="#3-4-5-创建商品表（增加分类）">¶</a>3.4.5 创建商品表（增加分类）</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xGWZQ.png" class="" title="8xGWZQ.png" loading="lazy">
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists dwd_sku_info;
create external table dwd_sku_info(
&#96;id&#96; string COMMENT &#39;skuId&#39;,
&#96;spu_id&#96; string COMMENT &#39;spuid&#39;,
&#96;price&#96; decimal(10,2) COMMENT &#39;&#39;,
&#96;sku_name&#96; string COMMENT &#39;&#39;,
&#96;sku_desc&#96; string COMMENT &#39;&#39;,
&#96;weight&#96; string COMMENT &#39;&#39;,
&#96;tm_id&#96; string COMMENT &#39;id&#39;,
&#96;category3_id&#96; string COMMENT &#39;1id&#39;,
&#96;category2_id&#96; string COMMENT &#39;2id&#39;,
&#96;category1_id&#96; string COMMENT &#39;3id&#39;,
&#96;category3_name&#96; string COMMENT &#39;3&#39;,
&#96;category2_name&#96; string COMMENT &#39;2&#39;,
&#96;category1_name&#96; string COMMENT &#39;1&#39;,
&#96;create_time&#96; string COMMENT &#39;&#39;
) 
PARTITIONED BY (&#96;dt&#96; string)
stored as parquet
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;dwd&#x2F;dwd_sku_info&#x2F;&#39;
tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-4-6-DWD层数据导入脚本"><a class="header-anchor" href="#3-4-6-DWD层数据导入脚本">¶</a>3.4.6 DWD层数据导入脚本</h3>
<p>1）在/home/atguigu/bin目录下创建脚本dwd_db.sh</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ vim dwd_db.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中填写如下内容</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;bin&#x2F;bash

# 定义变量方便修改
APP&#x3D;gmall
hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天
if [ -n &quot;$1&quot; ] ;then
	do_date&#x3D;$1
else 
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;  
fi 

sql&#x3D;&quot;

set hive.exec.dynamic.partition.mode&#x3D;nonstrict;

insert overwrite table &quot;$APP&quot;.dwd_order_info partition(dt)
select * from &quot;$APP&quot;.ods_order_info 
where dt&#x3D;&#39;$do_date&#39; and id is not null;
 
insert overwrite table &quot;$APP&quot;.dwd_order_detail partition(dt)
select * from &quot;$APP&quot;.ods_order_detail 
where dt&#x3D;&#39;$do_date&#39;   and id is not null;

insert overwrite table &quot;$APP&quot;.dwd_user_info partition(dt)
select * from &quot;$APP&quot;.ods_user_info
where dt&#x3D;&#39;$do_date&#39; and id is not null;
 
insert overwrite table &quot;$APP&quot;.dwd_payment_info partition(dt)
select * from &quot;$APP&quot;.ods_payment_info
where dt&#x3D;&#39;$do_date&#39; and id is not null;

insert overwrite table &quot;$APP&quot;.dwd_sku_info partition(dt)
select  
    sku.id,
    sku.spu_id,
    sku.price,
    sku.sku_name,
    sku.sku_desc,
    sku.weight,
    sku.tm_id,
    sku.category3_id,
    c2.id category2_id,
    c1.id category1_id,
    c3.name category3_name,
    c2.name category2_name,
    c1.name category1_name,
    sku.create_time,
    sku.dt
from
    &quot;$APP&quot;.ods_sku_info sku
join &quot;$APP&quot;.ods_base_category3 c3 on sku.category3_id&#x3D;c3.id 
    join &quot;$APP&quot;.ods_base_category2 c2 on c3.category2_id&#x3D;c2.id 
    join &quot;$APP&quot;.ods_base_category1 c1 on c2.category1_id&#x3D;c1.id 
where sku.dt&#x3D;&#39;$do_date&#39;  and c2.dt&#x3D;&#39;$do_date&#39;
and c3.dt&#x3D;&#39;$do_date&#39; and c1.dt&#x3D;&#39;$do_date&#39;
and sku.id is not null;
&quot;

$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ chmod 777 dwd_db.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）执行脚本导入数据</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ dwd_db.sh 2019-02-10
[atguigu@hadoop102 bin]$ dwd_db.sh 2019-02-11<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>4）查看导入数据</p>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
select * from dwd_sku_info where dt&#x3D;&#39;2019-02-10&#39; limit 2;
select * from dwd_sku_info where dt&#x3D;&#39;2019-02-11&#39; limit 2;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="3-4-3-小结"><a class="header-anchor" href="#3-4-3-小结">¶</a>3.4.3 小结</h3>
<p>思考：</p>
<p>1）维度退化要付出什么代价？</p>
<p>如果被退化的维度，还有其他业务表使用，退化后处理起来就麻烦些。</p>
<p>2）想想在实际业务中还有那些维度表可以退化</p>
<p>城市的三级分类（省、市、县）等</p>
<h2 id="3-5-DWS层之用户行为宽表"><a class="header-anchor" href="#3-5-DWS层之用户行为宽表">¶</a>3.5 DWS层之用户行为宽表</h2>
<p>1）为什么要建宽表</p>
<p>需求目标，把每个用户单日的行为聚合起来组成一张多列宽表，以便之后关联用户维度信息后进行，不同角度的统计分析。</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/8xJRl6.png" class="" title="8xJRl6.png" loading="lazy">
<h3 id="3-5-1-创建用户行为宽表"><a class="header-anchor" href="#3-5-1-创建用户行为宽表">¶</a>3.5.1 创建用户行为宽表</h3>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
drop table if exists dws_user_action;
create external table dws_user_action 
(   
user_id string comment &#39;用户 id&#39;,
order_count bigint comment &#39;下单次数 &#39;,
order_amount decimal(16,2) comment &#39;下单金额 &#39;,
payment_count bigint comment &#39;支付次数&#39;,
payment_amount decimal(16,2) comment &#39;支付金额 &#39;,
comment_count bigint comment &#39;评论次数&#39;
) COMMENT &#39;每日用户行为宽表&#39;
PARTITIONED BY (&#96;dt&#96; string)
stored as parquet
location &#39;&#x2F;warehouse&#x2F;gmall&#x2F;dws&#x2F;dws_user_action&#x2F;&#39;
tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-5-2-向用户行为宽表导入数据"><a class="header-anchor" href="#3-5-2-向用户行为宽表导入数据">¶</a>3.5.2 向用户行为宽表导入数据</h3>
<p>1）导入数据</p>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt;
with  
tmp_order as
(
    select 
        user_id, 
count(*)  order_count,
        sum(oi.total_amount) order_amount
    from dwd_order_info oi
    where date_format(oi.create_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;2019-02-10&#39;
    group by user_id
) ,
tmp_payment as
(
    select
        user_id, 
        sum(pi.total_amount) payment_amount, 
        count(*) payment_count 
    from dwd_payment_info pi 
    where date_format(pi.payment_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;2019-02-10&#39;
    group by user_id
),
tmp_comment as
(
    select
        user_id,
        count(*) comment_count
    from dwd_comment_log c
    where date_format(c.dt,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;2019-02-10&#39;
    group by user_id
)

insert overwrite table dws_user_action partition(dt&#x3D;&#39;2019-02-10&#39;)
select
    user_actions.user_id,
    sum(user_actions.order_count),
    sum(user_actions.order_amount),
    sum(user_actions.payment_count),
    sum(user_actions.payment_amount),
    sum(user_actions.comment_count)
from 
(
    select
        user_id,
        order_count,
        order_amount,
        0 payment_count,
        0 payment_amount,
        0 comment_count
    from tmp_order

    union all
    select
        user_id,
        0,
        0,
        payment_count,
        payment_amount,
        0
    from tmp_payment

    union all
    select
        user_id,
        0,
        0,
        0,
        0,
        comment_count
    from tmp_comment
 ) user_actions
group by user_id;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）查询导入结果</p>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt; select * from dws_user_action;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="3-5-3-用户行为数据宽表导入脚本"><a class="header-anchor" href="#3-5-3-用户行为数据宽表导入脚本">¶</a>3.5.3 用户行为数据宽表导入脚本</h3>
<p>1）在/home/atguigu/bin目录下创建脚本dws_db_wide.sh</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ vim dws_db_wide.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中填写如下内容</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;bin&#x2F;bash

# 定义变量方便修改
APP&#x3D;gmall
hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天
if [ -n &quot;$1&quot; ] ;then
	do_date&#x3D;$1
else 
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;  
fi 

sql&#x3D;&quot;

with  
tmp_order as
(
    select 
        user_id, 
        sum(oi.total_amount) order_amount, 
        count(*)  order_count
    from &quot;$APP&quot;.dwd_order_info  oi
    where date_format(oi.create_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;$do_date&#39;
    group by user_id
)  ,
tmp_payment as
(
    select 
        user_id, 
        sum(pi.total_amount) payment_amount, 
        count(*) payment_count 
    from &quot;$APP&quot;.dwd_payment_info pi 
    where date_format(pi.payment_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;$do_date&#39;
    group by user_id
),
tmp_comment as
(  
    select  
        user_id, 
        count(*) comment_count
    from &quot;$APP&quot;.dwd_comment_log c
    where date_format(c.dt,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;$do_date&#39;
    group by user_id 
)

Insert overwrite table &quot;$APP&quot;.dws_user_action partition(dt&#x3D;&#39;$do_date&#39;)
select 
    user_actions.user_id, 
    sum(user_actions.order_count), 
    sum(user_actions.order_amount),
    sum(user_actions.payment_count), 
    sum(user_actions.payment_amount),
    sum(user_actions.comment_count) 
from
(
    select
        user_id,
        order_count,
        order_amount,
        0 payment_count,
        0 payment_amount,
        0 comment_count
    from tmp_order

    union all
    select
        user_id,
        0,
        0,
        payment_count,
        payment_amount,
        0
    from tmp_payment

    union all
    select
        user_id,
        0,
        0,
        0,
        0,
        comment_count 
    from tmp_comment
 ) user_actions
group by user_id;
&quot;

$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ chmod 777 dws_db_wide.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）执行脚本导入数据</p>
<pre class="line-numbers language-none"><code class="language-none">[atguigu@hadoop102 bin]$ dws_db_wide.sh 2019-02-11<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查看导入数据</p>
<pre class="line-numbers language-none"><code class="language-none">hive (gmall)&gt; 
select * from dws_user_action where dt&#x3D;&#39;2019-02-11&#39; limit 2;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1>第4章 需求一：GMV成交总额</h1>
<h2 id="4-1-ADS层"><a class="header-anchor" href="#4-1-ADS层">¶</a>4.1 ADS层</h2>
<h3 id="4-1-1-什么是GMV"><a class="header-anchor" href="#4-1-1-什么是GMV">¶</a>4.1.1 什么是GMV</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GejcnJ.png" class="" title="GejcnJ.png" loading="lazy">
<h3 id="4-1-2-建表语句"><a class="header-anchor" href="#4-1-2-建表语句">¶</a>4.1.2 建表语句</h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ads_gmv_sum_day<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> ads_gmv_sum_day<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>gmv_count<span class="token punctuation">`</span>  <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'当日gmv订单个数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>gmv_amount<span class="token punctuation">`</span>  <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'当日gmv订单总金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>gmv_payment<span class="token punctuation">`</span>  <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'当日支付金额'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'GMV'</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_gmv_sum_day/'</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GevANq.png" class="" title="GevANq.png" loading="lazy">
<h3 id="4-1-3-数据导入"><a class="header-anchor" href="#4-1-3-数据导入">¶</a>4.1.3 数据导入</h3>
<p>1）数据导入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_gmv_sum_day
<span class="token keyword">select</span> 
<span class="token string">'2019-02-10'</span> dt<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> gmv_count<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_amount<span class="token punctuation">)</span> gmv_amount<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount 
<span class="token keyword">from</span> dws_user_action
<span class="token keyword">where</span> dt <span class="token operator">=</span><span class="token string">'2019-02-10'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> dt
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）查询导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_gmv_sum_day<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-1-4-数据导入脚本"><a class="header-anchor" href="#4-1-4-数据导入脚本">¶</a>4.1.4 数据导入脚本</h3>
<p>1）在/home/atguigu/bin目录下创建脚本ads_db_gmv.sh</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ads_db_gmv.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中填写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

# 定义变量方便修改
APP&#x3D;gmall
hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天
if [ -n &quot;$1&quot; ] ;then
	do_date&#x3D;$1
else 
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;
fi 

sql&#x3D;&quot;
insert into table &quot;$APP&quot;.ads_gmv_sum_day 
select 
    &#39;$do_date&#39; dt,
    sum(order_count)  gmv_count,
    sum(order_amount) gmv_amount,
    sum(payment_amount) payment_amount 
from &quot;$APP&quot;.dws_user_action 
where dt &#x3D;&#39;$do_date&#39;
group by dt;
&quot;

$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 ads_db_gmv.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）执行脚本导入数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ ads_db_gmv.sh 2019-02-11<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查看导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_gmv_sum_day <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-11'</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1>第5章 需求二：转化率之用户新鲜度及漏斗分析</h1>
<h2 id="5-1-什么是转化率"><a class="header-anchor" href="#5-1-什么是转化率">¶</a>5.1 什么是转化率</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GevaKe.png" class="" title="GevaKe.png" loading="lazy">
<h2 id="5-2-ADS层之新增用户占日活跃用户比率（用户新鲜度）"><a class="header-anchor" href="#5-2-ADS层之新增用户占日活跃用户比率（用户新鲜度）">¶</a>5.2 ADS层之新增用户占日活跃用户比率（用户新鲜度）</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/Gev68f.png" class="" title="Gev68f.png" loading="lazy">
<h3 id="5-2-1-建表语句"><a class="header-anchor" href="#5-2-1-建表语句">¶</a>5.2.1 建表语句</h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ads_user_convert_day<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> ads_user_convert_day<span class="token punctuation">(</span> 
    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>uv_m_count<span class="token punctuation">`</span>  <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'当日活跃设备'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>new_m_count<span class="token punctuation">`</span>  <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'当日新增设备'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>new_m_ratio<span class="token punctuation">`</span>   <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'当日新增占日活的比率'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'转化率'</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_user_convert_day/'</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="5-2-2-数据导入"><a class="header-anchor" href="#5-2-2-数据导入">¶</a>5.2.2 数据导入</h3>
<p>1）数据导入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_user_convert_day
<span class="token keyword">select</span>
    <span class="token string">'2019-02-10'</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>uc<span class="token punctuation">.</span>dc<span class="token punctuation">)</span> sum_dc<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>uc<span class="token punctuation">.</span>nmc<span class="token punctuation">)</span> sum_nmc<span class="token punctuation">,</span>
    cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span> uc<span class="token punctuation">.</span>nmc<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span> uc<span class="token punctuation">.</span>dc<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  new_m_ratio
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        day_count dc<span class="token punctuation">,</span>
        <span class="token number">0</span> nmc
    <span class="token keyword">from</span> ads_uv_count
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span>

    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        <span class="token number">0</span> dc<span class="token punctuation">,</span>
        new_mid_count nmc
    <span class="token keyword">from</span> ads_new_mid_count
    <span class="token keyword">where</span> create_date<span class="token operator">=</span><span class="token string">'2019-02-10'</span>
<span class="token punctuation">)</span>uc<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）查看导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_user_convert_day<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="5-3-ADS层之用户行为漏斗分析"><a class="header-anchor" href="#5-3-ADS层之用户行为漏斗分析">¶</a>5.3 ADS层之用户行为漏斗分析</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GexZdA.png" class="" title="GexZdA.png" loading="lazy">
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GexJds.png" class="" title="GexJds.png" loading="lazy">
<h3 id="5-3-1-建表语句"><a class="header-anchor" href="#5-3-1-建表语句">¶</a>5.3.1 建表语句</h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ads_user_action_convert_day<span class="token punctuation">;</span>
<span class="token keyword">create</span> external  <span class="token keyword">table</span> ads_user_action_convert_day<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>total_visitor_m_count<span class="token punctuation">`</span>  <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'总访问人数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_u_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span>     <span class="token keyword">COMMENT</span> <span class="token string">'下单人数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visitor2order_convert_ratio<span class="token punctuation">`</span>  <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'访问到下单转化率'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_u_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span>     <span class="token keyword">COMMENT</span> <span class="token string">'支付人数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order2payment_convert_ratio<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单到支付的转化率'</span>
 <span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户行为漏斗分析'</span>
<span class="token keyword">row</span> format delimited  <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_user_action_convert_day/'</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="5-3-2-数据导入"><a class="header-anchor" href="#5-3-2-数据导入">¶</a>5.3.2 数据导入</h3>
<p>1）数据导入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_user_action_convert_day
<span class="token keyword">select</span> 
    <span class="token string">'2019-02-10'</span><span class="token punctuation">,</span>
    uv<span class="token punctuation">.</span>day_count<span class="token punctuation">,</span>
    ua<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span>
    cast<span class="token punctuation">(</span>ua<span class="token punctuation">.</span>order_count<span class="token operator">/</span>uv<span class="token punctuation">.</span>day_count <span class="token keyword">as</span>  <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visitor2order_convert_ratio<span class="token punctuation">,</span>
    ua<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span>
    cast<span class="token punctuation">(</span>ua<span class="token punctuation">.</span>payment_count<span class="token operator">/</span>ua<span class="token punctuation">.</span>order_count <span class="token keyword">as</span>  <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order2payment_convert_ratio
<span class="token keyword">from</span>  
<span class="token punctuation">(</span>
<span class="token keyword">select</span> 
    dt<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_count
    <span class="token keyword">from</span> dws_user_action
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> dt
<span class="token punctuation">)</span>ua <span class="token keyword">join</span> ads_uv_count  uv <span class="token keyword">on</span> uv<span class="token punctuation">.</span>dt<span class="token operator">=</span>ua<span class="token punctuation">.</span>dt
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）查询导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_user_action_convert_day<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1>第6章 需求三：品牌复购率</h1>
<p>需求：以月为单位统计，购买2次以上商品的用户</p>
<h2 id="6-1-复购率计算分析"><a class="header-anchor" href="#6-1-复购率计算分析">¶</a>6.1 复购率计算分析</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/Gezpwj.png" class="" title="Gezpwj.png" loading="lazy">
<h2 id="6-2-DWS层"><a class="header-anchor" href="#6-2-DWS层">¶</a>6.2 DWS层</h2>
<h3 id="6-2-1-用户购买商品明细表（宽表）"><a class="header-anchor" href="#6-2-1-用户购买商品明细表（宽表）">¶</a>6.2.1 用户购买商品明细表（宽表）</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/Gezlfx.png" class="" title="Gezlfx.png" loading="lazy">
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dws_sale_detail_daycount<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> dws_sale_detail_daycount
<span class="token punctuation">(</span>   
    user_id   string  <span class="token keyword">comment</span> <span class="token string">'用户 id'</span><span class="token punctuation">,</span>
    sku_id    string <span class="token keyword">comment</span> <span class="token string">'商品 Id'</span><span class="token punctuation">,</span>
    user_gender  string <span class="token keyword">comment</span> <span class="token string">'用户性别'</span><span class="token punctuation">,</span>
    user_age string  <span class="token keyword">comment</span> <span class="token string">'用户年龄'</span><span class="token punctuation">,</span>
    user_level string <span class="token keyword">comment</span> <span class="token string">'用户等级'</span><span class="token punctuation">,</span>
    order_price <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'商品价格'</span><span class="token punctuation">,</span>
    sku_name string   <span class="token keyword">comment</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>
    sku_tm_id string   <span class="token keyword">comment</span> <span class="token string">'品牌id'</span><span class="token punctuation">,</span>
    sku_category3_id string <span class="token keyword">comment</span> <span class="token string">'商品三级品类id'</span><span class="token punctuation">,</span>
    sku_category2_id string <span class="token keyword">comment</span> <span class="token string">'商品二级品类id'</span><span class="token punctuation">,</span>
    sku_category1_id string <span class="token keyword">comment</span> <span class="token string">'商品一级品类id'</span><span class="token punctuation">,</span>
    sku_category3_name string <span class="token keyword">comment</span> <span class="token string">'商品三级品类名称'</span><span class="token punctuation">,</span>
    sku_category2_name string <span class="token keyword">comment</span> <span class="token string">'商品二级品类名称'</span><span class="token punctuation">,</span>
    sku_category1_name string <span class="token keyword">comment</span> <span class="token string">'商品一级品类名称'</span><span class="token punctuation">,</span>
    spu_id  string <span class="token keyword">comment</span> <span class="token string">'商品 spu'</span><span class="token punctuation">,</span>
    sku_num  <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'购买个数'</span><span class="token punctuation">,</span>
    order_count string <span class="token keyword">comment</span> <span class="token string">'当日下单单数'</span><span class="token punctuation">,</span>
    order_amount string <span class="token keyword">comment</span> <span class="token string">'当日下单金额'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户购买商品明细表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string<span class="token punctuation">)</span>
stored <span class="token keyword">as</span> parquet
location <span class="token string">'/warehouse/gmall/dws/dws_user_sale_detail_daycount/'</span>
tblproperties <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-2-2-数据导入"><a class="header-anchor" href="#6-2-2-数据导入">¶</a>6.2.2 数据导入</h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">with</span>
tmp_detail <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span> 
        <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> sku_num<span class="token punctuation">,</span>   
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span> 
        <span class="token function">sum</span><span class="token punctuation">(</span>od<span class="token punctuation">.</span>order_price<span class="token operator">*</span>sku_num<span class="token punctuation">)</span> order_amount
    <span class="token keyword">from</span> dwd_order_detail od
    <span class="token keyword">where</span> od<span class="token punctuation">.</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span> sku_id
<span class="token punctuation">)</span>  
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_sale_detail_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> 
    tmp_detail<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
    tmp_detail<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>
    u<span class="token punctuation">.</span>gender<span class="token punctuation">,</span>
    months_between<span class="token punctuation">(</span><span class="token string">'2019-02-10'</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>birthday<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">12</span>  age<span class="token punctuation">,</span> 
    u<span class="token punctuation">.</span>user_level<span class="token punctuation">,</span>
    price<span class="token punctuation">,</span>
    sku_name<span class="token punctuation">,</span>
    tm_id<span class="token punctuation">,</span>
    category3_id<span class="token punctuation">,</span>
    category2_id<span class="token punctuation">,</span>
    category1_id<span class="token punctuation">,</span>
    category3_name<span class="token punctuation">,</span>
    category2_name<span class="token punctuation">,</span>
    category1_name<span class="token punctuation">,</span>
    spu_id<span class="token punctuation">,</span>
    tmp_detail<span class="token punctuation">.</span>sku_num<span class="token punctuation">,</span>
    tmp_detail<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span>
    tmp_detail<span class="token punctuation">.</span>order_amount 
<span class="token keyword">from</span> tmp_detail 
<span class="token keyword">left</span> <span class="token keyword">join</span> dwd_user_info u <span class="token keyword">on</span> tmp_detail<span class="token punctuation">.</span>user_id <span class="token operator">=</span>u<span class="token punctuation">.</span>id <span class="token operator">and</span> u<span class="token punctuation">.</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> dwd_sku_info s <span class="token keyword">on</span> tmp_detail<span class="token punctuation">.</span>sku_id <span class="token operator">=</span>s<span class="token punctuation">.</span>id <span class="token operator">and</span> s<span class="token punctuation">.</span>dt<span class="token operator">=</span><span class="token string">'2019-02-10'</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-2-3-数据导入脚本"><a class="header-anchor" href="#6-2-3-数据导入脚本">¶</a>6.2.3 数据导入脚本</h3>
<p>1）在/home/atguigu/bin目录下创建脚本dws_sale.sh</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim dws_sale.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中填写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

# 定义变量方便修改
APP&#x3D;gmall
hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天
if [ -n &quot;$1&quot; ] ;then
	do_date&#x3D;$1
else 
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;  
fi 

sql&#x3D;&quot;

set hive.exec.dynamic.partition.mode&#x3D;nonstrict;

with
tmp_detail as
(
    select 
        user_id,
        sku_id, 
        sum(sku_num) sku_num,   
        count(*) order_count, 
        sum(od.order_price*sku_num)  order_amount
    from &quot;$APP&quot;.dwd_order_detail od
    where od.dt&#x3D;&#39;$do_date&#39;
    group by user_id, sku_id
)  
insert overwrite table &quot;$APP&quot;.dws_sale_detail_daycount partition(dt&#x3D;&#39;$do_date&#39;)
select 
    tmp_detail.user_id,
    tmp_detail.sku_id,
    u.gender,
    months_between(&#39;$do_date&#39;, u.birthday)&#x2F;12  age, 
    u.user_level,
    price,
    sku_name,
    tm_id,
    category3_id,
    category2_id,
    category1_id,
    category3_name,
    category2_name,
    category1_name,
    spu_id,
    tmp_detail.sku_num,
    tmp_detail.order_count,
    tmp_detail.order_amount 
from tmp_detail 
left join &quot;$APP&quot;.dwd_user_info u 
on tmp_detail.user_id&#x3D;u.id and u.dt&#x3D;&#39;$do_date&#39;
left join &quot;$APP&quot;.dwd_sku_info s on tmp_detail.sku_id &#x3D;s.id  and s.dt&#x3D;&#39;$do_date&#39;;

&quot;
$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 dws_sale.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）执行脚本导入数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ dws_sale.sh 2019-02-11<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查看导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dws_sale_detail_daycount <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-11'</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="6-3-ADS层品牌复购率"><a class="header-anchor" href="#6-3-ADS层品牌复购率">¶</a>6.3 ADS层品牌复购率</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GezbB4.png" class="" title="GezbB4.png" loading="lazy">
<h3 id="6-3-1-建表语句"><a class="header-anchor" href="#6-3-1-建表语句">¶</a>6.3.1 建表语句</h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> ads_sale_tm_category1_stat_mn<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> ads_sale_tm_category1_stat_mn
<span class="token punctuation">(</span>   
    tm_id string <span class="token keyword">comment</span> <span class="token string">'品牌id'</span><span class="token punctuation">,</span>
    category1_id string <span class="token keyword">comment</span> <span class="token string">'1级品类id '</span><span class="token punctuation">,</span>
    category1_name string <span class="token keyword">comment</span> <span class="token string">'1级品类名称 '</span><span class="token punctuation">,</span>
    buycount   <span class="token keyword">bigint</span> <span class="token keyword">comment</span>  <span class="token string">'购买人数'</span><span class="token punctuation">,</span>
    buy_twice_last <span class="token keyword">bigint</span>  <span class="token keyword">comment</span> <span class="token string">'两次以上购买人数'</span><span class="token punctuation">,</span>
    buy_twice_last_ratio <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">comment</span>  <span class="token string">'单次复购率'</span><span class="token punctuation">,</span>
    buy_3times_last   <span class="token keyword">bigint</span> <span class="token keyword">comment</span>   <span class="token string">'三次以上购买人数'</span><span class="token punctuation">,</span>
    buy_3times_last_ratio <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">comment</span>  <span class="token string">'多次复购率'</span><span class="token punctuation">,</span>
    stat_mn string <span class="token keyword">comment</span> <span class="token string">'统计月份'</span><span class="token punctuation">,</span>
    stat_date string <span class="token keyword">comment</span> <span class="token string">'统计日期'</span> 
<span class="token punctuation">)</span>   <span class="token keyword">COMMENT</span> <span class="token string">'复购率统计'</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
location <span class="token string">'/warehouse/gmall/ads/ads_sale_tm_category1_stat_mn/'</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-3-2-数据导入"><a class="header-anchor" href="#6-3-2-数据导入">¶</a>6.3.2 数据导入</h3>
<p>1）数据导入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ads_sale_tm_category1_stat_mn
<span class="token keyword">select</span>   
    mn<span class="token punctuation">.</span>sku_tm_id<span class="token punctuation">,</span>
    mn<span class="token punctuation">.</span>sku_category1_id<span class="token punctuation">,</span>
    mn<span class="token punctuation">.</span>sku_category1_name<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>mn<span class="token punctuation">.</span>order_count<span class="token operator">>=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> buycount<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>mn<span class="token punctuation">.</span>order_count<span class="token operator">>=</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> buyTwiceLast<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>mn<span class="token punctuation">.</span>order_count<span class="token operator">>=</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span> <span class="token keyword">if</span><span class="token punctuation">(</span>mn<span class="token punctuation">.</span>order_count<span class="token operator">>=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> buyTwiceLastRatio<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>mn<span class="token punctuation">.</span>order_count<span class="token operator">>=</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  buy3timeLast  <span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>mn<span class="token punctuation">.</span>order_count<span class="token operator">>=</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span> <span class="token keyword">if</span><span class="token punctuation">(</span>mn<span class="token punctuation">.</span>order_count<span class="token operator">>=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> buy3timeLastRatio <span class="token punctuation">,</span>
    date_format<span class="token punctuation">(</span><span class="token string">'2019-02-10'</span> <span class="token punctuation">,</span><span class="token string">'yyyy-MM'</span><span class="token punctuation">)</span> stat_mn<span class="token punctuation">,</span>
    <span class="token string">'2019-02-10'</span> stat_date
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
<span class="token keyword">select</span> 
        user_id<span class="token punctuation">,</span> 
sd<span class="token punctuation">.</span>sku_tm_id<span class="token punctuation">,</span>
        sd<span class="token punctuation">.</span>sku_category1_id<span class="token punctuation">,</span>
        sd<span class="token punctuation">.</span>sku_category1_name<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count
    <span class="token keyword">from</span> dws_sale_detail_daycount sd 
    <span class="token keyword">where</span> date_format<span class="token punctuation">(</span>dt<span class="token punctuation">,</span><span class="token string">'yyyy-MM'</span><span class="token punctuation">)</span><span class="token operator">=</span>date_format<span class="token punctuation">(</span><span class="token string">'2019-02-10'</span> <span class="token punctuation">,</span><span class="token string">'yyyy-MM'</span><span class="token punctuation">)</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span> sd<span class="token punctuation">.</span>sku_tm_id<span class="token punctuation">,</span> sd<span class="token punctuation">.</span>sku_category1_id<span class="token punctuation">,</span> sd<span class="token punctuation">.</span>sku_category1_name
<span class="token punctuation">)</span> mn
<span class="token keyword">group</span> <span class="token keyword">by</span> mn<span class="token punctuation">.</span>sku_tm_id<span class="token punctuation">,</span> mn<span class="token punctuation">.</span>sku_category1_id<span class="token punctuation">,</span> mn<span class="token punctuation">.</span>sku_category1_name
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）查询导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_sale_tm_category1_stat_mn<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="6-3-3-数据导入脚本"><a class="header-anchor" href="#6-3-3-数据导入脚本">¶</a>6.3.3 数据导入脚本</h3>
<p>1）在/home/atguigu/bin目录下创建脚本ads_sale.sh</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ads_sale.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中填写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

# 定义变量方便修改
APP&#x3D;gmall
hive&#x3D;&#x2F;opt&#x2F;module&#x2F;hive&#x2F;bin&#x2F;hive

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天
if [ -n &quot;$1&quot; ] ;then
	do_date&#x3D;$1
else 
	do_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;  
fi 

sql&#x3D;&quot;

set hive.exec.dynamic.partition.mode&#x3D;nonstrict;

insert into table &quot;$APP&quot;.ads_sale_tm_category1_stat_mn
select   
    mn.sku_tm_id,
    mn.sku_category1_id,
    mn.sku_category1_name,
    sum(if(mn.order_count&gt;&#x3D;1,1,0)) buycount,
    sum(if(mn.order_count&gt;&#x3D;2,1,0)) buyTwiceLast,
    sum(if(mn.order_count&gt;&#x3D;2,1,0))&#x2F;sum( if(mn.order_count&gt;&#x3D;1,1,0)) buyTwiceLastRatio,
    sum(if(mn.order_count&gt;&#x3D;3,1,0)) buy3timeLast,
    sum(if(mn.order_count&gt;&#x3D;3,1,0))&#x2F;sum( if(mn.order_count&gt;&#x3D;1,1,0)) buy3timeLastRatio ,
    date_format(&#39;$do_date&#39; ,&#39;yyyy-MM&#39;) stat_mn,
    &#39;$do_date&#39; stat_date
from 
(     
select 
        user_id, 
od.sku_tm_id, 
        od.sku_category1_id,
        od.sku_category1_name,  
        sum(order_count) order_count
    from &quot;$APP&quot;.dws_sale_detail_daycount  od 
    where date_format(dt,&#39;yyyy-MM&#39;)&#x3D;date_format(&#39;$do_date&#39; ,&#39;yyyy-MM&#39;)
    group by user_id, od.sku_tm_id, od.sku_category1_id, od.sku_category1_name
) mn
group by mn.sku_tm_id, mn.sku_category1_id, mn.sku_category1_name;

&quot;
$hive -e &quot;$sql&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）增加脚本执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 ads_sale.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3）执行脚本导入数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ ads_sale.sh 2019-02-11<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）查看导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_sale_tm_category1_stat_mn <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="6-4-练习：求每个等级的用户对应的复购率前十的商品排行"><a class="header-anchor" href="#6-4-练习：求每个等级的用户对应的复购率前十的商品排行">¶</a>6.4 练习：求每个等级的用户对应的复购率前十的商品排行</h2>
<p>1）每个等级，每种商品，买一次的用户数，买两次的用户数=》得出复购率</p>
<p>2）利用开窗函数，取每个等级的前十</p>
<p>3）形成脚本</p>
<h1>第7章 数据可视化</h1>
<h2 id="7-1-在MySQL中创建表"><a class="header-anchor" href="#7-1-在MySQL中创建表">¶</a>7.1 在MySQL中创建表</h2>
<h3 id="7-1-1-每日活跃统计"><a class="header-anchor" href="#7-1-1-每日活跃统计">¶</a>7.1.1 每日活跃统计</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmDGu9.png" class="" title="GmDGu9.png" loading="lazy">
<p>1）在MySQL中创建ads_uv_count表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span>  <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>day_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'当日用户数量'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>wk_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'当周用户数量'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>mn_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'当月用户数量'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>is_weekend<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'Y,N是否是周末,用于得到本周最终结果'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>is_monthend<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'Y,N是否是月末,用于得到本月最终结果'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci <span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">'每日活跃用户数量'</span> ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）向MySQL中插入如下数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-01 14:10:04'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-02 14:12:48'</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-03 14:14:07'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">3300</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-04 14:14:14'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-05 14:14:21'</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">121</span><span class="token punctuation">,</span> <span class="token number">131</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-06 14:14:38'</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">,</span> <span class="token number">453</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-07 14:33:27'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">453</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-08 14:33:39'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">,</span> <span class="token number">453</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-09 14:33:47'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">453</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-10 14:33:54'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">653</span><span class="token punctuation">,</span> <span class="token number">8453</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-11 14:34:04'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">453</span><span class="token punctuation">,</span> <span class="token number">1453</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-12 14:34:10'</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">,</span> <span class="token number">134</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-13 14:34:16'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">286</span><span class="token punctuation">,</span> <span class="token number">313</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-14 14:34:22'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">453</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-15 14:34:29'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">345</span><span class="token punctuation">,</span> <span class="token number">3453</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-16 14:34:35'</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">453</span><span class="token punctuation">,</span> <span class="token number">453</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-17 14:34:41'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">678</span><span class="token punctuation">,</span> <span class="token number">9812</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-18 14:34:46'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">186</span><span class="token punctuation">,</span> <span class="token number">193</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-19 14:34:53'</span><span class="token punctuation">,</span> <span class="token number">453</span><span class="token punctuation">,</span> <span class="token number">686</span><span class="token punctuation">,</span> <span class="token number">712</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-20 14:34:57'</span><span class="token punctuation">,</span> <span class="token number">452</span><span class="token punctuation">,</span> <span class="token number">786</span><span class="token punctuation">,</span> <span class="token number">823</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-21 14:35:02'</span><span class="token punctuation">,</span> <span class="token number">214</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">213</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-22 14:35:08'</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-23 14:35:13'</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">658</span><span class="token punctuation">,</span> <span class="token number">745</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-24 14:35:19'</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">687</span><span class="token punctuation">,</span> <span class="token number">9300</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-25 14:35:25'</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">876</span><span class="token punctuation">,</span> <span class="token number">923</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-26 14:35:30'</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">,</span> <span class="token number">511</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-27 14:35:35'</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">,</span> <span class="token number">623</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-28 14:35:41'</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">753</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-29 14:35:47'</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">876</span><span class="token punctuation">,</span> <span class="token number">4545</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-30 14:35:57'</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">354</span><span class="token punctuation">,</span> <span class="token number">523</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_uv_count<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-31 14:36:02'</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">634</span><span class="token punctuation">,</span> <span class="token number">6213</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="7-1-2-留存率统计"><a class="header-anchor" href="#7-1-2-留存率统计">¶</a>7.1.2 留存率统计</h3>
<p>1）在MySQL中创建ads_user_retention_day_rate表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span>  <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>stat_date<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>  <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>create_date<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'设备新增日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>retention_day<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'截止当前日期留存天数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>retention_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'留存数量'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>new_mid_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'当日设备新增数量'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>retention_ratio<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'留存率'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci <span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">'每日用户留存情况'</span> ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）向MySQL中插入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-09'</span><span class="token punctuation">,</span><span class="token string">'2019-03-08'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">,</span>  <span class="token number">99</span><span class="token punctuation">,</span>  <span class="token number">0.78</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-10'</span><span class="token punctuation">,</span><span class="token string">'2019-03-08'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">77</span><span class="token punctuation">,</span>  <span class="token number">88</span><span class="token punctuation">,</span>  <span class="token number">0.68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-11'</span><span class="token punctuation">,</span><span class="token string">'2019-03-08'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">66</span><span class="token punctuation">,</span>  <span class="token number">77</span><span class="token punctuation">,</span>  <span class="token number">0.58</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-12'</span><span class="token punctuation">,</span><span class="token string">'2019-03-08'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>  <span class="token number">66</span><span class="token punctuation">,</span>  <span class="token number">0.48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-13'</span><span class="token punctuation">,</span><span class="token string">'2019-03-08'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span>  <span class="token number">55</span><span class="token punctuation">,</span>  <span class="token number">0.38</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-14'</span><span class="token punctuation">,</span><span class="token string">'2019-03-08'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">,</span>  <span class="token number">44</span><span class="token punctuation">,</span>  <span class="token number">0.28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-10'</span><span class="token punctuation">,</span><span class="token string">'2019-03-09'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">77</span><span class="token punctuation">,</span>  <span class="token number">88</span><span class="token punctuation">,</span>  <span class="token number">0.56</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-11'</span><span class="token punctuation">,</span><span class="token string">'2019-03-09'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">66</span><span class="token punctuation">,</span>  <span class="token number">77</span><span class="token punctuation">,</span>  <span class="token number">0.46</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-12'</span><span class="token punctuation">,</span><span class="token string">'2019-03-09'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>  <span class="token number">66</span><span class="token punctuation">,</span>  <span class="token number">0.36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-13'</span><span class="token punctuation">,</span><span class="token string">'2019-03-09'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span>  <span class="token number">55</span><span class="token punctuation">,</span>  <span class="token number">0.26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-14'</span><span class="token punctuation">,</span><span class="token string">'2019-03-09'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">,</span>  <span class="token number">44</span><span class="token punctuation">,</span>  <span class="token number">0.16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-11'</span><span class="token punctuation">,</span><span class="token string">'2019-03-10'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">66</span><span class="token punctuation">,</span>  <span class="token number">77</span><span class="token punctuation">,</span>  <span class="token number">0.55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-12'</span><span class="token punctuation">,</span><span class="token string">'2019-03-10'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>  <span class="token number">66</span><span class="token punctuation">,</span>  <span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-13'</span><span class="token punctuation">,</span><span class="token string">'2019-03-10'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span>  <span class="token number">55</span><span class="token punctuation">,</span>  <span class="token number">0.35</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_retention_day_rate<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-14'</span><span class="token punctuation">,</span><span class="token string">'2019-03-10'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">,</span>  <span class="token number">44</span><span class="token punctuation">,</span>  <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="7-1-3-漏斗分析"><a class="header-anchor" href="#7-1-3-漏斗分析">¶</a>7.1.3 漏斗分析</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmD6HI.png" class="" title="GmD6HI.png" loading="lazy">
<p>1）在MySQL中创建ads_user_action_convert_day表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>ads_user_action_convert_day<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_user_action_convert_day<span class="token punctuation">`</span>  <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>total_visitor_m_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'总访问人数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_u_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单人数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>visitor2order_convert_ratio<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'购物车到下单转化率'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>payment_u_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付人数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order2payment_convert_ratio<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单到支付的转化率'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci <span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">'每日用户行为转化率统计'</span> ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）向MySQL中插入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_user_action_convert_day<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-04-28 19:36:18'</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="7-1-4-GMV统计"><a class="header-anchor" href="#7-1-4-GMV统计">¶</a>7.1.4 GMV统计</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmDXCT.png" class="" title="GmDXCT.png" loading="lazy">
<p>1）在MySQL中创建ads_gmv_sum_day表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_gmv_sum_day<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> ads_gmv_sum_day<span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>gmv_count<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'当日gmv订单个数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>gmv_amount<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'当日gmv订单总金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>gmv_payment<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'当日支付金额'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci <span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">'每日活跃用户数量'</span> ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）向MySQL中插入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_gmv_sum_day<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-03-01 22:51:37'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">210000.00</span><span class="token punctuation">,</span> <span class="token number">2000.00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_gmv_sum_day<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-05-08 22:52:32'</span><span class="token punctuation">,</span> <span class="token number">3434</span><span class="token punctuation">,</span> <span class="token number">12413.00</span><span class="token punctuation">,</span> <span class="token number">1.00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_gmv_sum_day<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-07-13 22:52:51'</span><span class="token punctuation">,</span> <span class="token number">1222</span><span class="token punctuation">,</span> <span class="token number">324345.00</span><span class="token punctuation">,</span> <span class="token number">1.00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_gmv_sum_day<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2019-09-13 22:53:08'</span><span class="token punctuation">,</span> <span class="token number">2344</span><span class="token punctuation">,</span> <span class="token number">12312.00</span><span class="token punctuation">,</span> <span class="token number">1.00</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="7-1-5-全国商品销售"><a class="header-anchor" href="#7-1-5-全国商品销售">¶</a>7.1.5 全国商品销售</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmrlIP.png" class="" title="GmrlIP.png" loading="lazy">
<p>1）在MySQL中创建ads_gmv_sum_province表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>ads_gmv_sum_province<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_gmv_sum_province<span class="token punctuation">`</span>  <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>province<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>gmv<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>remark<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）向MySQL中插入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_gmv_sum_province<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'北京'</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_gmv_sum_province<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'辽宁'</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token string">'沈阳：21.1%，大连：20%，鞍山：35%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>ads_gmv_sum_province<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'浙江'</span><span class="token punctuation">,</span> <span class="token number">8002</span><span class="token punctuation">,</span> <span class="token string">'杭州：20%，舟山：50%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="7-2-WEB页面查看"><a class="header-anchor" href="#7-2-WEB页面查看">¶</a>7.2 WEB页面查看</h2>
<p>1）运行spring-boot-echarts-master程序</p>
<p>2）在web页面上查看显示结果</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/active">http://localhost:8080/active</a></p>
<h2 id="7-3-Sqoop导出脚本"><a class="header-anchor" href="#7-3-Sqoop导出脚本">¶</a>7.3 Sqoop导出脚本</h2>
<p>1）编写Sqoop导出脚本</p>
<p>在/home/atguigu/bin目录下创建脚本sqoop_export.sh</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim sqoop_export.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在脚本中填写如下内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash

db_name&#x3D;gmall

export_data() &#123;
&#x2F;opt&#x2F;module&#x2F;sqoop&#x2F;bin&#x2F;sqoop export \
--connect &quot;jdbc:mysql:&#x2F;&#x2F;hadoop102:3306&#x2F;$&#123;db_name&#125;?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&quot;  \
--username root \
--password 000000 \
--table $1 \
--num-mappers 1 \
--export-dir &#x2F;warehouse&#x2F;$db_name&#x2F;ads&#x2F;$1 \
--input-fields-terminated-by &quot;\t&quot; \
--update-mode allowinsert \
--update-key &quot;tm_id,category1_id,stat_mn,stat_date&quot; \
--input-null-string &#39;\\N&#39;    \
--input-null-non-string &#39;\\N&#39;
&#125;

case $1 in
  &quot;ads_uv_count&quot;)
     export_data &quot;ads_uv_count&quot;
;;
  &quot;ads_user_action_convert_day&quot;)
     export_data &quot;ads_user_action_convert_day&quot;
;;
  &quot;ads_gmv_sum_day&quot;)
     export_data &quot;ads_gmv_sum_day&quot;
;;
   &quot;all&quot;)
	 export_data &quot;ads_uv_count&quot;
	 export_data &quot;ads_user_action_convert_day&quot;
     export_data &quot;ads_gmv_sum_day&quot;
;;
esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于导出update还是insert的问题</p>
<ul>
<li>
<p>–update-mode：</p>
<pre class="line-numbers language-none"><code class="language-none">updateonly  只更新，无法插入新数据

 allowinsert  允许新增 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>–update-key：允许更新的情况下，指定哪些字段匹配视为同一条数据，进行更新而不增加。多个字段用逗号分隔。</p>
</li>
<li>
<p>–input-null-string和–input-null-non-string：</p>
</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">分别表示，将字符串列和非字符串列的空串和“null”转义。

官网地址：http:&#x2F;&#x2F;sqoop.apache.org&#x2F;docs&#x2F;1.4.6&#x2F;SqoopUserGuide.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">Sqoop will by default import NULL values as string null. Hive is however using string \N to denote NULL values and therefore predicates dealing with NULL(like IS NULL) will not work correctly. You should append parameters --null-string and --null-non-string in case of import job or --input-null-string and --input-null-non-string in case of an export job if you wish to properly preserve NULL values. Because sqoop is using those parameters in generated code, you need to properly escape value \N to \\N:<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Hive中的Null在底层是以“\N”来存储，而MySQL中的Null在底层就是Null，为了保证数据两端的一致性。在导出数据时采用–input-null-string和–input-null-non-string两个参数。导入数据时采用–null-string和–null-non-string。</p>
<p>3）执行Sqoop导出脚本</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 sqoop_export.sh
[atguigu@hadoop102 bin]$ sqoop_export.sh all<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>4）在MySQL中查看结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> ads_uv_count<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> ads_user_retention_day_rate<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> ads_user_action_convert_day<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> ads_gmv_sum_day<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> ads_gmv_sum_province<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1>第8章 Azkaban调度器</h1>
<h2 id="8-1-Azkaban安装"><a class="header-anchor" href="#8-1-Azkaban安装">¶</a>8.1 Azkaban安装</h2>
<p>详见：尚硅谷大数据技术之Azkaban</p>
<h2 id="8-2-GMV指标获取的全调度流程"><a class="header-anchor" href="#8-2-GMV指标获取的全调度流程">¶</a>8.2 GMV指标获取的全调度流程</h2>
<p>1）生成数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CALL</span> init_data<span class="token punctuation">(</span><span class="token string">'2019-02-12'</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token boolean">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>2）编写Azkaban程序运行job</p>
<p>（1）import.job文件</p>
<pre class="line-numbers language-none"><code class="language-none">type&#x3D;command
do_date&#x3D;$&#123;dt&#125;
command&#x3D;&#x2F;home&#x2F;atguigu&#x2F;bin&#x2F;sqoop_import.sh all $&#123;do_date&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>（2）ods.job文件</p>
<pre class="line-numbers language-none"><code class="language-none">type&#x3D;command
do_date&#x3D;$&#123;dt&#125;
dependencies&#x3D;import
command&#x3D;&#x2F;home&#x2F;atguigu&#x2F;bin&#x2F;ods_db.sh $&#123;do_date&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>（3）dwd.job文件</p>
<pre class="line-numbers language-none"><code class="language-none">type&#x3D;command
do_date&#x3D;$&#123;dt&#125;
dependencies&#x3D;ods
command&#x3D;&#x2F;home&#x2F;atguigu&#x2F;bin&#x2F;dwd_db.sh $&#123;do_date&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>（4）dws.job文件</p>
<pre class="line-numbers language-none"><code class="language-none">type&#x3D;command
do_date&#x3D;$&#123;dt&#125;
dependencies&#x3D;dwd
command&#x3D;&#x2F;home&#x2F;atguigu&#x2F;bin&#x2F;dws_db_wide.sh $&#123;do_date&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>（5）ads.job文件</p>
<pre class="line-numbers language-none"><code class="language-none">type&#x3D;command
do_date&#x3D;$&#123;dt&#125;
dependencies&#x3D;dws
command&#x3D;&#x2F;home&#x2F;atguigu&#x2F;bin&#x2F;ads_db_gmv.sh $&#123;do_date&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>（6）export.job文件</p>
<pre class="line-numbers language-none"><code class="language-none">type&#x3D;command
dependencies&#x3D;ads
command&#x3D;&#x2F;home&#x2F;atguigu&#x2F;bin&#x2F;sqoop_export.sh ads_gmv_sum_day<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>（7）将以上6个文件压缩成gmv-job.zip文件</p>
<p>3）创建Azkaban工程，并上传gmv-job.zip文件。</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmP3LT.png" class="" title="GmP3LT.png" loading="lazy">
<p>4）在浏览器中输入**<a target="_blank" rel="noopener" href="https://hadoop102:8443">https://hadoop102:8443</a>，**并在页面上创建工程执行gmv-job.zip任务。</p>
<p>5）等待大约20分钟，在MySQL中查看结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_gmv_sum_day<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1>第9章 订单表拉链表</h1>
<h2 id="9-1-什么是拉链表"><a class="header-anchor" href="#9-1-什么是拉链表">¶</a>9.1 什么是拉链表</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmGUbD.png" class="" title="GmGUbD.png" loading="lazy">
<h2 id="9-2-为什么要做拉链表"><a class="header-anchor" href="#9-2-为什么要做拉链表">¶</a>9.2 为什么要做拉链表</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmGgr8.png" class="" title="GmGgr8.png" loading="lazy">
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/image-20200405222712168.png" class="" title="image-20200405222712168" loading="lazy">
<h2 id="9-3-拉链表形成过程"><a class="header-anchor" href="#9-3-拉链表形成过程">¶</a>9.3 拉链表形成过程</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmJpxx.png" class="" title="GmJpxx.png" loading="lazy">
<h2 id="9-4-拉链表制作过程图"><a class="header-anchor" href="#9-4-拉链表制作过程图">¶</a>9.4 拉链表制作过程图</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmdBex.png" class="" title="GmdBex.png" loading="lazy">
<h2 id="9-5-拉链表制作过程"><a class="header-anchor" href="#9-5-拉链表制作过程">¶</a>9.5 拉链表制作过程</h2>
<h3 id="9-5-1-步骤0：初始化拉链表（首次独立执行）"><a class="header-anchor" href="#9-5-1-步骤0：初始化拉链表（首次独立执行）">¶</a>9.5.1 步骤0：初始化拉链表（首次独立执行）</h3>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/image-20200405222806509.png" class="" title="image-20200405222806509" loading="lazy">
<p>1）生成10条原始订单数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CALL</span> init_data<span class="token punctuation">(</span><span class="token string">'2019-02-13'</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span>atguigu<span class="token variable">@hadoop102</span> bin<span class="token punctuation">]</span>$ sqoop_import<span class="token punctuation">.</span>sh <span class="token keyword">all</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">13</span>

<span class="token punctuation">[</span>atguigu<span class="token variable">@hadoop102</span> bin<span class="token punctuation">]</span>$ ods_db<span class="token punctuation">.</span>sh <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">13</span>

<span class="token punctuation">[</span>atguigu<span class="token variable">@hadoop102</span> bin<span class="token punctuation">]</span>$ dwd_db<span class="token punctuation">.</span>sh <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">13</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）建立拉链表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_order_info_his<span class="token punctuation">;</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> dwd_order_info_his<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>total_amount<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_status<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'订单状态'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span> <span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_way<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'支付方式'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'支付流水号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'操作时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>start_date<span class="token punctuation">`</span>  string <span class="token keyword">COMMENT</span> <span class="token string">'有效开始日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>end_date<span class="token punctuation">`</span>  string <span class="token keyword">COMMENT</span> <span class="token string">'有效结束日期'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单拉链表'</span>
stored <span class="token keyword">as</span> parquet
location <span class="token string">'/warehouse/gmall/dwd/dwd_order_info_his/'</span>
tblproperties <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）初始化拉链表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_info_his
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    total_amount<span class="token punctuation">,</span>
    order_status<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    payment_way<span class="token punctuation">,</span>
    out_trade_no<span class="token punctuation">,</span>
    create_time<span class="token punctuation">,</span>
    operate_time<span class="token punctuation">,</span>
    <span class="token string">'2019-02-13'</span><span class="token punctuation">,</span>
    <span class="token string">'9999-99-99'</span>
<span class="token keyword">from</span> ods_order_info oi
<span class="token keyword">where</span> oi<span class="token punctuation">.</span>dt<span class="token operator">=</span><span class="token string">'2019-02-13'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>4）查询拉链表中数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_order_info_his <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="9-5-2-步骤1：制作当日变动数据（包括新增，修改）每日执行"><a class="header-anchor" href="#9-5-2-步骤1：制作当日变动数据（包括新增，修改）每日执行">¶</a>9.5.2 步骤1：制作当日变动数据（包括新增，修改）每日执行</h3>
<p>1）如何获得每日变动表</p>
<p>（1）最好表内有创建时间和变动时间（Lucky!）</p>
<p>（2）如果没有，可以利用第三方工具监控比如canal，监控MySQL的实时变化进行记录(麻烦)。</p>
<p>（3）逐行对比前后两天的数据,<br>
检查md5(concat(全部有可能变化的字段))是否相同(low)</p>
<p>（4）要求业务数据库提供变动流水（人品，颜值）</p>
<p>2）因为dwd_order_info本身导入过来就是新增变动明细的表，所以不用处理</p>
<p>（1）2019-02-14日新增2条订单数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CALL</span> init_data<span class="token punctuation">(</span><span class="token string">'2019-02-14'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（2）通过Sqoop把2019-02-14日所有数据导入</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sqoop_import.sh all 2019-02-14<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（3）ODS层数据导入</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ods_db.sh 2019-02-14<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（4）DWD层数据导入</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">dwd_db.sh 2019-02-14<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="9-5-3-步骤2：先合并变动信息，再追加新增信息，插入到临时表中"><a class="header-anchor" href="#9-5-3-步骤2：先合并变动信息，再追加新增信息，插入到临时表中">¶</a>9.5.3 步骤2：先合并变动信息，再追加新增信息，插入到临时表中</h3>
<p>1）建立临时表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_order_info_his_tmp<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> dwd_order_info_his_tmp<span class="token punctuation">(</span> 
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>total_amount<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>order_status<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'订单状态'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span> <span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_way<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'支付方式'</span><span class="token punctuation">,</span>  
    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'支付流水号'</span><span class="token punctuation">,</span>  
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  
    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'操作时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>start_date<span class="token punctuation">`</span>  string <span class="token keyword">COMMENT</span> <span class="token string">'有效开始日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>end_date<span class="token punctuation">`</span>  string <span class="token keyword">COMMENT</span> <span class="token string">'有效结束日期'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单拉链临时表'</span>
stored <span class="token keyword">as</span> parquet
location <span class="token string">'/warehouse/gmall/dwd/dwd_order_info_his_tmp/'</span>
tblproperties <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）导入脚本</p>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/Gm0V2Q-1586097028879.png" class="" title="Gm0V2Q.png" loading="lazy">
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_info_his_tmp
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 
<span class="token punctuation">(</span>
<span class="token keyword">select</span> 
id<span class="token punctuation">,</span>
    total_amount<span class="token punctuation">,</span>
    order_status<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    payment_way<span class="token punctuation">,</span>
    out_trade_no<span class="token punctuation">,</span>
    create_time<span class="token punctuation">,</span>
    operate_time<span class="token punctuation">,</span>
    <span class="token string">'2019-02-14'</span> start_date<span class="token punctuation">,</span>
    <span class="token string">'9999-99-99'</span> end_date
<span class="token keyword">from</span> dwd_order_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-14'</span>

<span class="token keyword">union</span> <span class="token keyword">all</span> 
<span class="token keyword">select</span> oh<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    oh<span class="token punctuation">.</span>total_amount<span class="token punctuation">,</span>
    oh<span class="token punctuation">.</span>order_status<span class="token punctuation">,</span>
    oh<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
    oh<span class="token punctuation">.</span>payment_way<span class="token punctuation">,</span>
    oh<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>
    oh<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>
    oh<span class="token punctuation">.</span>operate_time<span class="token punctuation">,</span>
    oh<span class="token punctuation">.</span>start_date<span class="token punctuation">,</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>oi<span class="token punctuation">.</span>id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span> oh<span class="token punctuation">.</span>end_date<span class="token punctuation">,</span> date_add<span class="token punctuation">(</span>oi<span class="token punctuation">.</span>dt<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> end_date
<span class="token keyword">from</span> dwd_order_info_his oh <span class="token keyword">left</span> <span class="token keyword">join</span> 
     <span class="token punctuation">(</span>
<span class="token keyword">select</span>
<span class="token operator">*</span>
<span class="token keyword">from</span> dwd_order_info
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2019-02-14'</span>
<span class="token punctuation">)</span> oi
     <span class="token keyword">on</span> oh<span class="token punctuation">.</span>id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id <span class="token operator">and</span> oh<span class="token punctuation">.</span>end_date<span class="token operator">=</span><span class="token string">'9999-99-99'</span>  
<span class="token punctuation">)</span>his 
<span class="token keyword">order</span> <span class="token keyword">by</span> his<span class="token punctuation">.</span>id<span class="token punctuation">,</span> start_date<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="9-5-4-步骤3：把临时表覆盖给拉链表"><a class="header-anchor" href="#9-5-4-步骤3：把临时表覆盖给拉链表">¶</a>9.5.4 步骤3：把临时表覆盖给拉链表</h3>
<p>1）导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_info_his 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_order_info_his_tmp<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>2）查询导入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_order_info_his<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="9-5-5-整理为每日脚本"><a class="header-anchor" href="#9-5-5-整理为每日脚本">¶</a>9.5.5 整理为每日脚本</h3>
<h1>第10章 项目总结</h1>
<h2 id="10-1-熟悉8张表的业务字段，每张表记住3-5个字段"><a class="header-anchor" href="#10-1-熟悉8张表的业务字段，每张表记住3-5个字段">¶</a>10.1 熟悉8张表的业务字段，每张表记住3-5个字段</h2>
<h2 id="10-2-数仓理论"><a class="header-anchor" href="#10-2-数仓理论">¶</a>10.2 数仓理论</h2>
<p>1）表的分类：实体表、维度表、事务型事实表、周期型事实表</p>
<p>2）表的同步策略：</p>
<p>实体表（全量）</p>
<blockquote>
<p>维度表（全量）</p>
<p>事务型事实表（增量）</p>
<p>周期型事实表（新增和变化、拉链表）</p>
</blockquote>
<p>3）范式理论：</p>
<blockquote>
<p>一范式原则：属性不可切割；</p>
<p>二范式原则：不能存在部分函数依赖；</p>
<p>三范式原则：不能存在传递函数依赖；</p>
</blockquote>
<p>4）数仓维度建模模型</p>
<blockquote>
<p>星型模型，维度一层；</p>
<p>雪花模型，维度多层；</p>
<p>星座模型，多个事实表；</p>
</blockquote>
<p>性能优先选择星型模型，灵活优先选择雪花模型。企业中星型模型多一些。</p>
<h2 id="10-3-Sqoop参数"><a class="header-anchor" href="#10-3-Sqoop参数">¶</a>10.3 Sqoop参数</h2>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;opt&#x2F;module&#x2F;sqoop&#x2F;bin&#x2F;sqoop import \
--connect \
--username \
--password \
--target-dir \
--delete-target-dir \
--num-mappers \
--fields-terminated-by   \
--query   &quot;$2&quot; &#39; and $CONDITIONS;&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="10-3-1-Sqoop导入导出Null存储一致性问题"><a class="header-anchor" href="#10-3-1-Sqoop导入导出Null存储一致性问题">¶</a>10.3.1 Sqoop导入导出Null存储一致性问题</h3>
<p>Hive中的Null在底层是以&quot;\N&quot;来存储，而MySQL中的Null在底层就是Null，为了保证数据两端的一致性。在导出数据时采用–input-null-string和–input-null-non-string两个参数。导入数据时采用–null-string和–null-non-string。</p>
<h3 id="10-3-2-Sqoop数据导出一致性问题"><a class="header-anchor" href="#10-3-2-Sqoop数据导出一致性问题">¶</a>10.3.2 Sqoop数据导出一致性问题</h3>
<p>1）场景1：如Sqoop在导出到Mysql时，使用4个Map任务，过程中有2个任务失败，那此时MySQL中存储了另外两个Map任务导入的数据，此时老板正好看到了这个报表数据。而开发工程师发现任务失败后，会调试问题并最终将全部数据正确的导入MySQL，那后面老板再次看报表数据，发现本次看到的数据与之前的不一致，这在生产环境是不允许的。</p>
<p>官网：<a target="_blank" rel="noopener" href="http://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html">http://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html</a></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Since Sqoop breaks down export process into multiple transactions, it is possible that a failed export job may result in partial data being committed to the database. This can further lead to subsequent jobs failing due to insert collisions in some cases, or lead to duplicated data in others. You can overcome this problem by specifying a staging table via the --staging-table option which acts as an auxiliary table that is used to stage exported data. The staged data is finally moved to the destination table in a single transaction.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>–staging-table方式</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sqoop export --connect jdbc:mysql:&#x2F;&#x2F;192.168.137.10:3306&#x2F;user_behavior --username root --password 123456 --table app_cource_study_report --columns watch_video_cnt,complete_video_cnt,dt --fields-terminated-by &quot;\t&quot; --export-dir &quot;&#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;tmp.db&#x2F;app_cource_study_analysis_$&#123;day&#125;&quot; --staging-table app_cource_study_report_tmp --clear-staging-table --input-null-string &#39;\N&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>2）场景2：设置map数量为1个（不推荐，面试官想要的答案不只这个）</p>
<p>多个Map任务时，采用–staging-table方式，仍然可以解决数据一致性问题。</p>
<h3 id="10-3-3-Sqoop底层运行的任务是什么"><a class="header-anchor" href="#10-3-3-Sqoop底层运行的任务是什么">¶</a>10.3.3 Sqoop底层运行的任务是什么</h3>
<p>只有Map阶段，没有Reduce阶段的任务。</p>
<h3 id="10-3-4-Sqoop数据导出的时候一次执行多长时间"><a class="header-anchor" href="#10-3-4-Sqoop数据导出的时候一次执行多长时间">¶</a>10.3.4 Sqoop数据导出的时候一次执行多长时间</h3>
<p>Sqoop任务5分钟-2个小时的都有。取决于数据量。</p>
<h2 id="10-4-需求指标分析"><a class="header-anchor" href="#10-4-需求指标分析">¶</a>10.4 需求指标分析</h2>
<p>1）GMV：一段时间内的网站成交金额（包括付款和未付款）</p>
<p>计算：基于用户行为宽表，对订单总金额进行sum。</p>
<p>2）转化率：（先分别计算分子和分母，再相除）</p>
<p>（1）新增用户占活跃用户的比率；</p>
<pre class="line-numbers language-none"><code class="language-none">cast(sum( uc.nmc)&#x2F;sum( uc.dc)*100 as decimal(10,2))  new_m_ratio<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（2）下单人数占活跃用户的比率；</p>
<pre class="line-numbers language-none"><code class="language-none">sum(if(order_count&gt;0,1,0)) order_count

cast(ua.order_count&#x2F;uv.day_count*100 as  decimal(10,2)) visitor2order_convert_ratio<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>（3）支付人数占下单人数的比率；</p>
<pre class="line-numbers language-none"><code class="language-none">sum(if(payment_count&gt;0,1,0)) payment_count

cast(ua.payment_count&#x2F;ua.order_count*100 as  decimal(10,2)) order2payment_convert_ratio<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>3）复购率：（先分别计算分子和分母，再相除）</p>
<pre class="line-numbers language-none"><code class="language-none">sum(if(mn.order_count&gt;&#x3D;1,1,0)) buycount,
sum(if(mn.order_count&gt;&#x3D;2,1,0)) buyTwiceLast,
sum(if(mn.order_count&gt;&#x3D;2,1,0))&#x2F;sum( if(mn.order_count&gt;&#x3D;1,1,0)) buyTwiceLastRatio,
sum(if(mn.order_count&gt;&#x3D;3,1,0))  buy3timeLast  ,
sum(if(mn.order_count&gt;&#x3D;3,1,0))&#x2F;sum( if(mn.order_count&gt;&#x3D;1,1,0)) buy3timeLastRatio ,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="10-5-拉链表"><a class="header-anchor" href="#10-5-拉链表">¶</a>10.5 拉链表</h2>
<p>1）通过关系型数据库的create time和operation time获取数据的新增和变化。</p>
<p>2）用临时拉链表解决Hive了中数据不能更新的问题。</p>
<h2 id="10-6-Azkaban"><a class="header-anchor" href="#10-6-Azkaban">¶</a>10.6 Azkaban</h2>
<p>1）每天集群运行多少job?</p>
<p>2）多个指标（200）*6=1200（1000-2000个job）</p>
<p>3）每天集群运行多少个task? 1000*（5-8）=5000多个</p>
<p>4）任务挂了怎么办？运行成功或者失败都会发邮件</p>
<h2 id="10-7-项目中表关系"><a class="header-anchor" href="#10-7-项目中表关系">¶</a>10.7 项目中表关系</h2>
<img src="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/GmBqpD.png" class="" title="GmBqpD.png" loading="lazy">
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>momo</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/" title="3系统业务数据仓库">https://ppxiaodi.gitee.io/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%883%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%882%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/" rel="prev" title="2用户行为数据仓库"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">2用户行为数据仓库</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2020/12/12/CollectionNote/big/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%884%E5%8D%B3%E5%B8%AD%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%EF%BC%89/" rel="next" title="4即席查询数据仓库"><span class="post-nav-text">4即席查询数据仓库</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> momo</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.7.0</span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div id="local-search-result"></div></div></div></body></html>